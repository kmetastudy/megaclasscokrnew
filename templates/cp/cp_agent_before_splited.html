{% extends 'teacher/base.html' %}
{% load static %}

{% block title %}AI ë¬¸í•­ ìƒì„±ê¸°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<style>
    .CodeMirror {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        height: auto;
        background-color: #f9fafb;
    }
    
    .CodeMirror-focused {
        background-color: #ffffff;
    }
    
    .panel {
        transition: all 0.3s ease;
    }
    
    .panel-collapsed {
        width: 0 !important;
        overflow: hidden;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0;
    }
    
    .editable-word {
        cursor: pointer;
        transition: background-color 0.2s;
        display: inline;
        padding: 2px 4px;
        border-radius: 3px;
        margin: 1px;
        border: 1px solid transparent;
    }
    
    .editable-word:hover {
        background-color: #dbeafe;
        border-color: #93c5fd;
    }
    
    .editing-word {
        background-color: #fef3c7;
        border-color: #f59e0b;
    }
    
    .edit-input {
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
        background-color: #fffbeb;
        border: none;
        outline: none !important;
        border-radius: 0.25rem;
        padding: 2px 6px;
        box-shadow: 0 0 0 1px #ef4444;
    }
    
    .edit-input:focus {
        background-color: #ffffff;
        box-shadow: 0 0 0 1px #ef4444;
    }
    
    .text-changed {
        color: #ef4444 !important;
        font-weight: 500;
    }
    
    .editable-image {
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
        border-radius: 4px;
        position: relative;
    }
    
    .editable-image:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px #3b82f6;
    }
    
    .editable-image[data-changed="true"] {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 2px #ef4444;
    }
    
    .editable-image::after {
        content: "ğŸ“¸ í´ë¦­í•˜ì—¬ ë³€ê²½";
        position: absolute;
        bottom: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
    }
    
    .editable-image:hover::after {
        opacity: 1;
    }
    
    .image-upload-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(59, 130, 246, 0.1);
        border: 2px dashed #3b82f6;
        display: none;
        align-items: center;
        justify-content: center;
        color: #3b82f6;
        font-weight: 500;
        border-radius: 4px;
    }
    
    .editable-image:hover .image-upload-overlay {
        display: flex;
    }
    
    /* íƒ­ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .preview-tab-content {
        display: none;
    }
    
    .preview-tab-content.active {
        display: block !important;
    }
    
    .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #6b7280;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* ëª¨ë˜í•œ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f3f4f6;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }
    
    /* í•„í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .filter-section {
        background-color: #f9fafb;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    /* ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ */
    .accordion-header {
        cursor: pointer;
        user-select: none;
    }
    
    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    
    .accordion-content.active {
        max-height: 500px;
        transition: max-height 0.3s ease-in;
    }
    
    /* í¸ì§‘ ë„ì›€ë§ ìŠ¤íƒ€ì¼ */
    .edit-help {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
    }
    
    .edit-help i {
        margin-right: 8px;
    }
    
    /* ì•Œë¦¼ í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease-in-out;
        font-size: 14px;
        font-weight: 500;
    }
    
    .toast-notification.show {
        transform: translateX(0);
    }
    
    .toast-notification.error {
        background: #ef4444;
    }
    
    .toast-notification.warning {
        background: #f59e0b;
    }
    
    /* ì´ë¯¸ì§€ ë¡œë”© ì¸ë””ì¼€ì´í„° */
    .image-loading {
        position: relative;
        opacity: 0.6;
    }
    
    .image-loading::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50 gap-6">
    <!-- ì¢Œì¸¡ íŒ¨ë„ (1/3) -->
    <div id="leftPanel" class="w-1/3 bg-white border border-gray-300 panel overflow-hidden flex flex-col rounded shadow-sm">
        <div class="px-4 py-2.5 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-medium text-gray-800">ğŸ‡ ë¬¸í•­ & í…œí”Œë¦¿</h2>
            <button onclick="togglePanel('left')" class="text-gray-600 hover:text-white hover:bg-orange-400 p-2 rounded transition">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto">
            <!-- íƒ­ ë©”ë‰´ -->
            <div class="flex border-b border-gray-200 bg-gray-50">
                <button onclick="switchTab('contents')" class="tab-btn flex-1 py-3 px-4 text-center text-gray-700 hover:bg-white transition border-b-2 border-orange-400 bg-white" data-tab="contents">
                    ë¬¸í•­ ë¦¬ìŠ¤íŠ¸
                </button>
                <button onclick="switchTab('templates')" class="tab-btn flex-1 py-3 px-4 text-center text-gray-600 hover:bg-white transition border-b-2 border-transparent" data-tab="templates">
                    í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸
                </button>
            </div>
            
            <!-- ë¬¸í•­ ë¦¬ìŠ¤íŠ¸ íƒ­ -->
            <div id="contentsTab" class="tab-content active p-4">
                <!-- ê²€ìƒ‰ í•„í„° -->
                <div class="filter-section">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <select id="contentCategory" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        </select>
                        
                        <select id="contentType" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">íƒ€ì… ì„ íƒ</option>
                        </select>
                        
                        <select id="contentCourse" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ì½”ìŠ¤ ì„ íƒ</option>
                        </select>
                        
                        <select id="contentChapter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ëŒ€ë‹¨ì› ì„ íƒ</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-2">
                        <input type="text" id="contentSearch" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰..." 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400">
                        <button onclick="searchContents()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="mt-3 text-sm text-gray-600">
                        ê²€ìƒ‰ ê²°ê³¼: <span id="contentsCount" class="font-semibold">0</span>ê°œ
                    </div>
                </div>
                
                <!-- ë¬¸í•­ ë¦¬ìŠ¤íŠ¸ -->
                <div id="contentsList" class="space-y-2">
                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                </div>
            </div>
            
            <!-- í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸ íƒ­ -->
            <div id="templatesTab" class="tab-content p-4">
                <!-- í…œí”Œë¦¿ ë§Œë“¤ê¸° ë²„íŠ¼ -->
                <button onclick="openTemplateModal()" class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg hover:bg-gray-800 transition mb-4">
                    <i class="fas fa-plus mr-2"></i>í…œí”Œë¦¿ ë§Œë“¤ê¸°
                </button>
                
                <!-- ê²€ìƒ‰ í•„í„° -->
                <div class="filter-section">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <select id="templateCategory" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        </select>
                        
                        <select id="templateType" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">íƒ€ì… ì„ íƒ</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-2">
                        <input type="text" id="templateSearch" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰..." 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400">
                        <button onclick="searchTemplates()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="mt-3 text-sm text-gray-600">
                        ê²€ìƒ‰ ê²°ê³¼: <span id="templatesCount" class="font-semibold">0</span>ê°œ
                    </div>
                </div>
                
                <!-- í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸ -->
                <div id="templatesList" class="space-y-2">
                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì¢Œì¸¡ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ (ìˆ¨ê¹€ ìƒíƒœì¼ ë•Œ) -->
    <button id="leftToggleBtn" onclick="togglePanel('left')" class="bg-gray-600 hover:bg-orange-400 text-white p-2 rounded-r transition fixed left-0 top-1/2 transform -translate-y-1/2 z-10" style="display: none;">
        <i class="fas fa-chevron-right"></i>
    </button>
    
    <!-- ì¤‘ê°„ íŒ¨ë„ (1/3) -->
    <div id="middlePanel" class="w-1/3 bg-white border border-gray-300 panel overflow-hidden flex flex-col rounded shadow-sm">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-medium text-gray-800">âœ¨ ë¬¸í•­ ì œì‘</h2>
                <button onclick="createNewContent()" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">
                    <i class="fas fa-plus mr-1"></i>ìƒˆ ë¬¸í•­
                </button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
            <form id="contentForm">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="mb-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">ì œëª© *</label>
                        <input type="text" id="title" name="title" required
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">íƒ€ì… *</label>
                        <select id="content_type" name="content_type" required
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">í…œí”Œë¦¿</label>
                        <select id="template_select" name="template_select"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">í…œí”Œë¦¿ ì—†ìŒ</option>
                        </select>
                    </div>
                </div>
                
                <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë¬¸í•­ ìƒì„± ì§€ì‹œì‚¬í•­ (Markdown ì§€ì›)</label>
                    <textarea id="prompt_content" name="prompt" rows="20" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm"
                              placeholder="ë¬¸í•­ ìƒì„±ì„ ìœ„í•œ ìƒì„¸í•œ ì§€ì‹œì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
                
                <!-- ë‹µì•ˆ ì…ë ¥ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë‹µì•ˆ (JSON)</label>
                    <textarea id="answer_input" name="answer_input" class="hidden">{}</textarea>
                    <div id="answerInputEditor"></div>
                </div>
                
                <!-- ì•„ì½”ë””ì–¸ ì„¹ì…˜ -->
                <div class="mb-6">
                    <div class="accordion-header flex items-center justify-between p-3 bg-gray-100 rounded-lg cursor-pointer" onclick="toggleAccordion(this)">
                        <span class="text-sm font-medium text-gray-700">ê³ ê¸‰ ì„¤ì •</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                    </div>
                    <div class="accordion-content">
                        <div class="pt-4 space-y-4">
                            <!-- ë©”íƒ€ë°ì´í„° -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ë©”íƒ€ë°ì´í„° (JSON)</label>
                                <textarea id="meta_content" name="meta_data" class="hidden">{}</textarea>
                                <div id="metaEditor"></div>
                            </div>
                            
                            <!-- íƒœê·¸ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">íƒœê·¸/í‰ê°€ê¸°ì¤€ (JSON)</label>
                                <textarea id="tags_content" name="tags" class="hidden">{}</textarea>
                                <div id="tagsEditor"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI ìš”ì²­ ë²„íŠ¼ -->
                <button type="button" onclick="requestAI()" 
                        class="w-full bg-gradient-to-r from-gray-600 to-gray-700 text-white py-3 px-4 rounded-lg hover:from-gray-700 hover:to-gray-800 transition duration-200 font-medium shadow-sm">
                    <i class="fas fa-magic mr-2"></i>AIë¡œ ë¬¸í•­ ìƒì„±í•˜ê¸°
                </button>
            </form>
        </div>
    </div>
    
    <!-- ìš°ì¸¡ íŒ¨ë„ (1/3) -->
    <div id="rightPanel" class="w-1/3 bg-white border border-gray-300 panel overflow-hidden flex flex-col rounded shadow-sm">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-800">ğŸŠ ë¯¸ë¦¬ë³´ê¸° & í¸ì§‘</h2>
        </div>
        
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="flex border-b border-gray-200 bg-gray-50">
            <button onclick="switchPreviewTab('render')" class="preview-tab-btn flex-1 py-3 px-4 text-center text-gray-700 hover:bg-white transition border-b-2 border-gray-600 bg-white" data-tab="render">
                ë Œë”ë§
            </button>
            <button onclick="switchPreviewTab('html')" class="preview-tab-btn flex-1 py-3 px-4 text-center text-gray-600 hover:bg-white transition border-b-2 border-transparent" data-tab="html">
                HTML
            </button>
            <button onclick="switchPreviewTab('text')" class="preview-tab-btn flex-1 py-3 px-4 text-center text-gray-600 hover:bg-white transition border-b-2 border-transparent" data-tab="text">
                í…ìŠ¤íŠ¸ í¸ì§‘
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto bg-gray-50">
            <!-- ë Œë”ë§ íƒ­ -->
            <div id="renderTab" class="preview-tab-content active p-6">
                <div id="previewContent" class="prose max-w-none">
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-eye text-6xl mb-4"></i>
                        <p>AIë¡œ ë¬¸í•­ì„ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
            
            <!-- HTML íƒ­ -->
            <div id="htmlTab" class="preview-tab-content h-full flex flex-col">
                <div class="flex-1" style="height: 80%;">
                    <textarea id="htmlEditor" class="hidden"></textarea>
                    <div id="htmlEditorContainer" class="h-full"></div>
                </div>
                <div style="height: 20%;" class="border-t border-gray-200">
                    <div class="p-2 bg-gray-100">
                        <label class="text-sm font-medium text-gray-700">ì •ë‹µ (JSON)</label>
                    </div>
                    <div id="answerEditorContainer" class="h-full"></div>
                </div>
            </div>
            
            <!-- í…ìŠ¤íŠ¸ í¸ì§‘ íƒ­ -->
            <div id="textTab" class="preview-tab-content p-6">
                <div class="edit-help">
                    <i class="fas fa-lightbulb"></i>
                    <strong>í¸ì§‘ ê°€ì´ë“œ:</strong> 
                    í…ìŠ¤íŠ¸ë¥¼ ë”ë¸”í´ë¦­í•˜ì—¬ í¸ì§‘í•˜ê³  ì—”í„°í‚¤ë¡œ ì €ì¥í•˜ì„¸ìš”. 
                    ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ ìƒˆ ì´ë¯¸ì§€ë¡œ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    <div class="mt-2 text-sm opacity-90">
                        <i class="fas fa-keyboard mr-1"></i>
                        ì—”í„°: ì €ì¥ | ESC: ì·¨ì†Œ | ë”ë¸”í´ë¦­: í¸ì§‘ ì‹œì‘
                    </div>
                </div>
                
                <!-- í¸ì§‘ ìƒíƒœ í‘œì‹œ -->
                <div id="editStatus" class="mb-4 p-2 bg-gray-100 rounded text-sm text-gray-600 hidden">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="editStatusText">í¸ì§‘ ê°€ëŠ¥í•œ ìš”ì†Œ: 0ê°œ</span>
                </div>
                
                <!-- ë³€ê²½ ì‚¬í•­ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
                <div id="editControls" class="mb-4 hidden">
                    <div class="flex space-x-2">
                        <button onclick="resetAllChanges()" 
                                class="flex-1 bg-gray-500 text-white py-2 px-3 rounded text-sm hover:bg-gray-600 transition">
                            <i class="fas fa-undo mr-1"></i>ëª¨ë“  ë³€ê²½ì‚¬í•­ ì·¨ì†Œ
                        </button>
                        <button onclick="showChangedElements()" 
                                class="flex-1 bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600 transition">
                            <i class="fas fa-search mr-1"></i>ë³€ê²½ì‚¬í•­ ë³´ê¸°
                        </button>
                    </div>
                    <!-- ìƒˆë¡œ ì¶”ê°€ë˜ëŠ” ë²„íŠ¼ -->
                    <div class="flex space-x-2">
                        <button onclick="cleanupCorruptedImageSrcs()" 
                                class="flex-1 bg-orange-500 text-white py-2 px-3 rounded text-sm hover:bg-orange-600 transition">
                            <i class="fas fa-tools mr-1"></i>ì†ìƒëœ ì´ë¯¸ì§€ ê²½ë¡œ ì •ë¦¬
                        </button>
                        <button onclick="validateAllImages()" 
                                class="flex-1 bg-purple-500 text-white py-2 px-3 rounded text-sm hover:bg-purple-600 transition">
                            <i class="fas fa-check-circle mr-1"></i>ì´ë¯¸ì§€ ìœ íš¨ì„± ê²€ì‚¬
                        </button>
                    </div>
                </div>
                
                <div id="editableContent" class="space-y-4 min-h-[200px] border border-gray-200 rounded-lg p-4 bg-white">
                    <p class="text-gray-400 text-center py-8">
                        <i class="fas fa-edit text-4xl mb-2 block"></i>
                        AIë¡œ ë¬¸í•­ì„ ìƒì„±í•˜ë©´ í¸ì§‘ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                    </p>
                </div>
                
                <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            </div>
        </div>
        
        <!-- ì €ì¥ ë²„íŠ¼ -->
        <div class="p-4 border-t border-gray-200 bg-white">
            <button onclick="saveContent()" 
                    class="w-full bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-200 font-medium shadow-sm">
                <i class="fas fa-save mr-2"></i>ì €ì¥í•˜ê¸°
            </button>
        </div>
    </div>
</div>

<!-- í…œí”Œë¦¿ ë§Œë“¤ê¸° ëª¨ë‹¬ (ê°œì„ ëœ ë²„ì „) -->
<div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-5xl w-full max-h-[90vh] overflow-hidden">
            <div class="bg-gray-100 px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-800">í…œí”Œë¦¿ ë§Œë“¤ê¸°</h3>
                <button onclick="closeTemplateModal()" class="text-gray-500 hover:text-gray-700 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto bg-gray-50" style="max-height: calc(90vh - 120px);">
                <form id="templateForm">
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì¹´í…Œê³ ë¦¬ *</label>
                            <select id="templateFormCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 bg-white">
                                <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">íƒ€ì… *</label>
                            <select id="templateFormType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 bg-white" disabled>
                                <option value="">íƒ€ì… ì„ íƒ</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- í…œí”Œë¦¿ ì´ë¦„ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">í…œí”Œë¦¿ ì´ë¦„ *</label>
                        <input type="text" id="templateName" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 bg-white"
                               placeholder="ì˜ˆ: ê°ê´€ì‹ 5ì§€ ì„ ë‹¤í˜• ê¸°ë³¸ í…œí”Œë¦¿">
                    </div>
                    
                    <!-- HTML í…œí”Œë¦¿ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            HTML í…œí”Œë¦¿
                            <span class="text-gray-500 text-xs ml-2">(ë¬¸í•­ì˜ HTML êµ¬ì¡°)</span>
                        </label>
                        <textarea id="templateHtml" rows="8" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 bg-gray-50 font-mono text-sm"
                                  placeholder="<div class='question'>
    <h2>ë¬¸ì œ: {ë¬¸ì œ ë‚´ìš©}</h2>
    <div class='choices'>
        <label><input type='radio' name='answer' value='1'> ì„ íƒì§€ 1</label>
        <label><input type='radio' name='answer' value='2'> ì„ íƒì§€ 2</label>
    </div>
</div>"></textarea>
                    </div>
                    
                    <!-- ì •ë‹µ í…œí”Œë¦¿ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì •ë‹µ í…œí”Œë¦¿ (JSON)
                            <span class="text-gray-500 text-xs ml-2">(ë‹µì•ˆ í˜•ì‹ ì •ì˜)</span>
                        </label>
                        <textarea id="templateAnswer" rows="4" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 bg-gray-50 font-mono text-sm"
                                  placeholder='{
  "correct": "1",
  "explanation": "ì •ë‹µ í•´ì„¤",
  "type": "multiple_choice"
}'>{"correct": "", "explanation": "", "type": "multiple_choice"}</textarea>
                    </div>
                    
                    <!-- ë©”íƒ€ë°ì´í„° -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ë©”íƒ€ë°ì´í„° (JSON)
                            <span class="text-gray-500 text-xs ml-2">(ë‚œì´ë„, ì‹œê°„ ë“± ë¶€ê°€ ì •ë³´)</span>
                        </label>
                        <textarea id="templateMeta" rows="4" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 bg-gray-50 font-mono text-sm"
                                  placeholder='{
  "difficulty": "medium",
  "estimated_time": 180,
  "subject": "ì¼ë°˜"
}'>{"difficulty": "medium", "estimated_time": 180}</textarea>
                    </div>
                    
                    <!-- JavaScript ì½”ë“œ -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            JavaScript ì½”ë“œ (ì„ íƒì‚¬í•­)
                            <span class="text-gray-500 text-xs ml-2">(ë¬¸í•­ ë™ì‘ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸)</span>
                        </label>
                        <textarea id="templateJs" rows="6" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-blue-400 bg-gray-50 font-mono text-sm"
                                  placeholder="// ì˜ˆì‹œ: ì„ íƒì§€ í´ë¦­ ì‹œ ìŠ¤íƒ€ì¼ ë³€ê²½
document.querySelectorAll('input[name=&quot;answer&quot;]').forEach(input => {
    input.addEventListener('change', function() {
        // ì„ íƒëœ ë‹µì•ˆ ìŠ¤íƒ€ì¼ë§
        document.querySelectorAll('label').forEach(label => 
            label.classList.remove('selected')
        );
        this.parentElement.classList.add('selected');
    });
});"></textarea>
                    </div>
                    
                    <!-- ë²„íŠ¼ë“¤ -->
                    <div class="flex space-x-4">
                        <button type="button" onclick="testTemplate()" 
                                class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-play mr-2"></i>ë¯¸ë¦¬ë³´ê¸° í…ŒìŠ¤íŠ¸
                        </button>
                        <button type="button" onclick="saveTemplate()" 
                                class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-save mr-2"></i>í…œí”Œë¦¿ ì €ì¥
                        </button>
                    </div>
                    
                    <!-- ë„ì›€ë§ -->
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <h4 class="text-sm font-medium text-blue-800 mb-2">ğŸ“ í…œí”Œë¦¿ ì‘ì„± íŒ</h4>
                        <ul class="text-xs text-blue-700 space-y-1">
                            <li>â€¢ HTMLì—ì„œ ì¤‘ê´„í˜¸ {...}ë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì  ë‚´ìš© ìœ„ì¹˜ë¥¼ í‘œì‹œí•˜ì„¸ìš”</li>
                            <li>â€¢ ì •ë‹µ í…œí”Œë¦¿ì€ ì±„ì ì— ì‚¬ìš©ë˜ë¯€ë¡œ ì •í™•í•œ JSON í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”</li>
                            <li>â€¢ JavaScriptëŠ” ë¬¸í•­ì˜ ìƒí˜¸ì‘ìš© ê¸°ëŠ¥ì„ ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤ (ì„ íƒì‚¬í•­)</li>
                            <li>â€¢ ë¯¸ë¦¬ë³´ê¸° í…ŒìŠ¤íŠ¸ë¡œ í…œí”Œë¦¿ì´ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”</li>
                        </ul>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ë¡œë”© ëª¨ë‹¬ -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg p-8 text-center shadow-xl">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-700">AIê°€ ë¬¸í•­ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>

<script>
// ========== ì „ì—­ ë³€ìˆ˜ ==========
let metaEditor, tagsEditor, htmlEditorInstance, answerEditor, answerInputEditor;
let currentContent = null;
let templates = [];
let currentEditingImage = null;
let temporaryUploads = []; // ì„ì‹œ ì—…ë¡œë“œëœ íŒŒì¼ë“¤ ì¶”ì 
let originalHtmlContent = '';
let wordMappings = new Map();

// ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ==========

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ì•Œë¦¼ í† ìŠ¤íŠ¸ í‘œì‹œ
function showToast(message, type = 'success') {
    // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
    $('.toast-notification').remove();
    
    const toastClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
    const icon = type === 'error' ? 'fas fa-times-circle' : 
                 type === 'warning' ? 'fas fa-exclamation-triangle' : 
                 'fas fa-check-circle';
    
    const $toast = $(`
        <div class="toast-notification ${toastClass}">
            <i class="${icon} mr-2"></i>${message}
        </div>
    `);
    
    $('body').append($toast);
    
    // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í‘œì‹œ
    setTimeout(() => $toast.addClass('show'), 100);
    
    // 3ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        $toast.removeClass('show');
        setTimeout(() => $toast.remove(), 300);
    }, 3000);
}

// ì„ì‹œ ì—…ë¡œë“œ íŒŒì¼ ì •ë¦¬
function cleanupTemporaryUploads() {
    if (temporaryUploads.length === 0) return;
    
    console.log('ì„ì‹œ ì—…ë¡œë“œ íŒŒì¼ ì •ë¦¬:', temporaryUploads);
    
    temporaryUploads.forEach(attachmentId => {
        $.ajax({
            url: `/cp/api/cleanup-temp-upload/${attachmentId}/`,
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function() {
                console.log(`ì„ì‹œ íŒŒì¼ ${attachmentId} ì •ë¦¬ ì™„ë£Œ`);
            },
            error: function(xhr) {
                console.error(`ì„ì‹œ íŒŒì¼ ${attachmentId} ì •ë¦¬ ì‹¤íŒ¨:`, xhr);
            }
        });
    });
    
    temporaryUploads = [];
}

// ========== UI ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤ ==========

// íŒ¨ë„ í† ê¸€
function togglePanel(panel) {
    const $panel = $(`#${panel}Panel`);
    const $toggleBtn = $(`#${panel}ToggleBtn`);
    const $middlePanel = $('#middlePanel');
    const $rightPanel = $('#rightPanel');
    
    if ($panel.hasClass('panel-collapsed')) {
        // íŒ¨ë„ ì—´ê¸°
        $panel.removeClass('panel-collapsed');
        $toggleBtn.hide();
        $middlePanel.removeClass('w-1/2').addClass('w-1/3');
        $rightPanel.removeClass('w-1/2').addClass('w-1/3');
    } else {
        // íŒ¨ë„ ë‹«ê¸°
        $panel.addClass('panel-collapsed');
        $toggleBtn.show();
        $middlePanel.removeClass('w-1/3').addClass('w-1/2');
        $rightPanel.removeClass('w-1/3').addClass('w-1/2');
    }
}

// íƒ­ ì „í™˜
function switchTab(tab) {
    $('.tab-btn').removeClass('border-orange-400 bg-white text-gray-700').addClass('border-transparent text-gray-600');
    $(`.tab-btn[data-tab="${tab}"]`).removeClass('border-transparent text-gray-600').addClass('border-orange-400 bg-white text-gray-700');
    
    $('.tab-content').removeClass('active');
    $(`#${tab}Tab`).addClass('active');
}

function switchPreviewTab(tab) {
    console.log('íƒ­ ì „í™˜:', tab);
    
    // ëª¨ë“  íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
    $('.preview-tab-btn').removeClass('border-gray-600 bg-white text-gray-700').addClass('border-transparent text-gray-600');
    
    // ì„ íƒëœ íƒ­ ë²„íŠ¼ í™œì„±í™”
    $(`.preview-tab-btn[data-tab="${tab}"]`).removeClass('border-transparent text-gray-600').addClass('border-gray-600 bg-white text-gray-700');
    
    // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
    $('.preview-tab-content').removeClass('active').hide();
    
    // ì„ íƒëœ íƒ­ ì½˜í…ì¸  ë³´ì´ê¸°
    $(`#${tab}Tab`).addClass('active').show();
    
    // íŠ¹ë³„í•œ ê²½ìš° ì²˜ë¦¬
    if (tab === 'html' && htmlEditorInstance) {
        // HTML ì—ë””í„° ë¦¬í”„ë ˆì‹œ
        setTimeout(() => {
            htmlEditorInstance.refresh();
        }, 100);
    }
}

// ì•„ì½”ë””ì–¸ í† ê¸€
function toggleAccordion(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('i');
    
    content.classList.toggle('active');
    icon.classList.toggle('fa-chevron-down');
    icon.classList.toggle('fa-chevron-up');
}

// ========== ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤ ==========

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ
function loadInitialData() {
    console.log('=== ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œì‘ ===');
    
    // ì¹´í…Œê³ ë¦¬ ë¡œë“œ
    $.get('/cp/api/categories/', function(data) {
        console.log('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì™„ë£Œ:', data);
        
        const categorySelects = [
            '#contentCategory', 
            '#templateCategory', 
            '#templateFormCategory'
        ];
        
        categorySelects.forEach(selector => {
            $(selector).empty().append('<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>');
            data.forEach(category => {
                $(selector).append(`<option value="${category.id}">${category.category_name}</option>`);
            });
        });
        
        console.log('ì¹´í…Œê³ ë¦¬ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }).fail(function(xhr) {
        console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', xhr);
        showToast('ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    });
    
    // ì´ˆê¸°ì—ëŠ” ëª¨ë“  ContentType ë¡œë“œ
    loadAllContentTypes();
    
    // ì½”ìŠ¤ ë¡œë“œ
    $.get('/cp/api/courses/', function(data) {
        console.log('ì½”ìŠ¤ ë¡œë“œ ì™„ë£Œ:', data);
        
        $('#contentCourse').empty().append('<option value="">ì½”ìŠ¤ ì„ íƒ</option>');
        data.forEach(course => {
            $('#contentCourse').append(`<option value="${course.id}">${course.subject_name}</option>`);
        });
        
        console.log('ì½”ìŠ¤ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }).fail(function(xhr) {
        console.error('ì½”ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', xhr);
        showToast('ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    });
    
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    searchContents();
    searchTemplates();
    
    console.log('=== ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ ===');
}

// ëª¨ë“  ì»¨í…ì¸  íƒ€ì… ë¡œë“œ í•¨ìˆ˜
function loadAllContentTypes() {
    console.log('=== ëª¨ë“  ì»¨í…ì¸  íƒ€ì… ë¡œë“œ ===');
    
    $.get('/cp/api/content-types/', function(data) {
        console.log('ì»¨í…ì¸  íƒ€ì… ë¡œë“œ ì™„ë£Œ:', data);
        
        const typeSelects = [
            '#content_type', 
            '#contentType', 
            '#templateType', 
            '#templateFormType'
        ];
        
        typeSelects.forEach(selector => {
            const $select = $(selector);
            const currentValue = $select.val(); // í˜„ì¬ ì„ íƒê°’ ë³´ì¡´
            
            $select.empty();
            
            // ê¸°ë³¸ ì˜µì…˜ ì¶”ê°€
            if (selector === '#content_type') {
                $select.append('<option value="">ì„ íƒí•˜ì„¸ìš”</option>');
            } else {
                $select.append('<option value="">íƒ€ì… ì„ íƒ</option>');
            }
            
            // íƒ€ì… ì˜µì…˜ë“¤ ì¶”ê°€
            data.forEach(type => {
                $select.append(`<option value="${type.id}">${type.type_name}</option>`);
            });
            
            // ì´ì „ ì„ íƒê°’ ë³µì›
            if (currentValue) {
                $select.val(currentValue);
            }
        });
        
        console.log('ì»¨í…ì¸  íƒ€ì… UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }).fail(function(xhr) {
        console.error('ì»¨í…ì¸  íƒ€ì… ë¡œë“œ ì‹¤íŒ¨:', xhr);
        showToast('ì»¨í…ì¸  íƒ€ì…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    });
}

// ì¹´í…Œê³ ë¦¬ë³„ ì»¨í…ì¸  íƒ€ì… ë¡œë“œ í•¨ìˆ˜
function loadContentTypesByCategory(categoryId, targetSelectors = null) {
    console.log('=== ì¹´í…Œê³ ë¦¬ë³„ ì»¨í…ì¸  íƒ€ì… ë¡œë“œ ===', categoryId);
    
    if (!categoryId) {
        loadAllContentTypes();
        return;
    }
    
    // ê¸°ë³¸ ëŒ€ìƒ ì…€ë ‰í„°ë“¤
    const defaultSelectors = ['#contentType', '#content_type'];
    const selectors = targetSelectors || defaultSelectors;
    
    $.get(`/cp/api/content-types/?category=${categoryId}`, function(data) {
        console.log('ì¹´í…Œê³ ë¦¬ë³„ ì»¨í…ì¸  íƒ€ì… ë¡œë“œ ì™„ë£Œ:', data);
        
        selectors.forEach(selector => {
            const $select = $(selector);
            const currentValue = $select.val();
            
            $select.empty();
            
            if (selector === '#content_type') {
                $select.append('<option value="">ì„ íƒí•˜ì„¸ìš”</option>');
            } else {
                $select.append('<option value="">íƒ€ì… ì„ íƒ</option>');
            }
            
            data.forEach(type => {
                $select.append(`<option value="${type.id}">${type.type_name}</option>`);
            });
            
            // ì´ì „ ì„ íƒê°’ì´ ìƒˆ ëª©ë¡ì— ìˆìœ¼ë©´ ë³µì›
            if (currentValue && $select.find(`option[value="${currentValue}"]`).length > 0) {
                $select.val(currentValue);
            }
        });
        
        console.log('ì¹´í…Œê³ ë¦¬ë³„ ì»¨í…ì¸  íƒ€ì… UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }).fail(function(xhr) {
        console.error('ì¹´í…Œê³ ë¦¬ë³„ ì»¨í…ì¸  íƒ€ì… ë¡œë“œ ì‹¤íŒ¨:', xhr);
        showToast('ì»¨í…ì¸  íƒ€ì…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        loadAllContentTypes(); // ì‹¤íŒ¨ ì‹œ ì „ì²´ íƒ€ì… ë¡œë“œ
    });
}

// ========== ê²€ìƒ‰ í•¨ìˆ˜ë“¤ ==========

function searchContents() {
    console.log('=== ì»¨í…ì¸  ê²€ìƒ‰ ì‹œì‘ ===');
    
    const params = {
        category: $('#contentCategory').val(),
        type: $('#contentType').val(),
        course: $('#contentCourse').val(),
        chapter: $('#contentChapter').val(),
        search: $('#contentSearch').val()
    };
    
    console.log('ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', params);
    
    // ê²€ìƒ‰ ì „ UI ìƒíƒœ
    const $list = $('#contentsList');
    $list.html('<div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> ê²€ìƒ‰ ì¤‘...</div>');
    
    $.get('/cp/api/contents/search/', params, function(data) {
        console.log('ê²€ìƒ‰ ê²°ê³¼:', data);
        
        $list.empty();
        $('#contentsCount').text(data.length);
        
        if (data.length === 0) {
            $list.append('<p class="text-gray-500 text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>');
            return;
        }
        
        data.forEach(content => {
            $list.append(`
                <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" onclick="loadContent(${content.id})">
                    <h4 class="font-medium text-gray-800">${content.title}</h4>
                    <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded mr-2">
                            ${content.content_type_name}
                        </span>
                        <span>${content.created_at}</span>
                    </div>
                    ${content.preview ? `<div class="text-xs text-gray-400 mt-1 truncate">${content.preview}</div>` : ''}
                </div>
            `);
        });
        
        console.log('ê²€ìƒ‰ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        
    }).fail(function(xhr) {
        console.error('ë¬¸í•­ ê²€ìƒ‰ ì‹¤íŒ¨:', xhr);
        
        let errorMsg = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.error) {
                errorMsg = response.error;
            }
        } catch (e) {
            console.error('ì—ëŸ¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', e);
        }
        
        $list.html(`<p class="text-red-500 text-center py-4">${errorMsg}</p>`);
        showToast(errorMsg, 'error');
    });
}

// ìˆ˜ì •ëœ í…œí”Œë¦¿ ê²€ìƒ‰ í•¨ìˆ˜
function searchTemplates() {
    console.log('=== í…œí”Œë¦¿ ê²€ìƒ‰ ì‹œì‘ ===');
    
    const params = {
        category: $('#templateCategory').val(),
        type: $('#templateType').val(),
        search: $('#templateSearch').val()
    };
    
    console.log('ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', params);
    
    $.get('/cp/api/templates/search/', params, function(data) {
        console.log('í…œí”Œë¦¿ ê²€ìƒ‰ ê²°ê³¼:', data);
        
        templates = data; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        const $list = $('#templatesList');
        const $select = $('#template_select');
        
        $list.empty();
        $select.empty().append('<option value="">í…œí”Œë¦¿ ì—†ìŒ</option>');
        
        $('#templatesCount').text(data.length);
        
        if (data.length === 0) {
            $list.append('<p class="text-gray-500 text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>');
            return;
        }
        
        data.forEach(template => {
            // ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ (ìˆ˜ì •: selectTemplate -> selectTemplateFromList)
            const categoryName = template.category_name || 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ';
            const typeName = template.content_type_name || 'íƒ€ì… ì—†ìŒ';
            
            $list.append(`
                <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" onclick="selectTemplateFromList(${template.id})">
                    <h4 class="font-medium text-gray-800">${template.title}</h4>
                    <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded mr-2">
                            ${categoryName}
                        </span>
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded mr-2">
                            ${typeName}
                        </span>
                        <span>${template.created_at}</span>
                    </div>
                </div>
            `);
            
            // ì„ íƒ ì˜µì…˜ì— ì¶”ê°€
            $select.append(`<option value="${template.id}">${template.title} (${categoryName}-${typeName})</option>`);
        });
        
        console.log('í…œí”Œë¦¿ ê²€ìƒ‰ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }).fail(function(xhr) {
        console.error('í…œí”Œë¦¿ ê²€ìƒ‰ ì‹¤íŒ¨:', xhr);
        
        let errorMsg = 'í…œí”Œë¦¿ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.error) {
                errorMsg = response.error;
            }
        } catch (e) {
            console.error('ì—ëŸ¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', e);
        }
        
        showToast(errorMsg, 'error');
        $('#templatesList').html(`<p class="text-red-500 text-center py-4">${errorMsg}</p>`);
    });
}

// ========== ì»¨í…ì¸  ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========

// ë¬¸í•­ ë¡œë“œ
function loadContent(contentId) {
    $.get(`/cp/api/contents/${contentId}/`, function(data) {
        $('#title').val(data.title);
        $('#content_type').val(data.content_type);
        
        // í”„ë¡¬í”„íŠ¸ì™€ HTML êµ¬ë¶„í•˜ì—¬ ì²˜ë¦¬
        if (data.prompt) {
            $('#prompt_content').val(data.prompt);
        }
        
        // HTML ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸°ì— í‘œì‹œ
        if (data.page) {
            htmlEditorInstance.setValue(data.page);
            updatePreview(); // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        }
        
        // ë‹µì•ˆ ì„¤ì •
        answerInputEditor.setValue(data.answer || '{}');
        answerEditor.setValue(data.answer || '{}');
        
        // ë©”íƒ€ë°ì´í„°ì™€ íƒœê·¸ ì„¤ì •
        metaEditor.setValue(JSON.stringify(data.meta_data || {}, null, 2));
        tagsEditor.setValue(JSON.stringify(data.tags || {}, null, 2));
        
        currentContent = data;
    }).fail(function() {
        alert('ë¬¸í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ========== ìˆ˜ì •ëœ í…œí”Œë¦¿ ì„ íƒ í•¨ìˆ˜ (ë¬´í•œ ì¬ê·€ ë¬¸ì œ í•´ê²°) ==========

// í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸ì—ì„œ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ (HTMLì˜ onclickì—ì„œ ì‚¬ìš©)
function selectTemplateFromList(templateId) {
    console.log('ë¦¬ìŠ¤íŠ¸ì—ì„œ í…œí”Œë¦¿ ì„ íƒ:', templateId);
    
    // UI ì„ íƒìƒíƒœ ì—…ë°ì´íŠ¸ (ì´ë²¤íŠ¸ ë°œìƒì‹œí‚¤ì§€ ì•ŠìŒ)
    $('#template_select').val(templateId);
    
    // í…œí”Œë¦¿ ë°ì´í„° ì ìš©
    applyTemplateData(templateId);
}

// ìƒˆë¡œìš´ í…œí”Œë¦¿ ì ìš© í•¨ìˆ˜ (ì¬ê·€ ë°©ì§€ìš©)
function applyTemplateData(templateId) {
    console.log('í…œí”Œë¦¿ ë°ì´í„° ì ìš©:', templateId);
    
    // í…œí”Œë¦¿ ë°ì´í„° ì°¾ê¸°
    const template = templates.find(t => t.id == templateId);
    if (!template) {
        console.error('í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', templateId);
        showToast('í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    console.log('ì ìš©í•  í…œí”Œë¦¿:', template);
    
    try {
        // í¼ì— í…œí”Œë¦¿ ë°ì´í„° ì ìš©
        $('#prompt_content').val(template.page || '');
        
        // answer ì²˜ë¦¬
        if (template.answer) {
            answerInputEditor.setValue(template.answer);
        } else {
            answerInputEditor.setValue('{}');
        }
        
        // meta_data ì²˜ë¦¬
        if (template.meta_data) {
            if (typeof template.meta_data === 'string') {
                metaEditor.setValue(template.meta_data);
            } else {
                metaEditor.setValue(JSON.stringify(template.meta_data, null, 2));
            }
        } else {
            metaEditor.setValue('{}');
        }
        
        // tags ì²˜ë¦¬ (JavaScript ì½”ë“œ í¬í•¨ ê°€ëŠ¥)
        if (template.tags) {
            if (typeof template.tags === 'object' && template.tags.javascript) {
                // JavaScript ì½”ë“œê°€ tags.javascriptì— ì €ì¥ëœ ê²½ìš°
                tagsEditor.setValue(JSON.stringify(template.tags, null, 2));
            } else if (typeof template.tags === 'string') {
                tagsEditor.setValue(template.tags);
            } else {
                tagsEditor.setValue(JSON.stringify(template.tags, null, 2));
            }
        } else {
            tagsEditor.setValue('{}');
        }
        
        showToast(`í…œí”Œë¦¿ "${template.title}"ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
        
    } catch (error) {
        console.error('í…œí”Œë¦¿ ì ìš© ì¤‘ ì˜¤ë¥˜:', error);
        showToast('í…œí”Œë¦¿ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

// AI ìš”ì²­
function requestAI() {
    const formData = {
        title: $('#title').val(),
        content_type: $('#content_type').val(),
        template_id: $('#template_select').val(),
        prompt: $('#prompt_content').val(),
        answer_input: answerInputEditor.getValue(),
        meta_data: metaEditor.getValue(),
        tags: tagsEditor.getValue()
    };
    
    if (!formData.title || !formData.content_type) {
        alert('ì œëª©ê³¼ ì»¨í…ì¸  íƒ€ì…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    $('#loadingModal').removeClass('hidden');
    
    $.ajax({
        url: '/cp/api/generate-content/',
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            htmlEditorInstance.setValue(data.page || '');
            answerEditor.setValue(data.answer || '');
            metaEditor.setValue(data.meta_data || '{}');
            tagsEditor.setValue(data.tags || '{}');
            
            updatePreview();
            $('#loadingModal').addClass('hidden');
        },
        error: function(xhr) {
            alert('AI ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            $('#loadingModal').addClass('hidden');
        }
    });
}

// ========== ì™„ì „í•œ í…ìŠ¤íŠ¸ í¸ì§‘ ì‹œìŠ¤í…œ ==========

/**
 * í…ìŠ¤íŠ¸ í¸ì§‘ ì´ë²¤íŠ¸ ë°”ì¸ë”©
 */
function bindTextEditingEvents() {
    console.log('í…ìŠ¤íŠ¸ í¸ì§‘ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹œì‘');
    
    // ê¸°ì¡´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ëª¨ë‘ ì œê±°
    $(document).off('dblclick', '.editable-word');
    $(document).off('click', '.editable-image');
    
    // ìƒˆë¡œìš´ í…ìŠ¤íŠ¸ í¸ì§‘ ì´ë²¤íŠ¸
    $(document).on('dblclick.newTextEdit', '.editable-word', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const $word = $(this);
        const wordId = $word.data('word-id');
        const originalText = $word.data('original');
        const currentText = $word.text();
        
        console.log('í…ìŠ¤íŠ¸ í¸ì§‘ ì‹œì‘:', { wordId, originalText, currentText });
        
        if (!wordId || wordId === 'undefined' || wordId === 'NaN') {
            console.error('ìœ íš¨í•˜ì§€ ì•Šì€ wordId:', wordId);
            showToast('í¸ì§‘í•  ìˆ˜ ì—†ëŠ” í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤', 'error');
            return;
        }
        
        if ($word.hasClass('editing-word')) {
            return;
        }
        
        startTextEditing($word, wordId, originalText, currentText);
    });
    
    // ì´ë¯¸ì§€ í¸ì§‘ ì´ë²¤íŠ¸
    $(document).on('click.imageEdit', '.editable-image', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('ì´ë¯¸ì§€ í¸ì§‘ í´ë¦­');
        currentEditingImage = $(this);
        $('#imageUpload').click();
    });
    
    console.log('ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë°”ì¸ë”© ì™„ë£Œ');
}

/**
 * í…ìŠ¤íŠ¸ í¸ì§‘ ì‹œì‘
 */
function startTextEditing($word, wordId, originalText, currentText) {
    $word.addClass('editing-word');
    
    const $input = $('<input type="text" class="edit-input">');
    $input.val(currentText);
    $input.css({
        'width': Math.max(100, currentText.length * 10 + 30) + 'px',
        'font-family': $word.css('font-family'),
        'font-size': $word.css('font-size'),
        'font-weight': $word.css('font-weight')
    });
    
    $word.replaceWith($input);
    $input.focus().select();
    
    function finishEditing() {
        const newText = $input.val(); // trim() í•˜ì§€ ì•ŠìŒ
        
        if (newText !== currentText) {
            const updateSuccess = updateTextInHtml(wordId, currentText, newText);
            
            if (updateSuccess) {
                const $newWord = $(`<span class="editable-word text-changed" 
                    data-word-id="${wordId}" 
                    data-original="${originalText}"
                    data-changed="true"
                    title="ë”ë¸”í´ë¦­í•˜ì—¬ í¸ì§‘"
                    style="color: #ef4444 !important; font-weight: 500;">${newText}</span>`);
                
                $input.replaceWith($newWord);
                showToast(`"${currentText}" â†’ "${newText}" ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                
                setTimeout(() => {
                    updatePreview();
                    updateEditControls();
                }, 100);
            } else {
                restoreOriginalWord();
                showToast('í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        } else {
            restoreOriginalWord();
        }
    }
    
    function cancelEditing() {
        restoreOriginalWord();
        showToast('í¸ì§‘ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'warning');
    }
    
    function restoreOriginalWord() {
        const $restoredWord = $(`<span class="editable-word" 
            data-word-id="${wordId}" 
            data-original="${originalText}"
            title="ë”ë¸”í´ë¦­í•˜ì—¬ í¸ì§‘">${currentText}</span>`);
        $input.replaceWith($restoredWord);
    }
    
    $input.on('keydown', function(e) {
        e.stopPropagation();
        if (e.key === 'Enter') {
            e.preventDefault();
            finishEditing();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEditing();
        }
    });
    
    $input.on('blur', function() {
        finishEditing();
    });
}

/**
 * HTMLì—ì„œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
 */
function updateTextInHtml(wordId, oldText, newText) {
    console.log(`HTML í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸: wordId=${wordId}, "${oldText}" â†’ "${newText}"`);
    
    const mapping = wordMappings.get(wordId);
    if (!mapping) {
        console.error('ë§¤í•‘ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', wordId);
        return false;
    }
    
    let currentHtml = htmlEditorInstance.getValue();
    
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    const escapedOldText = escapeRegExp(oldText);
    
    const strategies = [
        {
            name: 'word boundary',
            regex: new RegExp(`\\b${escapedOldText}\\b`, 'g')
        },
        {
            name: 'html text',
            regex: new RegExp(`(>[^<]*?)${escapedOldText}([^<]*?<)`, 'g'),
            replacement: `$1${newText}$2`
        },
        {
            name: 'simple text',
            regex: new RegExp(escapedOldText, 'g')
        }
    ];
    
    let updatedHtml = currentHtml;
    let replacementMade = false;
    
    for (const strategy of strategies) {
        if (strategy.regex.test(currentHtml)) {
            if (strategy.replacement) {
                updatedHtml = currentHtml.replace(strategy.regex, strategy.replacement);
            } else {
                updatedHtml = currentHtml.replace(strategy.regex, newText);
            }
            replacementMade = true;
            break;
        }
    }
    
    if (replacementMade) {
        htmlEditorInstance.setValue(updatedHtml);
        mapping.originalText = newText;
        wordMappings.set(wordId, mapping);
        return true;
    }
    
    return false;
}

/**
 * HTML ì½˜í…ì¸ ë¥¼ í¸ì§‘ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜
 */
function updateEditableContent(html) {
    console.log('í¸ì§‘ ê°€ëŠ¥í•œ ì½˜í…ì¸  ì—…ë°ì´íŠ¸ ì‹œì‘');
    
    const $container = $('#editableContent');
    $container.empty();
    
    if (!html || html.trim() === '') {
        $container.html('<p class="text-gray-500 text-center py-4">í¸ì§‘í•  ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</p>');
        updateEditControls();
        return;
    }
    
    originalHtmlContent = html;
    wordMappings.clear();
    
    try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        let globalWordId = 0;
        
        function processNode(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                const fullText = node.textContent;
                
                if (!fullText.trim()) {
                    return $('<span>').text(fullText);
                }
                
                const segments = fullText.split(/(\s+)/);
                const $textContainer = $('<span class="text-container">');
                
                segments.forEach((segment, index) => {
                    if (segment.trim()) {
                        const wordId = `word_${globalWordId++}`;
                        
                        wordMappings.set(wordId, {
                            originalText: segment,
                            fullTextContent: fullText,
                            segmentIndex: index,
                            parentNode: node.parentNode ? node.parentNode.tagName : 'BODY'
                        });
                        
                        const $word = $(`<span class="editable-word" 
                            data-word-id="${wordId}" 
                            data-original="${segment}"
                            title="ë”ë¸”í´ë¦­í•˜ì—¬ í¸ì§‘">${segment}</span>`);
                        
                        $textContainer.append($word);
                    } else if (segment) {
                        $textContainer.append(segment);
                    }
                });
                
                return $textContainer;
                
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                if (node.tagName === 'IMG') {
                    const imageId = `img_${globalWordId++}`;
                    const $img = $(`<div class="relative inline-block">
                        <img src="${node.src}" 
                             class="editable-image max-w-full h-auto" 
                             data-image-id="${imageId}"
                             data-original-src="${node.src}"
                             title="í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ë³€ê²½">
                        <div class="image-upload-overlay">
                            <span>ğŸ“¸ í´ë¦­í•˜ì—¬ ë³€ê²½</span>
                        </div>
                    </div>`);
                    
                    // ì´ë¯¸ì§€ ì†ì„± ë³µì‚¬
                    const $realImg = $img.find('img');
                    Array.from(node.attributes).forEach(attr => {
                        if (attr.name !== 'src' && attr.name !== 'class') {
                            $realImg.attr(attr.name, attr.value);
                        }
                    });
                    
                    return $img;
                } else {
                    const $element = $(`<${node.tagName.toLowerCase()}></${node.tagName.toLowerCase()}>`);
                    
                    Array.from(node.attributes).forEach(attr => {
                        $element.attr(attr.name, attr.value);
                    });
                    
                    Array.from(node.childNodes).forEach(child => {
                        const $processedChild = processNode(child);
                        if ($processedChild) {
                            $element.append($processedChild);
                        }
                    });
                    
                    return $element;
                }
            }
            
            return null;
        }
        
        const $processedContent = $('<div>');
        Array.from(doc.body.childNodes).forEach(child => {
            const $processed = processNode(child);
            if ($processed) {
                $processedContent.append($processed);
            }
        });
        
        $container.html($processedContent.html());
        
        // í˜¸ë²„ íš¨ê³¼ ì ìš©
        $container.find('.editable-word').on('mouseenter', function() {
            if (!$(this).hasClass('text-changed')) {
                $(this).css({
                    'background-color': '#dbeafe',
                    'border-color': '#93c5fd'
                });
            }
        }).on('mouseleave', function() {
            if (!$(this).hasClass('text-changed')) {
                $(this).css({
                    'background-color': 'transparent',
                    'border-color': 'transparent'
                });
            }
        });
        
        const editableWordCount = $('.editable-word').length;
        const editableImageCount = $('.editable-image').length;
        
        console.log(`í¸ì§‘ ê°€ëŠ¥í•œ ë‹¨ì–´: ${editableWordCount}ê°œ, ì´ë¯¸ì§€: ${editableImageCount}ê°œ`);
        
        if (editableWordCount > 0 || editableImageCount > 0) {
            $('#editStatus').removeClass('hidden');
            $('#editStatusText').text(`í¸ì§‘ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸: ${editableWordCount}ê°œ, ì´ë¯¸ì§€: ${editableImageCount}ê°œ`);
        } else {
            $('#editStatus').addClass('hidden');
        }
        
        updateEditControls();
        
    } catch (error) {
        console.error('HTML íŒŒì‹± ì˜¤ë¥˜:', error);
        $container.html('<p class="text-red-500 text-center py-4">ì½˜í…ì¸  íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>');
    }
}

// ========== ì™„ì „í•œ ì´ë¯¸ì§€ í¸ì§‘ ì‹œìŠ¤í…œ ==========

/**
 * ì´ë¯¸ì§€ ì—…ë¡œë“œ
 */
function uploadImage(file, $img) {
    console.log('=== ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘ ===');
    console.log('íŒŒì¼:', file.name);
    console.log('í˜„ì¬ ì´ë¯¸ì§€ src:', $img.attr('src'));
    console.log('ì´ë¯¸ì§€ ID:', $img.attr('id'));
    
    // íŒŒì¼ í¬ê¸° ê²€ì¦ (10MB ì œí•œ)
    if (file.size > 10 * 1024 * 1024) {
        showToast('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    // íŒŒì¼ íƒ€ì… ê²€ì¦
    if (!file.type.startsWith('image/')) {
        showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    $img.addClass('image-loading');
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('original_name', file.name);
    formData.append('file_type', file.type);
    formData.append('file_size', file.size);
    
    // í˜„ì¬ ì½˜í…ì¸  IDê°€ ìˆìœ¼ë©´ ì „ì†¡
    if (currentContent && currentContent.id) {
        formData.append('content_id', currentContent.id);
    }
    
    $.ajax({
        url: '/cp/api/upload-image/',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            console.log('=== ì—…ë¡œë“œ ì„±ê³µ ===');
            console.log('ì„œë²„ ì‘ë‹µ:', data);
            
            // í˜„ì¬ ì´ë¯¸ì§€ ì •ë³´ ìˆ˜ì§‘
            const imageId = $img.attr('id');
            const newSrc = data.file_url;
            
            console.log('êµì²´í•  ì´ë¯¸ì§€ ID:', imageId);
            console.log('ìƒˆë¡œìš´ src:', newSrc);
            
            // HTML ì—ë””í„°ì˜ í˜„ì¬ ë‚´ìš©ì„ DOMìœ¼ë¡œ íŒŒì‹±
            const currentHtml = htmlEditorInstance.getValue();
            console.log('í˜„ì¬ HTML ê¸¸ì´:', currentHtml.length);
            
            // DOM íŒŒì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ ì†ì„± êµì²´
            let updatedHtml = updateImageSrcInHtml(currentHtml, imageId, newSrc);
            
            if (updatedHtml !== currentHtml) {
                console.log('HTML êµì²´ ì„±ê³µ!');
                htmlEditorInstance.setValue(updatedHtml);
            } else {
                console.error('HTML êµì²´ ì‹¤íŒ¨!');
                showToast('ì´ë¯¸ì§€ êµì²´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // ì›ë³¸ src ì €ì¥ (ì·¨ì†Œ ì‹œ ë³µì›ìš©)
            if (!$img.attr('data-original-src')) {
                $img.attr('data-original-src', $img.attr('src'));
            }
            
            // ìºì‹œ ë²„ìŠ¤í„° ì¶”ê°€
            const cacheBustedUrl = newSrc + '?t=' + Date.now();
            
            // ì´ë¯¸ì§€ ìš”ì†Œ ì—…ë°ì´íŠ¸
            $img.attr('src', cacheBustedUrl);
            $img.attr('data-changed', 'true');
            $img.attr('data-attachment-id', data.attachment_id || '');
            $img.attr('data-new-src', newSrc);
            
            // ë¡œë”© ìƒíƒœ ì œê±°
            $img.removeClass('image-loading');
            
            console.log('=== ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì‹œì‘ ===');
            
            // ê°•ì œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            setTimeout(() => {
                updatePreview();
                console.log('ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                
                // ëª¨ë“  íƒ­ì˜ ë™ì¼í•œ ì´ë¯¸ì§€ë“¤ ì—…ë°ì´íŠ¸
                updateAllTabImages(imageId, cacheBustedUrl);
                
            }, 100);
            
            // ì„ì‹œ ì—…ë¡œë“œ ëª©ë¡ì— ì¶”ê°€
            if (data.attachment_id) {
                temporaryUploads.push(data.attachment_id);
            }
            
            showToast('ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            updateEditControls();
        },
        error: function(xhr) {
            console.error('=== ì—…ë¡œë“œ ì‹¤íŒ¨ ===');
            console.error('xhr:', xhr);
            
            // ë¡œë”© ìƒíƒœ ì œê±°
            $img.removeClass('image-loading');
            
            let errorMsg = 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.error) {
                    errorMsg = response.error;
                }
            } catch (e) {
                console.error('ì—ëŸ¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', e);
            }
            
            showToast(errorMsg, 'error');
        }
    });
}

/**
 * DOM íŒŒì„œë¥¼ ì‚¬ìš©í•˜ì—¬ HTMLì—ì„œ ì´ë¯¸ì§€ src ì •í™•íˆ êµì²´
 */
function updateImageSrcInHtml(html, imageId, newSrc) {
    console.log('=== DOM íŒŒì„œë¥¼ í†µí•œ ì´ë¯¸ì§€ êµì²´ ===');
    console.log('ëŒ€ìƒ ì´ë¯¸ì§€ ID:', imageId);
    console.log('ìƒˆë¡œìš´ src:', newSrc);
    
    try {
        // DOM íŒŒì„œ ìƒì„±
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        let imageFound = false;
        
        // IDë¡œ ì´ë¯¸ì§€ ì°¾ê¸°
        if (imageId) {
            const targetImg = doc.getElementById(imageId);
            if (targetImg) {
                console.log('IDë¡œ ì´ë¯¸ì§€ ë°œê²¬:', targetImg.src);
                console.log('ê¸°ì¡´ src ì†ì„±:', targetImg.getAttribute('src'));
                
                // src ì†ì„± ì™„ì „ êµì²´
                targetImg.setAttribute('src', newSrc);
                imageFound = true;
                
                console.log('ìƒˆë¡œìš´ src ì†ì„±:', targetImg.getAttribute('src'));
            } else {
                console.log('IDë¡œ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', imageId);
            }
        }
        
        // IDë¡œ ì°¾ì§€ ëª»í•œ ê²½ìš° ë‹¤ë¥¸ ë°©ë²• ì‹œë„
        if (!imageFound) {
            const allImages = doc.querySelectorAll('img');
            console.log('ì „ì²´ ì´ë¯¸ì§€ ìˆ˜:', allImages.length);
            
            for (let i = 0; i < allImages.length; i++) {
                const img = allImages[i];
                const currentSrc = img.getAttribute('src');
                console.log(`ì´ë¯¸ì§€ ${i}:`, {
                    id: img.getAttribute('id'),
                    src: currentSrc,
                    alt: img.getAttribute('alt'),
                    class: img.getAttribute('class')
                });
                
                // srcê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ëˆ„ì ëœ ê²ƒ í™•ì¸
                if (currentSrc && (currentSrc.includes('.gif') || currentSrc.includes('.jpg') || currentSrc.includes('.png'))) {
                    // ë§ˆì§€ë§‰ ì´ë¯¸ì§€ íŒŒì¼ í™•ì¥ì ìœ„ì¹˜ ì°¾ê¸°
                    const extensions = ['.gif', '.jpg', '.jpeg', '.png', '.webp', '.svg'];
                    let lastExtIndex = -1;
                    let lastExt = '';
                    
                    for (const ext of extensions) {
                        const index = currentSrc.lastIndexOf(ext);
                        if (index > lastExtIndex) {
                            lastExtIndex = index;
                            lastExt = ext;
                        }
                    }
                    
                    if (lastExtIndex > -1) {
                        // ëˆ„ì ëœ URL ê°ì§€
                        const beforeLastExt = currentSrc.substring(0, lastExtIndex + lastExt.length);
                        const afterLastExt = currentSrc.substring(lastExtIndex + lastExt.length);
                        
                        if (afterLastExt.length > 0) {
                            console.log('ëˆ„ì ëœ URL ê°ì§€:', currentSrc);
                            console.log('ì •ë¦¬ëœ ë¶€ë¶„:', beforeLastExt);
                            console.log('ëˆ„ì ëœ ë¶€ë¶„:', afterLastExt);
                            
                            // ì´ ì´ë¯¸ì§€ê°€ êµì²´ ëŒ€ìƒì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
                            img.setAttribute('src', newSrc);
                            imageFound = true;
                            console.log('ëˆ„ì  URL ì´ë¯¸ì§€ êµì²´ ì™„ë£Œ');
                            break;
                        }
                    }
                }
            }
        }
        
        if (imageFound) {
            // ìˆ˜ì •ëœ HTML ë°˜í™˜
            const updatedHtml = doc.body.innerHTML;
            console.log('DOM íŒŒì„œ êµì²´ ì„±ê³µ');
            return updatedHtml;
        } else {
            console.log('êµì²´í•  ì´ë¯¸ì§€ë¥¼ ì°¾ì§€ ëª»í•¨');
            return html; // ì›ë³¸ ë°˜í™˜
        }
        
    } catch (error) {
        console.error('DOM íŒŒì„œ ì˜¤ë¥˜:', error);
        return html; // ì›ë³¸ ë°˜í™˜
    }
}

/**
 * ëª¨ë“  íƒ­ì˜ ë™ì¼í•œ ì´ë¯¸ì§€ë“¤ ì—…ë°ì´íŠ¸
 */
function updateAllTabImages(imageId, newSrc) {
    console.log('=== ëª¨ë“  íƒ­ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ===');
    console.log('ëŒ€ìƒ ID:', imageId);
    console.log('ìƒˆë¡œìš´ src:', newSrc);
    
    // ê° íƒ­ë³„ë¡œ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
    $('.preview-tab-content').each(function() {
        const tabId = $(this).attr('id');
        console.log(`${tabId} íƒ­ ì—…ë°ì´íŠ¸ ì¤‘...`);
        
        // IDë¡œ ì°¾ê¸°
        if (imageId) {
            const $targetImg = $(this).find(`#${imageId}`);
            if ($targetImg.length > 0) {
                console.log(`${tabId}ì—ì„œ IDë¡œ ì´ë¯¸ì§€ ë°œê²¬:`, $targetImg.attr('src'));
                $targetImg.attr('src', newSrc);
                console.log(`${tabId} ì—…ë°ì´íŠ¸ ì™„ë£Œ:`, $targetImg.attr('src'));
            }
        }
        
        // ëˆ„ì ëœ srcë¥¼ ê°€ì§„ ì´ë¯¸ì§€ë“¤ë„ ì •ë¦¬
        $(this).find('img').each(function() {
            const currentSrc = $(this).attr('src');
            if (currentSrc && isCorruptedSrc(currentSrc)) {
                console.log(`${tabId}ì—ì„œ ì†ìƒëœ src ë°œê²¬:`, currentSrc);
                $(this).attr('src', newSrc);
                console.log(`${tabId} ì†ìƒëœ ì´ë¯¸ì§€ ë³µêµ¬ ì™„ë£Œ`);
            }
        });
    });
}

/**
 * ì†ìƒëœ(ëˆ„ì ëœ) srcì¸ì§€ í™•ì¸
 */
function isCorruptedSrc(src) {
    if (!src) return false;
    
    // .gif, .jpg, .png ë“±ì´ ì—¬ëŸ¬ ë²ˆ ë‚˜íƒ€ë‚˜ëŠ”ì§€ í™•ì¸
    const extensions = ['.gif', '.jpg', '.jpeg', '.png', '.webp'];
    let extCount = 0;
    
    for (const ext of extensions) {
        const matches = src.match(new RegExp(ext, 'g'));
        if (matches) {
            extCount += matches.length;
        }
    }
    
    return extCount > 1; // í™•ì¥ìê°€ 2ê°œ ì´ìƒì´ë©´ ëˆ„ì ëœ ê²ƒìœ¼ë¡œ íŒë‹¨
}

/**
 * HTML ì—ë””í„°ì—ì„œ ì†ìƒëœ ì´ë¯¸ì§€ src ëª¨ë‘ ì •ë¦¬
 */
function cleanupCorruptedImageSrcs() {
    console.log('=== ì†ìƒëœ ì´ë¯¸ì§€ src ì •ë¦¬ ===');
    
    const currentHtml = htmlEditorInstance.getValue();
    const parser = new DOMParser();
    const doc = parser.parseFromString(currentHtml, 'text/html');
    
    let hasChanges = false;
    const allImages = doc.querySelectorAll('img');
    
    allImages.forEach((img, index) => {
        const currentSrc = img.getAttribute('src');
        if (currentSrc && isCorruptedSrc(currentSrc)) {
            console.log(`ì†ìƒëœ ì´ë¯¸ì§€ ${index} ë°œê²¬:`, currentSrc);
            
            // ì²« ë²ˆì§¸ ìœ íš¨í•œ URLë§Œ ì¶”ì¶œ
            const extensions = ['.gif', '.jpg', '.jpeg', '.png', '.webp', '.svg'];
            for (const ext of extensions) {
                const firstExtIndex = currentSrc.indexOf(ext);
                if (firstExtIndex > -1) {
                    const cleanSrc = currentSrc.substring(0, firstExtIndex + ext.length);
                    console.log(`ì •ë¦¬ëœ src:`, cleanSrc);
                    img.setAttribute('src', cleanSrc);
                    hasChanges = true;
                    break;
                }
            }
        }
    });
    
    if (hasChanges) {
        const cleanedHtml = doc.body.innerHTML;
        htmlEditorInstance.setValue(cleanedHtml);
        updatePreview();
        console.log('ì†ìƒëœ ì´ë¯¸ì§€ src ì •ë¦¬ ì™„ë£Œ');
        showToast('ì†ìƒëœ ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.', 'success');
    }
}

/**
 * ëª¨ë“  ì´ë¯¸ì§€ì˜ ìœ íš¨ì„± ê²€ì‚¬
 */
function validateAllImages() {
    console.log('=== ì´ë¯¸ì§€ ìœ íš¨ì„± ê²€ì‚¬ ì‹œì‘ ===');
    
    const currentHtml = htmlEditorInstance.getValue();
    const parser = new DOMParser();
    const doc = parser.parseFromString(currentHtml, 'text/html');
    
    const allImages = doc.querySelectorAll('img');
    const report = {
        total: allImages.length,
        valid: 0,
        corrupted: 0,
        missing: 0,
        details: []
    };
    
    allImages.forEach((img, index) => {
        const src = img.getAttribute('src');
        const id = img.getAttribute('id') || `image-${index}`;
        const alt = img.getAttribute('alt') || '(alt ì—†ìŒ)';
        
        const detail = {
            index: index,
            id: id,
            alt: alt,
            src: src,
            status: 'unknown'
        };
        
        if (!src) {
            detail.status = 'missing';
            detail.issue = 'src ì†ì„±ì´ ì—†ìŒ';
            report.missing++;
        } else if (isCorruptedSrc(src)) {
            detail.status = 'corrupted';
            detail.issue = 'URLì´ ëˆ„ì ë¨';
            report.corrupted++;
        } else {
            detail.status = 'valid';
            report.valid++;
        }
        
        report.details.push(detail);
        console.log(`ì´ë¯¸ì§€ ${index}:`, detail);
    });
    
    console.log('=== ê²€ì‚¬ ê²°ê³¼ ===');
    console.log('ì „ì²´:', report.total);
    console.log('ì •ìƒ:', report.valid);
    console.log('ì†ìƒ:', report.corrupted);
    console.log('ëˆ„ë½:', report.missing);
    
    // ê²°ê³¼ í‘œì‹œ
    showImageValidationReport(report);
    
    return report;
}

/**
 * ì´ë¯¸ì§€ ê²€ì‚¬ ê²°ê³¼ í‘œì‹œ
 */
function showImageValidationReport(report) {
    let message = `ğŸ“Š ì´ë¯¸ì§€ ê²€ì‚¬ ê²°ê³¼\n\n`;
    message += `ì „ì²´: ${report.total}ê°œ\n`;
    message += `âœ… ì •ìƒ: ${report.valid}ê°œ\n`;
    message += `âŒ ì†ìƒ: ${report.corrupted}ê°œ\n`;
    message += `âš ï¸ ëˆ„ë½: ${report.missing}ê°œ\n\n`;
    
    if (report.corrupted > 0 || report.missing > 0) {
        message += `ğŸ”§ ë¬¸ì œê°€ ìˆëŠ” ì´ë¯¸ì§€:\n`;
        report.details.forEach(detail => {
            if (detail.status !== 'valid') {
                message += `- ${detail.id}: ${detail.issue}\n`;
            }
        });
        
        if (report.corrupted > 0) {
            message += `\n"ì†ìƒëœ ì´ë¯¸ì§€ ê²½ë¡œ ì •ë¦¬" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìë™ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
        }
    } else {
        message += `ğŸ‰ ëª¨ë“  ì´ë¯¸ì§€ê°€ ì •ìƒì…ë‹ˆë‹¤!`;
    }
    
    alert(message);
    
    // í† ìŠ¤íŠ¸ë¡œë„ ê°„ë‹¨í•œ ê²°ê³¼ í‘œì‹œ
    if (report.corrupted > 0 || report.missing > 0) {
        showToast(`ì´ë¯¸ì§€ ê²€ì‚¬ ì™„ë£Œ: ë¬¸ì œ ${report.corrupted + report.missing}ê°œ ë°œê²¬`, 'warning');
    } else {
        showToast('ëª¨ë“  ì´ë¯¸ì§€ê°€ ì •ìƒì…ë‹ˆë‹¤!', 'success');
    }
}

/**
 * ì €ì¥ ì „ ì´ë¯¸ì§€ ìë™ ê²€ì¦ ë° ì •ë¦¬
 */
function validateAndCleanupBeforeSave() {
    console.log('=== ì €ì¥ ì „ ì´ë¯¸ì§€ ìë™ ì •ë¦¬ ===');
    
    const report = validateAllImages();
    
    if (report.corrupted > 0) {
        console.log('ì†ìƒëœ ì´ë¯¸ì§€ ë°œê²¬, ìë™ ì •ë¦¬ ì‹œì‘...');
        cleanupCorruptedImageSrcs();
        
        // ì •ë¦¬ í›„ ë‹¤ì‹œ ê²€ì¦
        setTimeout(() => {
            const newReport = validateAllImages();
            if (newReport.corrupted === 0) {
                console.log('ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ');
                showToast('ì €ì¥ ì „ ì´ë¯¸ì§€ ê²½ë¡œ ì •ë¦¬ ì™„ë£Œ', 'success');
            }
        }, 100);
    }
}

/**
 * ì´ë¯¸ì§€ ë³€ê²½ì‚¬í•­ ì·¨ì†Œ
 */
function cancelImageChanges() {
    $('.editable-image[data-changed="true"]').each(function() {
        const $img = $(this);
        const originalSrc = $img.attr('data-original-src');
        const attachmentId = $img.attr('data-attachment-id');
        
        if (originalSrc) {
            // ì›ë˜ ì´ë¯¸ì§€ë¡œ ë³µì›
            $img.attr('src', originalSrc);
            
            // HTML ì—ë””í„°ì˜ ë‚´ìš©ë„ ì—…ë°ì´íŠ¸
            const newSrc = $img.attr('data-new-src');
            if (newSrc) {
                let html = htmlEditorInstance.getValue();
                html = html.replace(newSrc, originalSrc);
                htmlEditorInstance.setValue(html);
            }
            
            // ë³€ê²½ í‘œì‹œ ì œê±°
            $img.removeAttr('data-changed data-attachment-id data-new-src');
        }
        
        // ì„ì‹œ ì—…ë¡œë“œ íŒŒì¼ ì‚­ì œ
        if (attachmentId) {
            $.ajax({
                url: `/cp/api/cleanup-temp-upload/${attachmentId}/`,
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function() {
                    console.log(`ì„ì‹œ ì´ë¯¸ì§€ ${attachmentId} ì‚­ì œ ì™„ë£Œ`);
                },
                error: function(xhr) {
                    console.error(`ì„ì‹œ ì´ë¯¸ì§€ ${attachmentId} ì‚­ì œ ì‹¤íŒ¨:`, xhr);
                }
            });
        }
    });
    
    // ì„ì‹œ ì—…ë¡œë“œ ëª©ë¡ ì´ˆê¸°í™”
    temporaryUploads = [];
    
    // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updatePreview();
}

// ========== í¸ì§‘ ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤ ==========

/**
 * í¸ì§‘ ì»¨íŠ¸ë¡¤ UI ì—…ë°ì´íŠ¸
 */
function updateEditControls() {
    const changedTexts = $('.text-changed').length;
    const changedImages = $('.editable-image[data-changed="true"]').length;
    const totalChanges = changedTexts + changedImages;
    
    if (totalChanges > 0) {
        $('#editControls').removeClass('hidden');
    } else {
        $('#editControls').addClass('hidden');
    }
}

/**
 * ëª¨ë“  ë³€ê²½ì‚¬í•­ ì´ˆê¸°í™”
 */
function resetAllChanges() {
    if (confirm('ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        // í…ìŠ¤íŠ¸ ë³€ê²½ì‚¬í•­ ì·¨ì†Œ
        $('.text-changed').each(function() {
            const $changed = $(this);
            const original = $changed.data('original');
            const wordId = $changed.data('word-id');
            
            const $original = $(`<span class="editable-word" 
                data-word-id="${wordId}" 
                data-original="${original}"
                title="ë”ë¸”í´ë¦­í•˜ì—¬ í¸ì§‘">${original}</span>`);
            $changed.replaceWith($original);
        });
        
        // ì´ë¯¸ì§€ ë³€ê²½ì‚¬í•­ ì·¨ì†Œ
        cancelImageChanges();
        
        // HTML ì—ë””í„°ë¥¼ ì›ë³¸ìœ¼ë¡œ ë³µì›
        if (originalHtmlContent) {
            htmlEditorInstance.setValue(originalHtmlContent);
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        updatePreview();
        
        showToast('ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }
}

/**
 * ë³€ê²½ëœ ìš”ì†Œë“¤ ê°•ì¡° í‘œì‹œ
 */
function showChangedElements() {
    const $changedElements = $('.text-changed, .editable-image[data-changed="true"]');
    
    if ($changedElements.length === 0) {
        showToast('ë³€ê²½ëœ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
        return;
    }
    
    // ê¸°ì¡´ ê°•ì¡° ì œê±°
    $('.highlight-changed').removeClass('highlight-changed');
    
    // ë³€ê²½ëœ ìš”ì†Œë“¤ ê°•ì¡°
    $changedElements.addClass('highlight-changed').css({
        'animation': 'pulse 1s infinite',
        'background-color': '#fef3c7'
    });
    
    // 2ì´ˆ í›„ ê°•ì¡° ì œê±°
    setTimeout(() => {
        $('.highlight-changed').removeClass('highlight-changed').css({
            'animation': '',
            'background-color': ''
        });
    }, 2000);
    
    showToast(`${$changedElements.length}ê°œì˜ ë³€ê²½ëœ ìš”ì†Œë¥¼ ê°•ì¡° í‘œì‹œí–ˆìŠµë‹ˆë‹¤`, 'success');
}

// ========== ê¸°ì¡´ í•¨ìˆ˜ë“¤ ìˆ˜ì • ==========

// ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updatePreview() {
    const html = htmlEditorInstance.getValue();
    
    // ë Œë”ë§ íƒ­ ì—…ë°ì´íŠ¸
    $('#previewContent').html(html);
    
    // í…ìŠ¤íŠ¸ í¸ì§‘ íƒ­ ì—…ë°ì´íŠ¸
    updateEditableContent(html);
    
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    setTimeout(() => {
        bindTextEditingEvents();
    }, 50);
}

// HTML í¸ì§‘ê¸°ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updatePreviewFromHtml() {
    const html = htmlEditorInstance.getValue();
    $('#previewContent').html(html);
    updateEditableContent(html);
}

// ë³€ê²½ëœ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì´ˆê¸°í™”
function resetTextColors() {
    $('.text-changed').removeClass('text-changed').css('color', '');
    $('.editable-word[data-changed="true"]').removeAttr('data-changed');
    $('.editable-image[data-changed="true"]').removeAttr('data-changed');
    console.log('í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì´ˆê¸°í™” ì™„ë£Œ');
}

// ê°œì„ ëœ ì½˜í…ì¸  ì €ì¥ í•¨ìˆ˜
function saveContent() {
    console.log('=== ì½˜í…ì¸  ì €ì¥ ì‹œì‘ ===');
    
    // 1. ì €ì¥ ì „ ì´ë¯¸ì§€ ìë™ ê²€ì¦ ë° ì •ë¦¬
    validateAndCleanupBeforeSave();
    
    // 2. ë³€ê²½ëœ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì´ˆê¸°í™”
    resetTextColors();
    
    // 3. HTML ì—ë””í„°ì˜ ë‚´ìš©ì„ ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
    updatePreviewFromHtml();
    
    const formData = {
        title: $('#title').val(),
        content_type: $('#content_type').val(),
        page: htmlEditorInstance.getValue(),
        answer: answerEditor.getValue(),
        meta_data: metaEditor.getValue(),
        tags: tagsEditor.getValue(),
        prompt: $('#prompt_content').val()
    };
    
    console.log('ì €ì¥í•  ë°ì´í„°:', {
        title: formData.title,
        content_type: formData.content_type,
        page_length: formData.page.length,
        has_answer: !!formData.answer,
        has_prompt: !!formData.prompt
    });
    
    if (!formData.title || !formData.content_type || !formData.page) {
        alert('ì œëª©, ì»¨í…ì¸  íƒ€ì…, í˜ì´ì§€ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    // ì €ì¥ ì „ ìµœì¢… ì´ë¯¸ì§€ src ê²€ì¦
    const finalValidation = validateAllImages();
    if (finalValidation.corrupted > 0) {
        console.warn('ì—¬ì „íˆ ì†ìƒëœ ì´ë¯¸ì§€ê°€ ìˆìŠµë‹ˆë‹¤:', finalValidation.corrupted);
        if (!confirm('ì¼ë¶€ ì´ë¯¸ì§€ ê²½ë¡œì— ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì† ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }
    }
    
    // ë¡œë”© í‘œì‹œ
    const $saveBtn = $('button[onclick="saveContent()"]');
    const originalText = $saveBtn.html();
    $saveBtn.html('<i class="fas fa-spinner fa-spin mr-2"></i>ì €ì¥ ì¤‘...').prop('disabled', true);
    
    $.ajax({
        url: currentContent ? `/cp/api/contents/${currentContent.id}/update/` : '/cp/api/contents/create/',
        method: currentContent ? 'PUT' : 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            console.log('ì½˜í…ì¸  ì €ì¥ ì„±ê³µ:', data);
            
            // ì €ì¥ ì™„ë£Œ í›„ ë²„íŠ¼ ë³µì›
            $saveBtn.html(originalText).prop('disabled', false);
            
            showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            currentContent = data;
            
            // ì„ì‹œ ì—…ë¡œë“œ ëª©ë¡ ì´ˆê¸°í™” (ì €ì¥ë˜ì—ˆìœ¼ë¯€ë¡œ)
            temporaryUploads = [];
            
            // ë³€ê²½ëœ ëª¨ë“  ìš”ì†Œì˜ í‘œì‹œ ì œê±°
            $('[data-changed="true"]').removeAttr('data-changed');
            
            // í¸ì§‘ ì»¨íŠ¸ë¡¤ ì—…ë°ì´íŠ¸
            updateEditControls();
            
            // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
            searchContents();
            
            // ì €ì¥ í›„ ë‹¤ì‹œ í•œ ë²ˆ ì´ë¯¸ì§€ ê²€ì¦ (ì„ íƒì‚¬í•­)
            setTimeout(() => {
                const postSaveValidation = validateAllImages();
                if (postSaveValidation.corrupted === 0 && postSaveValidation.missing === 0) {
                    console.log('ì €ì¥ í›„ ê²€ì¦: ëª¨ë“  ì´ë¯¸ì§€ ì •ìƒ');
                } else {
                    console.warn('ì €ì¥ í›„ ê²€ì¦: ì¼ë¶€ ì´ë¯¸ì§€ ë¬¸ì œ ìˆìŒ', postSaveValidation);
                }
            }, 1000);
        },
        error: function(xhr) {
            console.error('ì½˜í…ì¸  ì €ì¥ ì‹¤íŒ¨:', xhr);
            
            // ì—ëŸ¬ ì‹œ ë²„íŠ¼ ë³µì›
            $saveBtn.html(originalText).prop('disabled', false);
            
            let errorMsg = 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.error) {
                    errorMsg = response.error;
                }
            } catch (e) {
                console.error('ì—ëŸ¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', e);
            }
            
            showToast(errorMsg, 'error');
            alert(errorMsg);
        }
    });
}

// ========== í…œí”Œë¦¿ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========

function openTemplateModal() {
    $('#templateModal').removeClass('hidden');
    
    // í¼ ì´ˆê¸°í™”
    $('#templateForm')[0].reset();
    $('#templateFormCategory').val('');
    $('#templateFormType').val('');
    $('#templateName').val('');
    $('#templateHtml').val('');
    $('#templateAnswer').val('{}');
    $('#templateMeta').val('{}');
    $('#templateJs').val('');
}

function closeTemplateModal() {
    $('#templateModal').addClass('hidden');
}

function testTemplate() {
    const html = $('#templateHtml').val();
    const js = $('#templateJs').val();
    
    $('#previewContent').html(html);
    
    if (js && js.trim()) {
        try {
            // JavaScript ì½”ë“œ ì‹¤í–‰ (ì•ˆì „í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜)
            eval(js);
        } catch (e) {
            console.error('JavaScript ì‹¤í–‰ ì˜¤ë¥˜:', e);
            showToast('JavaScript ì½”ë“œì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤: ' + e.message, 'error');
        }
    }
    
    switchPreviewTab('render');
    showToast('í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

function saveTemplate() {
    console.log('=== í…œí”Œë¦¿ ì €ì¥ ì‹œì‘ ===');
    
    // í¼ ë°ì´í„° ìˆ˜ì§‘
    const formData = {
        title: $('#templateName').val().trim(),
        content_category: $('#templateFormCategory').val(),
        content_type: $('#templateFormType').val(),
        page: $('#templateHtml').val(),
        answer: $('#templateAnswer').val(),
        meta_data: $('#templateMeta').val(),
        tags: $('#templateJs').val(), // JavaScript ì½”ë“œ
        is_public: true
    };
    
    console.log('ì „ì†¡í•  ë°ì´í„°:', formData);
    
    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!formData.title) {
        showToast('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
        $('#templateName').focus();
        return;
    }
    
    if (!formData.content_category) {
        showToast('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
        $('#templateFormCategory').focus();
        return;
    }
    
    if (!formData.content_type) {
        showToast('íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”', 'error');
        $('#templateFormType').focus();
        return;
    }
    
    // JSON í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬
    try {
        // answer í•„ë“œ ê²€ì¦
        const answerText = formData.answer.trim();
        if (answerText && answerText !== '{}') {
            if (answerText.startsWith('{')) {
                JSON.parse(answerText); // JSON í˜•ì‹ ê²€ì¦
            }
        }
        
        // meta_data í•„ë“œ ê²€ì¦
        const metaText = formData.meta_data.trim();
        if (metaText && metaText !== '{}') {
            JSON.parse(metaText); // JSON í˜•ì‹ ê²€ì¦
        }
    } catch (e) {
        showToast('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ' + e.message, 'error');
        return;
    }
    
    // ì €ì¥ ë²„íŠ¼ ë¡œë”© ìƒíƒœ
    const $saveBtn = $('button[onclick="saveTemplate()"]');
    const originalText = $saveBtn.html();
    $saveBtn.html('<i class="fas fa-spinner fa-spin mr-2"></i>ì €ì¥ ì¤‘...').prop('disabled', true);
    
    $.ajax({
        url: '/cp/api/templates/create/',
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            console.log('í…œí”Œë¦¿ ì €ì¥ ì„±ê³µ:', data);
            
            // ë²„íŠ¼ ë³µì›
            $saveBtn.html(originalText).prop('disabled', false);
            
            showToast('í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            closeTemplateModal();
            
            // í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
            searchTemplates();
        },
        error: function(xhr) {
            console.error('í…œí”Œë¦¿ ì €ì¥ ì‹¤íŒ¨:', xhr);
            
            // ë²„íŠ¼ ë³µì›
            $saveBtn.html(originalText).prop('disabled', false);
            
            let errorMsg = 'í…œí”Œë¦¿ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.error) {
                    errorMsg = response.error;
                }
            } catch (e) {
                console.error('ì—ëŸ¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', e);
            }
            
            showToast(errorMsg, 'error');
            alert(errorMsg);
        }
    });
}

// í…œí”Œë¦¿ í¼ì˜ ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸
function bindTemplateEvents() {
    // í…œí”Œë¦¿ í¼ ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ
    $('#templateFormCategory').off('change.template').on('change.template', function() {
        const categoryId = $(this).val();
        const $typeSelect = $('#templateFormType');
        
        if (categoryId) {
            $.get(`/cp/api/content-types/?category=${categoryId}`, function(data) {
                $typeSelect.empty().append('<option value="">íƒ€ì… ì„ íƒ</option>');
                data.forEach(type => {
                    $typeSelect.append(`<option value="${type.id}">${type.type_name}</option>`);
                });
                $typeSelect.prop('disabled', false);
            }).fail(function() {
                console.error('ì¹´í…Œê³ ë¦¬ë³„ íƒ€ì… ë¡œë“œ ì‹¤íŒ¨');
                $typeSelect.empty().append('<option value="">íƒ€ì… ë¡œë“œ ì‹¤íŒ¨</option>');
            });
        } else {
            $typeSelect.empty().append('<option value="">íƒ€ì… ì„ íƒ</option>');
            $typeSelect.prop('disabled', true);
        }
    });
    
    // í…œí”Œë¦¿ ê²€ìƒ‰ ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ
    $('#templateCategory').off('change.templateSearch').on('change.templateSearch', function() {
        const categoryId = $(this).val();
        const $typeSelect = $('#templateType');
        
        if (categoryId) {
            $.get(`/cp/api/content-types/?category=${categoryId}`, function(data) {
                $typeSelect.empty().append('<option value="">íƒ€ì… ì„ íƒ</option>');
                data.forEach(type => {
                    $typeSelect.append(`<option value="${type.id}">${type.type_name}</option>`);
                });
            });
        } else {
            loadAllContentTypes(); // ì „ì²´ íƒ€ì… ë¡œë“œ
        }
        
        // ê²€ìƒ‰ ì‹¤í–‰
        searchTemplates();
    });
    
    $('#templateType').off('change.templateSearch').on('change.templateSearch', function() {
        searchTemplates();
    });
    
    // í…œí”Œë¦¿ ê²€ìƒ‰ì–´ ì—”í„°í‚¤
    $('#templateSearch').off('keypress.templateSearch').on('keypress.templateSearch', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            searchTemplates();
        }
    });
}

// ========== ì—ë””í„° ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ ==========

function initializeEditors() {
    // ë‹µì•ˆ ì…ë ¥ JSON ì—ë””í„°
    answerInputEditor = CodeMirror(document.getElementById('answerInputEditor'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    answerInputEditor.setSize(null, 200);
    answerInputEditor.on('change', function() {
        $('#answer_input').val(answerInputEditor.getValue());
    });
    
    // ë©”íƒ€ë°ì´í„° JSON ì—ë””í„°
    metaEditor = CodeMirror(document.getElementById('metaEditor'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    metaEditor.setSize(null, 150);
    metaEditor.on('change', function() {
        $('#meta_content').val(metaEditor.getValue());
    });
    
    // íƒœê·¸ JSON ì—ë””í„°
    tagsEditor = CodeMirror(document.getElementById('tagsEditor'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    tagsEditor.setSize(null, 150);
    tagsEditor.on('change', function() {
        $('#tags_content').val(tagsEditor.getValue());
    });
    
    // HTML í¸ì§‘ ì—ë””í„°
    htmlEditorInstance = CodeMirror(document.getElementById('htmlEditorContainer'), {
        mode: 'xml',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    htmlEditorInstance.setSize(null, '100%');
    htmlEditorInstance.on('change', function() {
        updatePreviewFromHtml();
    });
    
    // ì •ë‹µ JSON ì—ë””í„°
    answerEditor = CodeMirror(document.getElementById('answerEditorContainer'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    answerEditor.setSize(null, '100%');
}

// ========== ìˆ˜ì •ëœ ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜ ==========

function bindEvents() {
    console.log('=== ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹œì‘ ===');
    
    // ê¸°ì¡´ ì´ë²¤íŠ¸ ëª¨ë‘ ì œê±° (ì¤‘ë³µ ë°©ì§€)
    $('#contentCategory').off('change');
    $('#contentType').off('change');
    $('#contentCourse').off('change');
    $('#contentChapter').off('change');
    $('#contentSearch').off('keypress');
    $('#template_select').off('change'); // í…œí”Œë¦¿ ì´ë²¤íŠ¸ë„ ì´ˆê¸°í™”
    
    // contentCategory ì„ íƒ ì‹œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ íƒ€ì…ë§Œ í‘œì‹œ
    $('#contentCategory').on('change', function() {
        const categoryId = $(this).val();
        console.log('ì»¨í…ì¸  ì¹´í…Œê³ ë¦¬ ë³€ê²½:', categoryId);
        
        if (categoryId) {
            loadContentTypesByCategory(categoryId, ['#contentType', '#content_type']);
        } else {
            loadAllContentTypes();
        }
        
        $('#contentType').val('');
        searchContents();
    });
    
    // contentType ë³€ê²½ ì‹œ ê²€ìƒ‰
    $('#contentType').on('change', function() {
        console.log('ì»¨í…ì¸  íƒ€ì… ë³€ê²½:', $(this).val());
        searchContents();
    });
    
    // ì½”ìŠ¤ ì„ íƒ ì‹œ ì±•í„° ë¡œë“œ
    $('#contentCourse').on('change', function() {
        const courseId = $(this).val();
        const $chapterSelect = $('#contentChapter');
        
        console.log('ì½”ìŠ¤ ë³€ê²½:', courseId);
        
        if (courseId) {
            // ë¡œë”© í‘œì‹œ
            $chapterSelect.html('<option value="">ë¡œë”© ì¤‘...</option>').prop('disabled', true);
            
            $.get(`/cp/api/courses/${courseId}/chapters/`, function(data) {
                console.log('ì±•í„° ë¡œë“œ ì™„ë£Œ:', data);
                
                $chapterSelect.empty().append('<option value="">ëŒ€ë‹¨ì› ì„ íƒ</option>');
                data.forEach(chapter => {
                    $chapterSelect.append(`<option value="${chapter.id}">${chapter.chapter_title}</option>`);
                });
                $chapterSelect.prop('disabled', false);
                
                // ì±•í„° ë³€ê²½ ì´ë²¤íŠ¸ë„ ë‹¤ì‹œ ë°”ì¸ë”©
                bindChapterChangeEvent();
                
            }).fail(function(xhr) {
                console.error('ì±•í„° ë¡œë“œ ì‹¤íŒ¨:', xhr);
                $chapterSelect.html('<option value="">ì±•í„° ë¡œë“œ ì‹¤íŒ¨</option>');
                showToast('ì±•í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            });
        } else {
            $chapterSelect.empty().append('<option value="">ëŒ€ë‹¨ì› ì„ íƒ</option>');
            $chapterSelect.prop('disabled', true);
        }
        
        // ì½”ìŠ¤ ë³€ê²½ ì‹œì—ë„ ê²€ìƒ‰ ì‹¤í–‰
        searchContents();
    });
    
    // ì±•í„° ë³€ê²½ ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜
    function bindChapterChangeEvent() {
        $('#contentChapter').off('change.chapter').on('change.chapter', function() {
            console.log('ì±•í„° ë³€ê²½:', $(this).val(), $(this).find('option:selected').text());
            searchContents();
        });
    }
    
    // ì´ˆê¸° ì±•í„° ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bindChapterChangeEvent();
    
    // í…œí”Œë¦¿ ì„ íƒ ì‹œ ë‚´ìš© ì ìš© (ìˆ˜ì •ë¨ - ì¬ê·€ ë°©ì§€)
    $('#template_select').on('change.templateSelect', function() {
        const templateId = $(this).val();
        console.log('í…œí”Œë¦¿ select ë³€ê²½:', templateId);
        
        if (templateId) {
            // ì§ì ‘ í…œí”Œë¦¿ ì ìš© (selectTemplate í•¨ìˆ˜ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ)
            applyTemplateData(templateId);
        }
    });
    
    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ë²¤íŠ¸
    $('#imageUpload').off('change.imageUpload').on('change.imageUpload', function(e) {
        const file = e.target.files[0];
        console.log('ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ:', file?.name);
        
        if (file && currentEditingImage) {
            uploadImage(file, currentEditingImage);
        }
        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        $(this).val('');
    });
    
    // í…œí”Œë¦¿ ê´€ë ¨ ì´ë²¤íŠ¸
    bindTemplateEvents();
    
    // ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
    $('#contentSearch').on('keypress.contentSearch', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            searchContents();
        }
    });
    
    // ì´ˆê¸° ì„¤ì •
    $('#contentChapter').prop('disabled', true);
    $('#templateFormType').prop('disabled', true);
    
    // í…ìŠ¤íŠ¸ í¸ì§‘ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bindTextEditingEvents();
    
    console.log('=== ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ ===');
}

// ìƒˆ ì½˜í…ì¸  ìƒì„± ì‹œ ì´ˆê¸°í™”
function createNewContent() {
    // ì„ì‹œ íŒŒì¼ ì •ë¦¬
    if (temporaryUploads.length > 0) {
        cleanupTemporaryUploads();
    }
    
    // ì´ë¯¸ì§€ ë³€ê²½ì‚¬í•­ ì·¨ì†Œ
    cancelImageChanges();
    
    // í¼ ì´ˆê¸°í™”
    $('#title').val('');
    $('#content_type').val('');
    $('#template_select').val('');
    $('#prompt_content').val('');
    
    // ì—ë””í„° ì´ˆê¸°í™”
    answerInputEditor.setValue('{}');
    answerEditor.setValue('{}');
    metaEditor.setValue('{}');
    tagsEditor.setValue('{}');
    htmlEditorInstance.setValue('');
    
    // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
    $('#previewContent').html(`
        <div class="text-center text-gray-400 py-8">
            <i class="fas fa-eye text-6xl mb-4"></i>
            <p>AIë¡œ ë¬¸í•­ì„ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
        </div>
    `);
    
    $('#editableContent').html(`
        <p class="text-gray-400 text-center py-8">
            <i class="fas fa-edit text-4xl mb-2 block"></i>
            AIë¡œ ë¬¸í•­ì„ ìƒì„±í•˜ë©´ í¸ì§‘ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
        </p>
    `);
    
    // í˜„ì¬ ì½˜í…ì¸  ì´ˆê¸°í™”
    currentContent = null;
    
    // í¸ì§‘ ì»¨íŠ¸ë¡¤ ì—…ë°ì´íŠ¸
    updateEditControls();
    
    showToast('ìƒˆ ì½˜í…ì¸  ì‘ì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤.', 'success');
}

// ========== ì´ˆê¸°í™” í•¨ìˆ˜ ==========

$(document).ready(function() {
    console.log('CP Agent ì´ˆê¸°í™” ì‹œì‘...');
    
    try {
        // íƒ­ ì´ˆê¸°í™”
        switchTab('contents');
        switchPreviewTab('render');
        console.log('íƒ­ ì´ˆê¸°í™” ì™„ë£Œ');
        
        // ì—ë””í„° ì´ˆê¸°í™”
        initializeEditors();
        console.log('ì—ë””í„° ì´ˆê¸°í™” ì™„ë£Œ');
        
        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindEvents();
        console.log('ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadInitialData();
        console.log('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        
        // í˜ì´ì§€ ì´íƒˆ ì‹œ ì„ì‹œ íŒŒì¼ ì •ë¦¬
        $(window).on('beforeunload', function() {
            if (temporaryUploads.length > 0) {
                cleanupTemporaryUploads();
            }
        });
        
        console.log('CP Agent ì´ˆê¸°í™” ì™„ë£Œ!');
        
        // ë””ë²„ê¹…ì„ ìœ„í•œ ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.testEvents = function() {
            console.log('=== ì´ë²¤íŠ¸ ë™ì‘ í…ŒìŠ¤íŠ¸ ===');
            
            // ê° ìš”ì†Œì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í™•ì¸
            const elements = [
                '#contentCategory',
                '#contentType', 
                '#contentCourse',
                '#contentChapter',
                '#contentSearch'
            ];
            
            elements.forEach(selector => {
                const $el = $(selector);
                const events = $._data($el[0], 'events');
                console.log(`${selector} ì´ë²¤íŠ¸:`, events);
            });
            
            // ê°•ì œë¡œ ì±•í„° ë³€ê²½ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
            console.log('ì±•í„° ë³€ê²½ ì´ë²¤íŠ¸ ê°•ì œ íŠ¸ë¦¬ê±°...');
            $('#contentChapter').trigger('change');
        };
        
        window.searchContents = searchContents;
        
        console.log('ë””ë²„ê¹… í•¨ìˆ˜ ë“±ë¡ ì™„ë£Œ. testEvents() í•¨ìˆ˜ë¡œ ì´ë²¤íŠ¸ ìƒíƒœ í™•ì¸ ê°€ëŠ¥');
        
    } catch (error) {
        console.error('CP Agent ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        showToast('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
});
</script>
{% endblock %}