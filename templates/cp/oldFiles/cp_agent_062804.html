{% extends 'teacher/base.html' %}
{% load static %}

{% block title %}AI ë¬¸í•­ ìƒì„±ê¸°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<style>
    .CodeMirror {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        height: auto;
        background-color: #f9fafb;
    }
    
    .CodeMirror-focused {
        background-color: #ffffff;
    }
    
    .panel {
        transition: all 0.3s ease;
    }
    
    .panel-collapsed {
        width: 0 !important;
        overflow: hidden;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0;
    }
    
    .editable-word {
        cursor: pointer;
        transition: background-color 0.2s;
        display: inline;
        padding: 2px 4px;
        border-radius: 3px;
        margin: 1px;
        border: 1px solid transparent;
    }
    
    .editable-word:hover {
        background-color: #dbeafe;
        border-color: #93c5fd;
    }
    
    .editing-word {
        background-color: #fef3c7;
        border-color: #f59e0b;
    }
    
    .edit-input {
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
        background-color: #fffbeb;
        border: 2px solid #f59e0b;
        outline: none;
        border-radius: 4px;
        padding: 2px 6px;
    }
    
    .edit-input:focus {
        background-color: #ffffff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .editable-image {
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s;
        border-radius: 4px;
    }
    
    .editable-image:hover {
        border-color: #3b82f6;
    }
    
    /* íƒ­ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ ìˆ˜ì • */
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .preview-tab-content {
        display: none;
    }
    
    .preview-tab-content.active {
        display: block !important;
    }
    
    .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #6b7280;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* ëª¨ë˜í•œ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f3f4f6;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }
    
    /* í•„í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .filter-section {
        background-color: #f9fafb;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    /* ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ */
    .accordion-header {
        cursor: pointer;
        user-select: none;
    }
    
    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    
    .accordion-content.active {
        max-height: 500px;
        transition: max-height 0.3s ease-in;
    }
    
    /* Markdown ìŠ¤íƒ€ì¼ */
    .markdown-preview {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        min-height: 200px;
    }
    
    /* í¸ì§‘ ë„ì›€ë§ ìŠ¤íƒ€ì¼ */
    .edit-help {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
    }
    
    .edit-help i {
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50 gap-6">
    <!-- ì¢Œì¸¡ íŒ¨ë„ (1/3) -->
    <div id="leftPanel" class="w-1/3 bg-white border border-gray-300 panel overflow-hidden flex flex-col rounded shadow-sm">
        <div class="px-4 py-2.5 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-medium text-gray-800">ğŸ‡ ë¬¸í•­ & í…œí”Œë¦¿</h2>
            <button onclick="togglePanel('left')" class="text-gray-600 hover:text-white hover:bg-orange-400 p-2 rounded transition">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto">
            <!-- íƒ­ ë©”ë‰´ -->
            <div class="flex border-b border-gray-200 bg-gray-50">
                <button onclick="switchTab('contents')" class="tab-btn flex-1 py-3 px-4 text-center text-gray-700 hover:bg-white transition border-b-2 border-orange-400 bg-white" data-tab="contents">
                    ë¬¸í•­ ë¦¬ìŠ¤íŠ¸
                </button>
                <button onclick="switchTab('templates')" class="tab-btn flex-1 py-3 px-4 text-center text-gray-600 hover:bg-white transition border-b-2 border-transparent" data-tab="templates">
                    í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸
                </button>
            </div>
            
            <!-- ë¬¸í•­ ë¦¬ìŠ¤íŠ¸ íƒ­ -->
            <div id="contentsTab" class="tab-content active p-4">
                <!-- ê²€ìƒ‰ í•„í„° -->
                <div class="filter-section">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <select id="contentCategory" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        </select>
                        
                        <select id="contentType" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">íƒ€ì… ì„ íƒ</option>
                        </select>
                        
                        <select id="contentCourse" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ì½”ìŠ¤ ì„ íƒ</option>
                        </select>
                        
                        <select id="contentChapter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ëŒ€ë‹¨ì› ì„ íƒ</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-2">
                        <input type="text" id="contentSearch" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰..." 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400">
                        <button onclick="searchContents()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="mt-3 text-sm text-gray-600">
                        ê²€ìƒ‰ ê²°ê³¼: <span id="contentsCount" class="font-semibold">0</span>ê°œ
                    </div>
                </div>
                
                <!-- ë¬¸í•­ ë¦¬ìŠ¤íŠ¸ -->
                <div id="contentsList" class="space-y-2">
                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                </div>
            </div>
            
            <!-- í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸ íƒ­ -->
            <div id="templatesTab" class="tab-content p-4">
                <!-- í…œí”Œë¦¿ ë§Œë“¤ê¸° ë²„íŠ¼ -->
                <button onclick="openTemplateModal()" class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg hover:bg-gray-800 transition mb-4">
                    <i class="fas fa-plus mr-2"></i>í…œí”Œë¦¿ ë§Œë“¤ê¸°
                </button>
                
                <!-- ê²€ìƒ‰ í•„í„° -->
                <div class="filter-section">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <select id="templateCategory" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        </select>
                        
                        <select id="templateType" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">íƒ€ì… ì„ íƒ</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-2">
                        <input type="text" id="templateSearch" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰..." 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400">
                        <button onclick="searchTemplates()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="mt-3 text-sm text-gray-600">
                        ê²€ìƒ‰ ê²°ê³¼: <span id="templatesCount" class="font-semibold">0</span>ê°œ
                    </div>
                </div>
                
                <!-- í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸ -->
                <div id="templatesList" class="space-y-2">
                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œë¨ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì¢Œì¸¡ íŒ¨ë„ í† ê¸€ ë²„íŠ¼ (ìˆ¨ê¹€ ìƒíƒœì¼ ë•Œ) -->
    <button id="leftToggleBtn" onclick="togglePanel('left')" class="bg-gray-600 hover:bg-orange-400 text-white p-2 rounded-r transition fixed left-0 top-1/2 transform -translate-y-1/2 z-10" style="display: none;">
        <i class="fas fa-chevron-right"></i>
    </button>
    
    <!-- ì¤‘ê°„ íŒ¨ë„ (1/3) -->
    <div id="middlePanel" class="w-1/3 bg-white border border-gray-300 panel overflow-hidden flex flex-col rounded shadow-sm">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-800">âœ¨ ë¬¸í•­ ì œì‘</h2>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
            <form id="contentForm">
                <!-- ê¸°ë³¸ ì •ë³´ (í•œ ì¤„ ë°°ì¹˜) -->
                <div class="mb-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">ì œëª© *</label>
                        <input type="text" id="title" name="title" required
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">íƒ€ì… *</label>
                        <select id="content_type" name="content_type" required
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">í…œí”Œë¦¿</label>
                        <select id="template_select" name="template_select"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">í…œí”Œë¦¿ ì—†ìŒ</option>
                        </select>
                    </div>
                </div>
                
                <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë¬¸í•­ ìƒì„± ì§€ì‹œì‚¬í•­ (Markdown ì§€ì›)</label>
                    <textarea id="prompt_content" name="prompt" rows="20" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm"
                              placeholder="ë¬¸í•­ ìƒì„±ì„ ìœ„í•œ ìƒì„¸í•œ ì§€ì‹œì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
                
                <!-- ë‹µì•ˆ ì…ë ¥ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë‹µì•ˆ (JSON)</label>
                    <textarea id="answer_input" name="answer_input" class="hidden">{}</textarea>
                    <div id="answerInputEditor"></div>
                </div>
                
                <!-- ì•„ì½”ë””ì–¸ ì„¹ì…˜ -->
                <div class="mb-6">
                    <div class="accordion-header flex items-center justify-between p-3 bg-gray-100 rounded-lg cursor-pointer" onclick="toggleAccordion(this)">
                        <span class="text-sm font-medium text-gray-700">ê³ ê¸‰ ì„¤ì •</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                    </div>
                    <div class="accordion-content">
                        <div class="pt-4 space-y-4">
                            <!-- ë©”íƒ€ë°ì´í„° -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ë©”íƒ€ë°ì´í„° (JSON)</label>
                                <textarea id="meta_content" name="meta_data" class="hidden">{}</textarea>
                                <div id="metaEditor"></div>
                            </div>
                            
                            <!-- íƒœê·¸ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">íƒœê·¸/í‰ê°€ê¸°ì¤€ (JSON)</label>
                                <textarea id="tags_content" name="tags" class="hidden">{}</textarea>
                                <div id="tagsEditor"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI ìš”ì²­ ë²„íŠ¼ -->
                <button type="button" onclick="requestAI()" 
                        class="w-full bg-gradient-to-r from-gray-600 to-gray-700 text-white py-3 px-4 rounded-lg hover:from-gray-700 hover:to-gray-800 transition duration-200 font-medium shadow-sm">
                    <i class="fas fa-magic mr-2"></i>AIë¡œ ë¬¸í•­ ìƒì„±í•˜ê¸°
                </button>
            </form>
        </div>
    </div>
    
    <!-- ìš°ì¸¡ íŒ¨ë„ (1/3) -->
    <div id="rightPanel" class="w-1/3 bg-white border border-gray-300 panel overflow-hidden flex flex-col rounded shadow-sm">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-800">ğŸŠ ë¯¸ë¦¬ë³´ê¸° & í¸ì§‘</h2>
        </div>
        
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="flex border-b border-gray-200 bg-gray-50">
            <button onclick="switchPreviewTab('render')" class="preview-tab-btn flex-1 py-3 px-4 text-center text-gray-700 hover:bg-white transition border-b-2 border-gray-600 bg-white" data-tab="render">
                ë Œë”ë§
            </button>
            <button onclick="switchPreviewTab('html')" class="preview-tab-btn flex-1 py-3 px-4 text-center text-gray-600 hover:bg-white transition border-b-2 border-transparent" data-tab="html">
                HTML
            </button>
            <button onclick="switchPreviewTab('text')" class="preview-tab-btn flex-1 py-3 px-4 text-center text-gray-600 hover:bg-white transition border-b-2 border-transparent" data-tab="text">
                í…ìŠ¤íŠ¸ í¸ì§‘
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto bg-gray-50">
            <!-- ë Œë”ë§ íƒ­ -->
            <div id="renderTab" class="preview-tab-content active p-6">
                <div id="previewContent" class="prose max-w-none">
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-eye text-6xl mb-4"></i>
                        <p>AIë¡œ ë¬¸í•­ì„ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
            
            <!-- HTML íƒ­ -->
            <div id="htmlTab" class="preview-tab-content h-full flex flex-col">
                <div class="flex-1" style="height: 80%;">
                    <textarea id="htmlEditor" class="hidden"></textarea>
                    <div id="htmlEditorContainer" class="h-full"></div>
                </div>
                <div style="height: 20%;" class="border-t border-gray-200">
                    <div class="p-2 bg-gray-100">
                        <label class="text-sm font-medium text-gray-700">ì •ë‹µ (JSON)</label>
                    </div>
                    <div id="answerEditorContainer" class="h-full"></div>
                </div>
            </div>
            
            <!-- í…ìŠ¤íŠ¸ í¸ì§‘ íƒ­ -->
            <div id="textTab" class="preview-tab-content p-6">
                <div class="edit-help">
                    <i class="fas fa-lightbulb"></i>
                    <strong>í¸ì§‘ ê°€ì´ë“œ:</strong> 
                    í…ìŠ¤íŠ¸ë¥¼ ë”ë¸”í´ë¦­í•˜ì—¬ í¸ì§‘í•˜ê³  ì—”í„°í‚¤ë¡œ ì €ì¥í•˜ì„¸ìš”. 
                    ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ ìƒˆ ì´ë¯¸ì§€ë¡œ êµì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    <div class="mt-2 text-sm opacity-90">
                        <i class="fas fa-keyboard mr-1"></i>
                        ì—”í„°: ì €ì¥ | ESC: ì·¨ì†Œ | ë”ë¸”í´ë¦­: í¸ì§‘ ì‹œì‘
                    </div>
                </div>
                
                <!-- í¸ì§‘ ìƒíƒœ í‘œì‹œ -->
                <div id="editStatus" class="mb-4 p-2 bg-gray-100 rounded text-sm text-gray-600 hidden">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="editStatusText">í¸ì§‘ ê°€ëŠ¥í•œ ìš”ì†Œ: 0ê°œ</span>
                </div>
                
                <div id="editableContent" class="space-y-4 min-h-[200px] border border-gray-200 rounded-lg p-4 bg-white">
                    <p class="text-gray-400 text-center py-8">
                        <i class="fas fa-edit text-4xl mb-2 block"></i>
                        AIë¡œ ë¬¸í•­ì„ ìƒì„±í•˜ë©´ í¸ì§‘ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                    </p>
                </div>
                
                <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            </div>
        </div>
        
        <!-- ì €ì¥ ë²„íŠ¼ -->
        <div class="p-4 border-t border-gray-200 bg-white">
            <button onclick="saveContent()" 
                    class="w-full bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-200 font-medium shadow-sm">
                <i class="fas fa-save mr-2"></i>ì €ì¥í•˜ê¸°
            </button>
        </div>
    </div>
</div>

<!-- í…œí”Œë¦¿ ë§Œë“¤ê¸° ëª¨ë‹¬ -->
<div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="bg-gray-100 px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-800">í…œí”Œë¦¿ ë§Œë“¤ê¸°</h3>
                <button onclick="closeTemplateModal()" class="text-gray-500 hover:text-gray-700 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto bg-gray-50" style="max-height: calc(90vh - 120px);">
                <form id="templateForm">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì¹´í…Œê³ ë¦¬</label>
                            <select id="templateFormCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">íƒ€ì…</label>
                            <select id="templateFormType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">í…œí”Œë¦¿ ì´ë¦„</label>
                        <input type="text" id="templateName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">HTML í…œí”Œë¦¿</label>
                        <textarea id="templateHtml" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì •ë‹µ í…œí”Œë¦¿ (JSON)</label>
                        <textarea id="templateAnswer" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm">{}</textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë©”íƒ€ë°ì´í„° (JSON)</label>
                        <textarea id="templateMeta" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm">{}</textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">JavaScript (ì„ íƒì‚¬í•­)</label>
                        <textarea id="templateJs" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm"></textarea>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="testTemplate()" 
                                class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition">
                            <i class="fas fa-play mr-2"></i>ì‹¤í–‰í•´ë³´ê¸°
                        </button>
                        <button type="button" onclick="saveTemplate()" 
                                class="flex-1 bg-gray-700 text-white py-2 px-4 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-save mr-2"></i>ì €ì¥í•˜ê¸°
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ë¡œë”© ëª¨ë‹¬ -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg p-8 text-center shadow-xl">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-700">AIê°€ ë¬¸í•­ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>

<script>
// ì „ì—­ ë³€ìˆ˜
let metaEditor, tagsEditor, htmlEditorInstance, answerEditor, answerInputEditor;
let currentContent = null;
let templates = [];
let currentEditingImage = null;

// ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ==========

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ========== UI ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤ ==========

// íŒ¨ë„ í† ê¸€
function togglePanel(panel) {
    const $panel = $(`#${panel}Panel`);
    const $toggleBtn = $(`#${panel}ToggleBtn`);
    const $middlePanel = $('#middlePanel');
    const $rightPanel = $('#rightPanel');
    
    if ($panel.hasClass('panel-collapsed')) {
        // íŒ¨ë„ ì—´ê¸°
        $panel.removeClass('panel-collapsed');
        $toggleBtn.hide();
        $middlePanel.removeClass('w-1/2').addClass('w-1/3');
        $rightPanel.removeClass('w-1/2').addClass('w-1/3');
    } else {
        // íŒ¨ë„ ë‹«ê¸°
        $panel.addClass('panel-collapsed');
        $toggleBtn.show();
        $middlePanel.removeClass('w-1/3').addClass('w-1/2');
        $rightPanel.removeClass('w-1/3').addClass('w-1/2');
    }
}

// íƒ­ ì „í™˜
function switchTab(tab) {
    $('.tab-btn').removeClass('border-orange-400 bg-white text-gray-700').addClass('border-transparent text-gray-600');
    $(`.tab-btn[data-tab="${tab}"]`).removeClass('border-transparent text-gray-600').addClass('border-orange-400 bg-white text-gray-700');
    
    $('.tab-content').removeClass('active');
    $(`#${tab}Tab`).addClass('active');
}

function switchPreviewTab(tab) {
    console.log('íƒ­ ì „í™˜:', tab);
    
    // ëª¨ë“  íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
    $('.preview-tab-btn').removeClass('border-gray-600 bg-white text-gray-700').addClass('border-transparent text-gray-600');
    
    // ì„ íƒëœ íƒ­ ë²„íŠ¼ í™œì„±í™”
    $(`.preview-tab-btn[data-tab="${tab}"]`).removeClass('border-transparent text-gray-600').addClass('border-gray-600 bg-white text-gray-700');
    
    // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
    $('.preview-tab-content').removeClass('active').hide();
    
    // ì„ íƒëœ íƒ­ ì½˜í…ì¸  ë³´ì´ê¸°
    $(`#${tab}Tab`).addClass('active').show();
    
    // íŠ¹ë³„í•œ ê²½ìš° ì²˜ë¦¬
    if (tab === 'html' && htmlEditorInstance) {
        // HTML ì—ë””í„° ë¦¬í”„ë ˆì‹œ
        setTimeout(() => {
            htmlEditorInstance.refresh();
        }, 100);
    }
}

// ì•„ì½”ë””ì–¸ í† ê¸€
function toggleAccordion(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('i');
    
    content.classList.toggle('active');
    icon.classList.toggle('fa-chevron-down');
    icon.classList.toggle('fa-chevron-up');
}

// ========== ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤ ==========

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ
function loadInitialData() {
    // ì¹´í…Œê³ ë¦¬ ë¡œë“œ
    $.get('/cp/api/categories/', function(data) {
        const categorySelects = ['#contentCategory', '#templateCategory', '#templateFormCategory'];
        categorySelects.forEach(selector => {
            $(selector).empty().append('<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>');
            data.forEach(category => {
                $(selector).append(`<option value="${category.id}">${category.category_name}</option>`);
            });
        });
    }).fail(function() {
        console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
    });
    
    // ì´ˆê¸°ì—ëŠ” ëª¨ë“  ContentType ë¡œë“œ
    loadAllContentTypes();
    
    // ì½”ìŠ¤ ë¡œë“œ
    $.get('/cp/api/courses/', function(data) {
        $('#contentCourse').empty().append('<option value="">ì½”ìŠ¤ ì„ íƒ</option>');
        data.forEach(course => {
            $('#contentCourse').append(`<option value="${course.id}">${course.subject_name}</option>`);
        });
    }).fail(function() {
        console.error('ì½”ìŠ¤ ë¡œë“œ ì‹¤íŒ¨');
    });
    
    // ì´ˆê¸° ë¬¸í•­ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    searchContents();
    searchTemplates();
}

// ëª¨ë“  ì»¨í…ì¸  íƒ€ì… ë¡œë“œ í•¨ìˆ˜
function loadAllContentTypes() {
    $.get('/cp/api/content-types/', function(data) {
        const typeSelects = ['#content_type', '#contentType', '#templateType', '#templateFormType'];
        typeSelects.forEach(selector => {
            $(selector).empty().append('<option value="">íƒ€ì… ì„ íƒ</option>');
            data.forEach(type => {
                $(selector).append(`<option value="${type.id}">${type.type_name}</option>`);
            });
        });
    }).fail(function() {
        console.error('ì»¨í…ì¸  íƒ€ì… ë¡œë“œ ì‹¤íŒ¨');
    });
}

// ì¹´í…Œê³ ë¦¬ë³„ ì»¨í…ì¸  íƒ€ì… ë¡œë“œ í•¨ìˆ˜
function loadContentTypesByCategory(categoryId) {
    if (!categoryId) {
        loadAllContentTypes();
        return;
    }
    
    $.get(`/cp/api/content-types/?category=${categoryId}`, function(data) {
        // contentType select ì—…ë°ì´íŠ¸
        $('#contentType').empty().append('<option value="">íƒ€ì… ì„ íƒ</option>');
        data.forEach(type => {
            $('#contentType').append(`<option value="${type.id}">${type.type_name}</option>`);
        });
        
        // middlePanelì˜ content_typeë„ ì—…ë°ì´íŠ¸
        $('#content_type').empty().append('<option value="">ì„ íƒí•˜ì„¸ìš”</option>');
        data.forEach(type => {
            $('#content_type').append(`<option value="${type.id}">${type.type_name}</option>`);
        });
    }).fail(function() {
        console.error('ì»¨í…ì¸  íƒ€ì… ë¡œë“œ ì‹¤íŒ¨');
        loadAllContentTypes(); // ì‹¤íŒ¨ ì‹œ ì „ì²´ íƒ€ì… ë¡œë“œ
    });
}

// ========== ê²€ìƒ‰ í•¨ìˆ˜ë“¤ ==========

// ë¬¸í•­ ê²€ìƒ‰
function searchContents() {
    const params = {
        category: $('#contentCategory').val(),
        type: $('#contentType').val(),
        course: $('#contentCourse').val(),
        chapter: $('#contentChapter').val(),
        search: $('#contentSearch').val()
    };
    
    $.get('/cp/api/contents/search/', params, function(data) {
        const $list = $('#contentsList');
        $list.empty();
        
        $('#contentsCount').text(data.length);
        
        if (data.length === 0) {
            $list.append('<p class="text-gray-500 text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>');
            return;
        }
        
        data.forEach(content => {
            $list.append(`
                <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" onclick="loadContent(${content.id})">
                    <h4 class="font-medium text-gray-800">${content.title}</h4>
                    <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded mr-2">
                            ${content.content_type_name}
                        </span>
                        <span>${content.created_at}</span>
                    </div>
                </div>
            `);
        });
    }).fail(function() {
        console.error('ë¬¸í•­ ê²€ìƒ‰ ì‹¤íŒ¨');
    });
}

// í…œí”Œë¦¿ ê²€ìƒ‰
function searchTemplates() {
    const params = {
        category: $('#templateCategory').val(),
        type: $('#templateType').val(),
        search: $('#templateSearch').val()
    };
    
    $.get('/cp/api/templates/search/', params, function(data) {
        templates = data;
        const $list = $('#templatesList');
        const $select = $('#template_select');
        
        $list.empty();
        $select.empty().append('<option value="">í…œí”Œë¦¿ ì—†ìŒ</option>');
        
        $('#templatesCount').text(data.length);
        
        if (data.length === 0) {
            $list.append('<p class="text-gray-500 text-center py-4">í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</p>');
            return;
        }
        
        data.forEach(template => {
            // ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
            $list.append(`
                <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" onclick="selectTemplate(${template.id})">
                    <h4 class="font-medium text-gray-800">${template.title}</h4>
                    <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded mr-2">
                            ${template.content_type_name}
                        </span>
                        <span>${template.created_at}</span>
                    </div>
                </div>
            `);
            
            // ì„ íƒ ì˜µì…˜ì— ì¶”ê°€
            $select.append(`<option value="${template.id}">${template.title}</option>`);
        });
    }).fail(function() {
        console.error('í…œí”Œë¦¿ ê²€ìƒ‰ ì‹¤íŒ¨');
    });
}

// ========== ì»¨í…ì¸  ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========

// ë¬¸í•­ ë¡œë“œ
function loadContent(contentId) {
    $.get(`/cp/api/contents/${contentId}/`, function(data) {
        $('#title').val(data.title);
        $('#content_type').val(data.content_type);
        
        // í”„ë¡¬í”„íŠ¸ì™€ HTML êµ¬ë¶„í•˜ì—¬ ì²˜ë¦¬
        if (data.prompt) {
            $('#prompt_content').val(data.prompt);
        }
        
        // HTML ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸°ì— í‘œì‹œ
        if (data.page) {
            htmlEditorInstance.setValue(data.page);
            updatePreview(); // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        }
        
        // ë‹µì•ˆ ì„¤ì •
        answerInputEditor.setValue(data.answer || '{}');
        answerEditor.setValue(data.answer || '{}');
        
        // ë©”íƒ€ë°ì´í„°ì™€ íƒœê·¸ ì„¤ì •
        metaEditor.setValue(JSON.stringify(data.meta_data || {}, null, 2));
        tagsEditor.setValue(JSON.stringify(data.tags || {}, null, 2));
        
        currentContent = data;
    }).fail(function() {
        alert('ë¬¸í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// í…œí”Œë¦¿ ì„ íƒ
function selectTemplate(templateId) {
    $('#template_select').val(templateId).change();
}

// AI ìš”ì²­
function requestAI() {
    const formData = {
        title: $('#title').val(),
        content_type: $('#content_type').val(),
        template_id: $('#template_select').val(),
        prompt: $('#prompt_content').val(),
        answer_input: answerInputEditor.getValue(),
        meta_data: metaEditor.getValue(),
        tags: tagsEditor.getValue()
    };
    
    if (!formData.title || !formData.content_type) {
        alert('ì œëª©ê³¼ ì»¨í…ì¸  íƒ€ì…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    $('#loadingModal').removeClass('hidden');
    
    $.ajax({
        url: '/cp/api/generate-content/',
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            htmlEditorInstance.setValue(data.page || '');
            answerEditor.setValue(data.answer || '');
            metaEditor.setValue(data.meta_data || '{}');
            tagsEditor.setValue(data.tags || '{}');
            
            updatePreview();
            $('#loadingModal').addClass('hidden');
        },
        error: function(xhr) {
            alert('AI ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            $('#loadingModal').addClass('hidden');
        }
    });
}

// ì½˜í…ì¸  ì €ì¥
function saveContent() {
    const formData = {
        title: $('#title').val(),
        content_type: $('#content_type').val(),
        page: htmlEditorInstance.getValue(),
        answer: answerEditor.getValue(),
        meta_data: metaEditor.getValue(),
        tags: tagsEditor.getValue(),
        prompt: $('#prompt_content').val()
    };
    
    if (!formData.title || !formData.content_type || !formData.page) {
        alert('ì œëª©, ì»¨í…ì¸  íƒ€ì…, í˜ì´ì§€ ë‚´ìš©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    $.ajax({
        url: currentContent ? `/cp/api/contents/${currentContent.id}/update/` : '/cp/api/contents/create/',
        method: currentContent ? 'PUT' : 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            currentContent = data;
            searchContents(); // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
        },
        error: function(xhr) {
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// ========== í…œí”Œë¦¿ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========

// í…œí”Œë¦¿ ëª¨ë‹¬
function openTemplateModal() {
    $('#templateModal').removeClass('hidden');
}

function closeTemplateModal() {
    $('#templateModal').addClass('hidden');
}

// í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸
function testTemplate() {
    const html = $('#templateHtml').val();
    const js = $('#templateJs').val();
    
    $('#previewContent').html(html);
    if (js) {
        try {
            eval(js);
        } catch (e) {
            console.error('JavaScript ì‹¤í–‰ ì˜¤ë¥˜:', e);
        }
    }
    
    switchPreviewTab('render');
}

// í…œí”Œë¦¿ ì €ì¥
function saveTemplate() {
    const formData = {
        title: $('#templateName').val(),
        content_category: $('#templateFormCategory').val(),
        content_type: $('#templateFormType').val(),
        page: $('#templateHtml').val(),
        answer: $('#templateAnswer').val(),
        meta_data: $('#templateMeta').val(),
        tags: $('#templateJs').val(), // JSë¥¼ tags í•„ë“œì— ì €ì¥
        is_public: true
    };
    
    if (!formData.title || !formData.content_category || !formData.content_type) {
        alert('í…œí”Œë¦¿ ì´ë¦„, ì¹´í…Œê³ ë¦¬, íƒ€ì…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    $.ajax({
        url: '/cp/api/templates/create/',
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            alert('í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeTemplateModal();
            searchTemplates(); // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
        },
        error: function(xhr) {
            alert('í…œí”Œë¦¿ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// ========== ì´ë¯¸ì§€ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========

// ì´ë¯¸ì§€ ì—…ë¡œë“œ
function uploadImage(file, $img) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('content_id', currentContent ? currentContent.id : '');
    
    $.ajax({
        url: '/cp/api/upload-image/',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            // HTMLì—ì„œ ì´ë¯¸ì§€ ê²½ë¡œ ì—…ë°ì´íŠ¸
            const oldSrc = $img.attr('src');
            const newSrc = data.file_url;
            
            let html = htmlEditorInstance.getValue();
            html = html.replace(oldSrc, newSrc);
            htmlEditorInstance.setValue(html);
            
            updatePreview();
            alert('ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        },
        error: function(xhr) {
            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// ========== ì—ë””í„° ì´ˆê¸°í™” í•¨ìˆ˜ë“¤ ==========

// CodeMirror ì—ë””í„° ì´ˆê¸°í™”
function initializeEditors() {
    // ë‹µì•ˆ ì…ë ¥ JSON ì—ë””í„° (middlePanel)
    answerInputEditor = CodeMirror(document.getElementById('answerInputEditor'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    answerInputEditor.setSize(null, 200);
    answerInputEditor.on('change', function() {
        $('#answer_input').val(answerInputEditor.getValue());
    });
    
    // ë©”íƒ€ë°ì´í„° JSON ì—ë””í„°
    metaEditor = CodeMirror(document.getElementById('metaEditor'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    metaEditor.setSize(null, 150);
    metaEditor.on('change', function() {
        $('#meta_content').val(metaEditor.getValue());
    });
    
    // íƒœê·¸ JSON ì—ë””í„°
    tagsEditor = CodeMirror(document.getElementById('tagsEditor'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    tagsEditor.setSize(null, 150);
    tagsEditor.on('change', function() {
        $('#tags_content').val(tagsEditor.getValue());
    });
    
    // HTML í¸ì§‘ ì—ë””í„°
    htmlEditorInstance = CodeMirror(document.getElementById('htmlEditorContainer'), {
        mode: 'xml',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    htmlEditorInstance.setSize(null, '100%');
    htmlEditorInstance.on('change', function() {
        updatePreviewFromHtml();
    });
    
    // ì •ë‹µ JSON ì—ë””í„° (rightPanel)
    answerEditor = CodeMirror(document.getElementById('answerEditorContainer'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    answerEditor.setSize(null, '100%');
}

// ========== ë¯¸ë¦¬ë³´ê¸° ê´€ë ¨ í•¨ìˆ˜ë“¤ ==========

// ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updatePreview() {
    const html = htmlEditorInstance.getValue();
    
    // ë Œë”ë§ íƒ­ ì—…ë°ì´íŠ¸
    $('#previewContent').html(html);
    
    // í…ìŠ¤íŠ¸ í¸ì§‘ íƒ­ ì—…ë°ì´íŠ¸
    updateEditableContent(html);
}

// HTML í¸ì§‘ê¸°ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updatePreviewFromHtml() {
    const html = htmlEditorInstance.getValue();
    $('#previewContent').html(html);
    updateEditableContent(html);
}

// í¸ì§‘ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
function updateEditableContent(html) {
    console.log('í¸ì§‘ ê°€ëŠ¥í•œ ì½˜í…ì¸  ì—…ë°ì´íŠ¸:', html);
    
    const $container = $('#editableContent');
    $container.empty();
    
    if (!html || html.trim() === '') {
        $container.html('<p class="text-gray-500 text-center py-4">í¸ì§‘í•  ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</p>');
        return;
    }
    
    try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // ëª¨ë“  í…ìŠ¤íŠ¸ ë…¸ë“œ ì²˜ë¦¬
        function processNode(node, path = []) {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent.trim();
                if (text) {
                    const words = text.split(/(\s+)/);
                    const $wordContainer = $('<div class="inline"></div>');
                    
                    words.forEach((word, index) => {
                        if (word.trim()) {
                            const $word = $(`<span class="editable-word" data-path="${path.join(',')}" data-word-index="${index}" data-original="${word}">${word}</span>`);
                            $wordContainer.append($word);
                        } else {
                            $wordContainer.append(word);
                        }
                    });
                    
                    return $wordContainer;
                }
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                if (node.tagName === 'IMG') {
                    const $img = $(`<img src="${node.src}" class="editable-image max-w-full h-auto" data-path="${path.join(',')}">`);
                    if (node.width) $img.attr('width', node.width);
                    if (node.height) $img.attr('height', node.height);
                    if (node.alt) $img.attr('alt', node.alt);
                    return $img;
                } else {
                    const $elem = $(`<${node.tagName.toLowerCase()}></${node.tagName.toLowerCase()}>`);
                    
                    // ì†ì„± ë³µì‚¬
                    Array.from(node.attributes).forEach(attr => {
                        $elem.attr(attr.name, attr.value);
                    });
                    
                    // ìì‹ ë…¸ë“œ ì²˜ë¦¬
                    Array.from(node.childNodes).forEach((child, index) => {
                        const childPath = [...path, index];
                        const $child = processNode(child, childPath);
                        if ($child) {
                            $elem.append($child);
                        }
                    });
                    
                    return $elem;
                }
            }
            return null;
        }
        
        const $processed = processNode(doc.body, [0]);
        if ($processed) {
            $container.html($processed.html());
        } else {
            $container.html('<p class="text-gray-500 text-center py-4">ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</p>');
        }
        
        console.log('í¸ì§‘ ê°€ëŠ¥í•œ ìš”ì†Œ ìˆ˜:', $('.editable-word').length);
        
        // í¸ì§‘ ìƒíƒœ ì—…ë°ì´íŠ¸
        const editableCount = $('.editable-word').length;
        const imageCount = $('.editable-image').length;
        
        if (editableCount > 0 || imageCount > 0) {
            $('#editStatus').removeClass('hidden');
            $('#editStatusText').text(`í¸ì§‘ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸: ${editableCount}ê°œ, ì´ë¯¸ì§€: ${imageCount}ê°œ`);
        } else {
            $('#editStatus').addClass('hidden');
        }
        
    } catch (error) {
        console.error('HTML íŒŒì‹± ì˜¤ë¥˜:', error);
        $container.html('<p class="text-red-500 text-center py-4">ì½˜í…ì¸  íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>');
    }
}

// HTMLì—ì„œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
function updateTextInHtml(path, wordIndex, oldWord, newWord) {
    let html = htmlEditorInstance.getValue();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // ê²½ë¡œë¥¼ ë”°ë¼ ë…¸ë“œ ì°¾ê¸°
    let currentNode = doc.body;
    const pathArray = path.split(',').map(Number);
    
    for (let i = 1; i < pathArray.length; i++) {
        currentNode = currentNode.childNodes[pathArray[i]];
    }
    
    if (currentNode && currentNode.nodeType === Node.TEXT_NODE) {
        const text = currentNode.textContent;
        const words = text.split(/(\s+)/);
        
        // ë‹¨ì–´ êµì²´
        let wordCount = 0;
        for (let i = 0; i < words.length; i++) {
            if (words[i].trim()) {
                if (wordCount === wordIndex && words[i] === oldWord) {
                    words[i] = newWord;
                    break;
                }
                wordCount++;
            }
        }
        
        currentNode.textContent = words.join('');
    }
    
    // ì—…ë°ì´íŠ¸ëœ HTML ì„¤ì •
    htmlEditorInstance.setValue(doc.body.innerHTML);
}

// ========== ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜ë“¤ ==========

// ì´ë²¤íŠ¸ ë°”ì¸ë”©
function bindEvents() {
    // contentCategory ì„ íƒ ì‹œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ íƒ€ì…ë§Œ í‘œì‹œ
    $('#contentCategory').on('change', function() {
        const categoryId = $(this).val();
        console.log('ì¹´í…Œê³ ë¦¬ ë³€ê²½:', categoryId);
        
        if (categoryId) {
            // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ì˜ íƒ€ì…ë§Œ ë¡œë“œ
            loadContentTypesByCategory(categoryId);
        } else {
            // ì¹´í…Œê³ ë¦¬ ì„ íƒ í•´ì œ ì‹œ ëª¨ë“  íƒ€ì… í‘œì‹œ
            loadAllContentTypes();
        }
        
        // íƒ€ì… ì„ íƒ ì´ˆê¸°í™”
        $('#contentType').val('');
        
        // ë³€ê²½ í›„ ìë™ ê²€ìƒ‰
        searchContents();
    });
    
    // contentType ë³€ê²½ ì‹œ ìë™ ê²€ìƒ‰
    $('#contentType').on('change', function() {
        searchContents();
    });
    
    // ì½”ìŠ¤ ì„ íƒ ì‹œ ì±•í„° ë¡œë“œ ë° í‘œì‹œ
    $('#contentCourse').on('change', function() {
        const courseId = $(this).val();
        const $chapterSelect = $('#contentChapter');
        
        if (courseId) {
            $.get(`/cp/api/courses/${courseId}/chapters/`, function(data) {
                $chapterSelect.empty().append('<option value="">ëŒ€ë‹¨ì› ì„ íƒ</option>');
                data.forEach(chapter => {
                    $chapterSelect.append(`<option value="${chapter.id}">${chapter.chapter_title}</option>`);
                });
                $chapterSelect.prop('disabled', false); // ì±•í„° ì„ íƒ í™œì„±í™”
            });
        } else {
            $chapterSelect.empty().append('<option value="">ëŒ€ë‹¨ì› ì„ íƒ</option>');
            $chapterSelect.prop('disabled', true); // ì±•í„° ì„ íƒ ë¹„í™œì„±í™”
        }
        
        // ë³€ê²½ í›„ ìë™ ê²€ìƒ‰
        searchContents();
    });
    
    // ì±•í„° ë³€ê²½ ì‹œ ìë™ ê²€ìƒ‰
    $('#contentChapter').on('change', function() {
        searchContents();
    });
    
    // í…œí”Œë¦¿ ì„ íƒ ì‹œ ë‚´ìš© ì ìš©
    $('#template_select').change(function() {
        const templateId = $(this).val();
        if (templateId) {
            const template = templates.find(t => t.id == templateId);
            if (template) {
                $('#prompt_content').val(template.page || '');
                answerInputEditor.setValue(template.answer || '{}');
                metaEditor.setValue(JSON.stringify(template.meta_data || {}, null, 2));
                tagsEditor.setValue(JSON.stringify(template.tags || {}, null, 2));
            }
        }
    });
    
    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ë²¤íŠ¸
    $('#imageUpload').change(function(e) {
        const file = e.target.files[0];
        if (file && currentEditingImage) {
            uploadImage(file, currentEditingImage);
        }
    });
    
    // í…œí”Œë¦¿ ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ íƒ€ì…ë§Œ í‘œì‹œ
    $('#templateCategory').on('change', function() {
        const categoryId = $(this).val();
        if (categoryId) {
            $.get(`/cp/api/content-types/?category=${categoryId}`, function(data) {
                $('#templateType').empty().append('<option value="">íƒ€ì… ì„ íƒ</option>');
                data.forEach(type => {
                    $('#templateType').append(`<option value="${type.id}">${type.type_name}</option>`);
                });
            });
        } else {
            loadAllContentTypes();
        }
        
        // ë³€ê²½ í›„ ìë™ ê²€ìƒ‰
        searchTemplates();
    });
    
    // í…œí”Œë¦¿ íƒ€ì… ë³€ê²½ ì‹œ ìë™ ê²€ìƒ‰
    $('#templateType').on('change', function() {
        searchTemplates();
    });
    
    // ì´ˆê¸°ì— ì±•í„° ì„ íƒ ë°•ìŠ¤ ë¹„í™œì„±í™”
    $('#contentChapter').prop('disabled', true);
    
    // í…œí”Œë¦¿ ëª¨ë‹¬ì˜ ì¹´í…Œê³ ë¦¬ì—ì„œë„ íƒ€ì… í•„í„°ë§
    $('#templateFormCategory').on('change', function() {
        const categoryId = $(this).val();
        if (categoryId) {
            $.get(`/cp/api/content-types/?category=${categoryId}`, function(data) {
                $('#templateFormType').empty().append('<option value="">íƒ€ì… ì„ íƒ</option>');
                data.forEach(type => {
                    $('#templateFormType').append(`<option value="${type.id}">${type.type_name}</option>`);
                });
            });
        } else {
            loadAllContentTypes();
        }
    });
    
    // ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
    $('#contentSearch').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            searchContents();
        }
    });
    
    $('#templateSearch').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            searchTemplates();
        }
    });
    
    // ========== í…ìŠ¤íŠ¸ í¸ì§‘ ì´ë²¤íŠ¸ ìœ„ì„ ==========
    // ë™ì ìœ¼ë¡œ ìƒì„±ëœ í¸ì§‘ ê°€ëŠ¥í•œ ë‹¨ì–´ì— ëŒ€í•œ ì´ë²¤íŠ¸ ìœ„ì„
    $(document).on('dblclick', '.editable-word', function() {
        console.log('ë‹¨ì–´ ë”ë¸”í´ë¦­:', $(this).text());
        
        const $this = $(this);
        const word = $this.text();
        const path = $this.data('path');
        const wordIndex = $this.data('word-index');
        const original = $this.data('original');
        
        // ì´ë¯¸ í¸ì§‘ ì¤‘ì¸ ê²½ìš° ë¬´ì‹œ
        if ($this.hasClass('editing-word')) {
            return;
        }
        
        $this.addClass('editing-word');
        const $input = $(`<input type="text" class="edit-input px-2 py-1 border-2 border-blue-400 rounded bg-yellow-50" style="width: ${Math.max(80, word.length * 12)}px" value="${word}">`);
        
        // ì›ë˜ ìš”ì†Œë¥¼ ì…ë ¥ í•„ë“œë¡œ êµì²´
        $this.replaceWith($input);
        $input.focus().select();
        
        const updateWord = () => {
            const newWord = $input.val().trim();
            console.log('ë‹¨ì–´ ì—…ë°ì´íŠ¸:', word, '->', newWord);
            
            if (newWord !== word) {
                updateTextInHtml(path, wordIndex, original || word, newWord);
                updatePreview();
            } else {
                // ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
                const $newWord = $(`<span class="editable-word" data-path="${path}" data-word-index="${wordIndex}" data-original="${original || word}">${word}</span>`);
                $input.replaceWith($newWord);
            }
        };
        
        const cancelEdit = () => {
            console.log('í¸ì§‘ ì·¨ì†Œ');
            const $newWord = $(`<span class="editable-word" data-path="${path}" data-word-index="${wordIndex}" data-original="${original || word}">${word}</span>`);
            $input.replaceWith($newWord);
        };
        
        // ì—”í„°í‚¤ë¡œ ì €ì¥
        $input.on('keypress', function(e) {
            if (e.which === 13) { // Enter key
                e.preventDefault();
                updateWord();
            } else if (e.which === 27) { // Escape key
                e.preventDefault();
                cancelEdit();
            }
        });
        
        // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ì €ì¥
        $input.on('blur', function() {
            updateWord();
        });
    });
    
    // ì´ë¯¸ì§€ í¸ì§‘ ì´ë²¤íŠ¸ ìœ„ì„
    $(document).on('click', '.editable-image', function() {
        console.log('ì´ë¯¸ì§€ í´ë¦­');
        currentEditingImage = $(this);
        $('#imageUpload').click();
    });
}

// ========== ì´ˆê¸°í™” í•¨ìˆ˜ ==========

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
$(document).ready(function() {
    console.log('CP Agent ì´ˆê¸°í™” ì‹œì‘...');
    
    try {
        // 0. íƒ­ ì´ˆê¸°í™” (ì²« ë²ˆì§¸ íƒ­ë“¤ì„ ê¸°ë³¸ìœ¼ë¡œ í™œì„±í™”)
        switchTab('contents'); // ë¬¸í•­ ë¦¬ìŠ¤íŠ¸ íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ
        switchPreviewTab('render'); // ë Œë”ë§ íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ
        console.log('íƒ­ ì´ˆê¸°í™” ì™„ë£Œ');
        
        // 1. ì—ë””í„° ì´ˆê¸°í™”
        initializeEditors();
        console.log('ì—ë””í„° ì´ˆê¸°í™” ì™„ë£Œ');
        
        // 2. ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindEvents();
        console.log('ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
        
        // 3. ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadInitialData();
        console.log('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        
        console.log('CP Agent ì´ˆê¸°í™” ì™„ë£Œ!');
    } catch (error) {
        console.error('CP Agent ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    }
});
</script>
{% endblock %}