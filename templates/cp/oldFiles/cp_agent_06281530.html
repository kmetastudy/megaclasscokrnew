{% extends 'teacher/base.html' %}
{% load static %}

{% block title %}AI 문항 생성기{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<style>
    .CodeMirror {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        height: auto;
        background-color: #f9fafb;
    }
    
    .CodeMirror-focused {
        background-color: #ffffff;
    }
    
    .panel {
        transition: all 0.3s ease;
    }
    
    .panel-collapsed {
        width: 0 !important;
        overflow: hidden;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0;
    }
    
    .editable-word {
        cursor: pointer;
        transition: background-color 0.2s;
        display: inline;
        padding: 2px 4px;
        border-radius: 3px;
        margin: 1px;
        border: 1px solid transparent;
    }
    
    .editable-word:hover {
        background-color: #dbeafe;
        border-color: #93c5fd;
    }
    
    .editing-word {
        background-color: #fef3c7;
        border-color: #f59e0b;
    }
    
    .edit-input {
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
        background-color: #fef2f2; /* red-50 */
        border: 2px solid #ef4444 !important; /* red-500 border */
        outline: none !important;
        border-radius: 0.25rem; /* rounded */
        padding: 4px 8px;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important; /* red ring */
    }
    
    .edit-input:focus {
        background-color: #ffffff;
        border: 2px solid #dc2626 !important; /* red-600 on focus */
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3) !important;
    }
    
    .text-changed {
        color: #ef4444 !important; /* text-red-500 */
        font-weight: 500;
    }
    
    .editable-image {
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s;
        border-radius: 4px;
    }
    
    .editable-image:hover {
        border-color: #3b82f6;
    }
    
    .editable-image[data-changed="true"] {
        border-color: #ef4444 !important; /* 변경된 이미지는 빨간 테두리 */
        box-shadow: 0 0 0 1px #ef4444;
    }
    
    /* 탭 콘텐츠 스타일 수정 */
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .preview-tab-content {
        display: none;
    }
    
    .preview-tab-content.active {
        display: block !important;
    }
    
    .loader {
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #6b7280;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* 모던한 스크롤바 스타일 */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f3f4f6;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }
    
    /* 필터 섹션 스타일 */
    .filter-section {
        background-color: #f9fafb;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    /* 아코디언 스타일 */
    .accordion-header {
        cursor: pointer;
        user-select: none;
    }
    
    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    
    .accordion-content.active {
        max-height: 500px;
        transition: max-height 0.3s ease-in;
    }
    
    /* Markdown 스타일 */
    .markdown-preview {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        min-height: 200px;
    }
    
    /* 편집 도움말 스타일 */
    .edit-help {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
    }
    
    /* 알림 토스트 스타일 */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981; /* green-500 */
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease-in-out;
        font-size: 14px;
        font-weight: 500;
    }
    
    .toast-notification.show {
        transform: translateX(0);
    }
    
    .toast-notification.error {
        background: #ef4444; /* red-500 */
    }
    
    .toast-notification.warning {
        background: #f59e0b; /* yellow-500 */
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50 gap-6">
    <!-- 좌측 패널 (1/3) -->
    <div id="leftPanel" class="w-1/3 bg-white border border-gray-300 panel overflow-hidden flex flex-col rounded shadow-sm">
        <div class="px-4 py-2.5 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-medium text-gray-800">🎇 문항 & 템플릿</h2>
            <button onclick="togglePanel('left')" class="text-gray-600 hover:text-white hover:bg-orange-400 p-2 rounded transition">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto">
            <!-- 탭 메뉴 -->
            <div class="flex border-b border-gray-200 bg-gray-50">
                <button onclick="switchTab('contents')" class="tab-btn flex-1 py-3 px-4 text-center text-gray-700 hover:bg-white transition border-b-2 border-orange-400 bg-white" data-tab="contents">
                    문항 리스트
                </button>
                <button onclick="switchTab('templates')" class="tab-btn flex-1 py-3 px-4 text-center text-gray-600 hover:bg-white transition border-b-2 border-transparent" data-tab="templates">
                    템플릿 리스트
                </button>
            </div>
            
            <!-- 문항 리스트 탭 -->
            <div id="contentsTab" class="tab-content active p-4">
                <!-- 검색 필터 -->
                <div class="filter-section">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <select id="contentCategory" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">카테고리 선택</option>
                        </select>
                        
                        <select id="contentType" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">타입 선택</option>
                        </select>
                        
                        <select id="contentCourse" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">코스 선택</option>
                        </select>
                        
                        <select id="contentChapter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">대단원 선택</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-2">
                        <input type="text" id="contentSearch" placeholder="키워드 검색..." 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400">
                        <button onclick="searchContents()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="mt-3 text-sm text-gray-600">
                        검색 결과: <span id="contentsCount" class="font-semibold">0</span>개
                    </div>
                </div>
                
                <!-- 문항 리스트 -->
                <div id="contentsList" class="space-y-2">
                    <!-- 동적으로 로드됨 -->
                </div>
            </div>
            
            <!-- 템플릿 리스트 탭 -->
            <div id="templatesTab" class="tab-content p-4">
                <!-- 템플릿 만들기 버튼 -->
                <button onclick="openTemplateModal()" class="w-full bg-gray-700 text-white py-2 px-4 rounded-lg hover:bg-gray-800 transition mb-4">
                    <i class="fas fa-plus mr-2"></i>템플릿 만들기
                </button>
                
                <!-- 검색 필터 -->
                <div class="filter-section">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <select id="templateCategory" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">카테고리 선택</option>
                        </select>
                        
                        <select id="templateType" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">타입 선택</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-2">
                        <input type="text" id="templateSearch" placeholder="키워드 검색..." 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400">
                        <button onclick="searchTemplates()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="mt-3 text-sm text-gray-600">
                        검색 결과: <span id="templatesCount" class="font-semibold">0</span>개
                    </div>
                </div>
                
                <!-- 템플릿 리스트 -->
                <div id="templatesList" class="space-y-2">
                    <!-- 동적으로 로드됨 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 좌측 패널 토글 버튼 (숨김 상태일 때) -->
    <button id="leftToggleBtn" onclick="togglePanel('left')" class="bg-gray-600 hover:bg-orange-400 text-white p-2 rounded-r transition fixed left-0 top-1/2 transform -translate-y-1/2 z-10" style="display: none;">
        <i class="fas fa-chevron-right"></i>
    </button>
    
    <!-- 중간 패널 (1/3) -->
    <div id="middlePanel" class="w-1/3 bg-white border border-gray-300 panel overflow-hidden flex flex-col rounded shadow-sm">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-medium text-gray-800">✨ 문항 제작</h2>
                <button onclick="createNewContent()" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">
                    <i class="fas fa-plus mr-1"></i>새 문항
                </button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
            <form id="contentForm">
                <!-- 기본 정보 (한 줄 배치) -->
                <div class="mb-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">제목 *</label>
                        <input type="text" id="title" name="title" required
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">타입 *</label>
                        <select id="content_type" name="content_type" required
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">선택하세요</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">템플릿</label>
                        <select id="template_select" name="template_select"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                            <option value="">템플릿 없음</option>
                        </select>
                    </div>
                </div>
                
                <!-- 프롬프트 입력 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">문항 생성 지시사항 (Markdown 지원)</label>
                    <textarea id="prompt_content" name="prompt" rows="20" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm"
                              placeholder="문항 생성을 위한 상세한 지시사항을 입력하세요..."></textarea>
                </div>
                
                <!-- 답안 입력 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">답안 (JSON)</label>
                    <textarea id="answer_input" name="answer_input" class="hidden">{}</textarea>
                    <div id="answerInputEditor"></div>
                </div>
                
                <!-- 아코디언 섹션 -->
                <div class="mb-6">
                    <div class="accordion-header flex items-center justify-between p-3 bg-gray-100 rounded-lg cursor-pointer" onclick="toggleAccordion(this)">
                        <span class="text-sm font-medium text-gray-700">고급 설정</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                    </div>
                    <div class="accordion-content">
                        <div class="pt-4 space-y-4">
                            <!-- 메타데이터 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">메타데이터 (JSON)</label>
                                <textarea id="meta_content" name="meta_data" class="hidden">{}</textarea>
                                <div id="metaEditor"></div>
                            </div>
                            
                            <!-- 태그 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">태그/평가기준 (JSON)</label>
                                <textarea id="tags_content" name="tags" class="hidden">{}</textarea>
                                <div id="tagsEditor"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI 요청 버튼 -->
                <button type="button" onclick="requestAI()" 
                        class="w-full bg-gradient-to-r from-gray-600 to-gray-700 text-white py-3 px-4 rounded-lg hover:from-gray-700 hover:to-gray-800 transition duration-200 font-medium shadow-sm">
                    <i class="fas fa-magic mr-2"></i>AI로 문항 생성하기
                </button>
            </form>
        </div>
    </div>
    
    <!-- 우측 패널 (1/3) -->
    <div id="rightPanel" class="w-1/3 bg-white border border-gray-300 panel overflow-hidden flex flex-col rounded shadow-sm">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-800">🎊 미리보기 & 편집</h2>
        </div>
        
        <!-- 탭 메뉴 -->
        <div class="flex border-b border-gray-200 bg-gray-50">
            <button onclick="switchPreviewTab('render')" class="preview-tab-btn flex-1 py-3 px-4 text-center text-gray-700 hover:bg-white transition border-b-2 border-gray-600 bg-white" data-tab="render">
                렌더링
            </button>
            <button onclick="switchPreviewTab('html')" class="preview-tab-btn flex-1 py-3 px-4 text-center text-gray-600 hover:bg-white transition border-b-2 border-transparent" data-tab="html">
                HTML
            </button>
            <button onclick="switchPreviewTab('text')" class="preview-tab-btn flex-1 py-3 px-4 text-center text-gray-600 hover:bg-white transition border-b-2 border-transparent" data-tab="text">
                텍스트 편집
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto bg-gray-50">
            <!-- 렌더링 탭 -->
            <div id="renderTab" class="preview-tab-content active p-6">
                <div id="previewContent" class="prose max-w-none">
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-eye text-6xl mb-4"></i>
                        <p>AI로 문항을 생성하면 여기에 표시됩니다</p>
                    </div>
                </div>
            </div>
            
            <!-- HTML 탭 -->
            <div id="htmlTab" class="preview-tab-content h-full flex flex-col">
                <div class="flex-1" style="height: 80%;">
                    <textarea id="htmlEditor" class="hidden"></textarea>
                    <div id="htmlEditorContainer" class="h-full"></div>
                </div>
                <div style="height: 20%;" class="border-t border-gray-200">
                    <div class="p-2 bg-gray-100">
                        <label class="text-sm font-medium text-gray-700">정답 (JSON)</label>
                    </div>
                    <div id="answerEditorContainer" class="h-full"></div>
                </div>
            </div>
            
            <!-- 텍스트 편집 탭 -->
            <div id="textTab" class="preview-tab-content p-6">
                <div class="edit-help">
                    <i class="fas fa-lightbulb"></i>
                    <strong>편집 가이드:</strong> 
                    텍스트를 더블클릭하여 편집하고 엔터키로 저장하세요. 
                    이미지를 클릭하면 새 이미지로 교체할 수 있습니다.
                    <div class="mt-2 text-sm opacity-90">
                        <i class="fas fa-keyboard mr-1"></i>
                        엔터: 저장 | ESC: 취소 | 더블클릭: 편집 시작
                    </div>
                </div>
                
                <!-- 편집 상태 표시 -->
                <div id="editStatus" class="mb-4 p-2 bg-gray-100 rounded text-sm text-gray-600 hidden">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="editStatusText">편집 가능한 요소: 0개</span>
                </div>
                
                <div id="editableContent" class="space-y-4 min-h-[200px] border border-gray-200 rounded-lg p-4 bg-white">
                    <p class="text-gray-400 text-center py-8">
                        <i class="fas fa-edit text-4xl mb-2 block"></i>
                        AI로 문항을 생성하면 편집 가능한 텍스트가 여기에 표시됩니다
                    </p>
                </div>
                
                <!-- 숨겨진 파일 입력 -->
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            </div>
        </div>
        
        <!-- 저장 버튼 -->
        <div class="p-4 border-t border-gray-200 bg-white">
            <button onclick="saveContent()" 
                    class="w-full bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-200 font-medium shadow-sm">
                <i class="fas fa-save mr-2"></i>저장하기
            </button>
        </div>
    </div>
</div>

<!-- 템플릿 만들기 모달 -->
<div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="bg-gray-100 px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-800">템플릿 만들기</h3>
                <button onclick="closeTemplateModal()" class="text-gray-500 hover:text-gray-700 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto bg-gray-50" style="max-height: calc(90vh - 120px);">
                <form id="templateForm">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">카테고리</label>
                            <select id="templateFormCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">타입</label>
                            <select id="templateFormType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">템플릿 이름</label>
                        <input type="text" id="templateName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-white">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">HTML 템플릿</label>
                        <textarea id="templateHtml" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">정답 템플릿 (JSON)</label>
                        <textarea id="templateAnswer" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm">{}</textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">메타데이터 (JSON)</label>
                        <textarea id="templateMeta" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm">{}</textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">JavaScript (선택사항)</label>
                        <textarea id="templateJs" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-gray-400 bg-gray-50 font-mono text-sm"></textarea>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="testTemplate()" 
                                class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition">
                            <i class="fas fa-play mr-2"></i>실행해보기
                        </button>
                        <button type="button" onclick="saveTemplate()" 
                                class="flex-1 bg-gray-700 text-white py-2 px-4 rounded-lg hover:bg-gray-800 transition">
                            <i class="fas fa-save mr-2"></i>저장하기
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 모달 -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg p-8 text-center shadow-xl">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-700">AI가 문항을 생성하고 있습니다...</p>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>

<script>
// 전역 변수
let metaEditor, tagsEditor, htmlEditorInstance, answerEditor, answerInputEditor;
let currentContent = null;
let templates = [];
let currentEditingImage = null;
let temporaryUploads = []; // 임시 업로드된 파일들 추적

// ========== 수정된 텍스트 편집 시스템 변수 ==========
let originalHtmlContent = '';
let wordMappings = new Map();

// ========== 유틸리티 함수들 ==========

// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 알림 토스트 표시
function showToast(message, type = 'success') {
    // 기존 토스트 제거
    $('.toast-notification').remove();
    
    const toastClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
    const icon = type === 'error' ? 'fas fa-times-circle' : 
                 type === 'warning' ? 'fas fa-exclamation-triangle' : 
                 'fas fa-check-circle';
    
    const $toast = $(`
        <div class="toast-notification ${toastClass}">
            <i class="${icon} mr-2"></i>${message}
        </div>
    `);
    
    $('body').append($toast);
    
    // 애니메이션으로 표시
    setTimeout(() => $toast.addClass('show'), 100);
    
    // 3초 후 자동 제거
    setTimeout(() => {
        $toast.removeClass('show');
        setTimeout(() => $toast.remove(), 300);
    }, 3000);
}

// 임시 업로드 파일 정리
function cleanupTemporaryUploads() {
    if (temporaryUploads.length === 0) return;
    
    console.log('임시 업로드 파일 정리:', temporaryUploads);
    
    temporaryUploads.forEach(attachmentId => {
        $.ajax({
            url: `/cp/api/cleanup-temp-upload/${attachmentId}/`,
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function() {
                console.log(`임시 파일 ${attachmentId} 정리 완료`);
            },
            error: function(xhr) {
                console.error(`임시 파일 ${attachmentId} 정리 실패:`, xhr);
            }
        });
    });
    
    temporaryUploads = [];
}

// ========== UI 컨트롤 함수들 ==========

// 패널 토글
function togglePanel(panel) {
    const $panel = $(`#${panel}Panel`);
    const $toggleBtn = $(`#${panel}ToggleBtn`);
    const $middlePanel = $('#middlePanel');
    const $rightPanel = $('#rightPanel');
    
    if ($panel.hasClass('panel-collapsed')) {
        // 패널 열기
        $panel.removeClass('panel-collapsed');
        $toggleBtn.hide();
        $middlePanel.removeClass('w-1/2').addClass('w-1/3');
        $rightPanel.removeClass('w-1/2').addClass('w-1/3');
    } else {
        // 패널 닫기
        $panel.addClass('panel-collapsed');
        $toggleBtn.show();
        $middlePanel.removeClass('w-1/3').addClass('w-1/2');
        $rightPanel.removeClass('w-1/3').addClass('w-1/2');
    }
}

// 탭 전환
function switchTab(tab) {
    $('.tab-btn').removeClass('border-orange-400 bg-white text-gray-700').addClass('border-transparent text-gray-600');
    $(`.tab-btn[data-tab="${tab}"]`).removeClass('border-transparent text-gray-600').addClass('border-orange-400 bg-white text-gray-700');
    
    $('.tab-content').removeClass('active');
    $(`#${tab}Tab`).addClass('active');
}

function switchPreviewTab(tab) {
    console.log('탭 전환:', tab);
    
    // 모든 탭 버튼 스타일 초기화
    $('.preview-tab-btn').removeClass('border-gray-600 bg-white text-gray-700').addClass('border-transparent text-gray-600');
    
    // 선택된 탭 버튼 활성화
    $(`.preview-tab-btn[data-tab="${tab}"]`).removeClass('border-transparent text-gray-600').addClass('border-gray-600 bg-white text-gray-700');
    
    // 모든 탭 콘텐츠 숨기기
    $('.preview-tab-content').removeClass('active').hide();
    
    // 선택된 탭 콘텐츠 보이기
    $(`#${tab}Tab`).addClass('active').show();
    
    // 특별한 경우 처리
    if (tab === 'html' && htmlEditorInstance) {
        // HTML 에디터 리프레시
        setTimeout(() => {
            htmlEditorInstance.refresh();
        }, 100);
    }
}

// 아코디언 토글
function toggleAccordion(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('i');
    
    content.classList.toggle('active');
    icon.classList.toggle('fa-chevron-down');
    icon.classList.toggle('fa-chevron-up');
}

// ========== 데이터 로드 함수들 ==========

// 초기 데이터 로드
function loadInitialData() {
    // 카테고리 로드
    $.get('/cp/api/categories/', function(data) {
        const categorySelects = ['#contentCategory', '#templateCategory', '#templateFormCategory'];
        categorySelects.forEach(selector => {
            $(selector).empty().append('<option value="">카테고리 선택</option>');
            data.forEach(category => {
                $(selector).append(`<option value="${category.id}">${category.category_name}</option>`);
            });
        });
    }).fail(function() {
        console.error('카테고리 로드 실패');
    });
    
    // 초기에는 모든 ContentType 로드
    loadAllContentTypes();
    
    // 코스 로드
    $.get('/cp/api/courses/', function(data) {
        $('#contentCourse').empty().append('<option value="">코스 선택</option>');
        data.forEach(course => {
            $('#contentCourse').append(`<option value="${course.id}">${course.subject_name}</option>`);
        });
    }).fail(function() {
        console.error('코스 로드 실패');
    });
    
    // 초기 문항 리스트 로드
    searchContents();
    searchTemplates();
}

// 모든 컨텐츠 타입 로드 함수
function loadAllContentTypes() {
    $.get('/cp/api/content-types/', function(data) {
        const typeSelects = ['#content_type', '#contentType', '#templateType', '#templateFormType'];
        typeSelects.forEach(selector => {
            $(selector).empty().append('<option value="">타입 선택</option>');
            data.forEach(type => {
                $(selector).append(`<option value="${type.id}">${type.type_name}</option>`);
            });
        });
    }).fail(function() {
        console.error('컨텐츠 타입 로드 실패');
    });
}

// 카테고리별 컨텐츠 타입 로드 함수
function loadContentTypesByCategory(categoryId) {
    if (!categoryId) {
        loadAllContentTypes();
        return;
    }
    
    $.get(`/cp/api/content-types/?category=${categoryId}`, function(data) {
        // contentType select 업데이트
        $('#contentType').empty().append('<option value="">타입 선택</option>');
        data.forEach(type => {
            $('#contentType').append(`<option value="${type.id}">${type.type_name}</option>`);
        });
        
        // middlePanel의 content_type도 업데이트
        $('#content_type').empty().append('<option value="">선택하세요</option>');
        data.forEach(type => {
            $('#content_type').append(`<option value="${type.id}">${type.type_name}</option>`);
        });
    }).fail(function() {
        console.error('컨텐츠 타입 로드 실패');
        loadAllContentTypes(); // 실패 시 전체 타입 로드
    });
}

// ========== 검색 함수들 ==========

// 문항 검색
function searchContents() {
    const params = {
        category: $('#contentCategory').val(),
        type: $('#contentType').val(),
        course: $('#contentCourse').val(),
        chapter: $('#contentChapter').val(),
        search: $('#contentSearch').val()
    };
    
    $.get('/cp/api/contents/search/', params, function(data) {
        const $list = $('#contentsList');
        $list.empty();
        
        $('#contentsCount').text(data.length);
        
        if (data.length === 0) {
            $list.append('<p class="text-gray-500 text-center py-4">검색 결과가 없습니다</p>');
            return;
        }
        
        data.forEach(content => {
            $list.append(`
                <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" onclick="loadContent(${content.id})">
                    <h4 class="font-medium text-gray-800">${content.title}</h4>
                    <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded mr-2">
                            ${content.content_type_name}
                        </span>
                        <span>${content.created_at}</span>
                    </div>
                </div>
            `);
        });
    }).fail(function() {
        console.error('문항 검색 실패');
    });
}

// 템플릿 검색
function searchTemplates() {
    const params = {
        category: $('#templateCategory').val(),
        type: $('#templateType').val(),
        search: $('#templateSearch').val()
    };
    
    $.get('/cp/api/templates/search/', params, function(data) {
        templates = data;
        const $list = $('#templatesList');
        const $select = $('#template_select');
        
        $list.empty();
        $select.empty().append('<option value="">템플릿 없음</option>');
        
        $('#templatesCount').text(data.length);
        
        if (data.length === 0) {
            $list.append('<p class="text-gray-500 text-center py-4">템플릿이 없습니다</p>');
            return;
        }
        
        data.forEach(template => {
            // 리스트에 추가
            $list.append(`
                <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" onclick="selectTemplate(${template.id})">
                    <h4 class="font-medium text-gray-800">${template.title}</h4>
                    <div class="flex items-center text-xs text-gray-500 mt-1">
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded mr-2">
                            ${template.content_type_name}
                        </span>
                        <span>${template.created_at}</span>
                    </div>
                </div>
            `);
            
            // 선택 옵션에 추가
            $select.append(`<option value="${template.id}">${template.title}</option>`);
        });
    }).fail(function() {
        console.error('템플릿 검색 실패');
    });
}

// ========== 컨텐츠 관리 함수들 ==========

// 문항 로드
function loadContent(contentId) {
    $.get(`/cp/api/contents/${contentId}/`, function(data) {
        $('#title').val(data.title);
        $('#content_type').val(data.content_type);
        
        // 프롬프트와 HTML 구분하여 처리
        if (data.prompt) {
            $('#prompt_content').val(data.prompt);
        }
        
        // HTML 콘텐츠가 있으면 미리보기에 표시
        if (data.page) {
            htmlEditorInstance.setValue(data.page);
            updatePreview(); // 미리보기 업데이트
        }
        
        // 답안 설정
        answerInputEditor.setValue(data.answer || '{}');
        answerEditor.setValue(data.answer || '{}');
        
        // 메타데이터와 태그 설정
        metaEditor.setValue(JSON.stringify(data.meta_data || {}, null, 2));
        tagsEditor.setValue(JSON.stringify(data.tags || {}, null, 2));
        
        currentContent = data;
    }).fail(function() {
        alert('문항을 불러오는 중 오류가 발생했습니다.');
    });
}

// 템플릿 선택
function selectTemplate(templateId) {
    $('#template_select').val(templateId).change();
}

// AI 요청
function requestAI() {
    const formData = {
        title: $('#title').val(),
        content_type: $('#content_type').val(),
        template_id: $('#template_select').val(),
        prompt: $('#prompt_content').val(),
        answer_input: answerInputEditor.getValue(),
        meta_data: metaEditor.getValue(),
        tags: tagsEditor.getValue()
    };
    
    if (!formData.title || !formData.content_type) {
        alert('제목과 컨텐츠 타입은 필수입니다.');
        return;
    }
    
    $('#loadingModal').removeClass('hidden');
    
    $.ajax({
        url: '/cp/api/generate-content/',
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            htmlEditorInstance.setValue(data.page || '');
            answerEditor.setValue(data.answer || '');
            metaEditor.setValue(data.meta_data || '{}');
            tagsEditor.setValue(data.tags || '{}');
            
            updatePreview();
            $('#loadingModal').addClass('hidden');
        },
        error: function(xhr) {
            alert('AI 요청 중 오류가 발생했습니다.');
            $('#loadingModal').addClass('hidden');
        }
    });
}

// ========== 수정된 텍스트 편집 시스템 ==========

/**
 * 기존 이벤트 핸들러 완전 제거 및 새로운 핸들러 바인딩
 */
function bindTextEditingEvents() {
    console.log('텍스트 편집 이벤트 바인딩 시작');
    
    // *** 중요: 기존 이벤트 핸들러 모두 제거 ***
    $(document).off('dblclick', '.editable-word');
    $(document).off('dblclick.textEdit', '.editable-word');
    $(document).off('click', '.editable-image');
    
    console.log('기존 이벤트 핸들러 제거 완료');
    
    // 새로운 텍스트 편집 이벤트만 바인딩
    $(document).on('dblclick.newTextEdit', '.editable-word', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const $word = $(this);
        const wordId = $word.data('word-id');
        const originalText = $word.data('original');
        const currentText = $word.text();
        
        console.log('새로운 텍스트 편집 시작:', { wordId, originalText, currentText });
        
        // wordId 유효성 검사
        if (!wordId || wordId === 'undefined' || wordId === 'NaN') {
            console.error('유효하지 않은 wordId:', wordId);
            showToast('편집할 수 없는 텍스트입니다', 'error');
            return;
        }
        
        // 이미 편집 중인 경우 무시
        if ($word.hasClass('editing-word')) {
            console.log('이미 편집 중인 단어');
            return;
        }
        
        startTextEditing($word, wordId, originalText, currentText);
    });
    
    // 이미지 편집 이벤트 바인딩
    $(document).on('click.imageEdit', '.editable-image', function() {
        console.log('이미지 편집 클릭');
        currentEditingImage = $(this);
        $('#imageUpload').click();
    });
    
    console.log('새로운 이벤트 핸들러 바인딩 완료');
}

/**
 * 텍스트 편집 시작
 */
function startTextEditing($word, wordId, originalText, currentText) {
    console.log('텍스트 편집 모드 진입:', { wordId, originalText, currentText });
    
    // 편집 모드 표시
    $word.addClass('editing-word');
    
    // 입력 필드 생성
    const $input = $('<input type="text" class="edit-input">');
    $input.val(currentText);
    $input.css({
        'width': Math.max(100, currentText.length * 10 + 30) + 'px',
        'font-family': $word.css('font-family'),
        'font-size': $word.css('font-size'),
        'font-weight': $word.css('font-weight'),
        'background-color': '#fef2f2',
        'border': '2px solid #ef4444',
        'outline': 'none',
        'border-radius': '0.25rem',
        'padding': '4px 8px'
    });
    
    // 원본 요소를 입력 필드로 교체
    $word.replaceWith($input);
    $input.focus().select();
    
    /**
     * 편집 완료 처리
     */
    function finishEditing() {
        const newText = $input.val(); // trim() 하지 않음 - 빈 문자열도 허용
        console.log('편집 완료 처리:', { currentText, newText, wordId });
        
        // 변경사항이 있는지 확인
        if (newText !== currentText) {
            console.log('텍스트 변경 감지, HTML 업데이트 시작');
            
            // HTML 업데이트
            const updateSuccess = updateTextInHtml(wordId, currentText, newText);
            
            if (updateSuccess) {
                // 성공: 변경된 텍스트로 새 요소 생성 (빨간색 표시)
                const $newWord = $(`<span class="editable-word text-changed" 
                    data-word-id="${wordId}" 
                    data-original="${originalText}"
                    data-changed="true"
                    title="더블클릭하여 편집"
                    style="color: #ef4444 !important; font-weight: 500;">${newText}</span>`);
                
                $input.replaceWith($newWord);
                
                // 성공 알림
                showToast(`"${currentText}" → "${newText}" 변경되었습니다`, 'success');
                
                // 미리보기 업데이트 (새로운 이벤트 바인딩 포함)
                setTimeout(() => {
                    updatePreview();
                }, 100);
                
                console.log('텍스트 편집 성공 완료');
            } else {
                // 실패: 원래 상태로 복구
                console.log('HTML 업데이트 실패, 원래 상태로 복구');
                restoreOriginalWord();
                showToast('텍스트 업데이트에 실패했습니다', 'error');
            }
        } else {
            // 변경사항이 없으면 원래 상태로 복구
            console.log('변경사항 없음, 원래 상태로 복구');
            restoreOriginalWord();
        }
    }
    
    /**
     * 편집 취소 처리
     */
    function cancelEditing() {
        console.log('편집 취소');
        restoreOriginalWord();
        showToast('편집이 취소되었습니다', 'warning');
    }
    
    /**
     * 원래 단어로 복구
     */
    function restoreOriginalWord() {
        const $restoredWord = $(`<span class="editable-word" 
            data-word-id="${wordId}" 
            data-original="${originalText}"
            title="더블클릭하여 편집">${currentText}</span>`);
        
        $input.replaceWith($restoredWord);
    }
    
    // 키보드 이벤트
    $input.on('keydown', function(e) {
        e.stopPropagation(); // 이벤트 버블링 방지
        
        if (e.key === 'Enter') {
            e.preventDefault();
            console.log('Enter 키 감지, 편집 완료');
            finishEditing();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            console.log('Escape 키 감지, 편집 취소');
            cancelEditing();
        }
    });
    
    // 포커스 아웃 시 저장
    $input.on('blur', function() {
        console.log('포커스 아웃, 편집 완료');
        finishEditing();
    });
}

/**
 * HTML에서 텍스트 업데이트 (개선된 버전)
 */
function updateTextInHtml(wordId, oldText, newText) {
    console.log(`HTML 텍스트 업데이트 시작: wordId=${wordId}, "${oldText}" → "${newText}"`);
    
    // wordId 유효성 재검사
    if (!wordId || wordId === 'undefined' || wordId === 'NaN') {
        console.error('유효하지 않은 wordId로 HTML 업데이트 시도:', wordId);
        return false;
    }
    
    const mapping = wordMappings.get(wordId);
    if (!mapping) {
        console.error('매핑 정보를 찾을 수 없습니다:', wordId);
        console.log('현재 매핑:', Array.from(wordMappings.keys()));
        return false;
    }
    
    let currentHtml = htmlEditorInstance.getValue();
    console.log('현재 HTML 길이:', currentHtml.length);
    
    // 정확한 텍스트 매칭을 위한 이스케이프 처리
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    const escapedOldText = escapeRegExp(oldText);
    
    // 다양한 매칭 전략 시도
    const strategies = [
        // 1. 단어 경계를 고려한 매칭
        {
            name: 'word boundary',
            regex: new RegExp(`\\b${escapedOldText}\\b`, 'g')
        },
        // 2. HTML 태그 내 텍스트 매칭
        {
            name: 'html text',
            regex: new RegExp(`(>[^<]*?)${escapedOldText}([^<]*?<)`, 'g'),
            replacement: `$1${newText}$2`
        },
        // 3. 단순 텍스트 매칭
        {
            name: 'simple text',
            regex: new RegExp(escapedOldText, 'g')
        }
    ];
    
    let updatedHtml = currentHtml;
    let replacementMade = false;
    let usedStrategy = '';
    
    for (const strategy of strategies) {
        if (strategy.regex.test(currentHtml)) {
            if (strategy.replacement) {
                updatedHtml = currentHtml.replace(strategy.regex, strategy.replacement);
            } else {
                updatedHtml = currentHtml.replace(strategy.regex, newText);
            }
            replacementMade = true;
            usedStrategy = strategy.name;
            console.log(`매칭 성공: ${strategy.name} 전략 사용`);
            break;
        }
    }
    
    if (replacementMade) {
        // HTML 에디터 업데이트
        htmlEditorInstance.setValue(updatedHtml);
        
        // 매핑 정보 업데이트
        mapping.originalText = newText;
        wordMappings.set(wordId, mapping);
        
        console.log(`HTML 업데이트 성공 (${usedStrategy} 전략)`);
        return true;
    } else {
        console.warn('모든 매칭 전략 실패:', oldText);
        console.log('HTML 일부:', currentHtml.substring(0, 200) + '...');
        return false;
    }
}

/**
 * HTML 콘텐츠를 편집 가능한 형태로 변환 (수정된 버전)
 */
function updateEditableContent(html) {
    console.log('편집 가능한 콘텐츠 업데이트 시작');
    
    const $container = $('#editableContent');
    $container.empty();
    
    if (!html || html.trim() === '') {
        $container.html('<p class="text-gray-500 text-center py-4">편집할 콘텐츠가 없습니다</p>');
        return;
    }
    
    // 원본 HTML 저장 및 매핑 초기화
    originalHtmlContent = html;
    wordMappings.clear();
    
    try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        let globalWordId = 0;
        
        function processNode(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                const fullText = node.textContent;
                
                if (!fullText.trim()) {
                    return $('<span>').text(fullText);
                }
                
                // 단어와 공백을 모두 포함하여 분리
                const segments = fullText.split(/(\s+)/);
                const $textContainer = $('<span class="text-container">');
                
                segments.forEach((segment, index) => {
                    if (segment.trim()) {
                        // 실제 단어인 경우
                        const wordId = `word_${globalWordId++}`;
                        
                        // 매핑 정보 저장
                        wordMappings.set(wordId, {
                            originalText: segment,
                            fullTextContent: fullText,
                            segmentIndex: index,
                            parentNode: node.parentNode ? node.parentNode.tagName : 'BODY'
                        });
                        
                        const $word = $(`<span class="editable-word" 
                            data-word-id="${wordId}" 
                            data-original="${segment}"
                            title="더블클릭하여 편집"
                            style="cursor: pointer; transition: background-color 0.2s; display: inline; padding: 2px 4px; border-radius: 3px; margin: 1px; border: 1px solid transparent;">${segment}</span>`);
                        
                        $textContainer.append($word);
                    } else if (segment) {
                        // 공백 유지
                        $textContainer.append(segment);
                    }
                });
                
                return $textContainer;
                
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                if (node.tagName === 'IMG') {
                    const $img = $(`<img src="${node.src}" class="editable-image max-w-full h-auto" 
                        data-original-src="${node.src}"
                        title="클릭하여 이미지 변경"
                        style="cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; border-radius: 4px;">`);
                    
                    Array.from(node.attributes).forEach(attr => {
                        if (attr.name !== 'src') {
                            $img.attr(attr.name, attr.value);
                        }
                    });
                    
                    return $img;
                } else {
                    const $element = $(`<${node.tagName.toLowerCase()}></${node.tagName.toLowerCase()}>`);
                    
                    Array.from(node.attributes).forEach(attr => {
                        $element.attr(attr.name, attr.value);
                    });
                    
                    Array.from(node.childNodes).forEach(child => {
                        const $processedChild = processNode(child);
                        if ($processedChild) {
                            $element.append($processedChild);
                        }
                    });
                    
                    return $element;
                }
            }
            
            return null;
        }
        
        const $processedContent = $('<div>');
        Array.from(doc.body.childNodes).forEach(child => {
            const $processed = processNode(child);
            if ($processed) {
                $processedContent.append($processed);
            }
        });
        
        $container.html($processedContent.html());
        
        // CSS 스타일 적용
        $container.find('.editable-word').on('mouseenter', function() {
            $(this).css({
                'background-color': '#dbeafe',
                'border-color': '#93c5fd'
            });
        }).on('mouseleave', function() {
            if (!$(this).hasClass('text-changed')) {
                $(this).css({
                    'background-color': 'transparent',
                    'border-color': 'transparent'
                });
            }
        });
        
        $container.find('.editable-image').on('mouseenter', function() {
            $(this).css('border-color', '#3b82f6');
        }).on('mouseleave', function() {
            if (!$(this).attr('data-changed')) {
                $(this).css('border-color', 'transparent');
            }
        });
        
        // 편집 가능한 요소 수 업데이트
        const editableWordCount = $('.editable-word').length;
        const editableImageCount = $('.editable-image').length;
        
        console.log(`편집 가능한 단어: ${editableWordCount}개, 이미지: ${editableImageCount}개`);
        console.log('매핑된 단어 ID들:', Array.from(wordMappings.keys()));
        
        if (editableWordCount > 0 || editableImageCount > 0) {
            $('#editStatus').removeClass('hidden');
            $('#editStatusText').text(`편집 가능한 텍스트: ${editableWordCount}개, 이미지: ${editableImageCount}개`);
        } else {
            $('#editStatus').addClass('hidden');
        }
        
    } catch (error) {
        console.error('HTML 파싱 오류:', error);
        $container.html('<p class="text-red-500 text-center py-4">콘텐츠 파싱 중 오류가 발생했습니다</p>');
    }
}

// ========== 기존 함수들 수정 ==========

// 미리보기 업데이트 함수 수정
function updatePreview() {
    const html = htmlEditorInstance.getValue();
    
    // 렌더링 탭 업데이트
    $('#previewContent').html(html);
    
    // 텍스트 편집 탭 업데이트
    updateEditableContent(html);
    
    // 이벤트 바인딩 (약간의 지연을 두어 DOM 업데이트 완료 후 실행)
    setTimeout(() => {
        bindTextEditingEvents();
    }, 50);
}

// HTML 편집기에서 미리보기 업데이트
function updatePreviewFromHtml() {
    const html = htmlEditorInstance.getValue();
    $('#previewContent').html(html);
    updateEditableContent(html);
}

// 변경된 텍스트 색상 초기화
function resetTextColors() {
    $('.text-changed').removeClass('text-changed').css('color', '');
    $('.editable-word[data-changed="true"]').removeAttr('data-changed');
    $('.editable-image[data-changed="true"]').removeClass('border-2 border-red-500').removeAttr('data-changed');
    console.log('텍스트 색상 초기화 완료');
}

// 콘텐츠 저장
function saveContent() {
    // 저장 전에 변경된 텍스트 색상을 원래대로 복원
    resetTextColors();
    $('.editable-image[data-changed="true"]').removeClass('border-2 border-red-500').removeAttr('data-changed');
    
    // HTML 에디터의 내용을 최신 상태로 업데이트
    updatePreviewFromHtml();
    
    const formData = {
        title: $('#title').val(),
        content_type: $('#content_type').val(),
        page: htmlEditorInstance.getValue(),
        answer: answerEditor.getValue(),
        meta_data: metaEditor.getValue(),
        tags: tagsEditor.getValue(),
        prompt: $('#prompt_content').val()
    };
    
    if (!formData.title || !formData.content_type || !formData.page) {
        alert('제목, 컨텐츠 타입, 페이지 내용은 필수입니다.');
        return;
    }
    
    // 로딩 표시
    const $saveBtn = $('button[onclick="saveContent()"]');
    const originalText = $saveBtn.html();
    $saveBtn.html('<i class="fas fa-spinner fa-spin mr-2"></i>저장 중...').prop('disabled', true);
    
    $.ajax({
        url: currentContent ? `/cp/api/contents/${currentContent.id}/update/` : '/cp/api/contents/create/',
        method: currentContent ? 'PUT' : 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            console.log('콘텐츠 저장 성공:', data);
            
            // 저장 완료 후 버튼 복원
            $saveBtn.html(originalText).prop('disabled', false);
            
            alert('저장되었습니다.');
            currentContent = data;
            
            // 변경된 모든 요소의 표시 제거
            $('[data-changed="true"]').removeAttr('data-changed');
            
            // 리스트 새로고침
            searchContents();
        },
        error: function(xhr) {
            console.error('콘텐츠 저장 실패:', xhr);
            
            // 에러 시 버튼 복원
            $saveBtn.html(originalText).prop('disabled', false);
            
            let errorMsg = '저장 중 오류가 발생했습니다.';
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.error) {
                    errorMsg = response.error;
                }
            } catch (e) {
                console.error('에러 응답 파싱 실패:', e);
            }
            
            alert(errorMsg);
        }
    });
}

// ========== 템플릿 관리 함수들 ==========

// 템플릿 모달
function openTemplateModal() {
    $('#templateModal').removeClass('hidden');
}

function closeTemplateModal() {
    $('#templateModal').addClass('hidden');
}

// 템플릿 테스트
function testTemplate() {
    const html = $('#templateHtml').val();
    const js = $('#templateJs').val();
    
    $('#previewContent').html(html);
    if (js) {
        try {
            eval(js);
        } catch (e) {
            console.error('JavaScript 실행 오류:', e);
        }
    }
    
    switchPreviewTab('render');
}

// 템플릿 저장
function saveTemplate() {
    const formData = {
        title: $('#templateName').val(),
        content_category: $('#templateFormCategory').val(),
        content_type: $('#templateFormType').val(),
        page: $('#templateHtml').val(),
        answer: $('#templateAnswer').val(),
        meta_data: $('#templateMeta').val(),
        tags: $('#templateJs').val(), // JS를 tags 필드에 저장
        is_public: true
    };
    
    if (!formData.title || !formData.content_category || !formData.content_type) {
        alert('템플릿 이름, 카테고리, 타입은 필수입니다.');
        return;
    }
    
    $.ajax({
        url: '/cp/api/templates/create/',
        method: 'POST',
        data: JSON.stringify(formData),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            alert('템플릿이 저장되었습니다.');
            closeTemplateModal();
            searchTemplates(); // 리스트 새로고침
        },
        error: function(xhr) {
            alert('템플릿 저장 중 오류가 발생했습니다.');
        }
    });
}

// ========== 이미지 관리 함수들 ==========

// 이미지 업로드
function uploadImage(file, $img) {
    console.log('이미지 업로드 시작:', file.name);
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('original_name', file.name);
    formData.append('file_type', file.type);
    formData.append('file_size', file.size);
    
    // 현재 콘텐츠 ID가 있으면 전송 (저장된 콘텐츠의 경우)
    if (currentContent && currentContent.id) {
        formData.append('content_id', currentContent.id);
    }
    
    $.ajax({
        url: '/cp/api/upload-image/',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(data) {
            console.log('이미지 업로드 성공:', data);
            
            // 원본 src 저장 (취소 시 복원용)
            if (!$img.attr('data-original-src')) {
                $img.attr('data-original-src', $img.attr('src'));
            }
            
            // 임시로 미리보기에 새 이미지 적용
            const oldSrc = $img.attr('src');
            const newSrc = data.file_url;
            
            // 현재 편집 중인 이미지 요소 업데이트
            $img.attr('src', newSrc);
            
            // HTML 에디터의 내용도 업데이트
            let html = htmlEditorInstance.getValue();
            html = html.replace(oldSrc, newSrc);
            htmlEditorInstance.setValue(html);
            
            // 미리보기 업데이트
            updatePreview();
            
            // 이미지가 변경되었음을 표시 (빨간 테두리)
            $img.addClass('border-2 border-red-500');
            $img.attr('data-changed', 'true');
            $img.attr('data-attachment-id', data.attachment_id || '');
            $img.attr('data-new-src', newSrc);
            
            // 임시 업로드 목록에 추가
            if (data.attachment_id) {
                temporaryUploads.push(data.attachment_id);
            }
            
            showToast('이미지가 임시로 업로드되었습니다. 저장 버튼을 눌러 최종 저장하세요.', 'success');
        },
        error: function(xhr) {
            console.error('이미지 업로드 실패:', xhr);
            let errorMsg = '이미지 업로드 중 오류가 발생했습니다.';
            
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.error) {
                    errorMsg = response.error;
                }
            } catch (e) {
                console.error('에러 응답 파싱 실패:', e);
            }
            
            showToast(errorMsg, 'error');
        }
    });
}

// 이미지 변경 취소 (원래 이미지로 복원)
function cancelImageChanges() {
    $('.editable-image[data-changed="true"]').each(function() {
        const $img = $(this);
        const originalSrc = $img.attr('data-original-src');
        const attachmentId = $img.attr('data-attachment-id');
        
        if (originalSrc) {
            // 원래 이미지로 복원
            $img.attr('src', originalSrc);
            
            // HTML 에디터의 내용도 업데이트
            const newSrc = $img.attr('data-new-src');
            if (newSrc) {
                let html = htmlEditorInstance.getValue();
                html = html.replace(newSrc, originalSrc);
                htmlEditorInstance.setValue(html);
            }
            
            // 변경 표시 제거
            $img.removeClass('border-2 border-red-500');
            $img.removeAttr('data-changed data-attachment-id data-new-src');
        }
        
        // 임시 업로드 파일 삭제 (서버에서)
        if (attachmentId) {
            $.ajax({
                url: `/cp/api/cleanup-temp-upload/${attachmentId}/`,
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function() {
                    console.log(`임시 이미지 ${attachmentId} 삭제 완료`);
                },
                error: function(xhr) {
                    console.error(`임시 이미지 ${attachmentId} 삭제 실패:`, xhr);
                }
            });
        }
    });
    
    // 임시 업로드 목록 초기화
    temporaryUploads = [];
    
    // 미리보기 업데이트
    updatePreview();
}

// ========== 에디터 초기화 함수들 ==========

// CodeMirror 에디터 초기화
function initializeEditors() {
    // 답안 입력 JSON 에디터 (middlePanel)
    answerInputEditor = CodeMirror(document.getElementById('answerInputEditor'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    answerInputEditor.setSize(null, 200);
    answerInputEditor.on('change', function() {
        $('#answer_input').val(answerInputEditor.getValue());
    });
    
    // 메타데이터 JSON 에디터
    metaEditor = CodeMirror(document.getElementById('metaEditor'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    metaEditor.setSize(null, 150);
    metaEditor.on('change', function() {
        $('#meta_content').val(metaEditor.getValue());
    });
    
    // 태그 JSON 에디터
    tagsEditor = CodeMirror(document.getElementById('tagsEditor'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    tagsEditor.setSize(null, 150);
    tagsEditor.on('change', function() {
        $('#tags_content').val(tagsEditor.getValue());
    });
    
    // HTML 편집 에디터
    htmlEditorInstance = CodeMirror(document.getElementById('htmlEditorContainer'), {
        mode: 'xml',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    htmlEditorInstance.setSize(null, '100%');
    htmlEditorInstance.on('change', function() {
        updatePreviewFromHtml();
    });
    
    // 정답 JSON 에디터 (rightPanel)
    answerEditor = CodeMirror(document.getElementById('answerEditorContainer'), {
        value: '{}',
        mode: 'javascript',
        theme: 'material',
        lineNumbers: true,
        lineWrapping: true,
        viewportMargin: Infinity
    });
    answerEditor.setSize(null, '100%');
}

// ========== 이벤트 바인딩 함수들 ==========

// 이벤트 바인딩
function bindEvents() {
    // contentCategory 선택 시 해당 카테고리의 타입만 표시
    $('#contentCategory').on('change', function() {
        const categoryId = $(this).val();
        console.log('카테고리 변경:', categoryId);
        
        if (categoryId) {
            // 선택된 카테고리의 타입만 로드
            loadContentTypesByCategory(categoryId);
        } else {
            // 카테고리 선택 해제 시 모든 타입 표시
            loadAllContentTypes();
        }
        
        // 타입 선택 초기화
        $('#contentType').val('');
        
        // 변경 후 자동 검색
        searchContents();
    });
    
    // contentType 변경 시 자동 검색
    $('#contentType').on('change', function() {
        searchContents();
    });
    
    // 코스 선택 시 챕터 로드 및 표시
    $('#contentCourse').on('change', function() {
        const courseId = $(this).val();
        const $chapterSelect = $('#contentChapter');
        
        if (courseId) {
            $.get(`/cp/api/courses/${courseId}/chapters/`, function(data) {
                $chapterSelect.empty().append('<option value="">대단원 선택</option>');
                data.forEach(chapter => {
                    $chapterSelect.append(`<option value="${chapter.id}">${chapter.chapter_title}</option>`);
                });
                $chapterSelect.prop('disabled', false); // 챕터 선택 활성화
            });
        } else {
            $chapterSelect.empty().append('<option value="">대단원 선택</option>');
            $chapterSelect.prop('disabled', true); // 챕터 선택 비활성화
        }
        
        // 변경 후 자동 검색
        searchContents();
    });
    
    // 챕터 변경 시 자동 검색
    $('#contentChapter').on('change', function() {
        searchContents();
    });
    
    // 템플릿 선택 시 내용 적용
    $('#template_select').change(function() {
        const templateId = $(this).val();
        if (templateId) {
            const template = templates.find(t => t.id == templateId);
            if (template) {
                $('#prompt_content').val(template.page || '');
                answerInputEditor.setValue(template.answer || '{}');
                metaEditor.setValue(JSON.stringify(template.meta_data || {}, null, 2));
                tagsEditor.setValue(JSON.stringify(template.tags || {}, null, 2));
            }
        }
    });
    
    // 이미지 업로드 이벤트
    $('#imageUpload').change(function(e) {
        const file = e.target.files[0];
        if (file && currentEditingImage) {
            uploadImage(file, currentEditingImage);
        }
    });
    
    // 템플릿 카테고리 선택 시 해당 카테고리의 타입만 표시
    $('#templateCategory').on('change', function() {
        const categoryId = $(this).val();
        if (categoryId) {
            $.get(`/cp/api/content-types/?category=${categoryId}`, function(data) {
                $('#templateType').empty().append('<option value="">타입 선택</option>');
                data.forEach(type => {
                    $('#templateType').append(`<option value="${type.id}">${type.type_name}</option>`);
                });
            });
        } else {
            loadAllContentTypes();
        }
        
        // 변경 후 자동 검색
        searchTemplates();
    });
    
    // 템플릿 타입 변경 시 자동 검색
    $('#templateType').on('change', function() {
        searchTemplates();
    });
    
    // 초기에 챕터 선택 박스 비활성화
    $('#contentChapter').prop('disabled', true);
    
    // 템플릿 모달의 카테고리에서도 타입 필터링
    $('#templateFormCategory').on('change', function() {
        const categoryId = $(this).val();
        if (categoryId) {
            $.get(`/cp/api/content-types/?category=${categoryId}`, function(data) {
                $('#templateFormType').empty().append('<option value="">타입 선택</option>');
                data.forEach(type => {
                    $('#templateFormType').append(`<option value="${type.id}">${type.type_name}</option>`);
                });
            });
        } else {
            loadAllContentTypes();
        }
    });
    
    // 검색어 입력 시 엔터키로 검색
    $('#contentSearch').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            searchContents();
        }
    });
    
    $('#templateSearch').on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            searchTemplates();
        }
    });
    
    // *** 기존 텍스트 편집 이벤트 제거 ***
    $(document).off('dblclick', '.editable-word');
    $(document).off('click', '.editable-image');
    
    // 새로운 텍스트 편집 이벤트는 별도 함수에서 처리
    bindTextEditingEvents();
}

// 새 콘텐츠 생성 시 초기화
function createNewContent() {
    // 임시 파일 정리
    if (temporaryUploads.length > 0) {
        cleanupTemporaryUploads();
    }
    
    // 이미지 변경사항 취소
    cancelImageChanges();
    
    // 폼 초기화
    $('#title').val('');
    $('#content_type').val('');
    $('#template_select').val('');
    $('#prompt_content').val('');
    
    // 에디터 초기화
    answerInputEditor.setValue('{}');
    answerEditor.setValue('{}');
    metaEditor.setValue('{}');
    tagsEditor.setValue('{}');
    htmlEditorInstance.setValue('');
    
    // 미리보기 초기화
    $('#previewContent').html(`
        <div class="text-center text-gray-400 py-8">
            <i class="fas fa-eye text-6xl mb-4"></i>
            <p>AI로 문항을 생성하면 여기에 표시됩니다</p>
        </div>
    `);
    
    $('#editableContent').html(`
        <p class="text-gray-400 text-center py-8">
            <i class="fas fa-edit text-4xl mb-2 block"></i>
            AI로 문항을 생성하면 편집 가능한 텍스트가 여기에 표시됩니다
        </p>
    `);
    
    // 현재 콘텐츠 초기화
    currentContent = null;
    
    showToast('새 콘텐츠 작성을 시작합니다.', 'success');
}

// ========== 초기화 함수 ==========

// 페이지 로드 시 초기화
$(document).ready(function() {
    console.log('CP Agent 초기화 시작...');
    
    try {
        // 0. 탭 초기화 (첫 번째 탭들을 기본으로 활성화)
        switchTab('contents'); // 문항 리스트 탭을 기본으로
        switchPreviewTab('render'); // 렌더링 탭을 기본으로
        console.log('탭 초기화 완료');
        
        // 1. 에디터 초기화
        initializeEditors();
        console.log('에디터 초기화 완료');
        
        // 2. 이벤트 바인딩 (이미 bindTextEditingEvents() 포함됨)
        bindEvents();
        console.log('이벤트 바인딩 완료');
        
        // 3. 초기 데이터 로드
        loadInitialData();
        console.log('초기 데이터 로드 완료');
        
        // 4. 페이지 이탈 시 임시 파일 정리
        $(window).on('beforeunload', function() {
            if (temporaryUploads.length > 0) {
                cleanupTemporaryUploads();
            }
        });
        
        // 5. 브라우저 뒤로가기/앞으로가기 시 임시 파일 정리
        $(window).on('popstate', function() {
            if (temporaryUploads.length > 0) {
                cleanupTemporaryUploads();
            }
        });
        
        // *** 추가: 새로운 텍스트 편집 시스템 초기화 ***
        setTimeout(() => {
            bindTextEditingEvents();
            console.log('새로운 텍스트 편집 시스템 초기화 완료');
        }, 1000);
        
        console.log('CP Agent 초기화 완료!');
    } catch (error) {
        console.error('CP Agent 초기화 중 오류 발생:', error);
        showToast('페이지 초기화 중 오류가 발생했습니다.', 'error');
    }
});
</script>
{% endblock %}