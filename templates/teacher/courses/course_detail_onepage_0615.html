{% extends 'teacher/base.html' %}

{% block title %}{{ course.subject_name }} - 통합 관리{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* 전체 레이아웃 */
    body {
        background-color: #f0f2f5;
    }

    .main-container {
        display: flex;
        height: calc(100vh - 80px);
        gap: 1rem;
        padding: 1rem;
        max-width: 100%;
    }

    /* 트리 패널 스타일 */
    .tree-panel {
        width: 320px;
        background: #f8f9fa;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: width 0.3s ease;
        position: relative;
        border: 1px solid #e9ecef;
    }

    .tree-panel.collapsed {
        width: 60px;
    }

    /* Tree Header and Content Header unified height */
    .tree-header,
    .content-header {
        height: 60px; /* Desired consistent height */
        display: flex;
        align-items: center; /* Vertically center content */
        padding: 0 1rem; /* Adjust padding as needed */
        border-bottom: 1px solid #e9ecef; /* Existing border-bottom from tree-header */
        background: #f8f9fa; /* Existing background from tree-header, or similar */
    }

    /* Override content-header specific background if needed */
    .content-header {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); /* Original content-header background */
    }

    .tree-header-title {
        display: inline-block;
        transition: opacity 0.3s ease;
    }

    .tree-panel.collapsed .tree-header-title {
        opacity: 0;
        visibility: hidden;
    }

    .tree-header-icon {
        display: none;
        font-size: 1.25rem;
    }

    .tree-panel.collapsed .tree-header-icon {
        display: inline-block;
    }

    .tree-content {
        padding: 0.5rem;
        height: calc(100% - 60px); /* Adjust height based on new header height */
        overflow: auto;
        background: #ffffff;
    }

    /* 트리 스크롤바 스타일 */
    .tree-content::-webkit-scrollbar {
        width: 4px;
        height: 4px;
    }

    .tree-content::-webkit-scrollbar-track {
        background: #f1f3f4;
    }

    .tree-content::-webkit-scrollbar-thumb {
        background: #dadce0;
        border-radius: 2px;
    }

    .tree-content::-webkit-scrollbar-thumb:hover {
        background: #bdc1c6;
    }

    /* 메인 콘텐츠 패널 */
    .content-panel {
        flex: 1;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .content-body {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
    }

    /* 상세 패널 */
    .detail-panel {
        width: 0;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: width 0.3s ease;
    }

    .detail-panel.active {
        width: 400px;
    }

    /* 트리뷰 커스텀 스타일 */
    #courseTree {
        font-family: 'Noto Sans KR', sans-serif;
        font-size: 0.875rem;
    }

    /* 루트 노드의 확장 아이콘 숨기기 */
    .jstree-anchor[aria-level="1"] > .jstree-icon.jstree-ocl {
        display: none;
    }

    /* jstree 아이콘 재정의 및 배치 개선 */
    /* Remove default jstree icon background */
    .jstree-default .jstree-icon.jstree-ocl {
        background: none !important;
        width: auto; /* Let content define width */
        height: auto; /* Let content define height */
        line-height: normal; /* Reset line-height */
        text-align: left; /* Reset text-align */
    }

    /* Custom chevron icons for open/closed states */
    .jstree-default .jstree-ocl:before {
        font-family: 'Font Awesome 6 Free'; /* Use Font Awesome */
        font-weight: 900; /* Solid icon */
        font-size: 1rem; /* Icon size */
        color: #6B7280; /* Icon color (gray) */
        vertical-align: middle; /* Align with text */
        margin-right: 5px; /* Space between icon and text */
        display: inline-block; /* Ensure transform works */
        transition: transform 0.2s ease;
    }

    .jstree-default .jstree-closed > .jstree-ocl:before {
        content: "\f054"; /* fa-chevron-right */
        transform: rotate(0deg);
    }

    .jstree-default .jstree-open > .jstree-ocl:before {
        content: "\f078"; /* fa-chevron-down */
        transform: rotate(0deg); /* No rotation needed if using down arrow */
    }

    /* Ensure icons are aligned with text for all nodes */
    .jstree-anchor {
        display: inline-flex; /* Use flexbox for alignment */
        align-items: center; /* Vertically center items */
        padding: 6px 10px; /* Existing padding */
        border-radius: 6px;
        transition: all 0.2s;
        margin-bottom: 2px;
        line-height: 1.4;
    }

    /* ★★★ [수정] 트리 연결선 스타일 (일관성 및 모양 개선) ★★★ */
    .jstree-default .jstree-node {
        margin-top: 0;
        margin-bottom: 0;
        margin-left: 18px;
        position: relative;
    }
    
    /* Vertical line */
    .jstree-default .jstree-node:not(.jstree-last):after {
        content: '';
        position: absolute;
        left: -12px;
        top: 0;
        width: 1px;
        height: 100%;
        border-left: 1px solid #BDBDBD; /* 선 색상 명확하게 변경 */
    }

    /* Horizontal line */
    .jstree-default .jstree-node:before {
        content: '';
        position: absolute;
        left: -22px; 
        top: 50%;
        width: 10px;
        height: 1px;
        border-top: 1px solid #BDBDBD; /* 선 색상 명확하게 변경 */
    }

    /* Hide lines for the root node */
    .jstree-default > ul > .jstree-node:before,
    .jstree-default > ul > .jstree-node:after {
        display: none;
    }

    /* Existing styles for jstree-anchor, jstree-clicked, etc. */
    .jstree-default .jstree-anchor:hover {
        background: #e8f0fe;
    }

    /* ★★★ [수정] Active(clicked) 상태 스타일 (가독성 개선) ★★★ */
    .jstree-default .jstree-clicked {
        background: #D3E3FD; /* 덜 자극적인 파란색 배경 */
        color: #1967D2; /* 진한 파란색 텍스트로 가독성 확보 */
        box-shadow: 0 2px 8px rgba(26,115,232,0.2);
    }

    .node-chapter .jstree-anchor {
        font-weight: 600;
        color: #1a73e8;
    }

    .node-subchapter .jstree-anchor {
        color: #188038;
    }

    .node-chasi .jstree-anchor {
        color: #7c3aed;
    }

    /* ★★★ [수정] 하위 항목 개수 배지 (원형으로 변경) ★★★ */
    .tree-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #1565c0;
        background: #e3f2fd;
        height: 1.25rem; /* 높이 고정 */
        min-width: 1.25rem; /* 최소 너비 고정 */
        border-radius: 50%; /* 완벽한 원 */
        padding: 0 0.25rem; /* 좌우 패딩 */
        margin-left: 0.5rem;
        line-height: 1; /* 라인 높이 초기화 */
    }

    /* ★★★ [수정] Active 상태의 배지 스타일 (가독성 개선) ★★★ */
    .jstree-clicked .tree-count-badge {
        background: #FFFFFF; /* 흰색 배경 */
        color: #1967D2; /* 파란색 텍스트 */
    }

    /* 카드 스타일 */
    .stat-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: all 0.3s;
        border: 1px solid #e1e4e8;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.12);
    }

    .content-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e1e4e8;
        transition: all 0.2s;
    }

    .content-card:hover {
        border-color: #1a73e8;
        box-shadow: 0 4px 12px rgba(26,115,232,0.15);
    }

    /* 버튼 스타일 */
    .btn-modern {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #1a73e8;
        color: white;
        box-shadow: 0 2px 8px rgba(26,115,232,0.3);
    }

    .btn-primary:hover {
        background: #1557b0;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(26,115,232,0.4);
    }

    .btn-secondary {
        background: #f8f9fa;
        color: #5f6368;
        border: 1px solid #dadce0;
    }

    .btn-secondary:hover {
        background: #f1f3f4;
        border-color: #1a73e8;
        color: #1a73e8;
    }

    /* 로딩 애니메이션 */
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #f3f4f6;
        border-top-color: #1a73e8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 모달 스타일 */
    .modal-backdrop {
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    /* 스크롤바 스타일 */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f3f4;
    }

    ::-webkit-scrollbar-thumb {
        background: #dadce0;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #bdc1c6;
    }

    /* 반응형 */
    @media (max-width: 1024px) {
        .tree-panel {
            width: 280px;
        }
        .detail-panel.active {
            width: 350px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <a href="{% url 'teacher:course_detail' course.id %}" class="text-gray-600 hover:text-gray-900">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{ course.subject_name }}</h1>
                <p class="text-gray-600">{{ course.target }} | 통합 관리 시스템</p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="refreshTree()" class="btn-modern btn-secondary">
                <i class="fas fa-sync-alt"></i>
                새로고침
            </button>
            <a href="{% url 'teacher:contents_create' %}" target="_blank" class="btn-modern btn-primary">
                <i class="fas fa-plus-circle"></i>
                콘텐츠 제작
            </a>
        </div>
    </div>
</div>

<div class="main-container">
    <div class="tree-panel" id="treePanel">
        <div class="tree-header">
            <div class="flex justify-between items-center">
                <div>
                    <i class="fas fa-sitemap tree-header-icon"></i>
                    <span class="tree-header-title font-semibold text-gray-700">코스 구조</span>
                </div>
                <button onclick="toggleTreePanel()" class="text-gray-600 hover:bg-gray-200 p-2 rounded-lg transition">
                    <i class="fas fa-chevron-left" id="treePanelToggle"></i>
                </button>
            </div>
        </div>
        <div class="tree-content">
            <div id="courseTree"></div>
        </div>
    </div>

    <div class="content-panel">
        <div class="content-header">
            <h2 class="text-xl font-semibold text-gray-800" id="contentTitle">
                <i class="fas fa-home mr-2"></i>코스 개요
            </h2>
        </div>
        <div class="content-body" id="contentArea">
            <div class="loading-container">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <div class="detail-panel" id="detailPanel">
        <div class="p-6" id="detailContent">
            </div>
    </div>
</div>

<div id="modal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center">
    <div class="modal-content p-6">
        <div id="modalContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script>
let currentNode = null;
let currentActiveNodeId = null; // Variable to store the ID of the currently selected node for dynamic updates
const courseId = {{ course.id }};

// 페이지 로드 시 초기화
$(document).ready(function() {
    initializeTree();
    loadCourseOverview(); // 초기 코스 개요 로드

    // Event listener for content title input changes
    // Delegate event to document for dynamically loaded content
    $(document).on('input', '#chapterTitleInput, #subchapterTitleInput, #chasiTitleInput', function() {
        const newTitle = $(this).val();
        if (currentActiveNodeId) {
            updateTreeNode(currentActiveNodeId, newTitle);
        }
    });
});

// 트리 초기화
function initializeTree() {
    $('#courseTree').jstree({
        'core': {
            'data': function(node, cb) {
                if(node.id === "#") {
                    // 루트 노드 로드
                    $.ajax({
                        url: "{% url 'teacher:api_course_structure' course.id %}",
                        success: function(data) {
                            cb(formatTreeData(data));
                        },
                        error: function() {
                            showError('코스 구조를 불러올 수 없습니다.');
                        }
                    });
                }
            },
            'check_callback': true,
            'themes': {
                'responsive': true,
                'variant': 'large',
                'stripes': false,
                'dots': false
            }
        },
        'types': {
            'course': {
                'icon': 'fas fa-book text-blue-600'
            },
            'chapter': {
                'icon': 'fas fa-bookmark text-green-600'
            },
            'subchapter': {
                'icon': 'fas fa-file-alt text-yellow-600'
            },
            'chasi': {
                'icon': 'fas fa-clock text-purple-600'
            }
        },
        'plugins': ['types', 'contextmenu', 'state'],
        'contextmenu': {
            'items': customContextMenu
        }
    });

    // 노드 선택 이벤트
    $('#courseTree').on('select_node.jstree', function(e, data) {
        currentNode = data.node;
        currentActiveNodeId = data.node.id; // Store the ID of the selected node
        loadNodeContent(data.node);
    });
}

// 하위 항목 개수 계산 함수
function getChildCount(node) {
    if (node.type === 'course') {
        return node.children ? node.children.length : 0;
    } else if (node.type === 'chapter') {
        return node.children ? node.children.length : 0;
    } else if (node.type === 'subchapter') {
        return node.children ? node.children.length : 0;
    }
    return 0;
}

// 트리 데이터 포맷
function formatTreeData(data) {
    if (!data.structure) {
        console.error('Invalid data structure:', data);
        return [];
    }

    const structure = data.structure;
    let treeData = [{
        'id': 'course_' + structure.course.id,
        'text': structure.course.subject_name + (structure.chapters ? ` <span class="tree-count-badge">${structure.chapters.length}</span>` : ''),
        'type': 'course',
        'state': {'opened': true},
        'data': {'type': 'course', 'id': structure.course.id},
        'children': []
    }];

    if (structure.chapters) {
        structure.chapters.forEach(function(chapter) {
            const chapterChildCount = chapter.subchapters ? chapter.subchapters.length : 0;
            let chapterNode = {
                'id': 'chapter_' + chapter.id,
                'text': chapter.order + '. ' + chapter.title + (chapterChildCount > 0 ? ` <span class="tree-count-badge">${chapterChildCount}</span>` : ''),
                'type': 'chapter',
                'data': {'type': 'chapter', 'id': chapter.id},
                'li_attr': {'class': 'node-chapter'},
                'children': []
            };

            if (chapter.subchapters) {
                chapter.subchapters.forEach(function(subchapter) {
                    const subchapterChildCount = subchapter.chasis ? subchapter.chasis.length : 0;
                    let subchapterNode = {
                        'id': 'subchapter_' + subchapter.id,
                        'text': subchapter.order + '. ' + subchapter.title + (subchapterChildCount > 0 ? ` <span class="tree-count-badge">${subchapterChildCount}</span>` : ''),
                        'type': 'subchapter',
                        'data': {'type': 'subchapter', 'id': subchapter.id},
                        'li_attr': {'class': 'node-subchapter'},
                        'children': []
                    };

                    if (subchapter.chasis) {
                        subchapter.chasis.forEach(function(chasi) {
                            let chasiNode = {
                                'id': 'chasi_' + chasi.id,
                                'text': chasi.order + '. ' + chasi.title + ` <span class="tree-count-badge">${chasi.slide_count}</span>`,
                                'type': 'chasi',
                                'data': {'type': 'chasi', 'id': chasi.id},
                                'li_attr': {'class': 'node-chasi'}
                            };
                            subchapterNode.children.push(chasiNode);
                        });
                    }

                    chapterNode.children.push(subchapterNode);
                });
            }

            treeData[0].children.push(chapterNode);
        });
    }

    return treeData;
}

// Function to update jstree node text
function updateTreeNode(nodeId, newText) {
    if (newText && nodeId) {
        const tree = $('#courseTree').jstree(true);
        const node = tree.get_node(nodeId);
        if (node) {
            // Remove existing order number for update, then re-add if needed
            // Example: '1. Title' -> 'Title' for input, then back to '1. Title' in tree
            // For simplicity, directly update for now. If order is static, no problem.
            // If order changes, full refresh is better. Assuming only title text changes.
            const nodeOrder = node.text.split('. ')[0];
            const updatedText = nodeOrder.match(/^\d+$/) ? `${nodeOrder}. ${newText}` : newText; // Keep order if present
            tree.rename_node(node, updatedText);
        }
    }
}


// 코스 개요 로드
function loadCourseOverview() {
    const html = `
        <div class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-book text-blue-600 text-xl"></i>
                        </div>
                        <span class="text-xs text-gray-500">총계</span>
                    </div>
                    <p class="text-2xl font-bold text-gray-800">{{ stats.total_chapters }}</p>
                    <p class="text-sm text-gray-600">대단원</p>
                </div>

                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-alt text-green-600 text-xl"></i>
                        </div>
                        <span class="text-xs text-gray-500">총계</span>
                    </div>
                    <p class="text-2xl font-bold text-gray-800">{{ stats.total_subchapters }}</p>
                    <p class="text-sm text-gray-600">소단원</p>
                </div>

                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-purple-600 text-xl"></i>
                        </div>
                        <span class="text-xs text-gray-500">총계</span>
                    </div>
                    <p class="text-2xl font-bold text-gray-800">{{ stats.total_chasis }}</p>
                    <p class="text-sm text-gray-600">차시</p>
                </div>

                <div class="stat-card">
                    <div class="flex items-center justify-between mb-2">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-images text-orange-600 text-xl"></i>
                        </div>
                        <span class="text-xs text-gray-500">총계</span>
                    </div>
                    <p class="text-2xl font-bold text-gray-800">{{ stats.total_slides }}</p>
                    <p class="text-sm text-gray-600">슬라이드</p>
                </div>
            </div>

            <div class="content-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-info-circle mr-2"></i>코스 정보
                </h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">과목명</p>
                        <p class="font-medium text-gray-800">{{ course.subject_name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">대상</p>
                        <p class="font-medium text-gray-800">{{ course.target }}</p>
                    </div>
                    {% if course.description %}
                    <div>
                        <p class="text-sm text-gray-600">설명</p>
                        <p class="text-gray-700">{{ course.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="content-card bg-gradient-to-r from-blue-50 to-purple-50 border-0">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-lightbulb mr-2"></i>빠른 사용 가이드
                </h3>
                <ul class="space-y-2 text-gray-700">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                        <span>왼쪽 트리에서 항목을 클릭하여 상세 정보를 확인하세요</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                        <span>우클릭 메뉴로 항목을 추가, 수정, 삭제할 수 있습니다</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                        <span>드래그 앤 드롭으로 순서를 변경할 수 있습니다</span>
                    </li>
                </ul>
            </div>
        </div>
    `;

    $('#contentTitle').html('<i class="fas fa-home mr-2"></i>코스 개요');
    $('#contentArea').html(html);
}

// 노드 콘텐츠 로드
function loadNodeContent(node) {
    const type = node.data.type;
    const id = node.data.id;

    $('#contentArea').html('<div class="loading-container"><div class="loading-spinner"></div></div>');

    if (type === 'course') {
        loadCourseOverview();
        return;
    }

    // API 호출
    $.ajax({
        url: `/teacher/api/${type}/${id}/detail/`,
        method: 'GET',
        success: function(response) {
            displayContent(type, response);
        },
        error: function(xhr) {
            $('#contentArea').html(`
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-circle text-red-500 text-5xl mb-4"></i>
                    <p class="text-gray-700">콘텐츠를 불러올 수 없습니다.</p>
                </div>
            `);
        }
    });
}

// 콘텐츠 표시
function displayContent(type, data) {
    let html = '';
    let title = '';

    switch(type) {
        case 'chapter':
            // The displayed title will be dynamic from the input below
            title = `<i class="fas fa-bookmark mr-2"></i>대단원 상세`;
            html = renderChapterDetail(data);
            break;
        case 'subchapter':
            title = `<i class="fas fa-file-alt mr-2"></i>소단원 상세`;
            html = renderSubchapterDetail(data);
            break;
        case 'chasi':
            title = `<i class="fas fa-clock mr-2"></i>차시 상세`;
            html = renderChasiDetail(data);
            break;
    }

    $('#contentTitle').html(title);
    $('#contentArea').html(html);
}

// 대단원 상세 렌더링
function renderChapterDetail(data) {
    return `
        <div>
            <div class="flex justify-end mb-6">
                <button onclick="showAddSubchapterForm(${data.id})" class="btn-modern btn-primary">
                    <i class="fas fa-plus"></i>
                    소단원 추가
                </button>
            </div>
            
            <div class="content-card mb-6">
                <h3 class="font-semibold text-gray-800 mb-2">대단원 정보</h3>
                <div class="mb-4">
                    <label for="chapterTitleInput" class="block text-sm font-medium text-gray-700">제목</label>
                    <input type="text" id="chapterTitleInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" value="${data.chapter_title}">
                </div>
                ${data.description ? `
                <div class="mt-4">
                    <h3 class="font-semibold text-gray-800 mb-2">설명</h3>
                    <p class="text-gray-700">${data.description}</p>
                </div>
                ` : ''}
            </div>
            
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">소단원 목록</h3>
                ${data.subchapters && data.subchapters.length > 0 ? `
                    <div class="space-y-3">
                        ${data.subchapters.map(sc => `
                            <div class="content-card">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${sc.order}. ${sc.title}</h4>
                                        <p class="text-sm text-gray-600 mt-1">
                                            <i class="fas fa-clock mr-1"></i>${sc.chasi_count}개 차시
                                        </p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="editSubchapter(${sc.id})" class="text-gray-600 hover:text-blue-600 transition">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteSubchapter(${sc.id})" class="text-gray-600 hover:text-red-600 transition">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="text-center py-12 bg-gray-50 rounded-lg">
                        <i class="fas fa-folder-open text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">소단원이 없습니다.</p>
                    </div>
                `}
            </div>
        </div>
    `;
}

// 소단원 상세 렌더링
function renderSubchapterDetail(data) {
    return `
        <div>
            <div class="flex justify-end mb-6">
                <button onclick="showAddChasiForm(${data.id})" class="btn-modern btn-primary">
                    <i class="fas fa-plus"></i>
                    차시 추가
                </button>
            </div>
            
            <div class="content-card mb-6">
                <h3 class="font-semibold text-gray-800 mb-2">소단원 정보</h3>
                <div class="mb-4">
                    <label for="subchapterTitleInput" class="block text-sm font-medium text-gray-700">제목</label>
                    <input type="text" id="subchapterTitleInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" value="${data.sub_chapter_title}">
                </div>
                ${data.description ? `
                <div class="mt-4">
                    <h3 class="font-semibold text-gray-800 mb-2">설명</h3>
                    <p class="text-gray-700">${data.description}</p>
                </div>
                ` : ''}
            </div>
            
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">차시 목록</h3>
                ${data.chasis && data.chasis.length > 0 ? `
                    <div class="space-y-3">
                        ${data.chasis.map(ch => `
                            <div class="content-card">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${ch.order}. ${ch.title}</h4>
                                        <div class="flex items-center space-x-4 mt-1 text-sm text-gray-600">
                                            <span><i class="fas fa-images mr-1"></i>${ch.slide_count}개 슬라이드</span>
                                            <span><i class="fas fa-clock mr-1"></i>${ch.duration}분</span>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="{% url 'teacher:chasi_slide_manage' 0 %}".replace('0', ${ch.id}) 
                                           class="text-green-600 hover:text-green-700 transition">
                                            <i class="fas fa-images"></i>
                                        </a>
                                        <button onclick="editChasi(${ch.id})" class="text-gray-600 hover:text-blue-600 transition">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteChasi(${ch.id})" class="text-gray-600 hover:text-red-600 transition">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="text-center py-12 bg-gray-50 rounded-lg">
                        <i class="fas fa-clock text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">차시가 없습니다.</p>
                    </div>
                `}
            </div>
        </div>
    `;
}

// 차시 상세 렌더링
function renderChasiDetail(data) {
    return `
        <div>
            <div class="flex justify-end mb-6">
                <a href="{% url 'teacher:chasi_slide_manage' 0 %}".replace('0', ${data.id}) 
                   class="btn-modern btn-primary">
                    <i class="fas fa-images"></i>
                    슬라이드 관리
                </a>
            </div>
            
            <div class="content-card mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">차시 정보</h3>
                <div class="mb-4">
                    <label for="chasiTitleInput" class="block text-sm font-medium text-gray-700">제목</label>
                    <input type="text" id="chasiTitleInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" value="${data.chasi_title}">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">수업 시간</p>
                        <p class="font-medium text-gray-800">${data.duration_minutes}분</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">슬라이드 수</p>
                        <p class="font-medium text-gray-800">${data.slides ? data.slides.length : 0}개</p>
                    </div>
                </div>
                ${data.learning_objectives ? `
                    <div class="mt-4">
                        <p class="text-sm text-gray-600">학습 목표</p>
                        <p class="text-gray-700 mt-1">${data.learning_objectives}</p>
                    </div>
                ` : ''}
                ${data.description ? `
                    <div class="mt-4">
                        <p class="text-sm text-gray-600">설명</p>
                        <p class="text-gray-700 mt-1">${data.description}</p>
                    </div>
                ` : ''}
            </div>
            
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">슬라이드 목록</h3>
                ${data.slides && data.slides.length > 0 ? `
                    <div class="space-y-3">
                        ${data.slides.map(slide => `
                            <div class="content-card">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">슬라이드 ${slide.slide_number}</h4>
                                        <p class="text-sm text-gray-600 mt-1">
                                            <span class="inline-block bg-gray-100 px-2 py-1 rounded text-xs">
                                                ${slide.content_type}
                                            </span>
                                            <span class="ml-2">${slide.content_title}</span>
                                        </p>
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        ${slide.estimated_time}분
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="text-center py-12 bg-gray-50 rounded-lg">
                        <i class="fas fa-images text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">슬라이드가 없습니다.</p>
                    </div>
                `}
            </div>
        </div>
    `;
}

// 컨텍스트 메뉴
function customContextMenu(node) {
    const type = node.data.type;
    const items = {};

    if (type === 'course') {
        items.addChapter = {
            label: '대단원 추가',
            action: function() { showAddChapterForm(); }
        };
    } else if (type === 'chapter') {
        items.addSubchapter = {
            label: '소단원 추가',
            action: function() { showAddSubchapterForm(node.data.id); }
        };
        items.edit = {
            label: '수정',
            action: function() { editChapter(node.data.id); }
        };
        items.delete = {
            label: '삭제',
            action: function() { deleteChapter(node.data.id); }
        };
    } else if (type === 'subchapter') {
        items.addChasi = {
            label: '차시 추가',
            action: function() { showAddChasiForm(node.data.id); }
        };
        items.edit = {
            label: '수정',
            action: function() { editSubchapter(node.data.id); }
        };
        items.delete = {
            label: '삭제',
            action: function() { deleteSubchapter(node.data.id); }
        };
    } else if (type === 'chasi') {
        items.manageSlides = {
            label: '슬라이드 관리',
            action: function() {
                window.location.href = "{% url 'teacher:chasi_slide_manage' 0 %}".replace('0', node.data.id);
            }
        };
        items.edit = {
            label: '수정',
            action: function() { editChasi(node.data.id); }
        };
        items.delete = {
            label: '삭제',
            action: function() { deleteChasi(node.data.id); }
        };
    }

    return items;
}

// 트리 새로고침
function refreshTree() {
    $('#courseTree').jstree('refresh');
}

// 트리 패널 토글
function toggleTreePanel() {
    const panel = $('#treePanel');
    const icon = $('#treePanelToggle');

    panel.toggleClass('collapsed');
    if (panel.hasClass('collapsed')) {
        icon.removeClass('fa-chevron-left').addClass('fa-chevron-right');
    } else {
        icon.removeClass('fa-chevron-right').addClass('fa-chevron-left');
    }
}

// 모달 관련 함수
function showModal(content) {
    $('#modalContent').html(content);
    $('#modal').removeClass('hidden');
}

function closeModal() {
    $('#modal').addClass('hidden');
}

// ESC 키로 모달 닫기
$(document).keyup(function(e) {
    if (e.key === "Escape") {
        closeModal();
    }
});

// 모달 배경 클릭 시 닫기
$('#modal').on('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// 성공/에러 메시지
function showSuccess(message) {
    const alertHtml = `
        <div class="fixed top-20 right-6 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg shadow-lg z-50" id="successAlert">
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-3"></i>
                <p>${message}</p>
            </div>
        </div>
    `;
    $('body').append(alertHtml);
    setTimeout(() => $('#successAlert').fadeOut(() => $('#successAlert').remove()), 3000);
}

function showError(message) {
    const alertHtml = `
        <div class="fixed top-20 right-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg z-50" id="errorAlert">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-3"></i>
                <p>${message}</p>
            </div>
        </div>
    `;
    $('body').append(alertHtml);
    setTimeout(() => $('#errorAlert').fadeOut(() => $('#errorAlert').remove()), 5000);
}
</script>
{% endblock %}