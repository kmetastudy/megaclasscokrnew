<script>
// ê°„ì†Œí™”ëœ ë“œë˜ê·¸ì•¤ë“œë¡­ í€´ì¦ˆ JavaScript
$(document).ready(function() {
    // ì „ì—­ ë³€ìˆ˜
    let dragIsAnswered = false;
    let currentState = {};
    let draggedItem = null;
    let extractedItems = [];
    let questionText = '';
    
    // ë“œë˜ê·¸ í€´ì¦ˆ ì´ˆê¸°í™”
    function initializeDragQuiz() {
        if ($('#drag-quiz-container').length === 0) return;
        
        console.log('ğŸš€ ë“œë˜ê·¸ í€´ì¦ˆ ì´ˆê¸°í™” ì‹œì‘');
        
        // 1. ê¸°ì¡´ HTMLì—ì„œ ë°ì´í„° ì¶”ì¶œ
        extractQuestionAndItems();
        
        // 2. í…Œë§ˆ ì ìš©
        const theme = detectTheme(questionText);
        applyTheme(theme);
        
        // 3. ë“œë˜ê·¸ ì•„ì´í…œ ìƒì„±
        createDragItems();
        
        // 4. ë“œë¡­ì¡´ ì´ë²¤íŠ¸ ì„¤ì •
        setupDropZones();
        
        // 5. ê¸°ì¡´ ë‹µì•ˆ ë³µì›
        restoreAnswer();
        
        console.log('âœ… ë“œë˜ê·¸ í€´ì¦ˆ ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ê°„ì†Œí™”ëœ ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜
    function extractQuestionAndItems() {
        // ë¬¸ì œ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        questionText = $('.quiz-container .question-text').first().text().trim() || 
                      $('#question-text').text().trim() || 
                      "ë“œë˜ê·¸ì•¤ë“œë¡­ ë¬¸ì œë¥¼ í’€ì–´ë³´ì„¸ìš”!";
        
        // ë“œë˜ê·¸ ì•„ì´í…œ ì¶”ì¶œ (options-containerì—ì„œ)
        extractedItems = [];
        $('.options-container .option-button').each(function(index) {
            const itemText = $(this).find('.option-text').text().trim();
            const dataClicked = $(this).attr('data-clicked') || (index + 1).toString();
            
            if (itemText) {
                extractedItems.push({
                    id: `item${index + 1}`,
                    text: itemText,
                    value: dataClicked
                });
            }
        });
        
        // ìƒˆë¡œìš´ ë¬¸ì œ ë°•ìŠ¤ì— í…ìŠ¤íŠ¸ ì„¤ì • (HTML íƒœê·¸ í¬í•¨)
        const originalHTML = $('.quiz-container .question-text').first().html() || questionText;
        $('#question-text').html(originalHTML);
        
        console.log('ğŸ“ ì¶”ì¶œëœ ë¬¸ì œ:', questionText);
        console.log('ğŸ“‹ ì¶”ì¶œëœ ì•„ì´í…œ:', extractedItems);
    }
    
    // ê°„ì†Œí™”ëœ í…Œë§ˆ ê°ì§€
    function detectTheme(text) {
        const themes = {
            science: ['ê³¼í•™', 'ì‹¤í—˜', 'í™”í•™', 'ë¬¼ë¦¬', 'ìƒë¬¼'],
            math: ['ìˆ˜í•™', 'ê³„ì‚°', 'ê³µì‹', 'ë°©ì •ì‹'],
            social: ['ì‚¬íšŒ', 'ì—­ì‚¬', 'ì •ì¹˜', 'ê²½ì œ', 'ë¯¼ì£¼ì£¼ì˜'],
            default: []
        };
        
        for (const [theme, keywords] of Object.entries(themes)) {
            if (keywords.some(keyword => text.includes(keyword))) {
                return theme;
            }
        }
        return 'default';
    }
    
    // í…Œë§ˆ ì ìš©
    function applyTheme(theme) {
        $('#drag-quiz-container').attr('data-theme', theme);
        
        const themeNames = {
            science: 'ê³¼í•™',
            math: 'ìˆ˜í•™', 
            social: 'ì‚¬íšŒ',
            default: 'ì¼ë°˜'
        };
        $('#quiz-title').text(`${themeNames[theme]} ë“œë˜ê·¸ì•¤ë“œë¡­ í€´ì¦ˆ`);
    }
    
    // ë“œë˜ê·¸ ì•„ì´í…œ ìƒì„±
    function createDragItems() {
        const container = $('#drag-container');
        container.empty();
        
        extractedItems.forEach((item, index) => {
            const itemElement = $(`
                <div class="drag-item" 
                     id="${item.id}" 
                     draggable="true" 
                     data-value="${item.value}"
                     tabindex="0">
                    ${item.text}
                </div>
            `);
            
            // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            itemElement.on('dragstart', handleDragStart);
            itemElement.on('dragend', handleDragEnd);
            
            // í„°ì¹˜ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            itemElement.on('touchstart', handleTouchStart);
            itemElement.on('touchmove', handleTouchMove);
            itemElement.on('touchend', handleTouchEnd);
            
            container.append(itemElement);
        });
    }
    
    // ë“œë¡­ì¡´ ì´ë²¤íŠ¸ ì„¤ì •
    function setupDropZones() {
        $(document).on('dragover', '.drop-zone', function(e) {
            e.preventDefault();
        });
        
        $(document).on('dragenter', '.drop-zone', function(e) {
            e.preventDefault();
            $(this).addClass('highlight');
        });
        
        $(document).on('dragleave', '.drop-zone', function(e) {
            $(this).removeClass('highlight');
        });
        
        $(document).on('drop', '.drop-zone', handleDrop);
    }
    
    // ë“œë˜ê·¸ ì‹œì‘
    function handleDragStart(e) {
        draggedItem = this;
        $(this).addClass('dragging');
        e.originalEvent.dataTransfer.setData('text/plain', this.id);
        console.log('ğŸ¯ ë“œë˜ê·¸ ì‹œì‘:', $(this).text());
    }
    
    // ë“œë˜ê·¸ ì¢…ë£Œ
    function handleDragEnd(e) {
        $(this).removeClass('dragging');
        $('.drop-zone').removeClass('highlight');
    }
    
    // ë“œë¡­ ì²˜ë¦¬
    function handleDrop(e) {
        e.preventDefault();
        
        if (dragIsAnswered) return;
        
        const itemId = e.originalEvent.dataTransfer.getData('text/plain');
        const item = $('#' + itemId);
        const zoneId = $(this).attr('data-zone-id');
        
        if (!zoneId) {
            console.error('âŒ ë“œë¡­ì¡´ì— data-zone-idê°€ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        console.log('ğŸ“¥ ë“œë¡­ ì„±ê³µ:', item.text(), 'â†’', zoneId);
        
        // ê¸°ì¡´ ì•„ì´í…œì´ ìˆë‹¤ë©´ ë³µì›
        if ($(this).attr('data-filled-by')) {
            const existingItemId = $(this).attr('data-filled-by');
            $('#' + existingItemId).removeClass('placed').show();
        }
        
        // ìƒˆ ì•„ì´í…œ ë°°ì¹˜
        $(this)
            .text(item.text())
            .addClass('filled')
            .removeClass('highlight')
            .attr('data-filled-by', itemId);
        
        item.addClass('placed').hide();
        
        // ìƒíƒœ ì €ì¥
        currentState[zoneId] = item.attr('data-value');
        
        console.log('ğŸ’¾ í˜„ì¬ ìƒíƒœ:', currentState);
        
        // ì™„ë£Œ í™•ì¸
        setTimeout(() => checkCompletion(), 300);
    }
    
    // í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ê°„ì†Œí™”)
    let touchItem = null;
    
    function handleTouchStart(e) {
        if (dragIsAnswered) return;
        touchItem = this;
        $(this).addClass('dragging');
        e.preventDefault();
    }
    
    function handleTouchMove(e) {
        if (!touchItem) return;
        e.preventDefault();
        
        const touch = e.originalEvent.touches[0];
        $(touchItem).css({
            position: 'fixed',
            left: touch.clientX - 60 + 'px',
            top: touch.clientY - 30 + 'px',
            zIndex: 1000,
            pointerEvents: 'none'
        });
        
        // ë“œë¡­ì¡´ í•˜ì´ë¼ì´íŠ¸
        const element = document.elementFromPoint(touch.clientX, touch.clientY);
        $('.drop-zone').removeClass('highlight');
        if (element && $(element).hasClass('drop-zone')) {
            $(element).addClass('highlight');
        }
    }
    
    function handleTouchEnd(e) {
        if (!touchItem) return;
        
        const touch = e.originalEvent.changedTouches[0];
        const element = document.elementFromPoint(touch.clientX, touch.clientY);
        
        // ìŠ¤íƒ€ì¼ ë³µì›
        $(touchItem).css({
            position: '',
            left: '',
            top: '',
            zIndex: '',
            pointerEvents: ''
        }).removeClass('dragging');
        
        // ë“œë¡­ ì²˜ë¦¬
        if (element && $(element).hasClass('drop-zone')) {
            const fakeEvent = {
                preventDefault: () => {},
                originalEvent: {
                    dataTransfer: {
                        getData: () => touchItem.id
                    }
                }
            };
            handleDrop.call(element, fakeEvent);
        }
        
        $('.drop-zone').removeClass('highlight');
        touchItem = null;
    }
    
    // ì™„ë£Œ í™•ì¸
    function checkCompletion() {
        if (dragIsAnswered) return;
        
        const totalZones = $('.drop-zone').length;
        const filledZones = Object.keys(currentState).length;
        
        console.log(`ğŸ“Š ì™„ë£Œ í™•ì¸: ${filledZones}/${totalZones}`);
        
        if (filledZones >= totalZones && totalZones > 0) {
            submitAnswer();
        }
    }
    
    // ë‹µì•ˆ ì œì¶œ
    function submitAnswer() {
        if (dragIsAnswered) return;
        
        dragIsAnswered = true;
        console.log('ğŸ“¤ ë‹µì•ˆ ì œì¶œ:', currentState);
        
        const slideId = '{{ slide.id }}';
        const contentId = '{{ slide.content.id }}';
        
        $.ajax({
            url: '{% url "student:check_answer" %}',
            type: 'POST',
            data: {
                'content_id': contentId,
                'slide_id': slideId,
                'student_answer': JSON.stringify(currentState),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('âœ… ì±„ì  ê²°ê³¼:', response);
                handleResult(response);
            },
            error: function() {
                console.error('âŒ ì±„ì  ì˜¤ë¥˜');
                showToast('ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                resetQuiz();
            }
        });
    }
    
    // ê²°ê³¼ ì²˜ë¦¬
    function handleResult(response) {
        $('.drop-zone').each(function() {
            const zoneId = $(this).attr('data-zone-id');
            if (zoneId && currentState[zoneId]) {
                $(this).addClass(response.is_correct ? 'correct' : 'incorrect');
            }
        });
        
        setTimeout(() => {
            if (response.is_correct) {
                showToast('ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!', 'success');
                showFeedback('correct', 'ì •ë‹µì…ë‹ˆë‹¤! ì˜í–ˆì–´ìš”!');
                $('#submit-btn, #resubmit-btn').hide();
            } else {
                showToast('ğŸ’ª ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!', 'error');
                showFeedback('incorrect', 'í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!');
                $('#submit-btn').hide();
                $('#resubmit-btn').show();
            }
            
            updateSubmissionStatus(response);
        }, 300);
        
        // 8ì´ˆ í›„ ì¬ì‹œë„ ê°€ëŠ¥ (ì˜¤ë‹µì¸ ê²½ìš°)
        if (!response.is_correct) {
            setTimeout(() => resetForRetry(), 8000);
        }
    }
    
    // í”¼ë“œë°± í‘œì‹œ
    function showFeedback(type, message) {
        const feedbackElement = $(`#feedback-${type}`);
        feedbackElement.html(message).addClass('show');
        
        // í•´ì„¤ì´ ìˆìœ¼ë©´ ì¶”ê°€
        if (type === 'correct' && response.solution) {
            setTimeout(() => {
                feedbackElement.append(`
                    <div class="solution-box">
                        <strong>ğŸ’¡ í•´ì„¤:</strong><br>
                        ${response.solution}
                    </div>
                `);
            }, 1000);
        }
    }
    
    // ì¬ì‹œë„ë¥¼ ìœ„í•œ ë¦¬ì…‹
    function resetForRetry() {
        {% if not is_already_correct %}
        console.log('ğŸ”„ ì¬ì‹œë„ ì¤€ë¹„');
        
        dragIsAnswered = false;
        currentState = {};
        
        $('.drop-zone').removeClass('filled highlight correct incorrect')
                       .removeAttr('data-filled-by')
                       .text('ë¹ˆì¹¸');
        
        $('.drag-item').removeClass('placed').show();
        $('#feedback-correct, #feedback-incorrect').removeClass('show');
        
        console.log('âœ… ì¬ì‹œë„ ì¤€ë¹„ ì™„ë£Œ');
        {% endif %}
    }
    
    // ì™„ì „ ë¦¬ì…‹
    function resetQuiz() {
        dragIsAnswered = false;
        currentState = {};
        draggedItem = null;
        touchItem = null;
        
        $('.drop-zone').removeClass('filled highlight correct incorrect')
                       .removeAttr('data-filled-by')
                       .text('ë¹ˆì¹¸');
        
        $('.drag-item').removeClass('placed dragging').show();
        $('#feedback-correct, #feedback-incorrect').removeClass('show');
        
        console.log('ğŸ”„ í€´ì¦ˆ ë¦¬ì…‹ ì™„ë£Œ');
    }
    
    // ê¸°ì¡´ ë‹µì•ˆ ë³µì›
    function restoreAnswer() {
        {% if existing_answer and slide.content_type.type_name == 'drag' %}
        try {
            const rawAnswer = '{{ existing_answer.answer|escapejs|default:"{}" }}';
            const answerData = JSON.parse(rawAnswer.replace(/'/g, '"'));
            
            if (answerData.selected_answer) {
                currentState = answerData.selected_answer;
                dragIsAnswered = true;
                
                // ìƒíƒœ ë³µì›
                Object.keys(currentState).forEach(zoneId => {
                    const itemValue = currentState[zoneId];
                    const zone = $(`.drop-zone[data-zone-id="${zoneId}"]`);
                    const item = $(`.drag-item[data-value="${itemValue}"]`);
                    
                    if (zone.length && item.length) {
                        zone.text(item.text())
                            .addClass('filled')
                            .attr('data-filled-by', item.attr('id'));
                        item.addClass('placed').hide();
                    }
                });
                
                setTimeout(() => {
                    {% if is_already_correct %}
                    $('.drop-zone.filled').addClass('correct');
                    $('#submit-btn, #resubmit-btn').hide();
                    showFeedback('correct', 'ğŸ‰ ì´ì „ ì œì¶œ: ì •ë‹µì…ë‹ˆë‹¤!');
                    {% else %}
                    $('.drop-zone.filled').addClass('incorrect');
                    $('#submit-btn').hide();
                    $('#resubmit-btn').show();
                    showFeedback('incorrect', 'ğŸ’ª ì´ì „ ì œì¶œ: ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!');
                    {% endif %}
                }, 300);
            }
        } catch (e) {
            console.error('ë‹µì•ˆ ë³µì› ì˜¤ë¥˜:', e);
        }
        {% endif %}
    }
    
    // ì œì¶œ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateSubmissionStatus(response) {
        const wrapper = $('#submission-status-wrapper');
        const statusIcon = response.is_correct
            ? '<span class="text-green-600"><i class="fas fa-check-circle"></i> ì •ë‹µ</span>'
            : '<span class="text-red-600"><i class="fas fa-times-circle"></i> ì˜¤ë‹µ</span>';
        
        wrapper.html(`
            <div class="mt-4 text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>
                ë§ˆì§€ë§‰ ì œì¶œ: ${response.submitted_at || 'ë°©ê¸ˆ ì „'}
                ${statusIcon}
            </div>
        `);
    }
    
    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(message, type = 'info') {
        // ê¸°ì¡´ í† ìŠ¤íŠ¸ í•¨ìˆ˜ ì‚¬ìš©
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
        } else {
            console.log(`Toast [${type}]: ${message}`);
        }
    }
    
    // ì¬ì œì¶œ ë²„íŠ¼ ì´ë²¤íŠ¸
    $(document).on('click', '#resubmit-btn', function() {
        if ('{{ slide.content_type.type_name }}' === 'drag') {
            resetForRetry();
        }
    });
    
    // ì´ˆê¸°í™” ì‹¤í–‰
    initializeDragQuiz();
});
</script>