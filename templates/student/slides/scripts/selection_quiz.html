<script>
$(document).ready(function() {
    // Selection í€´ì¦ˆ ì „ìš© ì„¤ì •
    const SELECTION_CONFIG = {
        themes: {
            health: {
                keywords: ['ê±´ê°•', 'ë§ˆìŒ', 'ìŠ¤íŠ¸ë ˆìŠ¤', 'ìš´ë™', 'ì˜ì–‘', 'ìˆ˜ë©´', 'ê´€ë¦¬', 'íë§', 'ì›°ë¹™', 'ì‹¬ë¦¬'],
                emojis: ['ğŸ’š', 'ğŸƒâ€â™‚ï¸', 'ğŸ§˜â€â™€ï¸', 'ğŸ’ª', 'ğŸŒ±', 'ğŸ˜Œ', 'â¤ï¸', 'ğŸ', 'ğŸ¥', 'ğŸ’†â€â™€ï¸'],
                particles: ['ğŸ’š', 'ğŸƒâ€â™‚ï¸', 'ğŸ§˜â€â™€ï¸', 'ğŸ’ª', 'ğŸŒ±', 'âœ¨'],
                colors: ['rgba(255, 107, 107, 0.3)', 'rgba(78, 205, 196, 0.3)', 'rgba(69, 183, 209, 0.3)']
            },
            sports: {
                keywords: ['ìš´ë™', 'ìŠ¤í¬ì¸ ', 'ì¶•êµ¬', 'ë†êµ¬', 'ì•¼êµ¬', 'í…Œë‹ˆìŠ¤', 'ìˆ˜ì˜', 'ë‹¬ë¦¬ê¸°', 'ì²´ìœ¡', 'ê²½ê¸°'],
                emojis: ['âš½', 'ğŸ€', 'ğŸˆ', 'ğŸ¾', 'ğŸ', 'ğŸ“', 'ğŸ¸', 'ğŸ‘', 'ğŸ’', 'ğŸ¥…'],
                particles: ['âš½', 'ğŸ€', 'ğŸ†', 'ğŸ¥‡', 'ğŸƒ', 'ğŸ’ª'],
                colors: ['rgba(255, 107, 53, 0.3)', 'rgba(247, 147, 30, 0.3)', 'rgba(255, 210, 63, 0.3)']
            },
            science: {
                keywords: ['ê³¼í•™', 'ì‹¤í—˜', 'í™”í•™', 'ë¬¼ë¦¬', 'ìƒë¬¼', 'ì—°êµ¬', 'ì´ë¡ ', 'ë²•ì¹™', 'ê°€ì„¤'],
                emojis: ['ğŸ”¬', 'âš—ï¸', 'ğŸ§ª', 'ğŸ”­', 'ğŸŒ¡ï¸', 'âš›ï¸', 'ğŸ§¬', 'ğŸ’Š', 'ğŸ¦ ', 'ğŸŒŒ'],
                particles: ['ğŸ”¬', 'âš—ï¸', 'ğŸ§ª', 'âš›ï¸', 'ğŸ’¡', 'ğŸŒŸ'],
                colors: ['rgba(33, 150, 243, 0.3)', 'rgba(3, 218, 198, 0.3)', 'rgba(0, 188, 212, 0.3)']
            },
            nature: {
                keywords: ['ìì—°', 'í™˜ê²½', 'ë‚˜ë¬´', 'ê½ƒ', 'ë™ë¬¼', 'ì‹ë¬¼', 'ìƒíƒœ', 'ìˆ²', 'ë°”ë‹¤'],
                emojis: ['ğŸŒ±', 'ğŸŒ¸', 'ğŸŒ³', 'ğŸ¦‹', 'ğŸ', 'ğŸ›', 'ğŸŒº', 'ğŸƒ', 'ğŸŒ¿', 'ğŸŒ'],
                particles: ['ğŸŒ±', 'ğŸŒ¸', 'ğŸ¦‹', 'ğŸƒ', 'ğŸŒ¿', 'âœ¨'],
                colors: ['rgba(76, 175, 80, 0.3)', 'rgba(139, 195, 74, 0.3)', 'rgba(205, 220, 57, 0.3)']
            }
        },
        
        correctMessages: [
            "ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ğŸ‘ ì •ë§ ì˜í–ˆì–´ìš”!",
            "ì™„ë²½í•´ìš”! ğŸŒŸ í›Œë¥­í•œ ë‹µë³€ì´ì—ˆìŠµë‹ˆë‹¤!",
            "ë§ìŠµë‹ˆë‹¤! ğŸŠ ëŒ€ë‹¨í•œ ì‹¤ë ¥ì´ë„¤ìš”!",
            "ì •ë‹µì´ì—ìš”! ğŸ’¯ ìµœê³ ì˜ˆìš”!"
        ],
        
        incorrectMessages: [
            "ğŸ¤” ì•„ì§ ì •ë‹µì´ ì•„ë‹ˆì—ìš”! ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”! ğŸ˜Š",
            "ê´œì°®ì•„ìš”! ğŸ’ª í•œ ë²ˆ ë” ë„ì „í•´ë³´ì„¸ìš”!",
            "ì¡°ê¸ˆ ë” ìƒê°í•´ë³¼ê¹Œìš”? ğŸ§ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!",
            "ì•„ì‰¬ì›Œìš”! ğŸ˜Š ë‹¤ì‹œ í•œë²ˆ í’€ì–´ë³´ì„¸ìš”!"
        ]
    };
    
    let selectionIsAnswered = false;
    let selectionSelectedAnswer = null;
    let extractedChoices = [];
    let questionText = '';
    
    // Selection í€´ì¦ˆ ì´ˆê¸°í™”
    function initializeSelectionQuiz() {
        if ($('#selection-quiz-container').length === 0) return;
        
        console.log('Selection í€´ì¦ˆ ì´ˆê¸°í™” ì‹œì‘');
        
        // ê¸°ì¡´ HTMLì—ì„œ ë¬¸ì œì™€ ì„ íƒì§€ ì¶”ì¶œ
        extractQuestionAndChoices();
        
        // ë¬¸ì œ í…ìŠ¤íŠ¸ ë¶„ì„í•˜ì—¬ í…Œë§ˆ ì„¤ì •
        const theme = detectThemeFromText(questionText);
        applySelectionTheme(theme);
        
        // íŒŒí‹°í´ ìƒì„±
        createSelectionParticles(theme);
        
        // ì„ íƒì§€ ë²„íŠ¼ ìƒì„±
        createChoiceButtons();
        
        // ê¸°ì¡´ ë‹µì•ˆ ë³µì›
        restoreSelectionAnswer();
        
        console.log('Selection í€´ì¦ˆ ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ê¸°ì¡´ HTMLì—ì„œ ë¬¸ì œì™€ ì„ íƒì§€ ì¶”ì¶œ
    function extractQuestionAndChoices() {
        // ë¬¸ì œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        const questionSelectors = [
            '.quiz-container .question-text',
            '.quiz-container h1',
            '.question-box h1',
            '.question-text'
        ];
        
        for (let selector of questionSelectors) {
            const element = $(selector);
            if (element.length > 0 && element.text().trim()) {
                questionText = element.text().trim();
                break;
            }
        }
        
        // ì„ íƒì§€ ì¶”ì¶œ
        extractedChoices = [];
        $('.options-container .option-button').each(function(index) {
            const choiceText = $(this).find('.option-text').text().trim();
            const dataClicked = $(this).attr('data-clicked');
            
            if (choiceText) {
                extractedChoices.push({
                    index: index,
                    text: choiceText,
                    value: dataClicked || (index + 1).toString()
                });
            }
        });
        
        // ìƒˆë¡œìš´ ë¬¸ì œ ë°•ìŠ¤ì— í…ìŠ¤íŠ¸ ì„¤ì •
        $('#question-text').text(questionText || "ì„ íƒí˜• ë¬¸ì œë¥¼ í’€ì–´ë³´ì„¸ìš”!");
        
        console.log('ì¶”ì¶œëœ ë¬¸ì œ:', questionText);
        console.log('ì¶”ì¶œëœ ì„ íƒì§€:', extractedChoices);
    }
    
    // ì„ íƒì§€ ë²„íŠ¼ ìƒì„±
    function createChoiceButtons() {
        const container = $('#choices-container');
        container.empty();
        
        extractedChoices.forEach((choice, index) => {
            const button = $('<button>')
                .addClass(`choice-button choice-${index + 1} answer`)
                .attr('data-clicked', choice.value)
                .attr('id', `choice-${index}`)
                .text(choice.text);
            
            container.append(button);
        });
        
        // í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
        $('.choice-button.answer').off('click.selection').on('click.selection', handleSelectionClick);
    }
    
    // ë¬¸ì œ í…ìŠ¤íŠ¸ì—ì„œ í…Œë§ˆ ê°ì§€
    function detectThemeFromText(text) {
        let maxScore = 0;
        let detectedTheme = 'health'; // ê¸°ë³¸ê°’ì„ healthë¡œ ì„¤ì •
        
        Object.keys(SELECTION_CONFIG.themes).forEach(theme => {
            const keywords = SELECTION_CONFIG.themes[theme].keywords;
            let score = 0;
            
            keywords.forEach(keyword => {
                if (text.includes(keyword)) {
                    score++;
                }
            });
            
            if (score > maxScore) {
                maxScore = score;
                detectedTheme = theme;
            }
        });
        
        console.log(`í…Œë§ˆ ê°ì§€: ${detectedTheme} (ì ìˆ˜: ${maxScore})`);
        return detectedTheme;
    }
    
    // Selection í…Œë§ˆ ì ìš©
    function applySelectionTheme(theme) {
        const container = $('#selection-quiz-container');
        container.attr('data-theme', theme);
        
        if (SELECTION_CONFIG.themes[theme]) {
            const themeConfig = SELECTION_CONFIG.themes[theme];
            
            // ì¥ì‹ ì´ëª¨ì§€ ì„¤ì •
            $('#decoration1').text(themeConfig.emojis[0] || 'ğŸ¯');
            $('#decoration2').text(themeConfig.emojis[Math.floor(Math.random() * themeConfig.emojis.length)] || 'âœ¨');
        }
        
        // í€´ì¦ˆ ì œëª© ì„¤ì •
        $('#quiz-title').text(`${theme.charAt(0).toUpperCase() + theme.slice(1)} ì„ íƒí˜• í€´ì¦ˆ`);
    }
    
    // Selection íŒŒí‹°í´ ìƒì„±
    function createSelectionParticles(theme) {
        const particleContainer = $('#particles');
        const themeConfig = SELECTION_CONFIG.themes[theme];
        
        if (!themeConfig) return;
        
        particleContainer.empty();
        
        for (let i = 0; i < 15; i++) {
            const particle = $('<div>').addClass('particle');
            particle.css({
                'left': Math.random() * 100 + '%',
                'width': Math.random() * 8 + 4 + 'px',
                'height': Math.random() * 8 + 4 + 'px',
                'background-color': themeConfig.colors[Math.floor(Math.random() * themeConfig.colors.length)],
                'animation-delay': Math.random() * 15 + 's',
                'animation-duration': (Math.random() * 10 + 15) + 's'
            });
            
            // 30% í™•ë¥ ë¡œ í…Œë§ˆë³„ ì´ëª¨ì§€ íŒŒí‹°í´
            if (Math.random() < 0.3 && themeConfig.particles) {
                particle.text(themeConfig.particles[Math.floor(Math.random() * themeConfig.particles.length)]);
                particle.css({
                    'background-color': 'transparent',
                    'font-size': '20px',
                    'width': 'auto',
                    'height': 'auto'
                });
            }
            
            particleContainer.append(particle);
        }
    }
    
    // Selection í´ë¦­ ì²˜ë¦¬ - ê°œì„ ëœ ë²„ì „
    function handleSelectionClick() {
        if (selectionIsAnswered) return;
        
        const clickedValue = $(this).attr('data-clicked');
        selectionSelectedAnswer = clickedValue;
        selectionIsAnswered = true;
        
        console.log('Selection ë²„íŠ¼ í´ë¦­:', clickedValue);
        
        // ëª¨ë“  ë‹µì•ˆ ë¹„í™œì„±í™”
        $('.choice-button.answer').addClass('disabled');
        
        // í´ë¦­ëœ ë‹µì•ˆ ê°•ì¡° (ì¦‰ì‹œ ì²´í¬ ë§ˆí¬ í‘œì‹œ)
        $(this).addClass('user-selected');
        
        // ë¦¬í”Œ íš¨ê³¼ ì¶”ê°€
        createSelectionRippleEffect(this);
        
        // ì‚¬ìš©ìì—ê²Œ ì„ íƒ í™•ì¸ ë©”ì‹œì§€
        console.log('âœ“ ë‹µì•ˆì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ì±„ì  ì¤‘...');
        
        // ì¦‰ì‹œ ì±„ì  (ì•½ê°„ì˜ ì§€ì—°ìœ¼ë¡œ ì‚¬ìš©ìê°€ ì„ íƒì„ í™•ì¸í•  ìˆ˜ ìˆê²Œ)
        setTimeout(() => {
            checkSelectionAnswer(clickedValue);
        }, 500);
    }
    
    // ë¦¬í”Œ íš¨ê³¼ ìƒì„±
    function createSelectionRippleEffect(button) {
        const ripple = $('<div>').addClass('ripple');
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        
        ripple.css({
            'width': size + 'px',
            'height': size + 'px',
            'left': '50%',
            'top': '50%',
            'transform': 'translate(-50%, -50%)',
            'position': 'absolute',
            'border-radius': '50%',
            'background': 'rgba(255, 255, 255, 0.6)',
            'animation': 'rippleEffect 0.6s linear',
            'pointer-events': 'none'
        });
        
        $(button).append(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    }
    
    // Selection ë‹µì•ˆ ì±„ì 
    function checkSelectionAnswer(selectedAnswer) {
        const qid = $('.submit-button, .resubmit-button').first().attr('data-qid') || '{{ slide.content.id }}';
        const slideId = '{{ slide.id }}';
        
        console.log('ë‹µì•ˆ ì±„ì  ì‹œì‘:', selectedAnswer);
        
        // ì„œë²„ë¡œ ë‹µì•ˆ ì „ì†¡
        $.ajax({
            url: '{% url "student:check_answer" %}',
            type: 'POST',
            data: {
                'content_id': qid,
                'slide_id': slideId,
                'student_answer': selectedAnswer,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('ì±„ì  ê²°ê³¼:', response);
                handleSelectionResult(response, selectedAnswer);
            },
            error: function() {
                showSelectionToast('ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                resetSelectionQuiz();
            }
        });
    }
    
    // Selection ê²°ê³¼ ì²˜ë¦¬ - ê°œì„ ëœ ë²„ì „
    function handleSelectionResult(response, selectedAnswer) {
        const selectedElement = $(`.choice-button[data-clicked="${selectedAnswer}"]`);
        const correctAnswer = response.correct_answer;
        const correctElement = $(`.choice-button[data-clicked="${correctAnswer}"]`);
        
        console.log('ê²°ê³¼ ì²˜ë¦¬:', {
            selected: selectedAnswer,
            correct: correctAnswer,
            isCorrect: response.is_correct
        });
        
        // ë¨¼ì € ì„ íƒëœ ë‹µì•ˆì„ ëª…í™•í•˜ê²Œ í‘œì‹œ (ì²´í¬ ë§ˆí¬ í¬í•¨)
        selectedElement.addClass('user-selected');
        
        // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì •ë‹µ/ì˜¤ë‹µ ìƒíƒœ ì¶”ê°€
        setTimeout(() => {
            if (response.is_correct) {
                // ì •ë‹µ ì²˜ë¦¬: ì‚¬ìš©ì ì„ íƒ + ì •ë‹µ
                selectedElement.addClass('correct');
                $('#right-gif').removeClass('hidden');
                showSelectionToast(getRandomMessage(SELECTION_CONFIG.correctMessages), 'success');
                showSelectionAnimation('correct');
                showSelectionFeedback('correct', getRandomMessage(SELECTION_CONFIG.correctMessages));
                
                // ì œì¶œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                $('#submit-btn, #resubmit-btn').hide();
                
                console.log('âœ… ì •ë‹µ ì²˜ë¦¬ ì™„ë£Œ - ì‚¬ìš©ì ì„ íƒ ë‹µì•ˆì— ì •ë‹µ í‘œì‹œ');
                
            } else {
                // ì˜¤ë‹µ ì²˜ë¦¬: ì‚¬ìš©ì ì„ íƒ + ì˜¤ë‹µ
                selectedElement.addClass('incorrect');
                
                // ì •ë‹µ ë²„íŠ¼ë„ í•¨ê»˜ í‘œì‹œ (ì‚¬ìš©ìê°€ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ)
                if (selectedAnswer !== correctAnswer && correctElement.length > 0) {
                    setTimeout(() => {
                        correctElement.addClass('show-correct');
                        console.log('ğŸ’¡ ì •ë‹µ ë²„íŠ¼ë„ í‘œì‹œ:', correctAnswer);
                    }, 800);
                }
                
                $('#wrong-gif').removeClass('hidden');
                showSelectionToast(getRandomMessage(SELECTION_CONFIG.incorrectMessages), 'error');
                showSelectionAnimation('incorrect');
                showSelectionFeedback('incorrect', getRandomMessage(SELECTION_CONFIG.incorrectMessages));
                
                // ì¬ì œì¶œ ë²„íŠ¼ í‘œì‹œ
                $('#submit-btn').hide();
                $('#resubmit-btn').show();
                
                console.log('âŒ ì˜¤ë‹µ ì²˜ë¦¬ ì™„ë£Œ - ì‚¬ìš©ì ì„ íƒ ë‹µì•ˆì— ì˜¤ë‹µ í‘œì‹œ');
            }
        }, 300);
        
        // ì œì¶œ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateSelectionSubmissionStatus(response);
        
        // 8ì´ˆ í›„ UI ì •ë¦¬ (ì˜¤ë‹µì¸ ê²½ìš° ì¬ì‹œë„ ê°€ëŠ¥)
        setTimeout(() => {
            if (!response.is_correct) {
                resetSelectionQuizForRetry();
            }
        }, 8000);
    }
    
    // í”¼ë“œë°± í‘œì‹œ í•¨ìˆ˜
    function showSelectionFeedback(type, message) {
        const feedbackElement = $(`#feedback-${type}`);
        feedbackElement.html(message);
        feedbackElement.addClass('show');
        
        // ì„œë²„ ìƒíƒœ ë©”ì‹œì§€ ì¶”ê°€
        setTimeout(() => {
            const statusElement = $('<div>').addClass('server-status');
            statusElement.html('ğŸ“¡ ì„œë²„ë¡œ ê²°ê³¼ ì „ì†¡ ì¤‘...');
            feedbackElement.append(statusElement);
            
            // ì „ì†¡ ì™„ë£Œ ì‹œë®¬ë ˆì´ì…˜
            setTimeout(() => {
                statusElement.html('âœ… ì „ì†¡ ì™„ë£Œ!');
                statusElement.css({
                    'background-color': 'rgba(76, 175, 80, 0.9)',
                    'color': 'white',
                    'border-color': '#4CAF50'
                });
            }, 1500);
        }, 1000);
    }
    
    // Selection ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
    function showSelectionAnimation(type) {
        const container = $('#animation-container');
        
        if (type === 'correct') {
            // ì •ë‹µ ì• ë‹ˆë©”ì´ì…˜
            const animations = [createFireworks, createStarExplosion, createHeartStorm];
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
            randomAnimation();
        } else {
            // ì˜¤ë‹µ ì• ë‹ˆë©”ì´ì…˜
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const element = $('<div>').addClass('animated-element');
                    element.text(['ğŸ’­', 'ğŸ¤”', 'ğŸ˜…', 'ğŸ’ª'][Math.floor(Math.random() * 4)]);
                    element.css({
                        'left': Math.random() * 100 + '%',
                        'animation-delay': Math.random() * 500 + 'ms'
                    });
                    
                    container.append(element);
                    
                    setTimeout(() => {
                        element.remove();
                    }, 4000);
                }, i * 100);
            }
        }
    }
    
    // ë¶ˆê½ƒë†€ì´ ì• ë‹ˆë©”ì´ì…˜
    function createFireworks() {
        const container = $('#animation-container');
        
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const centerX = Math.random() * window.innerWidth;
                const centerY = Math.random() * (window.innerHeight * 0.6) + window.innerHeight * 0.2;
                
                for (let j = 0; j < 8; j++) {
                    const particle = $('<div>');
                    particle.text('âœ¨');
                    particle.css({
                        'position': 'absolute',
                        'font-size': window.innerWidth < 768 ? '20px' : '30px',
                        'left': centerX + 'px',
                        'top': centerY + 'px',
                        'transition': 'all 1.2s cubic-bezier(0.4, 0, 0.2, 1)',
                        'pointer-events': 'none'
                    });
                    
                    const angle = (j / 8) * 2 * Math.PI;
                    const distance = window.innerWidth < 768 ? 100 : 150;
                    const endX = centerX + Math.cos(angle) * distance;
                    const endY = centerY + Math.sin(angle) * distance;
                    
                    container.append(particle);
                    
                    setTimeout(() => {
                        particle.css({
                            'left': endX + 'px',
                            'top': endY + 'px',
                            'opacity': '0',
                            'transform': 'scale(1.5)'
                        });
                    }, 10);
                    
                    setTimeout(() => {
                        particle.remove();
                    }, 1200);
                }
            }, i * 400);
        }
    }
    
    // ë³„ í­ë°œ ì• ë‹ˆë©”ì´ì…˜
    function createStarExplosion() {
        const container = $('#animation-container');
        const stars = ['â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«'];
        
        for (let i = 0; i < 25; i++) {
            const star = $('<div>').addClass('animated-element');
            star.text(stars[Math.floor(Math.random() * stars.length)]);
            star.css({
                'left': Math.random() * 100 + '%',
                'animation-delay': Math.random() * 800 + 'ms'
            });
            
            container.append(star);
            
            setTimeout(() => {
                star.remove();
            }, 3500);
        }
    }
    
    // í•˜íŠ¸ ì• ë‹ˆë©”ì´ì…˜
    function createHeartStorm() {
        const container = $('#animation-container');
        const hearts = ['ğŸ’–', 'ğŸ’•', 'ğŸ’—', 'ğŸ’', 'ğŸ’˜'];
        
        for (let i = 0; i < 20; i++) {
            setTimeout(() => {
                const heart = $('<div>').addClass('animated-element');
                heart.text(hearts[Math.floor(Math.random() * hearts.length)]);
                heart.css({
                    'left': Math.random() * 100 + '%',
                    'animation-delay': Math.random() * 400 + 'ms'
                });
                
                container.append(heart);
                
                setTimeout(() => {
                    heart.remove();
                }, 3500);
            }, i * 120);
        }
    }
    
    // Selection ê¸°ì¡´ ë‹µì•ˆ ë³µì› - ê°œì„ ëœ ë²„ì „
    function restoreSelectionAnswer() {
        {% if existing_answer and slide.content_type.type_name == 'selection' %}
        try {
            const rawAnswerString = '{{ existing_answer.answer|escapejs|default:"{}" }}';
            console.log('=== Selection ê¸°ì¡´ ë‹µì•ˆ ë³µì› ===');
            console.log('Raw Answer:', rawAnswerString);
            
            const cleanedJsonString = rawAnswerString
                .replace(/\bTrue\b/g, 'true')
                .replace(/\bFalse\b/g, 'false')
                .replace(/\bNone\b/g, 'null')
                .replace(/'/g, '"');
            
            const answerData = JSON.parse(cleanedJsonString);
            console.log('Parsed Answer:', answerData);
            
            if (answerData.selected_answer) {
                const selectedAnswerId = answerData.selected_answer;
                const correctAnswer = answerData.correct_answer;
                const selectedElement = $(`.choice-button[data-clicked="${selectedAnswerId}"]`);
                const correctElement = $(`.choice-button[data-clicked="${correctAnswer}"]`);
                
                console.log('ë³µì› ë°ì´í„°:', {
                    selected: selectedAnswerId,
                    correct: correctAnswer,
                    isCorrect: {{ is_already_correct|yesno:"true,false" }}
                });
                
                if (selectedElement.length > 0) {
                    selectionIsAnswered = true;
                    selectionSelectedAnswer = selectedAnswerId;
                    
                    // ëª¨ë“  ë‹µì•ˆ ë¹„í™œì„±í™”
                    $('.choice-button.answer').addClass('disabled');
                    
                    // ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‹µì•ˆ í‘œì‹œ (ì²´í¬ ë§ˆí¬ í¬í•¨)
                    selectedElement.addClass('user-selected');
                    
                    // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì •ë‹µ/ì˜¤ë‹µ ìƒíƒœ ì¶”ê°€
                    setTimeout(() => {
                        {% if is_already_correct %}
                            // ì •ë‹µì¸ ê²½ìš°: ì„ íƒí•œ ë‹µì•ˆ = ì •ë‹µ
                            selectedElement.addClass('correct');
                            $('#right-gif').removeClass('hidden');
                            $('#submit-btn, #resubmit-btn').hide();
                            showSelectionFeedback('correct', 'ğŸ‰ ì´ì „ ì œì¶œ: ì •ë‹µì…ë‹ˆë‹¤! ì˜í–ˆì–´ìš”!');
                            
                            console.log('âœ… ì •ë‹µ ìƒíƒœë¡œ ë³µì› ì™„ë£Œ - ì²´í¬ ë§ˆí¬ í‘œì‹œ');
                        {% else %}
                            // ì˜¤ë‹µì¸ ê²½ìš°: ì„ íƒí•œ ë‹µì•ˆ â‰  ì •ë‹µ
                            selectedElement.addClass('incorrect');
                            
                            // ì •ë‹µë„ í•¨ê»˜ í‘œì‹œ (ì‚¬ìš©ìê°€ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°)
                            if (selectedAnswerId !== correctAnswer && correctElement.length > 0) {
                                setTimeout(() => {
                                    correctElement.addClass('show-correct');
                                    console.log('ğŸ’¡ ì •ë‹µ ë²„íŠ¼ë„ í‘œì‹œ:', correctAnswer);
                                }, 500);
                            }
                            
                            $('#wrong-gif').removeClass('hidden');
                            $('#submit-btn').hide();
                            $('#resubmit-btn').show();
                            showSelectionFeedback('incorrect', 'ğŸ’ª ì´ì „ ì œì¶œ: ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!');
                            
                            console.log('âŒ ì˜¤ë‹µ ìƒíƒœë¡œ ë³µì› ì™„ë£Œ - ì²´í¬ ë§ˆí¬ í‘œì‹œ');
                        {% endif %}
                    }, 300);
                    
                    // ìƒíƒœ ë©”ì‹œì§€ ì¶”ê°€
                    const statusHtml = `
                        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>ì´ì „ ì œì¶œ ì •ë³´</strong>
                            </div>
                            <div class="mt-2 text-sm text-blue-700">
                                ì œì¶œì¼: {{ existing_answer.submitted_at|date:"Y-m-d H:i" }}<br>
                                ì„ íƒí•œ ë‹µ: <strong>${selectedAnswerId}ë²ˆ ì„ íƒì§€</strong><br>
                                ì •ë‹µ: <strong>${correctAnswer}ë²ˆ ì„ íƒì§€</strong><br>
                                ê²°ê³¼: {% if is_already_correct %}<span class="text-green-600 font-bold">âœ… ì •ë‹µ</span>{% else %}<span class="text-red-600 font-bold">âŒ ì˜¤ë‹µ</span>{% endif %}
                            </div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        $('#feedback-{{ is_already_correct|yesno:"correct,incorrect" }}').append(statusHtml);
                    }, 1000);
                }
            }
        } catch (e) {
            console.error('Selection ë‹µì•ˆ ë³µì› ì¤‘ ì˜¤ë¥˜:', e);
        }
        {% endif %}
    }
    
    // Selection ì¬ì‹œë„ìš© ë¦¬ì…‹ - ê°œì„ ëœ ë²„ì „
    function resetSelectionQuizForRetry() {
        {% if not is_already_correct %}
        console.log('Selection í€´ì¦ˆ ì¬ì‹œë„ ë¦¬ì…‹');
        
        selectionIsAnswered = false;
        selectionSelectedAnswer = null;
        
        // UI ì´ˆê¸°í™” (ëª¨ë“  ìƒíƒœ í´ë˜ìŠ¤ ì œê±°)
        $('.choice-button.answer').removeClass('disabled user-selected correct incorrect show-correct');
        $('#right-gif, #wrong-gif').addClass('hidden');
        $('#feedback-correct, #feedback-incorrect').removeClass('show');
        $('#animation-container').empty();
        
        // í”¼ë“œë°± ë‚´ìš© ì´ˆê¸°í™”
        $('#feedback-correct, #feedback-incorrect').empty();
        
        // ì›ë˜ ìŠ¤íƒ€ì¼ ë³µì› (before/after ê°€ìƒ ìš”ì†Œë„ ì´ˆê¸°í™”ë¨)
        $('.choice-button.answer').each(function(index) {
            $(this).attr('class', `choice-button choice-${index + 1} answer`);
        });
        
        console.log('ì¬ì‹œë„ ì¤€ë¹„ ì™„ë£Œ - ì²´í¬ ë§ˆí¬ ì œê±°ë¨');
        {% endif %}
    }
    
    // Selection ì™„ì „ ë¦¬ì…‹ - ê°œì„ ëœ ë²„ì „
    function resetSelectionQuiz() {
        console.log('Selection í€´ì¦ˆ ì™„ì „ ë¦¬ì…‹');
        
        selectionIsAnswered = false;
        selectionSelectedAnswer = null;
        
        // ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
        $('.choice-button.answer').removeClass('disabled user-selected correct incorrect show-correct');
        $('#right-gif, #wrong-gif').addClass('hidden');
        $('#feedback-correct, #feedback-incorrect').removeClass('show');
        $('#animation-container').empty();
        $('#submission-status-wrapper').empty();
        
        // í”¼ë“œë°± ë‚´ìš© ì´ˆê¸°í™”
        $('#feedback-correct, #feedback-incorrect').empty();
        
        // ì›ë˜ ìŠ¤íƒ€ì¼ ì™„ì „ ë³µì›
        $('.choice-button.answer').each(function(index) {
            $(this).attr('class', `choice-button choice-${index + 1} answer`);
            $(this).removeAttr('style'); // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë„ ì œê±°
        });
        
        console.log('ì™„ì „ ë¦¬ì…‹ ì™„ë£Œ - ëª¨ë“  ì²´í¬ ë§ˆí¬ ì œê±°ë¨');
    }
    
    // ì œì¶œ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateSelectionSubmissionStatus(response) {
        const wrapper = $('#submission-status-wrapper');
        wrapper.empty();
        
        const statusIcon = response.is_correct
            ? '<span class="text-green-600 font-medium ml-2"><i class="fas fa-check-circle"></i> ì •ë‹µ</span>'
            : '<span class="text-red-600 font-medium ml-2"><i class="fas fa-times-circle"></i> ì˜¤ë‹µ</span>';
        
        const statusHtml = `<div class="mt-4 text-sm text-gray-600">
            <i class="fas fa-info-circle mr-1"></i>
            ë§ˆì§€ë§‰ ì œì¶œ: ${response.submitted_at}
            ${statusIcon}
        </div>`;
        
        wrapper.html(statusHtml);
    }
    
    // ëœë¤ ë©”ì‹œì§€ ì„ íƒ
    function getRandomMessage(messages) {
        return messages[Math.floor(Math.random() * messages.length)];
    }
    
    // Selection í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showSelectionToast(message, type = 'info') {
        showToast(message, type); // ê¸°ì¡´ í† ìŠ¤íŠ¸ í•¨ìˆ˜ ì‚¬ìš©
    }
    
    // ì¬ì œì¶œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $(document).on('click', '#resubmit-btn', function() {
        if ('{{ slide.content_type.type_name }}' === 'selection') {
            resetSelectionQuizForRetry();
        }
    });
    
    // í™”ë©´ íšŒì „ ëŒ€ì‘
    $(window).on('orientationchange resize', function() {
        setTimeout(() => {
            // íŒŒí‹°í´ ì¬ìƒì„±
            const theme = $('#selection-quiz-container').attr('data-theme') || 'health';
            createSelectionParticles(theme);
        }, 100);
    });
    
    // Selection í€´ì¦ˆ ì´ˆê¸°í™” ì‹¤í–‰
    initializeSelectionQuiz();
});
</script>