// 완전한 드래그앤드롭 퀴즈 JavaScript - 찌꺼기 코드 완전 제거
<script>
$(document).ready(function() {
    // ★★★ 즉시 실행으로 깜빡임 방지 ★★★
    (function() {
        const style = document.createElement('style');
        style.textContent = `
            .drag-quiz-container .quiz-container .space-y-4:not(.drag-items-container),
            .drag-quiz-container .quiz-container .options-container:not(.drag-items-container),
            .drag-quiz-container .quiz-container .option-button:not(.drag-item),
            .drag-quiz-container .quiz-container .choice:not(.drag-item),
            .drag-quiz-container .quiz-container .answer:not(.drag-item) {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }
        `;
        document.head.appendChild(style);
    })();
    
    // 드래그 퀴즈 전용 설정
    const DRAG_CONFIG = {
        themes: {
            science: {
                keywords: ['과학', '실험', '화학', '물리', '생물', '연구', '이론', '법칙', '가설', '원소', '실험실', '증발', '응결', '승화'],
                emojis: ['🔬', '⚗️', '🧪', '🔭', '🌡️', '⚛️', '🧬', '💊', '🦠', '🌌'],
                particles: ['🔬', '⚗️', '🧪', '⚛️', '💡', '🌟'],
                colors: ['rgba(33, 150, 243, 0.3)', 'rgba(3, 218, 198, 0.3)', 'rgba(0, 188, 212, 0.3)'],
                itemColors: ['#2196F3', '#03DAC6', '#00BCD4', '#4FC3F7', '#0288D1']
            },
            math: {
                keywords: ['수학', '계산', '공식', '방정식', '기하', '대수', '확률', '통계', '함수', '숫자', '순서', '정렬', '소수', '분수'],
                emojis: ['➕', '➖', '✖️', '➗', '📐', '📊', '📈', '🔢', '∑', '∞'],
                particles: ['➕', '➖', '✖️', '➗', '📐', '🔢'],
                colors: ['rgba(255, 152, 0, 0.3)', 'rgba(255, 193, 7, 0.3)', 'rgba(255, 171, 0, 0.3)'],
                itemColors: ['#FF9800', '#FFC107', '#FFAB00', '#FFB74D', '#FF8F00']
            },
            career: {
                keywords: ['진로', '직업', '취업', '미래', '꿈', '목표', '계획', '성장', '발전', '능력', '의사', '화가', '요리사', '연결', '매칭'],
                emojis: ['💼', '👔', '🎯', '📈', '🏆', '🚀', '💡', '🌟', '🔥', '⭐'],
                particles: ['💼', '🎯', '📈', '🏆', '🚀', '💡'],
                colors: ['rgba(76, 175, 80, 0.3)', 'rgba(139, 195, 74, 0.3)', 'rgba(102, 187, 106, 0.3)'],
                itemColors: ['#4CAF50', '#8BC34A', '#66BB6A', '#81C784', '#388E3C']
            },
            social: {
                keywords: ['사회', '역사', '정치', '경제', '문화', '지리', '인권', '민주주의', '선거', '투표', '토론', '집회'],
                emojis: ['👥', '🏛️', '🗳️', '📊', '🌍', '🏴', '📜', '⚖️', '🕊️', '🤝'],
                particles: ['👥', '🏛️', '🗳️', '🌍', '📊', '🤝'],
                colors: ['rgba(233, 30, 99, 0.3)', 'rgba(255, 64, 129, 0.3)', 'rgba(173, 20, 87, 0.3)'],
                itemColors: ['#E91E63', '#FF4081', '#AD1457', '#F06292', '#C2185B']
            },
            default: {
                keywords: [],
                emojis: ['🎯', '✨', '⭐', '🌟', '💫', '🎉', '🎊', '🌈', '🦋', '🌺'],
                particles: ['🎯', '✨', '⭐', '🌟', '💫', '🎉'],
                colors: ['rgba(255, 255, 255, 0.3)', 'rgba(255, 107, 107, 0.3)', 'rgba(78, 205, 196, 0.3)'],
                itemColors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#B794F6']
            }
        },
        
        correctMessages: [
            "🎉 정답입니다! 👏 완벽한 드래그 실력이에요!",
            "환상적이에요! 🌟 훌륭한 배치였습니다!",
            "맞습니다! 🎊 정확한 위치에 배치했어요!",
            "정답이에요! 💯 최고의 드래그 솜씨예요!",
            "브라보! 🎭 멋진 드래그 테크닉이었습니다!"
        ],
        
        incorrectMessages: [
            "🤔 아직 정답이 아니에요! 다시 시도해보세요! 😊",
            "괜찮아요! 💪 한 번 더 도전해보세요!",
            "조금 더 생각해볼까요? 🧐 다시 배치해보세요!",
            "아쉬워요! 😊 다시 한번 드래그해보세요!",
            "힘내세요! 🌟 올바른 위치를 찾아보세요!"
        ]
    };
    
    // 전역 변수
    let dragIsAnswered = false;
    let currentState = {};
    let draggedItem = null;
    let touchItem = null;
    let extractedItems = [];
    let questionText = '';
    let quizType = 'fill-blank'; // 기본값
    let zoneIdMap = {}; // Zone ID 매핑
    
    // 🚀 드래그 퀴즈 초기화 (개선된 버전)
    function initializeDragQuiz() {
        if ($('#drag-quiz-container').length === 0) return;
        
        console.log('🚀 드래그 퀴즈 초기화 시작');
        
        // ★★★ 단계 1: 기존 구조 완전 제거 ★★★
        forceCleanupOriginalStructure();
        
        // ★★★ 단계 2: 문제와 아이템 추출 ★★★
        extractQuestionAndItemsImproved();
        
        // ★★★ 단계 3: 나머지 초기화 ★★★
        detectQuizType();
        const theme = detectThemeFromText(questionText);
        applyDragTheme(theme);
        createDragParticles(theme);
        initializeQuizByType();
        restoreDragAnswer();
        
        console.log('✅ 드래그 퀴즈 초기화 완료');
        console.log(`📋 퀴즈 타입: ${quizType}`);
        console.log(`🎨 테마: ${theme}`);
    }
    
    // ★★★ 새로운 함수: 기존 구조 강제 제거 ★★★
    function forceCleanupOriginalStructure() {
        console.log('🧹 기존 구조 강제 정리 시작');
        
        const container = $('#drag-quiz-container');
        if (container.length === 0) return;
        
        // 숨겨야 할 요소들의 선택자 목록
        const selectorsToHide = [
            '.quiz-container .space-y-4:not(.drag-items-container)',
            '.quiz-container .options-container:not(.drag-items-container)', 
            '.quiz-container .option-button:not(.drag-item)',
            '.quiz-container .choice:not(.drag-item)',
            '.quiz-container .answer:not(.drag-item)',
            '.space-y-4:not(.drag-items-container)',
            '.options-container:not(.drag-items-container)',
            '.option-button:not(.drag-item)',
            '.choice:not(.drag-item)',
            '.answer:not(.drag-item)'
        ];
        
        // 각 선택자에 대해 강제로 숨김 처리
        selectorsToHide.forEach(selector => {
            container.find(selector).each(function() {
                $(this).css({
                    'display': 'none',
                    'visibility': 'hidden',
                    'opacity': '0',
                    'position': 'absolute',
                    'left': '-9999px',
                    'top': '-9999px',
                    'width': '0',
                    'height': '0',
                    'overflow': 'hidden',
                    'z-index': '-1000'
                }).addClass('drag-hidden');
            });
        });
        
        console.log('🧹 기존 구조 강제 정리 완료');
    }
    
    // ★★★ 개선된 문제와 아이템 추출 함수 ★★★
    function extractQuestionAndItemsImproved() {
        console.log('📝 개선된 문제/아이템 추출 시작');
        
        // 1. 문제 텍스트 추출 (더 안정적인 방법)
        extractQuestionTextSafely();
        
        // 2. 드래그 아이템 추출 (더 안정적인 방법)
        extractDragItemsSafely();
        
        console.log('📝 최종 문제:', questionText);
        console.log('📋 최종 아이템:', extractedItems);
    }
    
    // ★★★ 안전한 문제 텍스트 추출 ★★★
    function extractQuestionTextSafely() {
        questionText = '';
        
        // 방법 1: question-box에서 h1 태그의 텍스트만 추출
        const questionH1 = $('#question-text h1, .question-box h1').first();
        if (questionH1.length > 0) {
            // h1 내용을 복사하되, drop-zone은 [빈칸]으로 치환
            const clonedH1 = questionH1.clone();
            clonedH1.find('.drop-zone').text('[빈칸]');
            questionText = clonedH1.text().trim();
            console.log('✅ 방법1 성공 - h1에서 추출:', questionText);
        }
        
        // 방법 2: question-text 클래스에서 직접 추출
        if (!questionText || questionText.length < 5) {
            const questionDiv = $('.question-text').first();
            if (questionDiv.length > 0) {
                const clonedDiv = questionDiv.clone();
                clonedDiv.find('.drop-zone').text('[빈칸]');
                questionText = clonedDiv.text().trim();
                console.log('✅ 방법2 성공 - question-text에서 추출:', questionText);
            }
        }
        
        // 방법 3: 전체 question-box에서 정리해서 추출
        if (!questionText || questionText.length < 5) {
            const questionBox = $('#question-text, .question-box').first();
            if (questionBox.length > 0) {
                const cloned = questionBox.clone();
                // 불필요한 요소들 제거
                cloned.find('.space-y-4, .options-container, .option-button, .choice, .answer').not('.drag-items-container, .drag-item').remove();
                cloned.find('.drop-zone').text('[빈칸]');
                questionText = cloned.text().replace(/\s+/g, ' ').trim();
                console.log('✅ 방법3 성공 - 전체에서 정리 추출:', questionText);
            }
        }
        
        // 기본값 설정
        if (!questionText || questionText.length < 5) {
            questionText = "드래그앤드롭 문제를 풀어보세요!";
            console.log('⚠️ 기본 문제 텍스트 사용');
        }
    }
    
    // ★★★ 안전한 드래그 아이템 추출 ★★★
    function extractDragItemsSafely() {
        extractedItems = [];
        
        // 방법 1: data-clicked 속성을 가진 요소들에서 추출
        $('[data-clicked]').not('.drag-hidden').each(function(index) {
            const itemText = $(this).find('.option-text').text().trim() || $(this).text().trim();
            const dataClicked = $(this).attr('data-clicked');
            
            if (itemText && itemText !== '빈칸') {
                extractedItems.push({
                    id: `item${index + 1}`,
                    text: itemText,
                    value: dataClicked || (index + 1).toString()
                });
                console.log(`📋 아이템 ${index + 1} 추출:`, itemText, '(값:', dataClicked, ')');
            }
        });
        
        // 방법 2: .option-text를 가진 요소들에서 추출
        if (extractedItems.length === 0) {
            $('.option-text').not('.drag-hidden').each(function(index) {
                const itemText = $(this).text().trim();
                const parent = $(this).parent();
                const dataClicked = parent.attr('data-clicked');
                
                if (itemText && itemText !== '빈칸') {
                    extractedItems.push({
                        id: `item${index + 1}`,
                        text: itemText,
                        value: dataClicked || (index + 1).toString()
                    });
                    console.log(`📋 방법2 아이템 ${index + 1} 추출:`, itemText);
                }
            });
        }
        
        // 기본 아이템 설정
        if (extractedItems.length === 0) {
            console.log('⚠️ 추출된 아이템이 없음 - 기본 아이템 생성');
            extractedItems = [
                { id: 'item1', text: '선택지 1', value: '1' },
                { id: 'item2', text: '선택지 2', value: '2' },
                { id: 'item3', text: '선택지 3', value: '3' }
            ];
        }
        
        console.log('📋 최종 추출된 아이템 개수:', extractedItems.length);
    }
    
    // 🎯 퀴즈 타입 감지
    function detectQuizType() {
        const text = questionText.toLowerCase();
        
        // 키워드 기반 타입 감지
        if (text.includes('순서') || text.includes('정렬') || text.includes('배열') || 
            text.includes('작은 것부터') || text.includes('큰 것부터') ||
            text.includes('1번째') || text.includes('2번째') || text.includes('3번째')) {
            quizType = 'sort';
        } else if (text.includes('연결') || text.includes('매칭') || text.includes('짝') || 
                   text.includes('과 ') || text.includes('직업과') || text.includes('능력')) {
            quizType = 'match';
        } else if (text.includes('빈칸') || text.includes('____') || 
                   text.includes('<drop-zone') || text.includes('data-zone-id')) {
            quizType = 'fill-blank';
        } else {
            // 기본값은 빈칸채우기
            quizType = 'fill-blank';
        }
        
        console.log(`🎯 감지된 퀴즈 타입: ${quizType}`);
    }
    
    // 🎨 문제 텍스트에서 테마 감지
    function detectThemeFromText(text) {
        let maxScore = 0;
        let detectedTheme = 'default';
        
        Object.keys(DRAG_CONFIG.themes).forEach(theme => {
            const keywords = DRAG_CONFIG.themes[theme].keywords;
            let score = 0;
            
            keywords.forEach(keyword => {
                if (text.includes(keyword)) {
                    score++;
                }
            });
            
            if (score > maxScore) {
                maxScore = score;
                detectedTheme = theme;
            }
        });
        
        console.log(`🎨 감지된 테마: ${detectedTheme} (점수: ${maxScore})`);
        return detectedTheme;
    }
    
    // 🎪 드래그 테마 적용
    function applyDragTheme(theme) {
        const container = $('#drag-quiz-container');
        container.attr('data-theme', theme);
        
        if (DRAG_CONFIG.themes[theme]) {
            const themeConfig = DRAG_CONFIG.themes[theme];
            
            // 장식 이모지 설정
            $('#decoration1').text(themeConfig.emojis[0] || '🎯');
            $('#decoration2').text(themeConfig.emojis[Math.floor(Math.random() * themeConfig.emojis.length)] || '✨');
        }
        
        // 퀴즈 제목 설정
        const themeNames = {
            science: '과학',
            math: '수학',
            social: '사회',
            career: '진로',
            default: '일반'
        };
        
        const typeNames = {
            'fill-blank': '빈칸채우기',
            'sort': '순서정렬',
            'match': '매칭문제'
        };
        
        $('#quiz-title').text(`${themeNames[theme] || '일반'} ${typeNames[quizType] || '드래그앤드롭'} 퀴즈`);
    }
    
    // ✨ 파티클 생성
    function createDragParticles(theme) {
        const particleContainer = $('#particles');
        const themeConfig = DRAG_CONFIG.themes[theme];
        
        if (!themeConfig) return;
        
        particleContainer.empty();
        
        for (let i = 0; i < 20; i++) {
            const particle = $('<div>').addClass('particle');
            particle.css({
                'left': Math.random() * 100 + '%',
                'width': Math.random() * 10 + 6 + 'px',
                'height': Math.random() * 10 + 6 + 'px',
                'background-color': themeConfig.colors[Math.floor(Math.random() * themeConfig.colors.length)],
                'animation-delay': Math.random() * 15 + 's',
                'animation-duration': (Math.random() * 10 + 15) + 's'
            });
            
            // 40% 확률로 테마별 이모지 파티클
            if (Math.random() < 0.4 && themeConfig.particles) {
                particle.text(themeConfig.particles[Math.floor(Math.random() * themeConfig.particles.length)]);
                particle.css({
                    'background-color': 'transparent',
                    'font-size': '24px',
                    'width': 'auto',
                    'height': 'auto'
                });
            }
            
            particleContainer.append(particle);
        }
    }
    
    // 🏗️ 퀴즈 타입별 초기화
    function initializeQuizByType() {
        switch(quizType) {
            case 'fill-blank':
                initializeFillBlankImproved(); // ★★★ 개선된 함수 사용 ★★★
                break;
            case 'sort':
                initializeSort();
                break;
            case 'match':
                initializeMatch();
                break;
            default:
                initializeFillBlankImproved(); // ★★★ 개선된 함수 사용 ★★★
        }
    }
    
    // ★★★ 개선된 빈칸채우기 초기화 ★★★
    function initializeFillBlankImproved() {
        console.log('🔧 개선된 빈칸채우기 초기화');
        
        const questionElement = $('#question-text');
        
        // 1. 기존 HTML 완전 정리
        const originalHTML = questionElement.html();
        const tempDiv = $('<div>').html(originalHTML);
        
        // 2. 불필요한 요소들 완전 제거
        tempDiv.find('.space-y-4, .options-container, .option-button, .choice, .answer')
               .not('.drag-items-container, .drag-item')
               .remove();
        
        // 3. 정리된 HTML 적용
        let cleanHTML = tempDiv.html();
        
        // 4. drop-zone 확인 및 강제 적용
        const hasDropZone = cleanHTML.includes('drop-zone');
        if (!hasDropZone) {
            // drop-zone이 없으면 빈칸 표시를 drop-zone으로 변환
            cleanHTML = cleanHTML.replace(/\[빈칸\]/g, '<span class="drop-zone" data-zone-id="zone1">빈칸</span>');
            cleanHTML = cleanHTML.replace(/____+/g, '<span class="drop-zone" data-zone-id="zone1">빈칸</span>');
        }
        
        questionElement.html(cleanHTML);
        
        // 5. drop-zone 스타일 강제 적용
        questionElement.find('.drop-zone').each(function(index) {
            const zoneId = $(this).attr('data-zone-id') || `zone${index + 1}`;
            $(this).attr('data-zone-id', zoneId)
                   .addClass('drop-zone')
                   .css({
                       'display': 'inline-flex',
                       'align-items': 'center',
                       'justify-content': 'center',
                       'min-width': '120px',
                       'min-height': '40px',
                       'border': '3px dashed #45B7D1',
                       'border-radius': '8px',
                       'margin': '0 8px',
                       'padding': '8px',
                       'background-color': 'rgba(255, 255, 255, 0.3)',
                       'cursor': 'pointer',
                       'position': 'relative'
                   });
        });
        
        // 6. 이벤트 설정
        setupDropZones();
        createDragItems();
        
        console.log('✅ 개선된 빈칸채우기 초기화 완료');
    }
    
    // 🔢 정렬형 초기화
    function initializeSort() {
        console.log('🔧 순서정렬 초기화');
        
        $('#question-text').html(questionText);
        $('#sort-container').show();
        
        // 정렬 영역 생성
        const sortContainer = $('#sort-container');
        sortContainer.empty();
        
        for (let i = 1; i <= extractedItems.length; i++) {
            const zoneElement = $('<div>')
                .addClass('sort-zone drop-zone')
                .attr('id', `sort${i}`)
                .attr('data-zone-id', `order${i}`)
                .attr('data-order', i)
                .html(`
                    <div class="zone-label">${i}번째</div>
                    <div class="zone-content">여기에 드롭</div>
                `);
            
            sortContainer.append(zoneElement);
        }
        
        // 정렬존 특별 스타일 적용
        $('.sort-zone').css({
            'min-height': '100px',
            'border': '3px dashed #FF9800',
            'border-radius': '15px',
            'margin': '10px',
            'display': 'flex',
            'flex-direction': 'column',
            'justify-content': 'center',
            'align-items': 'center',
            'background': 'rgba(255, 152, 0, 0.1)',
            'transition': 'all 0.3s ease'
        });
        
        // 드롭존 이벤트 설정
        setupDropZones();
        
        // 드래그 아이템 생성
        createDragItems();
        
        console.log('✅ 순서정렬 초기화 완료');
    }
    
    // 🔗 매칭형 초기화
    function initializeMatch() {
        console.log('🔧 매칭문제 초기화');
        
        $('#question-text').html(questionText);
        $('#match-container').show();
        
        const matchContainer = $('#match-container');
        matchContainer.empty();
        
        // 매칭 쌍 정의 (실제로는 문제에서 추출해야 함)
        const matchPairs = [
            { left: '의사', right: '의학 지식' },
            { left: '화가', right: '창의성' },
            { left: '요리사', right: '미각' }
        ];
        
        matchPairs.forEach((pair, index) => {
            const rowElement = $('<div>')
                .addClass('match-row')
                .html(`
                    <div class="match-left">${pair.left}</div>
                    <div class="match-arrow">→</div>
                    <div class="match-right drop-zone" data-zone-id="match${index + 1}" data-match-id="match${index + 1}">
                        <span class="match-placeholder">능력을 선택하세요</span>
                    </div>
                `);
            matchContainer.append(rowElement);
        });
        
        // 매칭 영역 특별 스타일 적용
        $('.match-row').css({
            'display': 'flex',
            'align-items': 'center',
            'margin': '15px 0',
            'padding': '10px',
            'background': 'rgba(255, 255, 255, 0.1)',
            'border-radius': '12px'
        });
        
        $('.match-left').css({
            'flex': '1',
            'background': '#4CAF50',
            'color': 'white',
            'padding': '15px',
            'border-radius': '10px',
            'text-align': 'center',
            'font-weight': 'bold',
            'font-size': '18px'
        });
        
        $('.match-arrow').css({
            'font-size': '24px',
            'margin': '0 15px',
            'color': '#4CAF50'
        });
        
        $('.match-right').css({
            'min-width': '200px',
            'min-height': '60px',
            'border': '3px dashed #4CAF50',
            'border-radius': '10px',
            'background': 'rgba(76, 175, 80, 0.1)',
            'display': 'flex',
            'align-items': 'center',
            'justify-content': 'center',
            'transition': 'all 0.3s ease'
        });
        
        // 드롭존 이벤트 설정
        setupDropZones();
        
        // 드래그 아이템 생성
        createDragItems();
        
        console.log('✅ 매칭문제 초기화 완료');
    }
    
    // 🎨 드래그 아이템 생성 (화려한 버전)
    function createDragItems() {
        const container = $('#drag-container');
        const theme = $('#drag-quiz-container').attr('data-theme') || 'default';
        const themeConfig = DRAG_CONFIG.themes[theme];
        
        container.empty();
        
        extractedItems.forEach((item, index) => {
            const itemElement = $('<div>')
                .addClass('drag-item')
                .attr('id', item.id)
                .attr('draggable', 'true')
                .attr('data-value', item.value)
                .attr('tabindex', '0')
                .attr('role', 'button')
                .attr('aria-label', `드래그 가능한 아이템: ${item.text}`)
                .text(item.text)
                .css({
                    'background': `linear-gradient(135deg, ${themeConfig.itemColors[index % themeConfig.itemColors.length]}, ${adjustBrightness(themeConfig.itemColors[index % themeConfig.itemColors.length], 20)})`,
                    'color': 'white',
                    'padding': '12px 20px',
                    'margin': '8px',
                    'border-radius': '12px',
                    'cursor': 'move',
                    'font-weight': 'bold',
                    'font-size': '16px',
                    'box-shadow': '0 4px 12px rgba(0,0,0,0.15)',
                    'transition': 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                    'user-select': 'none',
                    'position': 'relative',
                    'overflow': 'hidden'
                });
            
            // 반짝이는 효과 추가
            const shimmer = $('<div>').css({
                'position': 'absolute',
                'top': '0',
                'left': '-100%',
                'width': '100%',
                'height': '100%',
                'background': 'linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent)',
                'animation': 'shimmer 2s infinite'
            });
            itemElement.append(shimmer);
            
            // 이벤트 바인딩
            itemElement.on('dragstart', handleDragStart);
            itemElement.on('dragend', handleDragEnd);
            itemElement.on('touchstart', handleTouchStart);
            itemElement.on('touchmove', handleTouchMove);
            itemElement.on('touchend', handleTouchEnd);
            
            // 호버 효과
            itemElement.on('mouseenter', function() {
                if (!$(this).hasClass('placed')) {
                    $(this).css({
                        'transform': 'translateY(-5px) scale(1.05)',
                        'box-shadow': '0 8px 25px rgba(0,0,0,0.25)'
                    });
                }
            }).on('mouseleave', function() {
                if (!$(this).hasClass('dragging placed')) {
                    $(this).css({
                        'transform': 'translateY(0) scale(1)',
                        'box-shadow': '0 4px 12px rgba(0,0,0,0.15)'
                    });
                }
            });
            
            container.append(itemElement);
            console.log('✨ 드래그 아이템 생성:', item.text);
        });
        
        // 반짝이는 애니메이션 추가
        $('<style>').prop('type', 'text/css').html(`
            @keyframes shimmer {
                0% { left: -100%; }
                100% { left: 100%; }
            }
        `).appendTo('head');
        
        // 키보드 지원 설정
        setupKeyboardSupport();
    }
    
    // 🎯 드롭존 설정 (통합된 버전)
    function setupDropZones() {
        $(document).off('dragover drop dragenter dragleave', '.drop-zone, .sort-zone, .match-right');
        
        $(document).on('dragover', '.drop-zone, .sort-zone, .match-right', function(e) {
            e.preventDefault();
        });
        
        $(document).on('dragenter', '.drop-zone, .sort-zone, .match-right', function(e) {
            e.preventDefault();
            $(this).addClass('highlight');
            
            // 진입 효과
            $(this).css({
                'transform': 'scale(1.05)',
                'box-shadow': '0 0 20px rgba(69, 183, 209, 0.6)'
            });
            
            console.log('🎯 드롭존 진입:', $(this).attr('data-zone-id') || $(this).attr('data-match-id'));
        });
        
        $(document).on('dragleave', '.drop-zone, .sort-zone, .match-right', function(e) {
            $(this).removeClass('highlight');
            $(this).css({
                'transform': '',
                'box-shadow': ''
            });
        });
        
        $(document).on('drop', '.drop-zone, .sort-zone, .match-right', handleDrop);
    }
    
    // 🎪 드래그 시작 (화려한 이벤트)
    function handleDragStart(e) {
        draggedItem = this;
        
        // 모든 아이템의 선택 상태 제거
        $('.drag-item').removeClass('selected dragging');
        
        // 현재 아이템을 선택 상태로 표시
        $(this).addClass('selected');
        
        // 폭죽 효과
        createMiniFireworks($(this).offset());
        
        console.log('🎯 드래그 시작:', $(this).text());
        
        // 약간의 지연 후 드래그 상태로 전환
        setTimeout(() => {
            $(this).removeClass('selected').addClass('dragging');
            $(this).css({
                'transform': 'scale(1.1) rotate(5deg)',
                'z-index': '1000',
                'box-shadow': '0 10px 30px rgba(0,0,0,0.3)'
            });
        }, 100);
        
        e.originalEvent.dataTransfer.setData('text/plain', this.id);
        
        // 진동 피드백
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
    }
    
    // 🎪 드래그 종료
    function handleDragEnd(e) {
        $(this).removeClass('dragging selected');
        $(this).css({
            'transform': '',
            'z-index': '',
            'box-shadow': '0 4px 12px rgba(0,0,0,0.15)'
        });
        
        $('.drop-zone, .sort-zone, .match-right').removeClass('highlight').css({
            'transform': '',
            'box-shadow': ''
        });
        
        console.log('🏁 드래그 종료:', $(this).text());
    }
    
    // 💥 드롭 처리 (화려한 이벤트)
    function handleDrop(e) {
        e.preventDefault();
        $(this).removeClass('highlight');
        
        if (dragIsAnswered) return;
        
        const itemId = e.originalEvent.dataTransfer.getData('text/plain');
        const item = $('#' + itemId);
        const zoneId = $(this).attr('data-zone-id') || $(this).attr('data-match-id') || 'zone1';
        
        console.log('💥 드롭 성공:', item.text(), '→', zoneId);
        
        // 기존 아이템이 있다면 복원
        if ($(this).attr('data-filled-by')) {
            const existingItem = $('#' + $(this).attr('data-filled-by'));
            if (existingItem.length) {
                existingItem.removeClass('placed').show();
                restoreItemStyle(existingItem);
            }
        }
        
        // 성공 폭죽 효과
        createSuccessExplosion($(this).offset());
        
        // 새 아이템 배치 - 매칭 타입별 처리
        if ($(this).hasClass('match-right')) {
            // 매칭 타입: 플레이스홀더 교체
            $(this).html(`<span class="match-answer">${item.text()}</span>`);
        } else {
            // 일반 빈칸/정렬 타입: 텍스트 교체
            $(this).text(item.text());
        }
        
        $(this).addClass('filled').attr('data-filled-by', itemId);
        item.addClass('placed').hide();
        
        // 성공 효과
        $(this).addClass('drop-success');
        setTimeout(() => {
            $(this).removeClass('drop-success');
        }, 1000);
        
        // 상태 저장
        currentState[zoneId] = item.attr('data-value') || itemId;
        
        console.log('💾 현재 상태:', currentState);
        
        // 완료 확인
        setTimeout(() => checkCompletion(), 300);
        
        // 진동 피드백 (성공 패턴)
        if (navigator.vibrate) {
            navigator.vibrate([50, 50, 50]);
        }
    }
    
    // 🌟 미니 폭죽 효과
    function createMiniFireworks(position) {
        for (let i = 0; i < 5; i++) {
            const spark = $('<div>').css({
                'position': 'fixed',
                'left': position.left + 'px',
                'top': position.top + 'px',
                'width': '4px',
                'height': '4px',
                'background': '#FFD700',
                'border-radius': '50%',
                'pointer-events': 'none',
                'z-index': '9999'
            });
            
            $('body').append(spark);
            
            const angle = (i / 5) * 2 * Math.PI;
            const distance = 30;
            const endX = position.left + Math.cos(angle) * distance;
            const endY = position.top + Math.sin(angle) * distance;
            
            spark.animate({
                left: endX + 'px',
                top: endY + 'px',
                opacity: 0
            }, 500, function() {
                $(this).remove();
            });
        }
    }
    
    // 💥 성공 폭발 효과
    function createSuccessExplosion(position) {
        const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];
        
        for (let i = 0; i < 12; i++) {
            const particle = $('<div>').css({
                'position': 'fixed',
                'left': position.left + 'px',
                'top': position.top + 'px',
                'width': '8px',
                'height': '8px',
                'background': colors[Math.floor(Math.random() * colors.length)],
                'border-radius': '50%',
                'pointer-events': 'none',
                'z-index': '9999'
            });
            
            $('body').append(particle);
            
            const angle = (i / 12) * 2 * Math.PI;
            const distance = 60 + Math.random() * 40;
            const endX = position.left + Math.cos(angle) * distance;
            const endY = position.top + Math.sin(angle) * distance;
            
            particle.animate({
                left: endX + 'px',
                top: endY + 'px',
                opacity: 0,
                transform: 'scale(2)'
            }, 800, function() {
                $(this).remove();
            });
        }
    }
    
    // 터치 이벤트 처리
    function handleTouchStart(e) {
        if (dragIsAnswered) return;
        
        touchItem = this;
        $(this).addClass('selected');
        
        // 터치 시작 효과
        createMiniFireworks($(this).offset());
        
        setTimeout(() => {
            $(this).removeClass('selected').addClass('dragging');
        }, 100);
        
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
        
        e.preventDefault();
    }
    
    function handleTouchMove(e) {
        if (!touchItem) return;
        e.preventDefault();
        
        const touch = e.originalEvent.touches[0];
        
        $(touchItem).css({
            'position': 'fixed',
            'left': touch.clientX - 60 + 'px',
            'top': touch.clientY - 30 + 'px',
            'z-index': '1000',
            'pointer-events': 'none',
            'transform': 'scale(1.1) rotate(5deg)',
            'box-shadow': '0 10px 30px rgba(0,0,0,0.3)'
        });
        
        // 드롭존 하이라이트 처리
        const element = document.elementFromPoint(touch.clientX, touch.clientY);
        $('.drop-zone, .sort-zone, .match-right').removeClass('highlight');
        
        if (element && ($(element).hasClass('drop-zone') || $(element).hasClass('sort-zone') || $(element).hasClass('match-right'))) {
            $(element).addClass('highlight');
            
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        }
    }
    
    function handleTouchEnd(e) {
        if (!touchItem) return;
        
        const touch = e.originalEvent.changedTouches[0];
        const element = document.elementFromPoint(touch.clientX, touch.clientY);
        
        // 스타일 복원
        restoreItemStyle($(touchItem));
        
        // 드롭 처리
        if (element && ($(element).hasClass('drop-zone') || $(element).hasClass('sort-zone') || $(element).hasClass('match-right'))) {
            if (navigator.vibrate) {
                navigator.vibrate([50, 50, 50]);
            }
            
            const fakeEvent = {
                preventDefault: () => {},
                originalEvent: {
                    dataTransfer: {
                        getData: () => touchItem.id
                    }
                }
            };
            handleDrop.call(element, fakeEvent);
        }
        
        $('.drop-zone, .sort-zone, .match-right').removeClass('highlight');
        touchItem = null;
    }
    
    // 아이템 스타일 복원
    function restoreItemStyle(item) {
        item.css({
            'position': '',
            'left': '',
            'top': '',
            'z-index': '',
            'pointer-events': '',
            'transform': '',
            'box-shadow': '0 4px 12px rgba(0,0,0,0.15)'
        }).removeClass('dragging selected');
    }
    
    // 키보드 접근성 지원
    function setupKeyboardSupport() {
        $(document).on('keydown', '.drag-item', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                $('.drag-item').removeClass('selected');
                $(this).addClass('selected');
                
                // 키보드 선택 효과
                createMiniFireworks($(this).offset());
                
                setTimeout(() => {
                    $(this).removeClass('selected');
                }, 2000);
            }
        });
    }
    
    // ✅ 완료 확인
    function checkCompletion() {
        if (dragIsAnswered) return;
        
        const totalZones = $('.drop-zone:visible, .sort-zone:visible, .match-right:visible').length;
        const filledZones = Object.keys(currentState).length;
        
        console.log(`📊 완료 확인: ${filledZones}/${totalZones}`);
        
        if (filledZones >= totalZones && totalZones > 0) {
            checkAnswers();
        }
    }
    
    // 📝 답안 채점
    function checkAnswers() {
        if (dragIsAnswered) return;
        
        dragIsAnswered = true;
        console.log('📤 답안 제출:', currentState);
        
        const slideId = '{{ slide.id }}';
        const contentId = '{{ slide.content.id }}';
        
        $.ajax({
            url: '{% url "student:check_answer" %}',
            type: 'POST',
            data: {
                'content_id': contentId,
                'slide_id': slideId,
                'student_answer': JSON.stringify(currentState),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('✅ 채점 결과:', response);
                handleDragResult(response);
            },
            error: function() {
                console.error('❌ 채점 오류');
                showDragToast('채점 중 오류가 발생했습니다.', 'error');
                resetDragQuiz();
            }
        });
    }
    
    // 🎉 결과 처리 (화려한 애니메이션)
    function handleDragResult(response) {
        console.log('🎉 결과 처리:', response);
        
        // 드롭존 상태 표시
        $('.drop-zone.filled, .sort-zone.filled, .match-right.filled').each(function() {
            const zoneId = $(this).attr('data-zone-id') || $(this).attr('data-match-id');
            if (zoneId && currentState[zoneId]) {
                $(this).addClass(response.is_correct ? 'correct' : 'incorrect');
            }
        });
        
        setTimeout(() => {
            if (response.is_correct) {
                // 정답 처리 - 대형 폭죽 쇼
                createGrandFireworks();
                showDragToast(getRandomMessage(DRAG_CONFIG.correctMessages), 'success');
                showDragFeedback('correct', getRandomMessage(DRAG_CONFIG.correctMessages));
                $('#submit-btn, #resubmit-btn').hide();
                
                console.log('🎉 정답 처리 완료');
            } else {
                // 오답 처리 - 격려 애니메이션
                createEncouragementAnimation();
                showDragToast(getRandomMessage(DRAG_CONFIG.incorrectMessages), 'error');
                showDragFeedback('incorrect', getRandomMessage(DRAG_CONFIG.incorrectMessages));
                $('#submit-btn').hide();
                $('#resubmit-btn').show();
                
                console.log('💪 오답 처리 완료');
            }
        }, 300);
        
        updateDragSubmissionStatus(response);
        
        if (!response.is_correct) {
            setTimeout(() => resetDragQuizForRetry(), 8000);
        }
    }
    
    // 🎆 대형 폭죽 쇼
    function createGrandFireworks() {
        const container = $('#animation-container');
        
        // 연속 폭죽 3발
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const centerX = Math.random() * window.innerWidth;
                const centerY = Math.random() * (window.innerHeight * 0.6) + window.innerHeight * 0.2;
                
                // 각 폭죽마다 16개의 불꽃
                for (let j = 0; j < 16; j++) {
                    const particle = $('<div>').css({
                        'position': 'fixed',
                        'left': centerX + 'px',
                        'top': centerY + 'px',
                        'width': '12px',
                        'height': '12px',
                        'background': `hsl(${Math.random() * 360}, 80%, 60%)`,
                        'border-radius': '50%',
                        'pointer-events': 'none',
                        'z-index': '9999'
                    });
                    
                    $('body').append(particle);
                    
                    const angle = (j / 16) * 2 * Math.PI;
                    const distance = 150 + Math.random() * 100;
                    const endX = centerX + Math.cos(angle) * distance;
                    const endY = centerY + Math.sin(angle) * distance;
                    
                    particle.animate({
                        left: endX + 'px',
                        top: endY + 'px',
                        opacity: 0,
                        transform: 'scale(2)'
                    }, 1500, function() {
                        $(this).remove();
                    });
                }
            }, i * 400);
        }
    }
    
    // 💪 격려 애니메이션
    function createEncouragementAnimation() {
        const encourageEmojis = ['💪', '🌟', '✨', '🎯', '🚀'];
        
        for (let i = 0; i < 10; i++) {
            setTimeout(() => {
                const emoji = $('<div>').css({
                    'position': 'fixed',
                    'left': Math.random() * window.innerWidth + 'px',
                    'top': window.innerHeight + 'px',
                    'font-size': '36px',
                    'pointer-events': 'none',
                    'z-index': '9999'
                });
                
                emoji.text(encourageEmojis[Math.floor(Math.random() * encourageEmojis.length)]);
                $('body').append(emoji);
                
                emoji.animate({
                    top: -100 + 'px',
                    opacity: 0,
                    transform: 'scale(1.5) rotate(360deg)'
                }, 2000, function() {
                    $(this).remove();
                });
            }, i * 200);
        }
    }
    
    // 피드백 표시
    function showDragFeedback(type, message) {
        const feedbackElement = $(`#feedback-${type}`);
        feedbackElement.html(message).addClass('show');
    }
    
    // 토스트 메시지
    function showDragToast(message, type = 'info') {
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
        } else {
            console.log(`Toast [${type}]: ${message}`);
        }
    }
    
    // 제출 상태 업데이트
    function updateDragSubmissionStatus(response) {
        const wrapper = $('#submission-status-wrapper');
        const statusIcon = response.is_correct
            ? '<span class="text-green-600"><i class="fas fa-check-circle"></i> 정답</span>'
            : '<span class="text-red-600"><i class="fas fa-times-circle"></i> 오답</span>';
        
        wrapper.html(`
            <div class="mt-4 text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>
                마지막 제출: ${response.submitted_at || '방금 전'}
                ${statusIcon}
            </div>
        `);
    }
    
    // 🔄 재시도용 리셋
    function resetDragQuizForRetry() {
        {% if not is_already_correct %}
        console.log('🔄 재시도 준비');
        
        dragIsAnswered = false;
        currentState = {};
        
        $('.drop-zone, .sort-zone, .match-right').removeClass('filled highlight correct incorrect')
                       .removeAttr('data-filled-by');
        
        // 타입별 원래 텍스트 복원
        $('.drop-zone').each(function() {
            if (!$(this).hasClass('sort-zone') && !$(this).hasClass('match-right')) {
                $(this).text('빈칸');
            }
        });
        
        $('.sort-zone').each(function() {
            const order = $(this).attr('data-order');
            $(this).html(`
                <div class="zone-label">${order}번째</div>
                <div class="zone-content">여기에 드롭</div>
            `);
        });
        
        $('.match-right').each(function() {
            $(this).html('<span class="match-placeholder">능력을 선택하세요</span>');
        });
        
        $('.drag-item').removeClass('placed').show();
        extractedItems.forEach(item => {
            restoreItemStyle($('#' + item.id));
        });
        
        $('#feedback-correct, #feedback-incorrect').removeClass('show');
        
        console.log('✅ 재시도 준비 완료');
        {% endif %}
    }
    
    // 🔄 기존 답안 복원 (개선된 버전)
    function restoreDragAnswer() {
        {% if existing_answer and slide.content_type.type_name == 'drag' %}
        try {
            const rawAnswer = '{{ existing_answer.answer|escapejs|default:"{}" }}';
            console.log('=== 답안 복원 시작 ===');
            console.log('Raw Answer:', rawAnswer);
            
            const answerData = JSON.parse(rawAnswer.replace(/'/g, '"'));
            console.log('Parsed Answer:', answerData);
            
            if (answerData.selected_answer) {
                const savedState = answerData.selected_answer;
                dragIsAnswered = true;
                
                console.log('💾 복원할 상태:', savedState);
                
                // 실제 존재하는 모든 드롭존 찾기
                const allDropZones = $('.drop-zone, .sort-zone, .match-right');
                console.log('🔍 전체 드롭존 개수:', allDropZones.length);
                
                // 저장된 상태의 각 항목에 대해 복원
                Object.keys(savedState).forEach((savedZoneId, index) => {
                    const itemValue = savedState[savedZoneId];
                    console.log(`🔍 복원 시도 ${index + 1}: Zone '${savedZoneId}' = Item '${itemValue}'`);
                    
                    // Zone 찾기 - 여러 방법으로 시도
                    let zone = null;
                    
                    // 방법 1: 정확한 zone-id 매칭
                    zone = $(`.drop-zone[data-zone-id="${savedZoneId}"], .sort-zone[data-zone-id="${savedZoneId}"], .match-right[data-zone-id="${savedZoneId}"], .match-right[data-match-id="${savedZoneId}"]`);
                    console.log(`   🎯 직접 매칭 시도: '${savedZoneId}' → ${zone.length}개 발견`);
                    
                    // 방법 2: 첫 번째 사용 가능한 드롭존 사용
                    if (zone.length === 0 && allDropZones.length > 0) {
                        zone = $(allDropZones[0]);
                        console.log(`   📍 첫 번째 드롭존 사용: ${zone.attr('data-zone-id') || zone.attr('data-match-id') || 'no-id'}`);
                    }
                    
                    // 방법 3: 인덱스 기반 매칭
                    if (zone.length === 0 && allDropZones.length > index) {
                        zone = $(allDropZones[index]);
                        console.log(`   📍 인덱스 기반 매칭: ${index}번째 드롭존 사용`);
                    }
                    
                    // Item 찾기
                    const item = $(`.drag-item[data-value="${itemValue}"]`);
                    
                    console.log(`   Zone 찾음: ${zone.length}개, Item 찾음: ${item.length}개`);
                    
                    // 복원 수행
                    if (zone.length > 0 && item.length > 0) {
                        // 매칭 타입별 복원 처리
                        if (zone.hasClass('match-right')) {
                            zone.html(`<span class="match-answer">${item.text()}</span>`);
                            console.log(`   ✅ 매칭 복원: ${item.text()}`);
                        } else {
                            zone.text(item.text());
                            console.log(`   ✅ 일반 복원: ${item.text()}`);
                        }
                        
                        zone.addClass('filled').attr('data-filled-by', item.attr('id'));
                        item.addClass('placed').hide();
                        
                        // 현재 상태 업데이트
                        const actualZoneId = zone.attr('data-zone-id') || zone.attr('data-match-id') || savedZoneId;
                        currentState[actualZoneId] = itemValue;
                        
                    } else {
                        console.log(`   ❌ 복원 실패: Zone(${zone.length}) 또는 Item(${item.length})을 찾을 수 없음`);
                    }
                });
                
                console.log('🎯 최종 복원된 상태:', currentState);
                
                // 정답/오답 상태 표시
                setTimeout(() => {
                    {% if is_already_correct %}
                    $('.drop-zone.filled, .sort-zone.filled, .match-right.filled').addClass('correct');
                    $('#submit-btn, #resubmit-btn').hide();
                    showDragFeedback('correct', '🎉 이전 제출: 정답입니다!');
                    console.log('✅ 정답 상태로 복원 완료');
                    {% else %}
                    $('.drop-zone.filled, .sort-zone.filled, .match-right.filled').addClass('incorrect');
                    $('#submit-btn').hide();
                    $('#resubmit-btn').show();
                    showDragFeedback('incorrect', '💪 이전 제출: 오답입니다. 다시 도전해보세요!');
                    console.log('❌ 오답 상태로 복원 완료');
                    {% endif %}
                }, 300);
            }
        } catch (e) {
            console.error('❌ 답안 복원 오류:', e);
            console.error('❌ 상세 오류 정보:', e.stack);
        }
        {% endif %}
    }
    
    // 유틸리티 함수들
    function adjustBrightness(color, percent) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }
    
    function getRandomMessage(messages) {
        return messages[Math.floor(Math.random() * messages.length)];
    }
    
    // 이벤트 리스너들
    $(document).on('click', '#resubmit-btn', function() {
        if ('{{ slide.content_type.type_name }}' === 'drag') {
            resetDragQuizForRetry();
        }
    });
    
    // 초기화 실행
    initializeDragQuiz();
});
</script>