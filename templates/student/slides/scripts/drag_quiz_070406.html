// ì™„ì „í•œ ë“œë˜ê·¸ì•¤ë“œë¡­ í€´ì¦ˆ JavaScript - ì°Œêº¼ê¸° ì½”ë“œ ì™„ì „ ì œê±°
<script>
$(document).ready(function() {
    // â˜…â˜…â˜… ì¦‰ì‹œ ì‹¤í–‰ìœ¼ë¡œ ê¹œë¹¡ì„ ë°©ì§€ â˜…â˜…â˜…
    (function() {
        const style = document.createElement('style');
        style.textContent = `
            .drag-quiz-container .quiz-container .space-y-4:not(.drag-items-container),
            .drag-quiz-container .quiz-container .options-container:not(.drag-items-container),
            .drag-quiz-container .quiz-container .option-button:not(.drag-item),
            .drag-quiz-container .quiz-container .choice:not(.drag-item),
            .drag-quiz-container .quiz-container .answer:not(.drag-item) {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }
        `;
        document.head.appendChild(style);
    })();
    
    // ë“œë˜ê·¸ í€´ì¦ˆ ì „ìš© ì„¤ì •
    const DRAG_CONFIG = {
        themes: {
            science: {
                keywords: ['ê³¼í•™', 'ì‹¤í—˜', 'í™”í•™', 'ë¬¼ë¦¬', 'ìƒë¬¼', 'ì—°êµ¬', 'ì´ë¡ ', 'ë²•ì¹™', 'ê°€ì„¤', 'ì›ì†Œ', 'ì‹¤í—˜ì‹¤', 'ì¦ë°œ', 'ì‘ê²°', 'ìŠ¹í™”'],
                emojis: ['ğŸ”¬', 'âš—ï¸', 'ğŸ§ª', 'ğŸ”­', 'ğŸŒ¡ï¸', 'âš›ï¸', 'ğŸ§¬', 'ğŸ’Š', 'ğŸ¦ ', 'ğŸŒŒ'],
                particles: ['ğŸ”¬', 'âš—ï¸', 'ğŸ§ª', 'âš›ï¸', 'ğŸ’¡', 'ğŸŒŸ'],
                colors: ['rgba(33, 150, 243, 0.3)', 'rgba(3, 218, 198, 0.3)', 'rgba(0, 188, 212, 0.3)'],
                itemColors: ['#2196F3', '#03DAC6', '#00BCD4', '#4FC3F7', '#0288D1']
            },
            math: {
                keywords: ['ìˆ˜í•™', 'ê³„ì‚°', 'ê³µì‹', 'ë°©ì •ì‹', 'ê¸°í•˜', 'ëŒ€ìˆ˜', 'í™•ë¥ ', 'í†µê³„', 'í•¨ìˆ˜', 'ìˆ«ì', 'ìˆœì„œ', 'ì •ë ¬', 'ì†Œìˆ˜', 'ë¶„ìˆ˜'],
                emojis: ['â•', 'â–', 'âœ–ï¸', 'â—', 'ğŸ“', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ”¢', 'âˆ‘', 'âˆ'],
                particles: ['â•', 'â–', 'âœ–ï¸', 'â—', 'ğŸ“', 'ğŸ”¢'],
                colors: ['rgba(255, 152, 0, 0.3)', 'rgba(255, 193, 7, 0.3)', 'rgba(255, 171, 0, 0.3)'],
                itemColors: ['#FF9800', '#FFC107', '#FFAB00', '#FFB74D', '#FF8F00']
            },
            career: {
                keywords: ['ì§„ë¡œ', 'ì§ì—…', 'ì·¨ì—…', 'ë¯¸ë˜', 'ê¿ˆ', 'ëª©í‘œ', 'ê³„íš', 'ì„±ì¥', 'ë°œì „', 'ëŠ¥ë ¥', 'ì˜ì‚¬', 'í™”ê°€', 'ìš”ë¦¬ì‚¬', 'ì—°ê²°', 'ë§¤ì¹­'],
                emojis: ['ğŸ’¼', 'ğŸ‘”', 'ğŸ¯', 'ğŸ“ˆ', 'ğŸ†', 'ğŸš€', 'ğŸ’¡', 'ğŸŒŸ', 'ğŸ”¥', 'â­'],
                particles: ['ğŸ’¼', 'ğŸ¯', 'ğŸ“ˆ', 'ğŸ†', 'ğŸš€', 'ğŸ’¡'],
                colors: ['rgba(76, 175, 80, 0.3)', 'rgba(139, 195, 74, 0.3)', 'rgba(102, 187, 106, 0.3)'],
                itemColors: ['#4CAF50', '#8BC34A', '#66BB6A', '#81C784', '#388E3C']
            },
            social: {
                keywords: ['ì‚¬íšŒ', 'ì—­ì‚¬', 'ì •ì¹˜', 'ê²½ì œ', 'ë¬¸í™”', 'ì§€ë¦¬', 'ì¸ê¶Œ', 'ë¯¼ì£¼ì£¼ì˜', 'ì„ ê±°', 'íˆ¬í‘œ', 'í† ë¡ ', 'ì§‘íšŒ'],
                emojis: ['ğŸ‘¥', 'ğŸ›ï¸', 'ğŸ—³ï¸', 'ğŸ“Š', 'ğŸŒ', 'ğŸ´', 'ğŸ“œ', 'âš–ï¸', 'ğŸ•Šï¸', 'ğŸ¤'],
                particles: ['ğŸ‘¥', 'ğŸ›ï¸', 'ğŸ—³ï¸', 'ğŸŒ', 'ğŸ“Š', 'ğŸ¤'],
                colors: ['rgba(233, 30, 99, 0.3)', 'rgba(255, 64, 129, 0.3)', 'rgba(173, 20, 87, 0.3)'],
                itemColors: ['#E91E63', '#FF4081', '#AD1457', '#F06292', '#C2185B']
            },
            default: {
                keywords: [],
                emojis: ['ğŸ¯', 'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ‰', 'ğŸŠ', 'ğŸŒˆ', 'ğŸ¦‹', 'ğŸŒº'],
                particles: ['ğŸ¯', 'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ‰'],
                colors: ['rgba(255, 255, 255, 0.3)', 'rgba(255, 107, 107, 0.3)', 'rgba(78, 205, 196, 0.3)'],
                itemColors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#B794F6']
            }
        },
        
        correctMessages: [
            "ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ğŸ‘ ì™„ë²½í•œ ë“œë˜ê·¸ ì‹¤ë ¥ì´ì—ìš”!",
            "í™˜ìƒì ì´ì—ìš”! ğŸŒŸ í›Œë¥­í•œ ë°°ì¹˜ì˜€ìŠµë‹ˆë‹¤!",
            "ë§ìŠµë‹ˆë‹¤! ğŸŠ ì •í™•í•œ ìœ„ì¹˜ì— ë°°ì¹˜í–ˆì–´ìš”!",
            "ì •ë‹µì´ì—ìš”! ğŸ’¯ ìµœê³ ì˜ ë“œë˜ê·¸ ì†œì”¨ì˜ˆìš”!",
            "ë¸Œë¼ë³´! ğŸ­ ë©‹ì§„ ë“œë˜ê·¸ í…Œí¬ë‹‰ì´ì—ˆìŠµë‹ˆë‹¤!"
        ],
        
        incorrectMessages: [
            "ğŸ¤” ì•„ì§ ì •ë‹µì´ ì•„ë‹ˆì—ìš”! ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”! ğŸ˜Š",
            "ê´œì°®ì•„ìš”! ğŸ’ª í•œ ë²ˆ ë” ë„ì „í•´ë³´ì„¸ìš”!",
            "ì¡°ê¸ˆ ë” ìƒê°í•´ë³¼ê¹Œìš”? ğŸ§ ë‹¤ì‹œ ë°°ì¹˜í•´ë³´ì„¸ìš”!",
            "ì•„ì‰¬ì›Œìš”! ğŸ˜Š ë‹¤ì‹œ í•œë²ˆ ë“œë˜ê·¸í•´ë³´ì„¸ìš”!",
            "í˜ë‚´ì„¸ìš”! ğŸŒŸ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!"
        ]
    };
    
    // ì „ì—­ ë³€ìˆ˜
    let dragIsAnswered = false;
    let currentState = {};
    let draggedItem = null;
    let touchItem = null;
    let extractedItems = [];
    let questionText = '';
    let quizType = 'fill-blank'; // ê¸°ë³¸ê°’
    let zoneIdMap = {}; // Zone ID ë§¤í•‘
    
    // ğŸš€ ë“œë˜ê·¸ í€´ì¦ˆ ì´ˆê¸°í™” (ê°œì„ ëœ ë²„ì „)
    function initializeDragQuiz() {
        if ($('#drag-quiz-container').length === 0) return;
        
        console.log('ğŸš€ ë“œë˜ê·¸ í€´ì¦ˆ ì´ˆê¸°í™” ì‹œì‘');
        
        // â˜…â˜…â˜… ë‹¨ê³„ 1: ê¸°ì¡´ êµ¬ì¡° ì™„ì „ ì œê±° â˜…â˜…â˜…
        forceCleanupOriginalStructure();
        
        // â˜…â˜…â˜… ë‹¨ê³„ 2: ë¬¸ì œì™€ ì•„ì´í…œ ì¶”ì¶œ â˜…â˜…â˜…
        extractQuestionAndItemsImproved();
        
        // â˜…â˜…â˜… ë‹¨ê³„ 3: ë‚˜ë¨¸ì§€ ì´ˆê¸°í™” â˜…â˜…â˜…
        detectQuizType();
        const theme = detectThemeFromText(questionText);
        applyDragTheme(theme);
        createDragParticles(theme);
        initializeQuizByType();
        restoreDragAnswer();
        
        console.log('âœ… ë“œë˜ê·¸ í€´ì¦ˆ ì´ˆê¸°í™” ì™„ë£Œ');
        console.log(`ğŸ“‹ í€´ì¦ˆ íƒ€ì…: ${quizType}`);
        console.log(`ğŸ¨ í…Œë§ˆ: ${theme}`);
    }
    
    // â˜…â˜…â˜… ìƒˆë¡œìš´ í•¨ìˆ˜: ê¸°ì¡´ êµ¬ì¡° ê°•ì œ ì œê±° â˜…â˜…â˜…
    function forceCleanupOriginalStructure() {
        console.log('ğŸ§¹ ê¸°ì¡´ êµ¬ì¡° ê°•ì œ ì •ë¦¬ ì‹œì‘');
        
        const container = $('#drag-quiz-container');
        if (container.length === 0) return;
        
        // ìˆ¨ê²¨ì•¼ í•  ìš”ì†Œë“¤ì˜ ì„ íƒì ëª©ë¡
        const selectorsToHide = [
            '.quiz-container .space-y-4:not(.drag-items-container)',
            '.quiz-container .options-container:not(.drag-items-container)', 
            '.quiz-container .option-button:not(.drag-item)',
            '.quiz-container .choice:not(.drag-item)',
            '.quiz-container .answer:not(.drag-item)',
            '.space-y-4:not(.drag-items-container)',
            '.options-container:not(.drag-items-container)',
            '.option-button:not(.drag-item)',
            '.choice:not(.drag-item)',
            '.answer:not(.drag-item)'
        ];
        
        // ê° ì„ íƒìì— ëŒ€í•´ ê°•ì œë¡œ ìˆ¨ê¹€ ì²˜ë¦¬
        selectorsToHide.forEach(selector => {
            container.find(selector).each(function() {
                $(this).css({
                    'display': 'none',
                    'visibility': 'hidden',
                    'opacity': '0',
                    'position': 'absolute',
                    'left': '-9999px',
                    'top': '-9999px',
                    'width': '0',
                    'height': '0',
                    'overflow': 'hidden',
                    'z-index': '-1000'
                }).addClass('drag-hidden');
            });
        });
        
        console.log('ğŸ§¹ ê¸°ì¡´ êµ¬ì¡° ê°•ì œ ì •ë¦¬ ì™„ë£Œ');
    }
    
    // â˜…â˜…â˜… ê°œì„ ëœ ë¬¸ì œì™€ ì•„ì´í…œ ì¶”ì¶œ í•¨ìˆ˜ â˜…â˜…â˜…
    function extractQuestionAndItemsImproved() {
        console.log('ğŸ“ ê°œì„ ëœ ë¬¸ì œ/ì•„ì´í…œ ì¶”ì¶œ ì‹œì‘');
        
        // 1. ë¬¸ì œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ë” ì•ˆì •ì ì¸ ë°©ë²•)
        extractQuestionTextSafely();
        
        // 2. ë“œë˜ê·¸ ì•„ì´í…œ ì¶”ì¶œ (ë” ì•ˆì •ì ì¸ ë°©ë²•)
        extractDragItemsSafely();
        
        console.log('ğŸ“ ìµœì¢… ë¬¸ì œ:', questionText);
        console.log('ğŸ“‹ ìµœì¢… ì•„ì´í…œ:', extractedItems);
    }
    
    // â˜…â˜…â˜… ì•ˆì „í•œ ë¬¸ì œ í…ìŠ¤íŠ¸ ì¶”ì¶œ â˜…â˜…â˜…
    function extractQuestionTextSafely() {
        questionText = '';
        
        // ë°©ë²• 1: question-boxì—ì„œ h1 íƒœê·¸ì˜ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
        const questionH1 = $('#question-text h1, .question-box h1').first();
        if (questionH1.length > 0) {
            // h1 ë‚´ìš©ì„ ë³µì‚¬í•˜ë˜, drop-zoneì€ [ë¹ˆì¹¸]ìœ¼ë¡œ ì¹˜í™˜
            const clonedH1 = questionH1.clone();
            clonedH1.find('.drop-zone').text('[ë¹ˆì¹¸]');
            questionText = clonedH1.text().trim();
            console.log('âœ… ë°©ë²•1 ì„±ê³µ - h1ì—ì„œ ì¶”ì¶œ:', questionText);
        }
        
        // ë°©ë²• 2: question-text í´ë˜ìŠ¤ì—ì„œ ì§ì ‘ ì¶”ì¶œ
        if (!questionText || questionText.length < 5) {
            const questionDiv = $('.question-text').first();
            if (questionDiv.length > 0) {
                const clonedDiv = questionDiv.clone();
                clonedDiv.find('.drop-zone').text('[ë¹ˆì¹¸]');
                questionText = clonedDiv.text().trim();
                console.log('âœ… ë°©ë²•2 ì„±ê³µ - question-textì—ì„œ ì¶”ì¶œ:', questionText);
            }
        }
        
        // ë°©ë²• 3: ì „ì²´ question-boxì—ì„œ ì •ë¦¬í•´ì„œ ì¶”ì¶œ
        if (!questionText || questionText.length < 5) {
            const questionBox = $('#question-text, .question-box').first();
            if (questionBox.length > 0) {
                const cloned = questionBox.clone();
                // ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤ ì œê±°
                cloned.find('.space-y-4, .options-container, .option-button, .choice, .answer').not('.drag-items-container, .drag-item').remove();
                cloned.find('.drop-zone').text('[ë¹ˆì¹¸]');
                questionText = cloned.text().replace(/\s+/g, ' ').trim();
                console.log('âœ… ë°©ë²•3 ì„±ê³µ - ì „ì²´ì—ì„œ ì •ë¦¬ ì¶”ì¶œ:', questionText);
            }
        }
        
        // ê¸°ë³¸ê°’ ì„¤ì •
        if (!questionText || questionText.length < 5) {
            questionText = "ë“œë˜ê·¸ì•¤ë“œë¡­ ë¬¸ì œë¥¼ í’€ì–´ë³´ì„¸ìš”!";
            console.log('âš ï¸ ê¸°ë³¸ ë¬¸ì œ í…ìŠ¤íŠ¸ ì‚¬ìš©');
        }
    }
    
    // â˜…â˜…â˜… ì•ˆì „í•œ ë“œë˜ê·¸ ì•„ì´í…œ ì¶”ì¶œ â˜…â˜…â˜…
    function extractDragItemsSafely() {
        extractedItems = [];
        
        // ë°©ë²• 1: data-clicked ì†ì„±ì„ ê°€ì§„ ìš”ì†Œë“¤ì—ì„œ ì¶”ì¶œ
        $('[data-clicked]').not('.drag-hidden').each(function(index) {
            const itemText = $(this).find('.option-text').text().trim() || $(this).text().trim();
            const dataClicked = $(this).attr('data-clicked');
            
            if (itemText && itemText !== 'ë¹ˆì¹¸') {
                extractedItems.push({
                    id: `item${index + 1}`,
                    text: itemText,
                    value: dataClicked || (index + 1).toString()
                });
                console.log(`ğŸ“‹ ì•„ì´í…œ ${index + 1} ì¶”ì¶œ:`, itemText, '(ê°’:', dataClicked, ')');
            }
        });
        
        // ë°©ë²• 2: .option-textë¥¼ ê°€ì§„ ìš”ì†Œë“¤ì—ì„œ ì¶”ì¶œ
        if (extractedItems.length === 0) {
            $('.option-text').not('.drag-hidden').each(function(index) {
                const itemText = $(this).text().trim();
                const parent = $(this).parent();
                const dataClicked = parent.attr('data-clicked');
                
                if (itemText && itemText !== 'ë¹ˆì¹¸') {
                    extractedItems.push({
                        id: `item${index + 1}`,
                        text: itemText,
                        value: dataClicked || (index + 1).toString()
                    });
                    console.log(`ğŸ“‹ ë°©ë²•2 ì•„ì´í…œ ${index + 1} ì¶”ì¶œ:`, itemText);
                }
            });
        }
        
        // ê¸°ë³¸ ì•„ì´í…œ ì„¤ì •
        if (extractedItems.length === 0) {
            console.log('âš ï¸ ì¶”ì¶œëœ ì•„ì´í…œì´ ì—†ìŒ - ê¸°ë³¸ ì•„ì´í…œ ìƒì„±');
            extractedItems = [
                { id: 'item1', text: 'ì„ íƒì§€ 1', value: '1' },
                { id: 'item2', text: 'ì„ íƒì§€ 2', value: '2' },
                { id: 'item3', text: 'ì„ íƒì§€ 3', value: '3' }
            ];
        }
        
        console.log('ğŸ“‹ ìµœì¢… ì¶”ì¶œëœ ì•„ì´í…œ ê°œìˆ˜:', extractedItems.length);
    }
    
    // ğŸ¯ í€´ì¦ˆ íƒ€ì… ê°ì§€
    function detectQuizType() {
        const text = questionText.toLowerCase();
        
        // í‚¤ì›Œë“œ ê¸°ë°˜ íƒ€ì… ê°ì§€
        if (text.includes('ìˆœì„œ') || text.includes('ì •ë ¬') || text.includes('ë°°ì—´') || 
            text.includes('ì‘ì€ ê²ƒë¶€í„°') || text.includes('í° ê²ƒë¶€í„°') ||
            text.includes('1ë²ˆì§¸') || text.includes('2ë²ˆì§¸') || text.includes('3ë²ˆì§¸')) {
            quizType = 'sort';
        } else if (text.includes('ì—°ê²°') || text.includes('ë§¤ì¹­') || text.includes('ì§') || 
                   text.includes('ê³¼ ') || text.includes('ì§ì—…ê³¼') || text.includes('ëŠ¥ë ¥')) {
            quizType = 'match';
        } else if (text.includes('ë¹ˆì¹¸') || text.includes('____') || 
                   text.includes('<drop-zone') || text.includes('data-zone-id')) {
            quizType = 'fill-blank';
        } else {
            // ê¸°ë³¸ê°’ì€ ë¹ˆì¹¸ì±„ìš°ê¸°
            quizType = 'fill-blank';
        }
        
        console.log(`ğŸ¯ ê°ì§€ëœ í€´ì¦ˆ íƒ€ì…: ${quizType}`);
    }
    
    // ğŸ¨ ë¬¸ì œ í…ìŠ¤íŠ¸ì—ì„œ í…Œë§ˆ ê°ì§€
    function detectThemeFromText(text) {
        let maxScore = 0;
        let detectedTheme = 'default';
        
        Object.keys(DRAG_CONFIG.themes).forEach(theme => {
            const keywords = DRAG_CONFIG.themes[theme].keywords;
            let score = 0;
            
            keywords.forEach(keyword => {
                if (text.includes(keyword)) {
                    score++;
                }
            });
            
            if (score > maxScore) {
                maxScore = score;
                detectedTheme = theme;
            }
        });
        
        console.log(`ğŸ¨ ê°ì§€ëœ í…Œë§ˆ: ${detectedTheme} (ì ìˆ˜: ${maxScore})`);
        return detectedTheme;
    }
    
    // ğŸª ë“œë˜ê·¸ í…Œë§ˆ ì ìš©
    function applyDragTheme(theme) {
        const container = $('#drag-quiz-container');
        container.attr('data-theme', theme);
        
        if (DRAG_CONFIG.themes[theme]) {
            const themeConfig = DRAG_CONFIG.themes[theme];
            
            // ì¥ì‹ ì´ëª¨ì§€ ì„¤ì •
            $('#decoration1').text(themeConfig.emojis[0] || 'ğŸ¯');
            $('#decoration2').text(themeConfig.emojis[Math.floor(Math.random() * themeConfig.emojis.length)] || 'âœ¨');
        }
        
        // í€´ì¦ˆ ì œëª© ì„¤ì •
        const themeNames = {
            science: 'ê³¼í•™',
            math: 'ìˆ˜í•™',
            social: 'ì‚¬íšŒ',
            career: 'ì§„ë¡œ',
            default: 'ì¼ë°˜'
        };
        
        const typeNames = {
            'fill-blank': 'ë¹ˆì¹¸ì±„ìš°ê¸°',
            'sort': 'ìˆœì„œì •ë ¬',
            'match': 'ë§¤ì¹­ë¬¸ì œ'
        };
        
        $('#quiz-title').text(`${themeNames[theme] || 'ì¼ë°˜'} ${typeNames[quizType] || 'ë“œë˜ê·¸ì•¤ë“œë¡­'} í€´ì¦ˆ`);
    }
    
    // âœ¨ íŒŒí‹°í´ ìƒì„±
    function createDragParticles(theme) {
        const particleContainer = $('#particles');
        const themeConfig = DRAG_CONFIG.themes[theme];
        
        if (!themeConfig) return;
        
        particleContainer.empty();
        
        for (let i = 0; i < 20; i++) {
            const particle = $('<div>').addClass('particle');
            particle.css({
                'left': Math.random() * 100 + '%',
                'width': Math.random() * 10 + 6 + 'px',
                'height': Math.random() * 10 + 6 + 'px',
                'background-color': themeConfig.colors[Math.floor(Math.random() * themeConfig.colors.length)],
                'animation-delay': Math.random() * 15 + 's',
                'animation-duration': (Math.random() * 10 + 15) + 's'
            });
            
            // 40% í™•ë¥ ë¡œ í…Œë§ˆë³„ ì´ëª¨ì§€ íŒŒí‹°í´
            if (Math.random() < 0.4 && themeConfig.particles) {
                particle.text(themeConfig.particles[Math.floor(Math.random() * themeConfig.particles.length)]);
                particle.css({
                    'background-color': 'transparent',
                    'font-size': '24px',
                    'width': 'auto',
                    'height': 'auto'
                });
            }
            
            particleContainer.append(particle);
        }
    }
    
    // ğŸ—ï¸ í€´ì¦ˆ íƒ€ì…ë³„ ì´ˆê¸°í™”
    function initializeQuizByType() {
        switch(quizType) {
            case 'fill-blank':
                initializeFillBlankImproved(); // â˜…â˜…â˜… ê°œì„ ëœ í•¨ìˆ˜ ì‚¬ìš© â˜…â˜…â˜…
                break;
            case 'sort':
                initializeSort();
                break;
            case 'match':
                initializeMatch();
                break;
            default:
                initializeFillBlankImproved(); // â˜…â˜…â˜… ê°œì„ ëœ í•¨ìˆ˜ ì‚¬ìš© â˜…â˜…â˜…
        }
    }
    
    // â˜…â˜…â˜… ê°œì„ ëœ ë¹ˆì¹¸ì±„ìš°ê¸° ì´ˆê¸°í™” â˜…â˜…â˜…
    function initializeFillBlankImproved() {
        console.log('ğŸ”§ ê°œì„ ëœ ë¹ˆì¹¸ì±„ìš°ê¸° ì´ˆê¸°í™”');
        
        const questionElement = $('#question-text');
        
        // 1. ê¸°ì¡´ HTML ì™„ì „ ì •ë¦¬
        const originalHTML = questionElement.html();
        const tempDiv = $('<div>').html(originalHTML);
        
        // 2. ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤ ì™„ì „ ì œê±°
        tempDiv.find('.space-y-4, .options-container, .option-button, .choice, .answer')
               .not('.drag-items-container, .drag-item')
               .remove();
        
        // 3. ì •ë¦¬ëœ HTML ì ìš©
        let cleanHTML = tempDiv.html();
        
        // 4. drop-zone í™•ì¸ ë° ê°•ì œ ì ìš©
        const hasDropZone = cleanHTML.includes('drop-zone');
        if (!hasDropZone) {
            // drop-zoneì´ ì—†ìœ¼ë©´ ë¹ˆì¹¸ í‘œì‹œë¥¼ drop-zoneìœ¼ë¡œ ë³€í™˜
            cleanHTML = cleanHTML.replace(/\[ë¹ˆì¹¸\]/g, '<span class="drop-zone" data-zone-id="zone1">ë¹ˆì¹¸</span>');
            cleanHTML = cleanHTML.replace(/____+/g, '<span class="drop-zone" data-zone-id="zone1">ë¹ˆì¹¸</span>');
        }
        
        questionElement.html(cleanHTML);
        
        // 5. drop-zone ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
        questionElement.find('.drop-zone').each(function(index) {
            const zoneId = $(this).attr('data-zone-id') || `zone${index + 1}`;
            $(this).attr('data-zone-id', zoneId)
                   .addClass('drop-zone')
                   .css({
                       'display': 'inline-flex',
                       'align-items': 'center',
                       'justify-content': 'center',
                       'min-width': '120px',
                       'min-height': '40px',
                       'border': '3px dashed #45B7D1',
                       'border-radius': '8px',
                       'margin': '0 8px',
                       'padding': '8px',
                       'background-color': 'rgba(255, 255, 255, 0.3)',
                       'cursor': 'pointer',
                       'position': 'relative'
                   });
        });
        
        // 6. ì´ë²¤íŠ¸ ì„¤ì •
        setupDropZones();
        createDragItems();
        
        console.log('âœ… ê°œì„ ëœ ë¹ˆì¹¸ì±„ìš°ê¸° ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ğŸ”¢ ì •ë ¬í˜• ì´ˆê¸°í™”
    function initializeSort() {
        console.log('ğŸ”§ ìˆœì„œì •ë ¬ ì´ˆê¸°í™”');
        
        $('#question-text').html(questionText);
        $('#sort-container').show();
        
        // ì •ë ¬ ì˜ì—­ ìƒì„±
        const sortContainer = $('#sort-container');
        sortContainer.empty();
        
        for (let i = 1; i <= extractedItems.length; i++) {
            const zoneElement = $('<div>')
                .addClass('sort-zone drop-zone')
                .attr('id', `sort${i}`)
                .attr('data-zone-id', `order${i}`)
                .attr('data-order', i)
                .html(`
                    <div class="zone-label">${i}ë²ˆì§¸</div>
                    <div class="zone-content">ì—¬ê¸°ì— ë“œë¡­</div>
                `);
            
            sortContainer.append(zoneElement);
        }
        
        // ì •ë ¬ì¡´ íŠ¹ë³„ ìŠ¤íƒ€ì¼ ì ìš©
        $('.sort-zone').css({
            'min-height': '100px',
            'border': '3px dashed #FF9800',
            'border-radius': '15px',
            'margin': '10px',
            'display': 'flex',
            'flex-direction': 'column',
            'justify-content': 'center',
            'align-items': 'center',
            'background': 'rgba(255, 152, 0, 0.1)',
            'transition': 'all 0.3s ease'
        });
        
        // ë“œë¡­ì¡´ ì´ë²¤íŠ¸ ì„¤ì •
        setupDropZones();
        
        // ë“œë˜ê·¸ ì•„ì´í…œ ìƒì„±
        createDragItems();
        
        console.log('âœ… ìˆœì„œì •ë ¬ ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ğŸ”— ë§¤ì¹­í˜• ì´ˆê¸°í™”
    function initializeMatch() {
        console.log('ğŸ”§ ë§¤ì¹­ë¬¸ì œ ì´ˆê¸°í™”');
        
        $('#question-text').html(questionText);
        $('#match-container').show();
        
        const matchContainer = $('#match-container');
        matchContainer.empty();
        
        // ë§¤ì¹­ ìŒ ì •ì˜ (ì‹¤ì œë¡œëŠ” ë¬¸ì œì—ì„œ ì¶”ì¶œí•´ì•¼ í•¨)
        const matchPairs = [
            { left: 'ì˜ì‚¬', right: 'ì˜í•™ ì§€ì‹' },
            { left: 'í™”ê°€', right: 'ì°½ì˜ì„±' },
            { left: 'ìš”ë¦¬ì‚¬', right: 'ë¯¸ê°' }
        ];
        
        matchPairs.forEach((pair, index) => {
            const rowElement = $('<div>')
                .addClass('match-row')
                .html(`
                    <div class="match-left">${pair.left}</div>
                    <div class="match-arrow">â†’</div>
                    <div class="match-right drop-zone" data-zone-id="match${index + 1}" data-match-id="match${index + 1}">
                        <span class="match-placeholder">ëŠ¥ë ¥ì„ ì„ íƒí•˜ì„¸ìš”</span>
                    </div>
                `);
            matchContainer.append(rowElement);
        });
        
        // ë§¤ì¹­ ì˜ì—­ íŠ¹ë³„ ìŠ¤íƒ€ì¼ ì ìš©
        $('.match-row').css({
            'display': 'flex',
            'align-items': 'center',
            'margin': '15px 0',
            'padding': '10px',
            'background': 'rgba(255, 255, 255, 0.1)',
            'border-radius': '12px'
        });
        
        $('.match-left').css({
            'flex': '1',
            'background': '#4CAF50',
            'color': 'white',
            'padding': '15px',
            'border-radius': '10px',
            'text-align': 'center',
            'font-weight': 'bold',
            'font-size': '18px'
        });
        
        $('.match-arrow').css({
            'font-size': '24px',
            'margin': '0 15px',
            'color': '#4CAF50'
        });
        
        $('.match-right').css({
            'min-width': '200px',
            'min-height': '60px',
            'border': '3px dashed #4CAF50',
            'border-radius': '10px',
            'background': 'rgba(76, 175, 80, 0.1)',
            'display': 'flex',
            'align-items': 'center',
            'justify-content': 'center',
            'transition': 'all 0.3s ease'
        });
        
        // ë“œë¡­ì¡´ ì´ë²¤íŠ¸ ì„¤ì •
        setupDropZones();
        
        // ë“œë˜ê·¸ ì•„ì´í…œ ìƒì„±
        createDragItems();
        
        console.log('âœ… ë§¤ì¹­ë¬¸ì œ ì´ˆê¸°í™” ì™„ë£Œ');
    }
    
    // ğŸ¨ ë“œë˜ê·¸ ì•„ì´í…œ ìƒì„± (í™”ë ¤í•œ ë²„ì „)
    function createDragItems() {
        const container = $('#drag-container');
        const theme = $('#drag-quiz-container').attr('data-theme') || 'default';
        const themeConfig = DRAG_CONFIG.themes[theme];
        
        container.empty();
        
        extractedItems.forEach((item, index) => {
            const itemElement = $('<div>')
                .addClass('drag-item')
                .attr('id', item.id)
                .attr('draggable', 'true')
                .attr('data-value', item.value)
                .attr('tabindex', '0')
                .attr('role', 'button')
                .attr('aria-label', `ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì•„ì´í…œ: ${item.text}`)
                .text(item.text)
                .css({
                    'background': `linear-gradient(135deg, ${themeConfig.itemColors[index % themeConfig.itemColors.length]}, ${adjustBrightness(themeConfig.itemColors[index % themeConfig.itemColors.length], 20)})`,
                    'color': 'white',
                    'padding': '12px 20px',
                    'margin': '8px',
                    'border-radius': '12px',
                    'cursor': 'move',
                    'font-weight': 'bold',
                    'font-size': '16px',
                    'box-shadow': '0 4px 12px rgba(0,0,0,0.15)',
                    'transition': 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                    'user-select': 'none',
                    'position': 'relative',
                    'overflow': 'hidden'
                });
            
            // ë°˜ì§ì´ëŠ” íš¨ê³¼ ì¶”ê°€
            const shimmer = $('<div>').css({
                'position': 'absolute',
                'top': '0',
                'left': '-100%',
                'width': '100%',
                'height': '100%',
                'background': 'linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent)',
                'animation': 'shimmer 2s infinite'
            });
            itemElement.append(shimmer);
            
            // ì´ë²¤íŠ¸ ë°”ì¸ë”©
            itemElement.on('dragstart', handleDragStart);
            itemElement.on('dragend', handleDragEnd);
            itemElement.on('touchstart', handleTouchStart);
            itemElement.on('touchmove', handleTouchMove);
            itemElement.on('touchend', handleTouchEnd);
            
            // í˜¸ë²„ íš¨ê³¼
            itemElement.on('mouseenter', function() {
                if (!$(this).hasClass('placed')) {
                    $(this).css({
                        'transform': 'translateY(-5px) scale(1.05)',
                        'box-shadow': '0 8px 25px rgba(0,0,0,0.25)'
                    });
                }
            }).on('mouseleave', function() {
                if (!$(this).hasClass('dragging placed')) {
                    $(this).css({
                        'transform': 'translateY(0) scale(1)',
                        'box-shadow': '0 4px 12px rgba(0,0,0,0.15)'
                    });
                }
            });
            
            container.append(itemElement);
            console.log('âœ¨ ë“œë˜ê·¸ ì•„ì´í…œ ìƒì„±:', item.text);
        });
        
        // ë°˜ì§ì´ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        $('<style>').prop('type', 'text/css').html(`
            @keyframes shimmer {
                0% { left: -100%; }
                100% { left: 100%; }
            }
        `).appendTo('head');
        
        // í‚¤ë³´ë“œ ì§€ì› ì„¤ì •
        setupKeyboardSupport();
    }
    
    // ğŸ¯ ë“œë¡­ì¡´ ì„¤ì • (í†µí•©ëœ ë²„ì „)
    function setupDropZones() {
        $(document).off('dragover drop dragenter dragleave', '.drop-zone, .sort-zone, .match-right');
        
        $(document).on('dragover', '.drop-zone, .sort-zone, .match-right', function(e) {
            e.preventDefault();
        });
        
        $(document).on('dragenter', '.drop-zone, .sort-zone, .match-right', function(e) {
            e.preventDefault();
            $(this).addClass('highlight');
            
            // ì§„ì… íš¨ê³¼
            $(this).css({
                'transform': 'scale(1.05)',
                'box-shadow': '0 0 20px rgba(69, 183, 209, 0.6)'
            });
            
            console.log('ğŸ¯ ë“œë¡­ì¡´ ì§„ì…:', $(this).attr('data-zone-id') || $(this).attr('data-match-id'));
        });
        
        $(document).on('dragleave', '.drop-zone, .sort-zone, .match-right', function(e) {
            $(this).removeClass('highlight');
            $(this).css({
                'transform': '',
                'box-shadow': ''
            });
        });
        
        $(document).on('drop', '.drop-zone, .sort-zone, .match-right', handleDrop);
    }
    
    // ğŸª ë“œë˜ê·¸ ì‹œì‘ (í™”ë ¤í•œ ì´ë²¤íŠ¸)
    function handleDragStart(e) {
        draggedItem = this;
        
        // ëª¨ë“  ì•„ì´í…œì˜ ì„ íƒ ìƒíƒœ ì œê±°
        $('.drag-item').removeClass('selected dragging');
        
        // í˜„ì¬ ì•„ì´í…œì„ ì„ íƒ ìƒíƒœë¡œ í‘œì‹œ
        $(this).addClass('selected');
        
        // í­ì£½ íš¨ê³¼
        createMiniFireworks($(this).offset());
        
        console.log('ğŸ¯ ë“œë˜ê·¸ ì‹œì‘:', $(this).text());
        
        // ì•½ê°„ì˜ ì§€ì—° í›„ ë“œë˜ê·¸ ìƒíƒœë¡œ ì „í™˜
        setTimeout(() => {
            $(this).removeClass('selected').addClass('dragging');
            $(this).css({
                'transform': 'scale(1.1) rotate(5deg)',
                'z-index': '1000',
                'box-shadow': '0 10px 30px rgba(0,0,0,0.3)'
            });
        }, 100);
        
        e.originalEvent.dataTransfer.setData('text/plain', this.id);
        
        // ì§„ë™ í”¼ë“œë°±
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
    }
    
    // ğŸª ë“œë˜ê·¸ ì¢…ë£Œ
    function handleDragEnd(e) {
        $(this).removeClass('dragging selected');
        $(this).css({
            'transform': '',
            'z-index': '',
            'box-shadow': '0 4px 12px rgba(0,0,0,0.15)'
        });
        
        $('.drop-zone, .sort-zone, .match-right').removeClass('highlight').css({
            'transform': '',
            'box-shadow': ''
        });
        
        console.log('ğŸ ë“œë˜ê·¸ ì¢…ë£Œ:', $(this).text());
    }
    
    // ğŸ’¥ ë“œë¡­ ì²˜ë¦¬ (í™”ë ¤í•œ ì´ë²¤íŠ¸)
    function handleDrop(e) {
        e.preventDefault();
        $(this).removeClass('highlight');
        
        if (dragIsAnswered) return;
        
        const itemId = e.originalEvent.dataTransfer.getData('text/plain');
        const item = $('#' + itemId);
        const zoneId = $(this).attr('data-zone-id') || $(this).attr('data-match-id') || 'zone1';
        
        console.log('ğŸ’¥ ë“œë¡­ ì„±ê³µ:', item.text(), 'â†’', zoneId);
        
        // ê¸°ì¡´ ì•„ì´í…œì´ ìˆë‹¤ë©´ ë³µì›
        if ($(this).attr('data-filled-by')) {
            const existingItem = $('#' + $(this).attr('data-filled-by'));
            if (existingItem.length) {
                existingItem.removeClass('placed').show();
                restoreItemStyle(existingItem);
            }
        }
        
        // ì„±ê³µ í­ì£½ íš¨ê³¼
        createSuccessExplosion($(this).offset());
        
        // ìƒˆ ì•„ì´í…œ ë°°ì¹˜ - ë§¤ì¹­ íƒ€ì…ë³„ ì²˜ë¦¬
        if ($(this).hasClass('match-right')) {
            // ë§¤ì¹­ íƒ€ì…: í”Œë ˆì´ìŠ¤í™€ë” êµì²´
            $(this).html(`<span class="match-answer">${item.text()}</span>`);
        } else {
            // ì¼ë°˜ ë¹ˆì¹¸/ì •ë ¬ íƒ€ì…: í…ìŠ¤íŠ¸ êµì²´
            $(this).text(item.text());
        }
        
        $(this).addClass('filled').attr('data-filled-by', itemId);
        item.addClass('placed').hide();
        
        // ì„±ê³µ íš¨ê³¼
        $(this).addClass('drop-success');
        setTimeout(() => {
            $(this).removeClass('drop-success');
        }, 1000);
        
        // ìƒíƒœ ì €ì¥
        currentState[zoneId] = item.attr('data-value') || itemId;
        
        console.log('ğŸ’¾ í˜„ì¬ ìƒíƒœ:', currentState);
        
        // ì™„ë£Œ í™•ì¸
        setTimeout(() => checkCompletion(), 300);
        
        // ì§„ë™ í”¼ë“œë°± (ì„±ê³µ íŒ¨í„´)
        if (navigator.vibrate) {
            navigator.vibrate([50, 50, 50]);
        }
    }
    
    // ğŸŒŸ ë¯¸ë‹ˆ í­ì£½ íš¨ê³¼
    function createMiniFireworks(position) {
        for (let i = 0; i < 5; i++) {
            const spark = $('<div>').css({
                'position': 'fixed',
                'left': position.left + 'px',
                'top': position.top + 'px',
                'width': '4px',
                'height': '4px',
                'background': '#FFD700',
                'border-radius': '50%',
                'pointer-events': 'none',
                'z-index': '9999'
            });
            
            $('body').append(spark);
            
            const angle = (i / 5) * 2 * Math.PI;
            const distance = 30;
            const endX = position.left + Math.cos(angle) * distance;
            const endY = position.top + Math.sin(angle) * distance;
            
            spark.animate({
                left: endX + 'px',
                top: endY + 'px',
                opacity: 0
            }, 500, function() {
                $(this).remove();
            });
        }
    }
    
    // ğŸ’¥ ì„±ê³µ í­ë°œ íš¨ê³¼
    function createSuccessExplosion(position) {
        const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];
        
        for (let i = 0; i < 12; i++) {
            const particle = $('<div>').css({
                'position': 'fixed',
                'left': position.left + 'px',
                'top': position.top + 'px',
                'width': '8px',
                'height': '8px',
                'background': colors[Math.floor(Math.random() * colors.length)],
                'border-radius': '50%',
                'pointer-events': 'none',
                'z-index': '9999'
            });
            
            $('body').append(particle);
            
            const angle = (i / 12) * 2 * Math.PI;
            const distance = 60 + Math.random() * 40;
            const endX = position.left + Math.cos(angle) * distance;
            const endY = position.top + Math.sin(angle) * distance;
            
            particle.animate({
                left: endX + 'px',
                top: endY + 'px',
                opacity: 0,
                transform: 'scale(2)'
            }, 800, function() {
                $(this).remove();
            });
        }
    }
    
    // í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
    function handleTouchStart(e) {
        if (dragIsAnswered) return;
        
        touchItem = this;
        $(this).addClass('selected');
        
        // í„°ì¹˜ ì‹œì‘ íš¨ê³¼
        createMiniFireworks($(this).offset());
        
        setTimeout(() => {
            $(this).removeClass('selected').addClass('dragging');
        }, 100);
        
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
        
        e.preventDefault();
    }
    
    function handleTouchMove(e) {
        if (!touchItem) return;
        e.preventDefault();
        
        const touch = e.originalEvent.touches[0];
        
        $(touchItem).css({
            'position': 'fixed',
            'left': touch.clientX - 60 + 'px',
            'top': touch.clientY - 30 + 'px',
            'z-index': '1000',
            'pointer-events': 'none',
            'transform': 'scale(1.1) rotate(5deg)',
            'box-shadow': '0 10px 30px rgba(0,0,0,0.3)'
        });
        
        // ë“œë¡­ì¡´ í•˜ì´ë¼ì´íŠ¸ ì²˜ë¦¬
        const element = document.elementFromPoint(touch.clientX, touch.clientY);
        $('.drop-zone, .sort-zone, .match-right').removeClass('highlight');
        
        if (element && ($(element).hasClass('drop-zone') || $(element).hasClass('sort-zone') || $(element).hasClass('match-right'))) {
            $(element).addClass('highlight');
            
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        }
    }
    
    function handleTouchEnd(e) {
        if (!touchItem) return;
        
        const touch = e.originalEvent.changedTouches[0];
        const element = document.elementFromPoint(touch.clientX, touch.clientY);
        
        // ìŠ¤íƒ€ì¼ ë³µì›
        restoreItemStyle($(touchItem));
        
        // ë“œë¡­ ì²˜ë¦¬
        if (element && ($(element).hasClass('drop-zone') || $(element).hasClass('sort-zone') || $(element).hasClass('match-right'))) {
            if (navigator.vibrate) {
                navigator.vibrate([50, 50, 50]);
            }
            
            const fakeEvent = {
                preventDefault: () => {},
                originalEvent: {
                    dataTransfer: {
                        getData: () => touchItem.id
                    }
                }
            };
            handleDrop.call(element, fakeEvent);
        }
        
        $('.drop-zone, .sort-zone, .match-right').removeClass('highlight');
        touchItem = null;
    }
    
    // ì•„ì´í…œ ìŠ¤íƒ€ì¼ ë³µì›
    function restoreItemStyle(item) {
        item.css({
            'position': '',
            'left': '',
            'top': '',
            'z-index': '',
            'pointer-events': '',
            'transform': '',
            'box-shadow': '0 4px 12px rgba(0,0,0,0.15)'
        }).removeClass('dragging selected');
    }
    
    // í‚¤ë³´ë“œ ì ‘ê·¼ì„± ì§€ì›
    function setupKeyboardSupport() {
        $(document).on('keydown', '.drag-item', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                $('.drag-item').removeClass('selected');
                $(this).addClass('selected');
                
                // í‚¤ë³´ë“œ ì„ íƒ íš¨ê³¼
                createMiniFireworks($(this).offset());
                
                setTimeout(() => {
                    $(this).removeClass('selected');
                }, 2000);
            }
        });
    }
    
    // âœ… ì™„ë£Œ í™•ì¸
    function checkCompletion() {
        if (dragIsAnswered) return;
        
        const totalZones = $('.drop-zone:visible, .sort-zone:visible, .match-right:visible').length;
        const filledZones = Object.keys(currentState).length;
        
        console.log(`ğŸ“Š ì™„ë£Œ í™•ì¸: ${filledZones}/${totalZones}`);
        
        if (filledZones >= totalZones && totalZones > 0) {
            checkAnswers();
        }
    }
    
    // ğŸ“ ë‹µì•ˆ ì±„ì 
    function checkAnswers() {
        if (dragIsAnswered) return;
        
        dragIsAnswered = true;
        console.log('ğŸ“¤ ë‹µì•ˆ ì œì¶œ:', currentState);
        
        const slideId = '{{ slide.id }}';
        const contentId = '{{ slide.content.id }}';
        
        $.ajax({
            url: '{% url "student:check_answer" %}',
            type: 'POST',
            data: {
                'content_id': contentId,
                'slide_id': slideId,
                'student_answer': JSON.stringify(currentState),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('âœ… ì±„ì  ê²°ê³¼:', response);
                handleDragResult(response);
            },
            error: function() {
                console.error('âŒ ì±„ì  ì˜¤ë¥˜');
                showDragToast('ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                resetDragQuiz();
            }
        });
    }
    
    // ğŸ‰ ê²°ê³¼ ì²˜ë¦¬ (í™”ë ¤í•œ ì• ë‹ˆë©”ì´ì…˜)
    function handleDragResult(response) {
        console.log('ğŸ‰ ê²°ê³¼ ì²˜ë¦¬:', response);
        
        // ë“œë¡­ì¡´ ìƒíƒœ í‘œì‹œ
        $('.drop-zone.filled, .sort-zone.filled, .match-right.filled').each(function() {
            const zoneId = $(this).attr('data-zone-id') || $(this).attr('data-match-id');
            if (zoneId && currentState[zoneId]) {
                $(this).addClass(response.is_correct ? 'correct' : 'incorrect');
            }
        });
        
        setTimeout(() => {
            if (response.is_correct) {
                // ì •ë‹µ ì²˜ë¦¬ - ëŒ€í˜• í­ì£½ ì‡¼
                createGrandFireworks();
                showDragToast(getRandomMessage(DRAG_CONFIG.correctMessages), 'success');
                showDragFeedback('correct', getRandomMessage(DRAG_CONFIG.correctMessages));
                $('#submit-btn, #resubmit-btn').hide();
                
                console.log('ğŸ‰ ì •ë‹µ ì²˜ë¦¬ ì™„ë£Œ');
            } else {
                // ì˜¤ë‹µ ì²˜ë¦¬ - ê²©ë ¤ ì• ë‹ˆë©”ì´ì…˜
                createEncouragementAnimation();
                showDragToast(getRandomMessage(DRAG_CONFIG.incorrectMessages), 'error');
                showDragFeedback('incorrect', getRandomMessage(DRAG_CONFIG.incorrectMessages));
                $('#submit-btn').hide();
                $('#resubmit-btn').show();
                
                console.log('ğŸ’ª ì˜¤ë‹µ ì²˜ë¦¬ ì™„ë£Œ');
            }
        }, 300);
        
        updateDragSubmissionStatus(response);
        
        if (!response.is_correct) {
            setTimeout(() => resetDragQuizForRetry(), 8000);
        }
    }
    
    // ğŸ† ëŒ€í˜• í­ì£½ ì‡¼
    function createGrandFireworks() {
        const container = $('#animation-container');
        
        // ì—°ì† í­ì£½ 3ë°œ
        for (let i = 0; i < 3; i++) {
            setTimeout(() => {
                const centerX = Math.random() * window.innerWidth;
                const centerY = Math.random() * (window.innerHeight * 0.6) + window.innerHeight * 0.2;
                
                // ê° í­ì£½ë§ˆë‹¤ 16ê°œì˜ ë¶ˆê½ƒ
                for (let j = 0; j < 16; j++) {
                    const particle = $('<div>').css({
                        'position': 'fixed',
                        'left': centerX + 'px',
                        'top': centerY + 'px',
                        'width': '12px',
                        'height': '12px',
                        'background': `hsl(${Math.random() * 360}, 80%, 60%)`,
                        'border-radius': '50%',
                        'pointer-events': 'none',
                        'z-index': '9999'
                    });
                    
                    $('body').append(particle);
                    
                    const angle = (j / 16) * 2 * Math.PI;
                    const distance = 150 + Math.random() * 100;
                    const endX = centerX + Math.cos(angle) * distance;
                    const endY = centerY + Math.sin(angle) * distance;
                    
                    particle.animate({
                        left: endX + 'px',
                        top: endY + 'px',
                        opacity: 0,
                        transform: 'scale(2)'
                    }, 1500, function() {
                        $(this).remove();
                    });
                }
            }, i * 400);
        }
    }
    
    // ğŸ’ª ê²©ë ¤ ì• ë‹ˆë©”ì´ì…˜
    function createEncouragementAnimation() {
        const encourageEmojis = ['ğŸ’ª', 'ğŸŒŸ', 'âœ¨', 'ğŸ¯', 'ğŸš€'];
        
        for (let i = 0; i < 10; i++) {
            setTimeout(() => {
                const emoji = $('<div>').css({
                    'position': 'fixed',
                    'left': Math.random() * window.innerWidth + 'px',
                    'top': window.innerHeight + 'px',
                    'font-size': '36px',
                    'pointer-events': 'none',
                    'z-index': '9999'
                });
                
                emoji.text(encourageEmojis[Math.floor(Math.random() * encourageEmojis.length)]);
                $('body').append(emoji);
                
                emoji.animate({
                    top: -100 + 'px',
                    opacity: 0,
                    transform: 'scale(1.5) rotate(360deg)'
                }, 2000, function() {
                    $(this).remove();
                });
            }, i * 200);
        }
    }
    
    // í”¼ë“œë°± í‘œì‹œ
    function showDragFeedback(type, message) {
        const feedbackElement = $(`#feedback-${type}`);
        feedbackElement.html(message).addClass('show');
    }
    
    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showDragToast(message, type = 'info') {
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
        } else {
            console.log(`Toast [${type}]: ${message}`);
        }
    }
    
    // ì œì¶œ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateDragSubmissionStatus(response) {
        const wrapper = $('#submission-status-wrapper');
        const statusIcon = response.is_correct
            ? '<span class="text-green-600"><i class="fas fa-check-circle"></i> ì •ë‹µ</span>'
            : '<span class="text-red-600"><i class="fas fa-times-circle"></i> ì˜¤ë‹µ</span>';
        
        wrapper.html(`
            <div class="mt-4 text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>
                ë§ˆì§€ë§‰ ì œì¶œ: ${response.submitted_at || 'ë°©ê¸ˆ ì „'}
                ${statusIcon}
            </div>
        `);
    }
    
    // ğŸ”„ ì¬ì‹œë„ìš© ë¦¬ì…‹
    function resetDragQuizForRetry() {
        {% if not is_already_correct %}
        console.log('ğŸ”„ ì¬ì‹œë„ ì¤€ë¹„');
        
        dragIsAnswered = false;
        currentState = {};
        
        $('.drop-zone, .sort-zone, .match-right').removeClass('filled highlight correct incorrect')
                       .removeAttr('data-filled-by');
        
        // íƒ€ì…ë³„ ì›ë˜ í…ìŠ¤íŠ¸ ë³µì›
        $('.drop-zone').each(function() {
            if (!$(this).hasClass('sort-zone') && !$(this).hasClass('match-right')) {
                $(this).text('ë¹ˆì¹¸');
            }
        });
        
        $('.sort-zone').each(function() {
            const order = $(this).attr('data-order');
            $(this).html(`
                <div class="zone-label">${order}ë²ˆì§¸</div>
                <div class="zone-content">ì—¬ê¸°ì— ë“œë¡­</div>
            `);
        });
        
        $('.match-right').each(function() {
            $(this).html('<span class="match-placeholder">ëŠ¥ë ¥ì„ ì„ íƒí•˜ì„¸ìš”</span>');
        });
        
        $('.drag-item').removeClass('placed').show();
        extractedItems.forEach(item => {
            restoreItemStyle($('#' + item.id));
        });
        
        $('#feedback-correct, #feedback-incorrect').removeClass('show');
        
        console.log('âœ… ì¬ì‹œë„ ì¤€ë¹„ ì™„ë£Œ');
        {% endif %}
    }
    
    // ğŸ”„ ê¸°ì¡´ ë‹µì•ˆ ë³µì› (ê°œì„ ëœ ë²„ì „)
    function restoreDragAnswer() {
        {% if existing_answer and slide.content_type.type_name == 'drag' %}
        try {
            const rawAnswer = '{{ existing_answer.answer|escapejs|default:"{}" }}';
            console.log('=== ë‹µì•ˆ ë³µì› ì‹œì‘ ===');
            console.log('Raw Answer:', rawAnswer);
            
            const answerData = JSON.parse(rawAnswer.replace(/'/g, '"'));
            console.log('Parsed Answer:', answerData);
            
            if (answerData.selected_answer) {
                const savedState = answerData.selected_answer;
                dragIsAnswered = true;
                
                console.log('ğŸ’¾ ë³µì›í•  ìƒíƒœ:', savedState);
                
                // ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ëª¨ë“  ë“œë¡­ì¡´ ì°¾ê¸°
                const allDropZones = $('.drop-zone, .sort-zone, .match-right');
                console.log('ğŸ” ì „ì²´ ë“œë¡­ì¡´ ê°œìˆ˜:', allDropZones.length);
                
                // ì €ì¥ëœ ìƒíƒœì˜ ê° í•­ëª©ì— ëŒ€í•´ ë³µì›
                Object.keys(savedState).forEach((savedZoneId, index) => {
                    const itemValue = savedState[savedZoneId];
                    console.log(`ğŸ” ë³µì› ì‹œë„ ${index + 1}: Zone '${savedZoneId}' = Item '${itemValue}'`);
                    
                    // Zone ì°¾ê¸° - ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„
                    let zone = null;
                    
                    // ë°©ë²• 1: ì •í™•í•œ zone-id ë§¤ì¹­
                    zone = $(`.drop-zone[data-zone-id="${savedZoneId}"], .sort-zone[data-zone-id="${savedZoneId}"], .match-right[data-zone-id="${savedZoneId}"], .match-right[data-match-id="${savedZoneId}"]`);
                    console.log(`   ğŸ¯ ì§ì ‘ ë§¤ì¹­ ì‹œë„: '${savedZoneId}' â†’ ${zone.length}ê°œ ë°œê²¬`);
                    
                    // ë°©ë²• 2: ì²« ë²ˆì§¸ ì‚¬ìš© ê°€ëŠ¥í•œ ë“œë¡­ì¡´ ì‚¬ìš©
                    if (zone.length === 0 && allDropZones.length > 0) {
                        zone = $(allDropZones[0]);
                        console.log(`   ğŸ“ ì²« ë²ˆì§¸ ë“œë¡­ì¡´ ì‚¬ìš©: ${zone.attr('data-zone-id') || zone.attr('data-match-id') || 'no-id'}`);
                    }
                    
                    // ë°©ë²• 3: ì¸ë±ìŠ¤ ê¸°ë°˜ ë§¤ì¹­
                    if (zone.length === 0 && allDropZones.length > index) {
                        zone = $(allDropZones[index]);
                        console.log(`   ğŸ“ ì¸ë±ìŠ¤ ê¸°ë°˜ ë§¤ì¹­: ${index}ë²ˆì§¸ ë“œë¡­ì¡´ ì‚¬ìš©`);
                    }
                    
                    // Item ì°¾ê¸°
                    const item = $(`.drag-item[data-value="${itemValue}"]`);
                    
                    console.log(`   Zone ì°¾ìŒ: ${zone.length}ê°œ, Item ì°¾ìŒ: ${item.length}ê°œ`);
                    
                    // ë³µì› ìˆ˜í–‰
                    if (zone.length > 0 && item.length > 0) {
                        // ë§¤ì¹­ íƒ€ì…ë³„ ë³µì› ì²˜ë¦¬
                        if (zone.hasClass('match-right')) {
                            zone.html(`<span class="match-answer">${item.text()}</span>`);
                            console.log(`   âœ… ë§¤ì¹­ ë³µì›: ${item.text()}`);
                        } else {
                            zone.text(item.text());
                            console.log(`   âœ… ì¼ë°˜ ë³µì›: ${item.text()}`);
                        }
                        
                        zone.addClass('filled').attr('data-filled-by', item.attr('id'));
                        item.addClass('placed').hide();
                        
                        // í˜„ì¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                        const actualZoneId = zone.attr('data-zone-id') || zone.attr('data-match-id') || savedZoneId;
                        currentState[actualZoneId] = itemValue;
                        
                    } else {
                        console.log(`   âŒ ë³µì› ì‹¤íŒ¨: Zone(${zone.length}) ë˜ëŠ” Item(${item.length})ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                    }
                });
                
                console.log('ğŸ¯ ìµœì¢… ë³µì›ëœ ìƒíƒœ:', currentState);
                
                // ì •ë‹µ/ì˜¤ë‹µ ìƒíƒœ í‘œì‹œ
                setTimeout(() => {
                    {% if is_already_correct %}
                    $('.drop-zone.filled, .sort-zone.filled, .match-right.filled').addClass('correct');
                    $('#submit-btn, #resubmit-btn').hide();
                    showDragFeedback('correct', 'ğŸ‰ ì´ì „ ì œì¶œ: ì •ë‹µì…ë‹ˆë‹¤!');
                    console.log('âœ… ì •ë‹µ ìƒíƒœë¡œ ë³µì› ì™„ë£Œ');
                    {% else %}
                    $('.drop-zone.filled, .sort-zone.filled, .match-right.filled').addClass('incorrect');
                    $('#submit-btn').hide();
                    $('#resubmit-btn').show();
                    showDragFeedback('incorrect', 'ğŸ’ª ì´ì „ ì œì¶œ: ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!');
                    console.log('âŒ ì˜¤ë‹µ ìƒíƒœë¡œ ë³µì› ì™„ë£Œ');
                    {% endif %}
                }, 300);
            }
        } catch (e) {
            console.error('âŒ ë‹µì•ˆ ë³µì› ì˜¤ë¥˜:', e);
            console.error('âŒ ìƒì„¸ ì˜¤ë¥˜ ì •ë³´:', e.stack);
        }
        {% endif %}
    }
    
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function adjustBrightness(color, percent) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }
    
    function getRandomMessage(messages) {
        return messages[Math.floor(Math.random() * messages.length)];
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    $(document).on('click', '#resubmit-btn', function() {
        if ('{{ slide.content_type.type_name }}' === 'drag') {
            resetDragQuizForRetry();
        }
    });
    
    // ì´ˆê¸°í™” ì‹¤í–‰
    initializeDragQuiz();
});
</script>