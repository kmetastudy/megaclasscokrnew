// ëŒ€í­ ê°„ì†Œí™”ëœ drag_quiz.js
<script>
$(document).ready(function() {
    // ë“œë˜ê·¸ í€´ì¦ˆ ì „ìš© ì„¤ì • (ê¸°ë³¸ë§Œ ìœ ì§€)
    const DRAG_CONFIG = {
        correctMessages: [
            "ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ğŸ‘",
            "ì™„ë²½í•´ìš”! ğŸŒŸ",
            "ë§ìŠµë‹ˆë‹¤! ğŸŠ",
            "ì •ë‹µì´ì—ìš”! ğŸ’¯",
            "ë¸Œë¼ë³´! ğŸ­"
        ],
        incorrectMessages: [
            "ğŸ¤” ë‹¤ì‹œ í•œë²ˆ ì‹œë„í•´ë³´ì„¸ìš”! ğŸ˜Š",
            "ê´œì°®ì•„ìš”! ğŸ’ª í•œ ë²ˆ ë”!",
            "ì¡°ê¸ˆ ë” ìƒê°í•´ë³¼ê¹Œìš”? ğŸ§",
            "ì•„ì‰¬ì›Œìš”! ğŸ˜Š ë‹¤ì‹œ ë„ì „!",
            "í˜ë‚´ì„¸ìš”! ğŸŒŸ"
        ]
    };
    
    let dragIsAnswered = false;
    let currentState = {};
    let draggedItem = null;
    let touchItem = null;
    let extractedItems = [];
    
    // ê°„ì†Œí™”ëœ í€´ì¦ˆ ì´ˆê¸°í™”
    function initializeDragQuiz() {
        if ($('#drag-quiz-container').length === 0) return;
        
        console.log('Drag í€´ì¦ˆ ì´ˆê¸°í™” ì‹œì‘');
        
        // 1. ê¸°ì¡´ ë“œë¡­ì¡´ í™•ì¸ (ë³€í™˜ ì‘ì—… ì—†ìŒ!)
        const existingDropZones = $('.drop-zone').length;
        console.log(`ê¸°ì¡´ ë“œë¡­ì¡´ ê°œìˆ˜: ${existingDropZones}`);
        
        // 2. ë“œë˜ê·¸ ì•„ì´í…œ ì¶”ì¶œ
        extractDragItems();
        
        // 3. ì´ë²¤íŠ¸ ì„¤ì •
        if (existingDropZones > 0) {
            setupDropZones();
            createDragItems();
            
            // ê¸°ì¡´ ë‹µì•ˆ ë³µì›
            restoreDragAnswer();
            
            console.log('Drag í€´ì¦ˆ ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.error('ë“œë¡­ì¡´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
    }
    
    // ë“œë˜ê·¸ ì•„ì´í…œë§Œ ì¶”ì¶œ (ê°„ì†Œí™”)
    function extractDragItems() {
        extractedItems = [];
        $('.options-container .option-button').each(function(index) {
            const itemText = $(this).find('.option-text').text().trim();
            const dataClicked = $(this).attr('data-clicked');
            
            if (itemText) {
                extractedItems.push({
                    id: `item${index + 1}`,
                    text: itemText,
                    value: dataClicked || (index + 1).toString()
                });
            }
        });
        
        console.log('ì¶”ì¶œëœ ì•„ì´í…œ:', extractedItems);
    }
    
    // ë“œë˜ê·¸ ì•„ì´í…œ ìƒì„±
    function createDragItems() {
        const container = $('#drag-container');
        container.empty();
        
        extractedItems.forEach((item, index) => {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#A55EEA'];
            const itemElement = $('<div>')
                .addClass('drag-item')
                .attr('id', item.id)
                .attr('draggable', 'true')
                .attr('data-value', item.value)
                .text(item.text)
                .css({
                    'background': colors[index % colors.length],
                    'color': 'white',
                    'padding': '10px 15px',
                    'margin': '5px',
                    'border-radius': '8px',
                    'cursor': 'move',
                    'user-select': 'none',
                    'box-shadow': '0 2px 4px rgba(0,0,0,0.2)',
                    'transition': 'all 0.3s ease'
                });
            
            // ë“œë˜ê·¸ ì´ë²¤íŠ¸
            itemElement.on('dragstart', handleDragStart);
            itemElement.on('dragend', handleDragEnd);
            
            // í„°ì¹˜ ì´ë²¤íŠ¸
            itemElement.on('touchstart', handleTouchStart);
            itemElement.on('touchmove', handleTouchMove);
            itemElement.on('touchend', handleTouchEnd);
            
            container.append(itemElement);
        });
    }
    
    // ë“œë¡­ì¡´ ì´ë²¤íŠ¸ ì„¤ì • (ê¸°ì¡´ .drop-zoneì— ë°”ë¡œ ì ìš©)
    function setupDropZones() {
        $('.drop-zone').on('dragover', handleDragOver);
        $('.drop-zone').on('drop', handleDrop);
        $('.drop-zone').on('dragenter', handleDragEnter);
        $('.drop-zone').on('dragleave', handleDragLeave);
    }
    
    // ë“œë˜ê·¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤ (í•µì‹¬ë§Œ)
    function handleDragStart(e) {
        draggedItem = this;
        $(this).css('opacity', '0.7');
        e.originalEvent.dataTransfer.setData('text/plain', this.id);
    }
    
    function handleDragEnd(e) {
        $(this).css('opacity', '1');
    }
    
    function handleDragOver(e) {
        e.preventDefault();
    }
    
    function handleDragEnter(e) {
        e.preventDefault();
        $(this).addClass('highlight');
    }
    
    function handleDragLeave(e) {
        $(this).removeClass('highlight');
    }
    
    // ë“œë¡­ ì²˜ë¦¬ (í•µì‹¬ ë¡œì§)
    function handleDrop(e) {
        e.preventDefault();
        $(this).removeClass('highlight');
        
        if (dragIsAnswered) return;
        
        const itemId = e.originalEvent.dataTransfer.getData('text/plain');
        const item = $('#' + itemId);
        const zoneId = $(this).attr('data-zone-id');
        
        if (!zoneId) {
            console.error('zone-idê°€ ì—†ìŠµë‹ˆë‹¤!');
            return;
        }
        
        // ê¸°ì¡´ ì•„ì´í…œ ë³µì›
        if ($(this).attr('data-filled-by')) {
            const existingItem = $('#' + $(this).attr('data-filled-by'));
            existingItem.show().css('opacity', '1');
        }
        
        // ìƒˆ ì•„ì´í…œ ë°°ì¹˜
        $(this).text(item.text()).addClass('filled').attr('data-filled-by', itemId);
        item.hide();
        
        // ìƒíƒœ ì €ì¥
        currentState[zoneId] = item.attr('data-value');
        
        console.log('í˜„ì¬ ìƒíƒœ:', currentState);
        
        // ì™„ë£Œ í™•ì¸
        checkCompletion();
    }
    
    // í„°ì¹˜ ì´ë²¤íŠ¸ (ê°„ì†Œí™”)
    function handleTouchStart(e) {
        if (dragIsAnswered) return;
        touchItem = this;
        e.preventDefault();
    }
    
    function handleTouchMove(e) {
        if (!touchItem) return;
        e.preventDefault();
        
        const touch = e.originalEvent.touches[0];
        $(touchItem).css({
            'position': 'fixed',
            'left': touch.clientX - 60 + 'px',
            'top': touch.clientY - 30 + 'px',
            'z-index': '1000'
        });
        
        // ë“œë¡­ì¡´ í•˜ì´ë¼ì´íŠ¸
        const element = document.elementFromPoint(touch.clientX, touch.clientY);
        $('.drop-zone').removeClass('highlight');
        if (element && $(element).hasClass('drop-zone')) {
            $(element).addClass('highlight');
        }
    }
    
    function handleTouchEnd(e) {
        if (!touchItem) return;
        
        const touch = e.originalEvent.changedTouches[0];
        const element = document.elementFromPoint(touch.clientX, touch.clientY);
        
        // ìŠ¤íƒ€ì¼ ë³µì›
        $(touchItem).css({
            'position': '',
            'left': '',
            'top': '',
            'z-index': ''
        });
        
        // ë“œë¡­ ì²˜ë¦¬
        if (element && $(element).hasClass('drop-zone')) {
            const fakeEvent = {
                preventDefault: () => {},
                originalEvent: {
                    dataTransfer: {
                        getData: () => touchItem.id
                    }
                }
            };
            handleDrop.call(element, fakeEvent);
        }
        
        $('.drop-zone').removeClass('highlight');
        touchItem = null;
    }
    
    // ì™„ë£Œ í™•ì¸
    function checkCompletion() {
        const totalDropZones = $('.drop-zone').length;
        const filledDropZones = Object.keys(currentState).length;
        
        if (filledDropZones >= totalDropZones && totalDropZones > 0) {
            console.log('ëª¨ë“  ë“œë¡­ì¡´ ì™„ë£Œ - ì±„ì  ì‹œì‘');
            checkAnswers();
        }
    }
    
    // ë‹µì•ˆ ì±„ì 
    function checkAnswers() {
        if (dragIsAnswered) return;
        dragIsAnswered = true;
        
        console.log('ì±„ì  ì‹œì‘:', currentState);
        
        // ì„œë²„ë¡œ ë‹µì•ˆ ì „ì†¡
        $.ajax({
            url: '{% url "student:check_answer" %}',
            type: 'POST',
            data: {
                'content_id': '{{ slide.content.id }}',
                'slide_id': '{{ slide.id }}',
                'student_answer': JSON.stringify(currentState),
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('ì±„ì  ê²°ê³¼:', response);
                handleResult(response);
            },
            error: function() {
                alert('ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                resetQuiz();
            }
        });
    }
    
    // ê²°ê³¼ ì²˜ë¦¬
    function handleResult(response) {
        // ë“œë¡­ì¡´ ìƒíƒœ í‘œì‹œ
        $('.drop-zone.filled').each(function() {
            if (response.is_correct) {
                $(this).css({
                    'background-color': '#d4edda',
                    'border-color': '#28a745',
                    'color': '#155724'
                });
            } else {
                $(this).css({
                    'background-color': '#f8d7da',
                    'border-color': '#dc3545',
                    'color': '#721c24'
                });
            }
        });
        
        // ë©”ì‹œì§€ í‘œì‹œ
        const message = response.is_correct 
            ? DRAG_CONFIG.correctMessages[Math.floor(Math.random() * DRAG_CONFIG.correctMessages.length)]
            : DRAG_CONFIG.incorrectMessages[Math.floor(Math.random() * DRAG_CONFIG.incorrectMessages.length)];
        
        setTimeout(() => {
            alert(message);
            
            // í•´ì„¤ì´ ìˆìœ¼ë©´ í‘œì‹œ
            if (response.solution) {
                setTimeout(() => {
                    alert('í•´ì„¤: ' + response.solution);
                }, 1000);
            }
            
            // ì˜¤ë‹µì¸ ê²½ìš° ì¬ì‹œë„ í—ˆìš©
            if (!response.is_correct) {
                setTimeout(() => {
                    if (confirm('ë‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        resetQuiz();
                    }
                }, 2000);
            }
        }, 1000);
    }
    
    // í€´ì¦ˆ ë¦¬ì…‹
    function resetQuiz() {
        dragIsAnswered = false;
        currentState = {};
        
        // UI ë¦¬ì…‹
        $('.drop-zone').removeClass('filled highlight').removeAttr('data-filled-by').text('ë¹ˆì¹¸');
        $('.drop-zone').css({
            'background-color': '',
            'border-color': '',
            'color': ''
        });
        $('.drag-item').show().css('opacity', '1');
    }
    
    // ê¸°ì¡´ ë‹µì•ˆ ë³µì›
    function restoreDragAnswer() {
        {% if existing_answer and slide.content_type.type_name == 'drag' %}
        try {
            const answerData = JSON.parse('{{ existing_answer.answer|escapejs }}');
            if (answerData.selected_answer) {
                currentState = answerData.selected_answer;
                dragIsAnswered = true;
                
                // ìƒíƒœ ë³µì›
                Object.keys(currentState).forEach(zoneId => {
                    const itemValue = currentState[zoneId];
                    const zone = $(`.drop-zone[data-zone-id="${zoneId}"]`);
                    const item = $(`.drag-item[data-value="${itemValue}"]`);
                    
                    if (zone.length && item.length) {
                        zone.text(item.text()).addClass('filled').attr('data-filled-by', item.attr('id'));
                        item.hide();
                    }
                });
                
                console.log('ê¸°ì¡´ ë‹µì•ˆ ë³µì› ì™„ë£Œ');
            }
        } catch (e) {
            console.error('ë‹µì•ˆ ë³µì› ì¤‘ ì˜¤ë¥˜:', e);
        }
        {% endif %}
    }
    
    // ì¬ì œì¶œ ë²„íŠ¼ ì´ë²¤íŠ¸
    $(document).on('click', '#resubmit-btn', function() {
        if ('{{ slide.content_type.type_name }}' === 'drag') {
            resetQuiz();
        }
    });
    
    // ì´ˆê¸°í™” ì‹¤í–‰
    initializeDragQuiz();
});

</script>