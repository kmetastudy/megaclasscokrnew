// ë””ë²„ê¹…ì´ ê°•í™”ëœ ì„  ë§¤ì¹­ í€´ì¦ˆ JavaScript
<script>
  $(document).ready(function() {
      // ì„  ë§¤ì¹­ í€´ì¦ˆ ì „ìš© ë³€ìˆ˜
      let lineIsAnswered = false;
      let selectedLeft = null;
      let connections = {};
      let tempLine = null;
      let isDrawingMode = false;
      let correctMatches = {};
      let hintUsed = false;
      let currentScore = 0;
      let maxScore = 0;

      // ğŸ” ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
      function printDebugInfo() {
          console.log('ğŸ” === ë””ë²„ê¹… ì •ë³´ ===');
          console.log('Content Type:', '{{ slide.content_type.type_name }}');
          console.log('Existing Answer:', '{{ existing_answer|yesno:"ìˆìŒ,ì—†ìŒ" }}');
          console.log('Existing Answer Data:', '{{ existing_answer_data|yesno:"ìˆìŒ,ì—†ìŒ" }}');
          console.log('Existing Answer JSON:', '{{ existing_answer_json|yesno:"ìˆìŒ,ì—†ìŒ" }}');
          console.log('Is Already Correct:', '{{ is_already_correct }}');

          {% if existing_answer %}
          console.log('Existing Answer ID:', '{{ existing_answer.id }}');
          console.log('Existing Answer Is Correct:', '{{ existing_answer.is_correct }}');
          {% endif %}

          {% if existing_answer_json %}
          console.log('Raw Existing Answer JSON:', '{{ existing_answer_json }}');
          {% endif %}

          console.log('ğŸ” === ë””ë²„ê¹… ì •ë³´ ë ===');
      }

      // ğŸš€ ì„  ë§¤ì¹­ í€´ì¦ˆ ì´ˆê¸°í™”
      function initializeLineQuiz() {
          // ì„  ë§¤ì¹­ í€´ì¦ˆê°€ ì•„ë‹Œ ê²½ìš° ì¢…ë£Œ
          if ('{{ slide.content_type.type_name }}' !== 'line_matching') {
              return;
          }

          console.log('ğŸš€ ì„  ë§¤ì¹­ í€´ì¦ˆ ì´ˆê¸°í™” ì‹œì‘');

          // 0. ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
          printDebugInfo();

          // 1. ê¸°ì¡´ HTML êµ¬ì¡° ì •ë¦¬
          setupHTMLStructure();

          // 1.1 ë§¤ì¹­ ë˜í¼ ìœ„ì¹˜ ì¡°ì •
          relocateMatchingWrapper();

          // 2. ì„œë²„ì—ì„œ ì •ë‹µ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          loadCorrectAnswers();

          // 3. ì´ë²¤íŠ¸ ì„¤ì •
          setupEvents();

          // 4. ì§„í–‰ë¥  ì´ˆê¸°í™”
          updateProgress();

          // 5. ê¸°ì¡´ ë‹µì•ˆ ë³µì›
          restoreAnswer();

          console.log('âœ… ì„  ë§¤ì¹­ í€´ì¦ˆ ì´ˆê¸°í™” ì™„ë£Œ');
      }

      // ğŸ—ï¸ HTML êµ¬ì¡° ì •ë¦¬
      function setupHTMLStructure() {
          console.log('ğŸ—ï¸ HTML êµ¬ì¡° ì •ë¦¬ ì‹œì‘');

          const container = $('.quiz-container');
          if (!container.length) return;

          // ì¢Œìš° ë°°ì¹˜ë¥¼ ìœ„í•œ ë˜í¼ ì¶”ê°€
          const leftItems = container.find('.left-items');
          const rightItems = container.find('.right-items');

          if (leftItems.length && rightItems.length && !container.find('.matching-wrapper').length) {
              leftItems.add(rightItems).wrapAll('<div class="matching-wrapper"></div>');
          }

          // ì•„ì´í…œë“¤ì— í•„ìš”í•œ ì†ì„± ì¶”ê°€
          leftItems.find('.match-item').each(function() {
              $(this).attr('data-side', 'left');
              if (!$(this).attr('data-item-id')) {
                  $(this).attr('data-item-id', 'left' + ($(this).index() + 1));
              }
          });

          rightItems.find('.match-item').each(function() {
              $(this).attr('data-side', 'right');
              if (!$(this).attr('data-item-id')) {
                  $(this).attr('data-item-id', 'right' + ($(this).index() + 1));
              }
          });

          // SVG ì—°ê²°ì„  ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ì¶”ê°€
          if (!container.find('.connection-svg').length) {
              container.find('.matching-wrapper').append('<svg class="connection-svg" id="connection-svg"></svg>');
          }

          console.log('âœ… HTML êµ¬ì¡° ì •ë¦¬ ì™„ë£Œ');
      }

      // matching-wrapper ì˜ ë¶€ëª¨ê°€ question-box ê°€ ì•„ë‹Œ ê²½ìš°, ì´ë¥¼ ìˆ˜ì •
      // 2025-07-16
      function relocateMatchingWrapper() {
        const matchingWrapper = document.querySelector(".matching-wrapper");

        if (matchingWrapper) {
            // question-box ì°¾ê¸°
            const questionBox = matchingWrapper.closest(".question-box");

            // matching-wrapperì—ì„œ question-boxì˜ ì§ì ‘ ìì‹ê¹Œì§€ ì˜¬ë¼ê°€ê¸°
            let currentElement = matchingWrapper;
            while (currentElement.parentElement &&
                currentElement.parentElement !== questionBox) {
                currentElement = currentElement.parentElement;
            }

            // currentElementê°€ ì´ë¯¸ matching-wrapperê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì´ë™
            if (currentElement !== matchingWrapper && questionBox) {
                questionBox.insertBefore(matchingWrapper, currentElement);
            }
        }
      }

      // ğŸ¯ ì„œë²„ì—ì„œ ì •ë‹µ ë°ì´í„° ë¡œë“œ
      function loadCorrectAnswers() {
          try {
              {% if slide.content.answer %}
              const answerData = JSON.parse('{{ slide.content.answer|escapejs }}');
              if (answerData && answerData.answer) {
                  correctMatches = answerData.answer;
                  maxScore = Object.keys(correctMatches).length;
                  console.log('âœ… ì •ë‹µ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', correctMatches);
              } else {
                  throw new Error('ì •ë‹µ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜');
              }
              {% else %}
              throw new Error('ì„œë²„ì— ì •ë‹µ ë°ì´í„°ê°€ ì—†ìŒ');
              {% endif %}
          } catch (e) {
              console.warn('âš ï¸ ì„œë²„ ì •ë‹µ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', e);
              // ê¸°ë³¸ ì •ë‹µ ë°ì´í„° ìƒì„±
              correctMatches = {};
              $('.quiz-container .left-items .match-item').each(function(index) {
                  const leftId = $(this).attr('data-item-id');
                  const rightId = 'right' + (index + 1);
                  correctMatches[leftId] = rightId;
              });
              maxScore = Object.keys(correctMatches).length;
          }

          console.log('ğŸ¯ ì •ë‹µ ë§¤ì¹­:', correctMatches);
          console.log('ğŸ“Š ìµœëŒ€ ì ìˆ˜:', maxScore);
      }

      // ğŸ¯ ì´ë²¤íŠ¸ ì„¤ì •
      function setupEvents() {
          console.log('ğŸ¯ ì´ë²¤íŠ¸ ì„¤ì • ì‹œì‘');

          // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°
          $(document).off('click', '.quiz-container .match-item');

          // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ì„¤ì •
          $(document).on('click', '.quiz-container .match-item[data-side="left"]', handleLeftClick);
          $(document).on('click', '.quiz-container .match-item[data-side="right"]', handleRightClick);

          // ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸
          $('.quiz-container .matching-wrapper').on('mousemove', handleMouseMove);

          // íŒíŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸
          $(document).on('click', '.hint-button', showHint);

          // ì¬ì‹œë„ ë²„íŠ¼ ì´ë²¤íŠ¸
          $(document).on('click', '.retry-button', resetQuiz);

          // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
          $(window).on('resize', function() {
              setTimeout(redrawAllLines, 100);
          });

          console.log('âœ… ì´ë²¤íŠ¸ ì„¤ì • ì™„ë£Œ');
      }

      // ğŸ–±ï¸ ì™¼ìª½ ì•„ì´í…œ í´ë¦­ ì²˜ë¦¬
      function handleLeftClick(e) {
          if (lineIsAnswered) return;

          const itemId = $(this).attr('data-item-id');
          console.log('ğŸ–±ï¸ ì™¼ìª½ ì•„ì´í…œ í´ë¦­:', itemId);

          // ì´ë¯¸ ì—°ê²°ëœ ì•„ì´í…œì¸ì§€ í™•ì¸
          if (connections[itemId]) {
              removeConnection(itemId);
              return;
          }

          // ì´ì „ ì„ íƒ ì´ˆê¸°í™”
          $('.quiz-container .match-item').removeClass('selected');

          // í˜„ì¬ ì•„ì´í…œ ì„ íƒ
          $(this).addClass('selected');
          selectedLeft = itemId;
          isDrawingMode = true;

          // ì„ì‹œ ì„  ì œê±°
          removeTempLine();

          console.log('âœ… ì™¼ìª½ ì•„ì´í…œ ì„ íƒ:', itemId);
      }

      // ğŸ–±ï¸ ì˜¤ë¥¸ìª½ ì•„ì´í…œ í´ë¦­ ì²˜ë¦¬
      function handleRightClick(e) {
          if (lineIsAnswered || !selectedLeft) return;

          const rightId = $(this).attr('data-item-id');
          console.log('ğŸ–±ï¸ ì˜¤ë¥¸ìª½ ì•„ì´í…œ í´ë¦­:', rightId);

          // ì´ë¯¸ ì—°ê²°ëœ ì˜¤ë¥¸ìª½ ì•„ì´í…œì¸ì§€ í™•ì¸
          const existingLeft = Object.keys(connections).find(key => connections[key] === rightId);
          if (existingLeft) {
              removeConnection(existingLeft);
          }

          // ì—°ê²° ìƒì„±
          createConnection(selectedLeft, rightId);

          // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
          $('.quiz-container .match-item').removeClass('selected');
          selectedLeft = null;
          isDrawingMode = false;

          // ì„ì‹œ ì„  ì œê±°
          removeTempLine();

          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
          updateProgress();

          // ëª¨ë“  ì—°ê²° ì™„ë£Œ í™•ì¸
          setTimeout(checkAllConnections, 300);

          console.log('âœ… ì—°ê²° ìƒì„± ì™„ë£Œ');
      }

      // ğŸ¨ ì—°ê²° ìƒì„±
      function createConnection(leftId, rightId) {
          connections[leftId] = rightId;

          const leftElement = $(`.quiz-container .match-item[data-item-id="${leftId}"]`);
          const rightElement = $(`.quiz-container .match-item[data-item-id="${rightId}"]`);

          // ì•„ì´í…œ ìŠ¤íƒ€ì¼ ë³€ê²½
          leftElement.addClass('connected');
          rightElement.addClass('connected');

          // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
          drawConnectionLine(leftId, rightId);

          console.log('ğŸ¨ ì—°ê²° ìƒì„±:', leftId, 'â†’', rightId);
      }

      // ğŸ—‘ï¸ ì—°ê²° ì œê±°
      function removeConnection(leftId) {
          const rightId = connections[leftId];
          if (!rightId) return;

          delete connections[leftId];

          const leftElement = $(`.quiz-container .match-item[data-item-id="${leftId}"]`);
          const rightElement = $(`.quiz-container .match-item[data-item-id="${rightId}"]`);

          // ì•„ì´í…œ ìŠ¤íƒ€ì¼ ë³µì›
          leftElement.removeClass('connected error');
          rightElement.removeClass('connected error');

          // ì—°ê²°ì„  ì œê±°
          $(`.connection-line[data-left="${leftId}"]`).remove();

          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
          updateProgress();

          console.log('ğŸ—‘ï¸ ì—°ê²° ì œê±°:', leftId, 'â†’', rightId);
      }

      // ğŸ“ ì—°ê²°ì„  ê·¸ë¦¬ê¸°
      function drawConnectionLine(leftId, rightId) {
          const svg = $('#connection-svg');
          const leftElement = $(`.quiz-container .match-item[data-item-id="${leftId}"]`);
          const rightElement = $(`.quiz-container .match-item[data-item-id="${rightId}"]`);

          if (!leftElement.length || !rightElement.length || !svg.length) return;

          const container = $('.quiz-container .matching-wrapper');
          const containerRect = container[0].getBoundingClientRect();
          const leftRect = leftElement[0].getBoundingClientRect();
          const rightRect = rightElement[0].getBoundingClientRect();

          // ì—°ê²°ì  ê³„ì‚°
          const startX = leftRect.right - containerRect.left;
          const startY = leftRect.top + leftRect.height / 2 - containerRect.top;
          const endX = rightRect.left - containerRect.left;
          const endY = rightRect.top + rightRect.height / 2 - containerRect.top;

          // ê¸°ì¡´ ì„  ì œê±°
          svg.find(`[data-left="${leftId}"]`).remove();

          // ê³¡ì„  ê²½ë¡œ ìƒì„±
          const controlX1 = startX + (endX - startX) * 0.3;
          const controlY1 = startY;
          const controlX2 = startX + (endX - startX) * 0.7;
          const controlY2 = endY;

          const pathData = `M ${startX} ${startY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${endX} ${endY}`;

          // SVG path ìƒì„±
          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', pathData);
          path.setAttribute('class', 'connection-line');
          path.setAttribute('data-left', leftId);
          path.setAttribute('data-right', rightId);

          svg[0].appendChild(path);

          // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
          try {
              const pathLength = path.getTotalLength();
              path.style.strokeDasharray = pathLength;
              path.style.strokeDashoffset = pathLength;

              $(path).animate({
                  'stroke-dashoffset': 0
              }, 500, function() {
                  path.style.strokeDasharray = 'none';
              });
          } catch (e) {
              console.warn('ì—°ê²°ì„  ì• ë‹ˆë©”ì´ì…˜ ì‹¤íŒ¨:', e);
          }

          console.log('ğŸ“ ì—°ê²°ì„  ê·¸ë¦¬ê¸° ì™„ë£Œ:', leftId, 'â†’', rightId);
      }

      // ğŸ¨ ì„ì‹œ ì„  ê·¸ë¦¬ê¸°
      function handleMouseMove(e) {
          if (!isDrawingMode || !selectedLeft) return;

          const svg = $('#connection-svg');
          const leftElement = $(`.quiz-container .match-item[data-item-id="${selectedLeft}"]`);

          if (!leftElement.length || !svg.length) return;

          const container = $('.quiz-container .matching-wrapper');
          const containerRect = container[0].getBoundingClientRect();
          const leftRect = leftElement[0].getBoundingClientRect();

          const startX = leftRect.right - containerRect.left;
          const startY = leftRect.top + leftRect.height / 2 - containerRect.top;
          const endX = e.clientX - containerRect.left;
          const endY = e.clientY - containerRect.top;

          // ê¸°ì¡´ ì„ì‹œ ì„  ì œê±°
          removeTempLine();

          // ê³¡ì„  ê²½ë¡œ ìƒì„±
          const controlX1 = startX + (endX - startX) * 0.3;
          const controlY1 = startY;
          const controlX2 = startX + (endX - startX) * 0.7;
          const controlY2 = endY;

          const pathData = `M ${startX} ${startY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${endX} ${endY}`;

          // SVG path ìƒì„±
          tempLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          tempLine.setAttribute('d', pathData);
          tempLine.setAttribute('class', 'connection-line temp');

          svg[0].appendChild(tempLine);
      }

      // ğŸ—‘ï¸ ì„ì‹œ ì„  ì œê±°
      function removeTempLine() {
          if (tempLine) {
              tempLine.remove();
              tempLine = null;
          }
      }

      // ğŸ“Š ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      function updateProgress() {
          const currentConnections = Object.keys(connections).length;
          const progressPercent = Math.round((currentConnections / maxScore) * 100);

          $('#progress-text').text(`${currentConnections}/${maxScore}`);
          $('#progress-fill').css('width', progressPercent + '%');

          console.log('ğŸ“Š ì§„í–‰ë¥  ì—…ë°ì´íŠ¸:', currentConnections, '/', maxScore);
      }

      // âœ… ëª¨ë“  ì—°ê²° ì™„ë£Œ í™•ì¸
      function checkAllConnections() {
          if (lineIsAnswered) return;

          const currentConnections = Object.keys(connections).length;

          if (currentConnections >= maxScore) {
              setTimeout(checkAnswers, 500);
          }
      }

      // ğŸ“ ì •ë‹µ í™•ì¸ ë° ì±„ì 
      function checkAnswers() {
          if (lineIsAnswered) return;

          lineIsAnswered = true;

          let correctCount = 0;

          // ê° ì—°ê²° í™•ì¸
          Object.keys(connections).forEach(leftId => {
              const rightId = connections[leftId];
              const isCorrect = correctMatches[leftId] === rightId;

              const leftElement = $(`.quiz-container .match-item[data-item-id="${leftId}"]`);
              const rightElement = $(`.quiz-container .match-item[data-item-id="${rightId}"]`);
              const lineElement = $(`.connection-line[data-left="${leftId}"]`);

              if (isCorrect) {
                  correctCount++;
                  leftElement.addClass('connected').removeClass('error');
                  rightElement.addClass('connected').removeClass('error');
                  lineElement.addClass('connected').removeClass('error');
              } else {
                  leftElement.addClass('error').removeClass('connected');
                  rightElement.addClass('error').removeClass('connected');
                  lineElement.addClass('error').removeClass('connected');
              }
          });

          // ê²°ê³¼ ì²˜ë¦¬
          const finalScore = Math.round((correctCount / maxScore) * 100);
          const isAllCorrect = correctCount === maxScore;

          if (isAllCorrect) {
              showFeedback('correct', 'ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤! ëª¨ë“  ì—°ê²°ì´ ì •í™•í•´ìš”!', finalScore);
              createFireworks();
          } else if (correctCount > 0) {
              showFeedback('partial', `ğŸ‘ ${correctCount}ê°œ ì •ë‹µ! ì¡°ê¸ˆ ë” í˜ë‚´ì„¸ìš”!`, finalScore);
          } else {
              showFeedback('incorrect', 'ğŸ¤” ë‹¤ì‹œ í•œë²ˆ ìƒê°í•´ë³´ì„¸ìš”!', finalScore);
          }

          // ì¬ì‹œë„ ë²„íŠ¼ í‘œì‹œ
          $('#retry-button').show();

          // ì„œë²„ë¡œ ê²°ê³¼ ì „ì†¡
          sendAnswerToServer(connections, isAllCorrect, finalScore);

          console.log('ğŸ“ ì±„ì  ì™„ë£Œ:', correctCount, '/', maxScore);
      }

      // ğŸ“¢ í”¼ë“œë°± í‘œì‹œ
      function showFeedback(type, message, score) {
          const feedbackElement = $(`#feedback-${type}`);
          let feedbackHTML = message;

          if (score !== undefined) {
              feedbackHTML += `<div style="margin-top: 10px; font-size: 18px;">ì ìˆ˜: ${score}ì </div>`;
          }

          feedbackElement.html(feedbackHTML).addClass('show');

          // ë‹¤ë¥¸ í”¼ë“œë°± ìˆ¨ê¸°ê¸°
          $('.feedback').not(feedbackElement).removeClass('show');
      }

      // ğŸ† í­ì£½ íš¨ê³¼
      function createFireworks() {
          for (let i = 0; i < 5; i++) {
              setTimeout(() => {
                  const particle = $('<div>').css({
                      'position': 'fixed',
                      'left': Math.random() * window.innerWidth + 'px',
                      'top': window.innerHeight + 'px',
                      'font-size': '30px',
                      'pointer-events': 'none',
                      'z-index': '9999'
                  });

                  particle.text(['ğŸ‰', 'âœ¨', 'ğŸŒŸ', 'ğŸŠ'][Math.floor(Math.random() * 4)]);
                  $('body').append(particle);

                  particle.animate({
                      top: -100 + 'px',
                      left: (Math.random() * window.innerWidth) + 'px',
                      opacity: 0
                  }, 2000, function() {
                      $(this).remove();
                  });
              }, i * 200);
          }
      }

      // ğŸ’¡ íŒíŠ¸ í‘œì‹œ
      function showHint() {
          if (hintUsed || lineIsAnswered) return;

          // ì—°ê²°ë˜ì§€ ì•Šì€ ì²« ë²ˆì§¸ ì •ë‹µ ì°¾ê¸°
          let hintPair = null;
          for (let leftId in correctMatches) {
              if (!connections[leftId]) {
                  hintPair = { left: leftId, right: correctMatches[leftId] };
                  break;
              }
          }

          if (!hintPair) return;

          const leftElement = $(`.quiz-container .match-item[data-item-id="${hintPair.left}"]`);
          const rightElement = $(`.quiz-container .match-item[data-item-id="${hintPair.right}"]`);

          // íŒíŠ¸ íš¨ê³¼
          leftElement.addClass('hint');
          rightElement.addClass('hint');

          setTimeout(() => {
              leftElement.removeClass('hint');
              rightElement.removeClass('hint');
          }, 4500);

          hintUsed = true;
          $('.hint-button').css('opacity', '0.5').prop('disabled', true);

          console.log('ğŸ’¡ íŒíŠ¸ í‘œì‹œ:', hintPair.left, 'â†’', hintPair.right);
      }

      // ğŸ”„ í€´ì¦ˆ ë¦¬ì…‹
      function resetQuiz() {
          console.log('ğŸ”„ í€´ì¦ˆ ë¦¬ì…‹');

          lineIsAnswered = false;
          selectedLeft = null;
          connections = {};
          isDrawingMode = false;
          hintUsed = false;
          currentScore = 0;

          // í”¼ë“œë°± ìˆ¨ê¸°ê¸°
          $('.feedback').removeClass('show');

          // ì•„ì´í…œ ìƒíƒœ ì´ˆê¸°í™”
          $('.quiz-container .match-item').removeClass('selected connected error hint');

          // ì—°ê²°ì„  ì œê±°
          $('#connection-svg').empty();

          // ì„ì‹œ ì„  ì œê±°
          removeTempLine();

          // íŒíŠ¸ ë²„íŠ¼ ë³µì›
          $('.hint-button').css('opacity', '1').prop('disabled', false);

          // ì¬ì‹œë„ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          $('#retry-button').hide();

          // ì§„í–‰ë¥  ì´ˆê¸°í™”
          updateProgress();

          console.log('âœ… í€´ì¦ˆ ë¦¬ì…‹ ì™„ë£Œ');
      }

      // ğŸ”„ ëª¨ë“  ì—°ê²°ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
      function redrawAllLines() {
          Object.keys(connections).forEach(leftId => {
              const rightId = connections[leftId];
              drawConnectionLine(leftId, rightId);
          });
      }

      // ğŸ“¡ ì„œë²„ë¡œ ê²°ê³¼ ì „ì†¡
      async function sendAnswerToServer(answers, isCorrect, score) {
          console.log('ğŸ“¡ ì„œë²„ë¡œ ê²°ê³¼ ì „ì†¡');

          const slideId = '{{ slide.id }}';
          const contentId = '{{ slide.content.id }}';

          try {
              const response = await $.ajax({
                  url: '{% url "student:check_answer" %}',
                  type: 'POST',
                  data: {
                      'content_id': contentId,
                      'slide_id': slideId,
                      'student_answer': JSON.stringify(answers),
                      'csrfmiddlewaretoken': '{{ csrf_token }}'
                  }
              });

              console.log('âœ… ì„œë²„ ì‘ë‹µ:', response);
              updateSubmissionStatus(response);

          } catch (error) {
              console.error('âŒ ì„œë²„ ì „ì†¡ ì˜¤ë¥˜:', error);
          }
      }

      // ğŸ“Š ì œì¶œ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateSubmissionStatus(response) {
          const wrapper = $('#submission-status-wrapper');
          const statusIcon = response.is_correct
              ? '<span class="text-green-600"><i class="fas fa-check-circle"></i> ì •ë‹µ</span>'
              : '<span class="text-red-600"><i class="fas fa-times-circle"></i> ì˜¤ë‹µ</span>';

          wrapper.html(`
              <div class="mt-4 text-sm text-gray-600">
                  <i class="fas fa-info-circle mr-1"></i>
                  ì œì¶œ ì™„ë£Œ: ${response.submitted_at || 'ë°©ê¸ˆ ì „'}
                  ${statusIcon}
                  (ì ìˆ˜: ${response.score || 0}ì )
              </div>
          `);
      }

      // ğŸ”„ ê¸°ì¡´ ë‹µì•ˆ ë³µì› (ë‹¤ì¤‘ ì¡°ê±´ í™•ì¸)
      function restoreAnswer() {
          console.log('ğŸ”„ ë‹µì•ˆ ë³µì› ì‹œì‘ - ì¡°ê±´ í™•ì¸');

          // ì¡°ê±´ 1: existing_answer_json í™•ì¸
          {% if existing_answer_json %}
          console.log('ğŸ“‹ existing_answer_json ì¡´ì¬í•¨');
          try {
              const existingAnswerData = JSON.parse('{{ existing_answer_json|escapejs }}');
              console.log('ğŸ”„ JSON íŒŒì‹± ì„±ê³µ:', existingAnswerData);

              if (existingAnswerData && existingAnswerData.selected_answer) {
                  restoreConnectionsFromData(existingAnswerData);
                  return;
              }
          } catch (e) {
              console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', e);
          }
          {% else %}
          console.log('âš ï¸ existing_answer_json ì—†ìŒ');
          {% endif %}

          // ì¡°ê±´ 2: existing_answer ì§ì ‘ í™•ì¸
          {% if existing_answer %}
          console.log('ğŸ“‹ existing_answer ì¡´ì¬í•¨');
          try {
              const rawAnswer = '{{ existing_answer.answer|escapejs }}';
              console.log('ğŸ”„ Raw answer:', rawAnswer);

              const parsedAnswer = JSON.parse(rawAnswer);
              console.log('ğŸ”„ Parsed answer:', parsedAnswer);

              if (parsedAnswer && parsedAnswer.selected_answer) {
                  restoreConnectionsFromData(parsedAnswer);
                  return;
              }
          } catch (e) {
              console.error('âŒ ì§ì ‘ íŒŒì‹± ì‹¤íŒ¨:', e);
          }
          {% else %}
          console.log('âš ï¸ existing_answer ì—†ìŒ');
          {% endif %}

          console.log('ğŸ”„ ë³µì›í•  ë‹µì•ˆì´ ì—†ìŒ');
      }

      // ğŸ”„ ì—°ê²° ë°ì´í„°ë¡œë¶€í„° ë‹µì•ˆ ë³µì›
      function restoreConnectionsFromData(answerData) {
          console.log('ğŸ”„ ì—°ê²° ë³µì› ì‹œì‘:', answerData);

          const savedConnections = answerData.selected_answer;
          lineIsAnswered = true;

          // ì—°ê²° ë³µì›
          Object.keys(savedConnections).forEach(leftId => {
              const rightId = savedConnections[leftId];

              const leftElement = $(`.quiz-container .match-item[data-item-id="${leftId}"]`);
              const rightElement = $(`.quiz-container .match-item[data-item-id="${rightId}"]`);

              if (leftElement.length && rightElement.length) {
                  connections[leftId] = rightId;
                  leftElement.addClass('connected');
                  rightElement.addClass('connected');
                  drawConnectionLine(leftId, rightId);
              }
          });

          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
          updateProgress();

          // ì •ë‹µ/ì˜¤ë‹µ ìƒíƒœ í‘œì‹œ
          setTimeout(() => {
              {% if is_already_correct %}
              $('.quiz-container .match-item.connected').addClass('connected').removeClass('error');
              $('.connection-line').addClass('connected').removeClass('error');
              showFeedback('correct', 'ğŸ‰ ì´ì „ ì œì¶œ: ì™„ë²½í•œ ì—°ê²°ì…ë‹ˆë‹¤!', 100);
              {% else %}
              $('.quiz-container .match-item.connected').addClass('error').removeClass('connected');
              $('.connection-line').addClass('error').removeClass('connected');
              showFeedback('incorrect', 'ğŸ’ª ì´ì „ ì œì¶œ: ì¼ë¶€ ì—°ê²°ì„ ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”!');
              $('#retry-button').show();
              {% endif %}
          }, 500);

          console.log('âœ… ë‹µì•ˆ ë³µì› ì™„ë£Œ');
      }

      // ì´ˆê¸°í™” ì‹¤í–‰
      initializeLineQuiz();
  });
</script>
