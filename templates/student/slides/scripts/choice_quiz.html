<script>
    $(document).ready(function() {
        // Choice í€´ì¦ˆ ì „ìš© ì„¤ì •
        const CHOICE_CONFIG = {
            themes: {
                science: {
                    keywords: ['ê³¼í•™', 'ì‹¤í—˜', 'í™”í•™', 'ë¬¼ë¦¬', 'ìƒë¬¼', 'ì—°êµ¬', 'ì´ë¡ ', 'ë²•ì¹™', 'ê°€ì„¤', 'ì›ì†Œ'],
                    emojis: ['ğŸ”¬', 'âš—ï¸', 'ğŸ§ª', 'ğŸ”­', 'ğŸŒ¡ï¸', 'âš›ï¸', 'ğŸ§¬', 'ğŸ’Š', 'ğŸ¦ ', 'ğŸŒŒ'],
                    particles: ['ğŸ”¬', 'âš—ï¸', 'ğŸ§ª', 'âš›ï¸', 'ğŸ’¡', 'ğŸŒŸ'],
                    colors: ['rgba(33, 150, 243, 0.3)', 'rgba(3, 218, 198, 0.3)', 'rgba(0, 188, 212, 0.3)'],
                    choiceColors: ['#2196F3', '#03DAC6', '#00BCD4', '#4FC3F7', '#0288D1']
                },
                math: {
                    keywords: ['ìˆ˜í•™', 'ê³„ì‚°', 'ê³µì‹', 'ë°©ì •ì‹', 'ê¸°í•˜', 'ëŒ€ìˆ˜', 'í™•ë¥ ', 'í†µê³„', 'í•¨ìˆ˜'],
                    emojis: ['â•', 'â–', 'âœ–ï¸', 'â—', 'ğŸ“', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ”¢', 'âˆ‘', 'âˆ'],
                    particles: ['â•', 'â–', 'âœ–ï¸', 'â—', 'ğŸ“', 'ğŸ”¢'],
                    colors: ['rgba(255, 152, 0, 0.3)', 'rgba(255, 193, 7, 0.3)', 'rgba(255, 171, 0, 0.3)'],
                    choiceColors: ['#FF9800', '#FFC107', '#FFAB00', '#FFB74D', '#FF8F00']
                },
                social: {
                    keywords: ['ì‚¬íšŒ', 'ì—­ì‚¬', 'ì •ì¹˜', 'ê²½ì œ', 'ë¬¸í™”', 'ì§€ë¦¬', 'ì¸ê¶Œ', 'ë¯¼ì£¼ì£¼ì˜', 'ì‚¬íšŒ'],
                    emojis: ['ğŸ‘¥', 'ğŸ›ï¸', 'ğŸ—³ï¸', 'ğŸ“Š', 'ğŸŒ', 'ğŸ´', 'ğŸ“œ', 'âš–ï¸', 'ğŸ•Šï¸', 'ğŸ¤'],
                    particles: ['ğŸ‘¥', 'ğŸ›ï¸', 'ğŸ—³ï¸', 'ğŸŒ', 'ğŸ“Š', 'ğŸ¤'],
                    colors: ['rgba(233, 30, 99, 0.3)', 'rgba(255, 64, 129, 0.3)', 'rgba(173, 20, 87, 0.3)'],
                    choiceColors: ['#E91E63', '#FF4081', '#AD1457', '#F06292', '#C2185B']
                },
                career: {
                    keywords: ['ì§„ë¡œ', 'ì§ì—…', 'ì·¨ì—…', 'ë¯¸ë˜', 'ê¿ˆ', 'ëª©í‘œ', 'ê³„íš', 'ì„±ì¥', 'ë°œì „'],
                    emojis: ['ğŸ’¼', 'ğŸ‘”', 'ğŸ¯', 'ğŸ“ˆ', 'ğŸ†', 'ğŸš€', 'ğŸ’¡', 'ğŸŒŸ', 'ğŸ”¥', 'â­'],
                    particles: ['ğŸ’¼', 'ğŸ¯', 'ğŸ“ˆ', 'ğŸ†', 'ğŸš€', 'ğŸ’¡'],
                    colors: ['rgba(76, 175, 80, 0.3)', 'rgba(139, 195, 74, 0.3)', 'rgba(102, 187, 106, 0.3)'],
                    choiceColors: ['#4CAF50', '#8BC34A', '#66BB6A', '#81C784', '#388E3C']
                },
                cooking: {
                    keywords: ['ìš”ë¦¬', 'ìŒì‹', 'ë ˆì‹œí”¼', 'ì¬ë£Œ', 'ì¡°ë¦¬', 'ë§›', 'ì˜ì–‘', 'ê±´ê°•ì‹í’ˆ'],
                    emojis: ['ğŸ³', 'ğŸ‘¨â€ğŸ³', 'ğŸ¥„', 'ğŸ½ï¸', 'ğŸ”¥', 'ğŸ¥—', 'ğŸ²', 'ğŸ§„', 'ğŸŒ¶ï¸', 'ğŸ…'],
                    particles: ['ğŸ³', 'ğŸ‘¨â€ğŸ³', 'ğŸ¥„', 'ğŸ”¥', 'ğŸ¥—', 'ğŸ²'],
                    colors: ['rgba(244, 67, 54, 0.3)', 'rgba(255, 87, 34, 0.3)', 'rgba(229, 115, 115, 0.3)'],
                    choiceColors: ['#F44336', '#FF5722', '#E57373', '#EF5350', '#D32F2F']
                },
                default: {
                    keywords: [],
                    emojis: ['ğŸ¯', 'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ‰', 'ğŸŠ', 'ğŸŒˆ', 'ğŸ¦‹', 'ğŸŒº'],
                    particles: ['ğŸ¯', 'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ‰'],
                    colors: ['rgba(255, 255, 255, 0.3)', 'rgba(255, 107, 107, 0.3)', 'rgba(78, 205, 196, 0.3)'],
                    choiceColors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#B794F6']
                }
            },
            
            correctMessages: [
                "ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ğŸ‘ ì •ë§ ì˜í–ˆì–´ìš”!",
                "ì™„ë²½í•´ìš”! ğŸŒŸ í›Œë¥­í•œ ë‹µë³€ì´ì—ˆìŠµë‹ˆë‹¤!",
                "ë§ìŠµë‹ˆë‹¤! ğŸŠ ëŒ€ë‹¨í•œ ì‹¤ë ¥ì´ë„¤ìš”!",
                "ì •ë‹µì´ì—ìš”! ğŸ’¯ ìµœê³ ì˜ˆìš”!",
                "ë¸Œë¼ë³´! ğŸ­ ë©‹ì§„ ì„ íƒì´ì—ˆìŠµë‹ˆë‹¤!"
            ],
            
            incorrectMessages: [
                "ğŸ¤” ì•„ì§ ì •ë‹µì´ ì•„ë‹ˆì—ìš”! ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”! ğŸ˜Š",
                "ê´œì°®ì•„ìš”! ğŸ’ª í•œ ë²ˆ ë” ë„ì „í•´ë³´ì„¸ìš”!",
                "ì¡°ê¸ˆ ë” ìƒê°í•´ë³¼ê¹Œìš”? ğŸ§ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!",
                "ì•„ì‰¬ì›Œìš”! ğŸ˜Š ë‹¤ì‹œ í•œë²ˆ í’€ì–´ë³´ì„¸ìš”!",
                "í˜ë‚´ì„¸ìš”! ğŸŒŸ ë‹¤ìŒì—” ë¶„ëª… ë§í ê±°ì˜ˆìš”!"
            ]
        };
        
        let choiceIsAnswered = false;
        let choiceSelectedAnswer = null;
        let extractedChoices = [];
        let questionText = '';
        
        // Choice í€´ì¦ˆ ì´ˆê¸°í™”
        function initializeChoiceQuiz() {
            if ($('#choice-quiz-container').length === 0) return;
            
            console.log('Choice í€´ì¦ˆ ì´ˆê¸°í™” ì‹œì‘');
            
            // ê¸°ì¡´ HTMLì—ì„œ ë¬¸ì œì™€ ì„ íƒì§€ ì¶”ì¶œ
            extractQuestionAndChoices();
            
            // ë¬¸ì œ í…ìŠ¤íŠ¸ ë¶„ì„í•˜ì—¬ í…Œë§ˆ ì„¤ì •
            const theme = detectThemeFromText(questionText);
            applyChoiceTheme(theme);
            
            // íŒŒí‹°í´ ìƒì„±
            createChoiceParticles(theme);
            
            // ì„ íƒì§€ ë²„íŠ¼ ìƒì„± (ë²ˆí˜¸ í¬í•¨)
            createNumberedChoiceButtons();
            
            // ê¸°ì¡´ ë‹µì•ˆ ë³µì›
            restoreChoiceAnswer();
            
            console.log('Choice í€´ì¦ˆ ì´ˆê¸°í™” ì™„ë£Œ');
        }
        
        // ê¸°ì¡´ HTMLì—ì„œ ë¬¸ì œì™€ ì„ íƒì§€ ì¶”ì¶œ
        function extractQuestionAndChoices() {
            // ë¬¸ì œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            const questionSelectors = [
                '.quiz-container .question-text',
                '.quiz-container h1',
                '.question-box h1',
                '.question-text'
            ];
            
            for (let selector of questionSelectors) {
                const element = $(selector);
                if (element.length > 0 && element.text().trim()) {
                    questionText = element.text().trim();
                    break;
                }
            }
            
            // ì„ íƒì§€ ì¶”ì¶œ
            extractedChoices = [];
            $('.options-container .option-button').each(function(index) {
                const choiceText = $(this).find('.option-text').text().trim();
                const dataClicked = $(this).attr('data-clicked');
                
                if (choiceText) {
                    extractedChoices.push({
                        index: index,
                        text: choiceText,
                        value: dataClicked || (index + 1).toString()
                    });
                }
            });
            
            // ìƒˆë¡œìš´ ë¬¸ì œ ë°•ìŠ¤ì— í…ìŠ¤íŠ¸ ì„¤ì •
            $('#question-text').text(questionText || "ê°ê´€ì‹ ë¬¸ì œë¥¼ í’€ì–´ë³´ì„¸ìš”!");
            
            console.log('ì¶”ì¶œëœ ë¬¸ì œ:', questionText);
            console.log('ì¶”ì¶œëœ ì„ íƒì§€:', extractedChoices);
        }
        
        // ë²ˆí˜¸ê°€ ìˆëŠ” ì„ íƒì§€ ë²„íŠ¼ ìƒì„± - Choice íƒ€ì…ì˜ í•µì‹¬
        function createNumberedChoiceButtons() {
            const container = $('#choices-container');
            const theme = $('#choice-quiz-container').attr('data-theme') || 'default';
            const themeConfig = CHOICE_CONFIG.themes[theme];
            
            container.empty();
            
            extractedChoices.forEach((choice, index) => {
                const button = $('<button>')
                    .addClass(`choice-button choice-${index + 1} answer`)
                    .attr('data-clicked', choice.value)
                    .attr('id', `choice-${index}`)
                    .css({
                        'background': `linear-gradient(135deg, ${themeConfig.choiceColors[index % themeConfig.choiceColors.length]}, ${adjustBrightness(themeConfig.choiceColors[index % themeConfig.choiceColors.length], 20)})`
                    });
                
                // Choice íƒ€ì…ì˜ í•µì‹¬: ë²ˆí˜¸ì™€ í…ìŠ¤íŠ¸ë¥¼ ë¶„ë¦¬í•˜ì—¬ í‘œì‹œ
                const choiceNumber = $('<span>')
                    .addClass('choice-number')
                    .text(index + 1);
                
                const choiceText = $('<span>')
                    .addClass('choice-text')
                    .text(choice.text);
                
                button.append(choiceNumber).append(choiceText);
                container.append(button);
            });
            
            // í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
            $('.choice-button.answer').off('click.choice').on('click.choice', handleChoiceClick);
        }
        
        // ìƒ‰ìƒ ë°ê¸° ì¡°ì • í•¨ìˆ˜
        function adjustBrightness(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        // ë¬¸ì œ í…ìŠ¤íŠ¸ì—ì„œ í…Œë§ˆ ê°ì§€
        function detectThemeFromText(text) {
            let maxScore = 0;
            let detectedTheme = 'default';
            
            Object.keys(CHOICE_CONFIG.themes).forEach(theme => {
                const keywords = CHOICE_CONFIG.themes[theme].keywords;
                let score = 0;
                
                keywords.forEach(keyword => {
                    if (text.includes(keyword)) {
                        score++;
                    }
                });
                
                if (score > maxScore) {
                    maxScore = score;
                    detectedTheme = theme;
                }
            });
            
            console.log(`í…Œë§ˆ ê°ì§€: ${detectedTheme} (ì ìˆ˜: ${maxScore})`);
            return detectedTheme;
        }
        
        // Choice í…Œë§ˆ ì ìš©
        function applyChoiceTheme(theme) {
            const container = $('#choice-quiz-container');
            container.attr('data-theme', theme);
            
            if (CHOICE_CONFIG.themes[theme]) {
                const themeConfig = CHOICE_CONFIG.themes[theme];
                
                // ì¥ì‹ ì´ëª¨ì§€ ì„¤ì •
                $('#decoration1').text(themeConfig.emojis[0] || 'ğŸ¯');
                $('#decoration2').text(themeConfig.emojis[Math.floor(Math.random() * themeConfig.emojis.length)] || 'âœ¨');
            }
            
            // í€´ì¦ˆ ì œëª© ì„¤ì •
            const themeNames = {
                science: 'ê³¼í•™',
                math: 'ìˆ˜í•™',
                social: 'ì‚¬íšŒ',
                career: 'ì§„ë¡œ',
                cooking: 'ìš”ë¦¬',
                default: 'ì¼ë°˜'
            };
            $('#quiz-title').text(`${themeNames[theme] || 'ì¼ë°˜'} ê°ê´€ì‹ í€´ì¦ˆ`);
        }
        
        // Choice íŒŒí‹°í´ ìƒì„±
        function createChoiceParticles(theme) {
            const particleContainer = $('#particles');
            const themeConfig = CHOICE_CONFIG.themes[theme];
            
            if (!themeConfig) return;
            
            particleContainer.empty();
            
            for (let i = 0; i < 15; i++) {
                const particle = $('<div>').addClass('particle');
                particle.css({
                    'left': Math.random() * 100 + '%',
                    'width': Math.random() * 8 + 4 + 'px',
                    'height': Math.random() * 8 + 4 + 'px',
                    'background-color': themeConfig.colors[Math.floor(Math.random() * themeConfig.colors.length)],
                    'animation-delay': Math.random() * 15 + 's',
                    'animation-duration': (Math.random() * 10 + 15) + 's'
                });
                
                // 30% í™•ë¥ ë¡œ í…Œë§ˆë³„ ì´ëª¨ì§€ íŒŒí‹°í´
                if (Math.random() < 0.3 && themeConfig.particles) {
                    particle.text(themeConfig.particles[Math.floor(Math.random() * themeConfig.particles.length)]);
                    particle.css({
                        'background-color': 'transparent',
                        'font-size': '20px',
                        'width': 'auto',
                        'height': 'auto'
                    });
                }
                
                particleContainer.append(particle);
            }
        }
        
        // Choice í´ë¦­ ì²˜ë¦¬ - ê°œì„ ëœ ë²„ì „
        function handleChoiceClick() {
            if (choiceIsAnswered) return;
            
            const clickedValue = $(this).attr('data-clicked');
            choiceSelectedAnswer = clickedValue;
            choiceIsAnswered = true;
            
            console.log('Choice ë²„íŠ¼ í´ë¦­:', clickedValue);
            
            // ëª¨ë“  ë‹µì•ˆ ë¹„í™œì„±í™”
            $('.choice-button.answer').addClass('disabled');
            
            // í´ë¦­ëœ ë‹µì•ˆ ê°•ì¡° (ë²ˆí˜¸ í¬í•¨)
            $(this).addClass('user-selected');
            
            // ë¦¬í”Œ íš¨ê³¼ ì¶”ê°€
            createChoiceRippleEffect(this);
            
            // ì‚¬ìš©ìì—ê²Œ ì„ íƒ í™•ì¸ ë©”ì‹œì§€
            console.log('âœ“ ë‹µì•ˆì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ì±„ì  ì¤‘...');
            
            // ì¦‰ì‹œ ì±„ì  (ì•½ê°„ì˜ ì§€ì—°ìœ¼ë¡œ ì‚¬ìš©ìê°€ ì„ íƒì„ í™•ì¸í•  ìˆ˜ ìˆê²Œ)
            setTimeout(() => {
                checkChoiceAnswer(clickedValue);
            }, 500);
        }
        
        // ë¦¬í”Œ íš¨ê³¼ ìƒì„±
        function createChoiceRippleEffect(button) {
            const ripple = $('<div>').addClass('ripple');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            
            ripple.css({
                'width': size + 'px',
                'height': size + 'px',
                'left': '50%',
                'top': '50%',
                'transform': 'translate(-50%, -50%)',
                'position': 'absolute',
                'border-radius': '50%',
                'background': 'rgba(255, 255, 255, 0.6)',
                'animation': 'rippleEffect 0.6s linear',
                'pointer-events': 'none'
            });
            
            $(button).append(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }
        
        // Choice ë‹µì•ˆ ì±„ì 
        function checkChoiceAnswer(selectedAnswer) {
            const qid = $('.submit-button, .resubmit-button').first().attr('data-qid') || '{{ slide.content.id }}';
            const slideId = '{{ slide.id }}';
            
            console.log('ë‹µì•ˆ ì±„ì  ì‹œì‘:', selectedAnswer);
            
            // ì„œë²„ë¡œ ë‹µì•ˆ ì „ì†¡
            $.ajax({
                url: '{% url "student:check_answer" %}',
                type: 'POST',
                data: {
                    'content_id': qid,
                    'slide_id': slideId,
                    'student_answer': selectedAnswer,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('ì±„ì  ê²°ê³¼:', response);
                    handleChoiceResult(response, selectedAnswer);
                },
                error: function() {
                    showChoiceToast('ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    resetChoiceQuiz();
                }
            });
        }
        
        // Choice ê²°ê³¼ ì²˜ë¦¬ - ê°œì„ ëœ ë²„ì „ (ë²ˆí˜¸ ê°•ì¡° í¬í•¨)
        function handleChoiceResult(response, selectedAnswer) {
            const selectedElement = $(`.choice-button[data-clicked="${selectedAnswer}"]`);
            const correctAnswer = response.correct_answer;
            const correctElement = $(`.choice-button[data-clicked="${correctAnswer}"]`);
            
            console.log('ê²°ê³¼ ì²˜ë¦¬:', {
                selected: selectedAnswer,
                correct: correctAnswer,
                isCorrect: response.is_correct
            });
            
            // ë¨¼ì € ì„ íƒëœ ë‹µì•ˆì„ ëª…í™•í•˜ê²Œ í‘œì‹œ (ë²ˆí˜¸ ê°•ì¡° í¬í•¨)
            selectedElement.addClass('user-selected');
            
            // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì •ë‹µ/ì˜¤ë‹µ ìƒíƒœ ì¶”ê°€
            setTimeout(() => {
                if (response.is_correct) {
                    // ì •ë‹µ ì²˜ë¦¬: ì‚¬ìš©ì ì„ íƒ + ì •ë‹µ (ë²ˆí˜¸ë„ í•¨ê»˜ ë³€ê²½)
                    selectedElement.addClass('correct');
                    {% comment %} $('#right-gif').removeClass('hidden'); {% endcomment %}
                    showChoiceToast(getRandomMessage(CHOICE_CONFIG.correctMessages), 'success');
                    showChoiceAnimation('correct');
                    showChoiceFeedback('correct', getRandomMessage(CHOICE_CONFIG.correctMessages));
                    
                    // ì œì¶œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    $('#submit-btn, #resubmit-btn').hide();
                    
                    console.log('âœ… ì •ë‹µ ì²˜ë¦¬ ì™„ë£Œ - ë²ˆí˜¸ì™€ í•¨ê»˜ ì •ë‹µ í‘œì‹œ');
                    
                } else {
                    // ì˜¤ë‹µ ì²˜ë¦¬: ì‚¬ìš©ì ì„ íƒ + ì˜¤ë‹µ (ë²ˆí˜¸ë„ í•¨ê»˜ ë³€ê²½)
                    selectedElement.addClass('incorrect');
                    
                    // ì •ë‹µ ë²„íŠ¼ë„ í•¨ê»˜ í‘œì‹œ (ì‚¬ìš©ìê°€ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ)
                    if (selectedAnswer !== correctAnswer && correctElement.length > 0) {
                        setTimeout(() => {
                            correctElement.addClass('show-correct');
                            console.log('ğŸ’¡ ì •ë‹µ ë²„íŠ¼ë„ í‘œì‹œ:', correctAnswer);
                        }, 800);
                    }
                    
                    {% comment %} $('#wrong-gif').removeClass('hidden'); {% endcomment %}
                    showChoiceToast(getRandomMessage(CHOICE_CONFIG.incorrectMessages), 'error');
                    showChoiceAnimation('incorrect');
                    showChoiceFeedback('incorrect', getRandomMessage(CHOICE_CONFIG.incorrectMessages));
                    
                    // ì¬ì œì¶œ ë²„íŠ¼ í‘œì‹œ
                    $('#submit-btn').hide();
                    $('#resubmit-btn').show();
                    
                    console.log('âŒ ì˜¤ë‹µ ì²˜ë¦¬ ì™„ë£Œ - ë²ˆí˜¸ì™€ í•¨ê»˜ ì˜¤ë‹µ í‘œì‹œ');
                }
            }, 300);
            
            // ì œì¶œ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateChoiceSubmissionStatus(response);
            
            // 8ì´ˆ í›„ UI ì •ë¦¬ (ì˜¤ë‹µì¸ ê²½ìš° ì¬ì‹œë„ ê°€ëŠ¥)
            setTimeout(() => {
                if (!response.is_correct) {
                    resetChoiceQuizForRetry();
                }
            }, 8000);
        }
        
        // í”¼ë“œë°± í‘œì‹œ í•¨ìˆ˜
        function showChoiceFeedback(type, message) {
            const feedbackElement = $(`#feedback-${type}`);
            feedbackElement.html(message);
            feedbackElement.addClass('show');
            
            // ì„œë²„ ìƒíƒœ ë©”ì‹œì§€ ì¶”ê°€
            setTimeout(() => {
                const statusElement = $('<div>').addClass('server-status');
                statusElement.html('ğŸ“¡ ì„œë²„ë¡œ ê²°ê³¼ ì „ì†¡ ì¤‘...');
                feedbackElement.append(statusElement);
                
                // ì „ì†¡ ì™„ë£Œ ì‹œë®¬ë ˆì´ì…˜
                setTimeout(() => {
                    statusElement.html('âœ… ì „ì†¡ ì™„ë£Œ!');
                    statusElement.css({
                        'background-color': 'rgba(76, 175, 80, 0.9)',
                        'color': 'white',
                        'border-color': '#4CAF50'
                    });
                }, 1500);
            }, 1000);
        }
        
        // Choice ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
        function showChoiceAnimation(type) {
            const container = $('#animation-container');
            
            if (type === 'correct') {
                // ì •ë‹µ ì• ë‹ˆë©”ì´ì…˜
                const animations = [createFireworks, createStarExplosion, createNumberStorm];
                const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                randomAnimation();
            } else {
                // ì˜¤ë‹µ ì• ë‹ˆë©”ì´ì…˜
                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        const element = $('<div>').addClass('animated-element');
                        element.text(['ğŸ’­', 'ğŸ¤”', 'ğŸ˜…', 'ğŸ’ª'][Math.floor(Math.random() * 4)]);
                        element.css({
                            'left': Math.random() * 100 + '%',
                            'animation-delay': Math.random() * 500 + 'ms'
                        });
                        
                        container.append(element);
                        
                        setTimeout(() => {
                            element.remove();
                        }, 4000);
                    }, i * 100);
                }
            }
        }
        
        // ìˆ«ì í­í’ ì• ë‹ˆë©”ì´ì…˜ (Choice íƒ€ì… ì „ìš©)
        function createNumberStorm() {
            const container = $('#animation-container');
            const numbers = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', 'ğŸ”¢', 'ğŸ’¯'];
            
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const number = $('<div>').addClass('animated-element');
                    number.text(numbers[Math.floor(Math.random() * numbers.length)]);
                    number.css({
                        'left': Math.random() * 100 + '%',
                        'animation-delay': Math.random() * 400 + 'ms'
                    });
                    
                    container.append(number);
                    
                    setTimeout(() => {
                        number.remove();
                    }, 3500);
                }, i * 120);
            }
        }
        
        // ë¶ˆê½ƒë†€ì´ ì• ë‹ˆë©”ì´ì…˜
        function createFireworks() {
            const container = $('#animation-container');
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const centerX = Math.random() * window.innerWidth;
                    const centerY = Math.random() * (window.innerHeight * 0.6) + window.innerHeight * 0.2;
                    
                    for (let j = 0; j < 8; j++) {
                        const particle = $('<div>');
                        particle.text('âœ¨');
                        particle.css({
                            'position': 'absolute',
                            'font-size': window.innerWidth < 768 ? '20px' : '30px',
                            'left': centerX + 'px',
                            'top': centerY + 'px',
                            'transition': 'all 1.2s cubic-bezier(0.4, 0, 0.2, 1)',
                            'pointer-events': 'none'
                        });
                        
                        const angle = (j / 8) * 2 * Math.PI;
                        const distance = window.innerWidth < 768 ? 100 : 150;
                        const endX = centerX + Math.cos(angle) * distance;
                        const endY = centerY + Math.sin(angle) * distance;
                        
                        container.append(particle);
                        
                        setTimeout(() => {
                            particle.css({
                                'left': endX + 'px',
                                'top': endY + 'px',
                                'opacity': '0',
                                'transform': 'scale(1.5)'
                            });
                        }, 10);
                        
                        setTimeout(() => {
                            particle.remove();
                        }, 1200);
                    }
                }, i * 400);
            }
        }
        
        // ë³„ í­ë°œ ì• ë‹ˆë©”ì´ì…˜
        function createStarExplosion() {
            const container = $('#animation-container');
            const stars = ['â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«'];
            
            for (let i = 0; i < 25; i++) {
                const star = $('<div>').addClass('animated-element');
                star.text(stars[Math.floor(Math.random() * stars.length)]);
                star.css({
                    'left': Math.random() * 100 + '%',
                    'animation-delay': Math.random() * 800 + 'ms'
                });
                
                container.append(star);
                
                setTimeout(() => {
                    star.remove();
                }, 3500);
            }
        }
        
        // Choice ê¸°ì¡´ ë‹µì•ˆ ë³µì› - ê°œì„ ëœ ë²„ì „ (ë²ˆí˜¸ í¬í•¨)
        function restoreChoiceAnswer() {
            {% if existing_answer and slide.content_type.type_name == 'choice' %}
            try {
                const rawAnswerString = '{{ existing_answer.answer|escapejs|default:"{}" }}';
                console.log('=== Choice ê¸°ì¡´ ë‹µì•ˆ ë³µì› ===');
                console.log('Raw Answer:', rawAnswerString);
                
                const cleanedJsonString = rawAnswerString
                    .replace(/\bTrue\b/g, 'true')
                    .replace(/\bFalse\b/g, 'false')
                    .replace(/\bNone\b/g, 'null')
                    .replace(/'/g, '"');
                
                const answerData = JSON.parse(cleanedJsonString);
                console.log('Parsed Answer:', answerData);
                
                if (answerData.selected_answer) {
                    const selectedAnswerId = answerData.selected_answer;
                    const correctAnswer = answerData.correct_answer;
                    const selectedElement = $(`.choice-button[data-clicked="${selectedAnswerId}"]`);
                    const correctElement = $(`.choice-button[data-clicked="${correctAnswer}"]`);
                    
                    console.log('ë³µì› ë°ì´í„°:', {
                        selected: selectedAnswerId,
                        correct: correctAnswer,
                        isCorrect: {{ is_already_correct|yesno:"true,false" }}
                    });
                    
                    if (selectedElement.length > 0) {
                        choiceIsAnswered = true;
                        choiceSelectedAnswer = selectedAnswerId;
                        
                        // ëª¨ë“  ë‹µì•ˆ ë¹„í™œì„±í™”
                        $('.choice-button.answer').addClass('disabled');
                        
                        // ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‹µì•ˆ í‘œì‹œ (ë²ˆí˜¸ ê°•ì¡° í¬í•¨)
                        selectedElement.addClass('user-selected');
                        
                        // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì •ë‹µ/ì˜¤ë‹µ ìƒíƒœ ì¶”ê°€
                        setTimeout(() => {
                            {% if is_already_correct %}
                                // ì •ë‹µì¸ ê²½ìš°: ì„ íƒí•œ ë‹µì•ˆ = ì •ë‹µ (ë²ˆí˜¸ë„ í•¨ê»˜ ë³€ê²½) - GIF ì œê±°
                                selectedElement.addClass('correct');
                                // $('#right-gif').removeClass('hidden'); // ì¬ë°©ë¬¸ ì‹œ GIF í‘œì‹œ ì•ˆí•¨
                                $('#submit-btn, #resubmit-btn').hide();
                                showChoiceFeedback('correct', 'ğŸ‰ ì´ì „ ì œì¶œ: ì •ë‹µì…ë‹ˆë‹¤! ì˜í–ˆì–´ìš”!');
                                
                                console.log('âœ… ì •ë‹µ ìƒíƒœë¡œ ë³µì› ì™„ë£Œ - ë²ˆí˜¸ ê°•ì¡° í‘œì‹œ (GIF ì—†ìŒ)');
                            {% else %}
                                // ì˜¤ë‹µì¸ ê²½ìš°: ì„ íƒí•œ ë‹µì•ˆ â‰  ì •ë‹µ (ë²ˆí˜¸ë„ í•¨ê»˜ ë³€ê²½) - GIF ì œê±°
                                selectedElement.addClass('incorrect');
                                
                                // ì •ë‹µë„ í•¨ê»˜ í‘œì‹œ (ì‚¬ìš©ìê°€ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°)
                                if (selectedAnswerId !== correctAnswer && correctElement.length > 0) {
                                    setTimeout(() => {
                                        correctElement.addClass('show-correct');
                                        console.log('ğŸ’¡ ì •ë‹µ ë²„íŠ¼ë„ í‘œì‹œ:', correctAnswer);
                                    }, 500);
                                }
                                
                                // $('#wrong-gif').removeClass('hidden'); // ì¬ë°©ë¬¸ ì‹œ GIF í‘œì‹œ ì•ˆí•¨
                                $('#submit-btn').hide();
                                $('#resubmit-btn').show();
                                showChoiceFeedback('incorrect', 'ğŸ’ª ì´ì „ ì œì¶œ: ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!');
                                
                                console.log('âŒ ì˜¤ë‹µ ìƒíƒœë¡œ ë³µì› ì™„ë£Œ - ë²ˆí˜¸ ê°•ì¡° í‘œì‹œ (GIF ì—†ìŒ)');
                            {% endif %}
                        }, 300);
                        
                        // ìƒíƒœ ë©”ì‹œì§€ ì¶”ê°€
                        const statusHtml = `
                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <strong>ì´ì „ ì œì¶œ ì •ë³´</strong>
                                </div>
                                <div class="mt-2 text-sm text-blue-700">
                                    ì œì¶œì¼: {{ existing_answer.submitted_at|date:"Y-m-d H:i" }}<br>
                                    ì„ íƒí•œ ë‹µ: <strong>${selectedAnswerId}ë²ˆ ì„ íƒì§€</strong><br>
                                    ì •ë‹µ: <strong>${correctAnswer}ë²ˆ ì„ íƒì§€</strong><br>
                                    ê²°ê³¼: {% if is_already_correct %}<span class="text-green-600 font-bold">âœ… ì •ë‹µ</span>{% else %}<span class="text-red-600 font-bold">âŒ ì˜¤ë‹µ</span>{% endif %}
                                </div>
                            </div>
                        `;
                        
                        setTimeout(() => {
                            $('#feedback-{{ is_already_correct|yesno:"correct,incorrect" }}').append(statusHtml);
                        }, 1000);
                    }
                }
            } catch (e) {
                console.error('Choice ë‹µì•ˆ ë³µì› ì¤‘ ì˜¤ë¥˜:', e);
            }
            {% endif %}
        }
        
        // Choice ì¬ì‹œë„ìš© ë¦¬ì…‹ - ê°œì„ ëœ ë²„ì „ (ë²ˆí˜¸ ì´ˆê¸°í™” í¬í•¨)
        function resetChoiceQuizForRetry() {
            {% if not is_already_correct %}
            console.log('Choice í€´ì¦ˆ ì¬ì‹œë„ ë¦¬ì…‹');
            
            choiceIsAnswered = false;
            choiceSelectedAnswer = null;
            
            // UI ì´ˆê¸°í™” (ëª¨ë“  ìƒíƒœ í´ë˜ìŠ¤ ì œê±°)
            $('.choice-button.answer').removeClass('disabled user-selected correct incorrect show-correct');
            $('#right-gif, #wrong-gif').addClass('hidden');
            $('#feedback-correct, #feedback-incorrect').removeClass('show');
            $('#animation-container').empty();
            
            // í”¼ë“œë°± ë‚´ìš© ì´ˆê¸°í™”
            $('#feedback-correct, #feedback-incorrect').empty();
            
            // ì›ë˜ ìŠ¤íƒ€ì¼ ë³µì› (ë²ˆí˜¸ ìŠ¤íƒ€ì¼ë„ ì´ˆê¸°í™”)
            $('.choice-button.answer').each(function(index) {
                $(this).attr('class', `choice-button choice-${index + 1} answer`);
                
                // ì›ë˜ ë°°ê²½ìƒ‰ ë³µì›
                const theme = $('#choice-quiz-container').attr('data-theme') || 'default';
                const themeConfig = CHOICE_CONFIG.themes[theme];
                $(this).css({
                    'background': `linear-gradient(135deg, ${themeConfig.choiceColors[index % themeConfig.choiceColors.length]}, ${adjustBrightness(themeConfig.choiceColors[index % themeConfig.choiceColors.length], 20)})`
                });
            });
            
            console.log('ì¬ì‹œë„ ì¤€ë¹„ ì™„ë£Œ - ë²ˆí˜¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”ë¨');
            {% endif %}
        }
        
        // Choice ì™„ì „ ë¦¬ì…‹ - ê°œì„ ëœ ë²„ì „ (ë²ˆí˜¸ ì´ˆê¸°í™” í¬í•¨)
        function resetChoiceQuiz() {
            console.log('Choice í€´ì¦ˆ ì™„ì „ ë¦¬ì…‹');
            
            choiceIsAnswered = false;
            choiceSelectedAnswer = null;
            
            // ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
            $('.choice-button.answer').removeClass('disabled user-selected correct incorrect show-correct');
            $('#right-gif, #wrong-gif').addClass('hidden');
            $('#feedback-correct, #feedback-incorrect').removeClass('show');
            $('#animation-container').empty();
            $('#submission-status-wrapper').empty();
            
            // í”¼ë“œë°± ë‚´ìš© ì´ˆê¸°í™”
            $('#feedback-correct, #feedback-incorrect').empty();
            
            // ì›ë˜ ìŠ¤íƒ€ì¼ ì™„ì „ ë³µì› (ë²ˆí˜¸ ìŠ¤íƒ€ì¼ë„ í¬í•¨)
            $('.choice-button.answer').each(function(index) {
                $(this).attr('class', `choice-button choice-${index + 1} answer`);
                $(this).removeAttr('style'); // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë„ ì œê±°
                
                // ì›ë˜ ë°°ê²½ìƒ‰ ë‹¤ì‹œ ì ìš©
                const theme = $('#choice-quiz-container').attr('data-theme') || 'default';
                const themeConfig = CHOICE_CONFIG.themes[theme];
                $(this).css({
                    'background': `linear-gradient(135deg, ${themeConfig.choiceColors[index % themeConfig.choiceColors.length]}, ${adjustBrightness(themeConfig.choiceColors[index % themeConfig.choiceColors.length], 20)})`
                });
            });
            
            console.log('ì™„ì „ ë¦¬ì…‹ ì™„ë£Œ - ëª¨ë“  ë²ˆí˜¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”ë¨');
        }
        
        // ì œì¶œ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateChoiceSubmissionStatus(response) {
            const wrapper = $('#submission-status-wrapper');
            wrapper.empty();
            
            const statusIcon = response.is_correct
                ? '<span class="text-green-600 font-medium ml-2"><i class="fas fa-check-circle"></i> ì •ë‹µ</span>'
                : '<span class="text-red-600 font-medium ml-2"><i class="fas fa-times-circle"></i> ì˜¤ë‹µ</span>';
            
            const statusHtml = `<div class="mt-4 text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>
                ë§ˆì§€ë§‰ ì œì¶œ: ${response.submitted_at}
                ${statusIcon}
            </div>`;
            
            wrapper.html(statusHtml);
        }
        
        // ëœë¤ ë©”ì‹œì§€ ì„ íƒ
        function getRandomMessage(messages) {
            return messages[Math.floor(Math.random() * messages.length)];
        }
        
        // Choice í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showChoiceToast(message, type = 'info') {
            showToast(message, type); // ê¸°ì¡´ í† ìŠ¤íŠ¸ í•¨ìˆ˜ ì‚¬ìš©
        }
        
        // ì¬ì œì¶œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        $(document).on('click', '#resubmit-btn', function() {
            if ('{{ slide.content_type.type_name }}' === 'choice') {
                resetChoiceQuizForRetry();
            }
        });
        
        // í™”ë©´ íšŒì „ ëŒ€ì‘
        $(window).on('orientationchange resize', function() {
            setTimeout(() => {
                // íŒŒí‹°í´ ì¬ìƒì„±
                const theme = $('#choice-quiz-container').attr('data-theme') || 'default';
                createChoiceParticles(theme);
            }, 100);
        });
        
        // Choice í€´ì¦ˆ ì´ˆê¸°í™” ì‹¤í–‰
        initializeChoiceQuiz();
    });
    </script>