<!-- teacher_evaluation.html -->
{% extends 'teacher/base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- ì»´íŒ©íŠ¸í•œ ìƒë‹¨ ì˜ì—­ -->
    <div class="bg-white/90 backdrop-blur rounded-2xl shadow-lg p-4 mb-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <h2 class="fun-font text-2xl text-purple-700 flex items-center">
                <span class="text-3xl mr-2">ğŸ“</span> í•™ìƒ ê±´ê°• ìŠµê´€ í‰ê°€
            </h2>
            
            <div class="flex items-center gap-3">
                <select id="classSelect" class="px-3 py-1.5 border-2 border-purple-300 rounded-lg text-sm focus:border-purple-500 focus:outline-none">
                    <option value="">ì „ì²´ í•™ê¸‰</option>
                    {% for class in classes %}
                    <option value="{{ class.id }}">{{ class.grade }}-{{ class.class_number }}ë°˜</option>
                    {% endfor %}
                </select>
                
                <button onclick="loadStudents()" class="bg-purple-500 text-white px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-purple-600 transition transform hover:scale-105">
                    ğŸ” ì¡°íšŒ
                </button>
                <button onclick="toggleStatistics()" id="statsToggleBtn" class="bg-green-500 text-white px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-green-600 transition transform hover:scale-105">
                    ğŸ“Š í†µê³„
                </button>
            </div>
        </div>
    </div>

    <!-- í†µê³„ ì˜ì—­ (í† ê¸€) -->
    <div id="statisticsPanel" class="hidden opacity-0 transform -translate-y-4 transition-all duration-500 ease-out mb-4">
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl shadow-lg p-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <!-- í†µê³„ ì¹´ë“œë“¤ -->
                <div class="bg-white rounded-xl p-4 text-center transform hover:scale-105 transition">
                    <p class="text-3xl font-bold text-purple-600" id="totalStudents">0</p>
                    <p class="text-sm text-gray-600">ì „ì²´ í•™ìƒ</p>
                </div>
                <div class="bg-white rounded-xl p-4 text-center transform hover:scale-105 transition">
                    <p class="text-3xl font-bold text-green-600" id="submittedStudents">0</p>
                    <p class="text-sm text-gray-600">ì œì¶œ ì™„ë£Œ</p>
                </div>
                <div class="bg-white rounded-xl p-4 text-center transform hover:scale-105 transition">
                    <p class="text-3xl font-bold text-blue-600" id="avgCompletionRate">0%</p>
                    <p class="text-sm text-gray-600">í‰ê·  ì™„ë£Œìœ¨</p>
                </div>
                <div class="bg-white rounded-xl p-4 text-center transform hover:scale-105 transition">
                    <p class="text-3xl font-bold text-yellow-600" id="totalStars">0</p>
                    <p class="text-sm text-gray-600">ì´ íšë“ ë³„</p>
                </div>
            </div>
            
            <!-- SVG ì°¨íŠ¸ ì˜ì—­ -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- ë“±ê¸‰ ë¶„í¬ ì°¨íŠ¸ -->
                <div class="bg-white rounded-xl p-4">
                    <h4 class="font-bold text-sm mb-3 text-gray-700">ë“±ê¸‰ ë¶„í¬</h4>
                    <svg id="gradeChart" viewBox="0 0 300 200" class="w-full h-40"></svg>
                </div>
                
                <!-- ì•½ì†ë³„ í‰ê·  ì™„ë£Œìœ¨ -->
                <div class="bg-white rounded-xl p-4">
                    <h4 class="font-bold text-sm mb-3 text-gray-700">ì•½ì†ë³„ í‰ê·  ì™„ë£Œìœ¨</h4>
                    <svg id="promiseChart" viewBox="0 0 300 200" class="w-full h-40"></svg>
                </div>
            </div>
        </div>
    </div>

    <!-- ì»´íŒ©íŠ¸í•œ í•™ìƒ ëª©ë¡ -->
    <div class="grid md:grid-cols-3 lg:grid-cols-4 gap-3" id="studentGrid">
        <!-- ë™ì  ë¡œë“œ -->
    </div>
</div>

<!-- í•™ìƒ ìƒì„¸ í‰ê°€ ëª¨ë‹¬ (ì• ë‹ˆë©”ì´ì…˜ ê°œì„ ) -->
<div id="evaluationModal" class="fixed inset-0 bg-black bg-opacity-0 hidden transition-opacity duration-300 overflow-y-auto z-50">
    <div class="min-h-screen px-4 py-8">
        <div id="modalContent" class="bg-white rounded-3xl max-w-4xl mx-auto p-6 transform scale-95 opacity-0 transition-all duration-300 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="fun-font text-3xl">
                    <span class="text-4xl animate-bounce inline-block">ğŸŒŸ</span> 
                    <span id="studentName"></span>ì˜ ê±´ê°• ìŠµê´€ ê¸°ë¡
                </h3>
                <button onclick="closeEvaluationModal()" class="text-3xl hover:scale-110 transition transform hover:rotate-90 duration-300">âŒ</button>
            </div>
            
            <div id="studentDetail" class="space-y-6">
                <!-- ë™ì  ë¡œë“œ -->
            </div>
            
            <!-- ì¢…í•© í‰ê°€ -->
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl p-6 mt-6 transform hover:shadow-lg transition">
                <h4 class="fun-font text-2xl mb-4 flex items-center">
                    <span class="text-3xl animate-pulse mr-2">ğŸ†</span> ì¢…í•© í‰ê°€
                </h4>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block font-bold mb-2">ë“±ê¸‰ ì„ íƒ</label>
                        <select id="overallGrade" class="w-full p-3 border-2 rounded-xl hover:border-purple-400 focus:border-purple-500 transition">
                            <option value="A">ğŸ† ìµœìš°ìˆ˜</option>
                            <option value="B">ğŸ¥‡ ìš°ìˆ˜</option>
                            <option value="C">ğŸ¥ˆ ë³´í†µ</option>
                            <option value="D">ğŸ¥‰ ë…¸ë ¥ í•„ìš”</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-bold mb-2">ì¹­ì°¬ ë±ƒì§€</label>
                        <div class="flex flex-wrap gap-2" id="badgeSelection">
                            <label class="cursor-pointer">
                                <input type="checkbox" value="perfect" class="hidden badge-check">
                                <span class="badge-label inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 transition transform hover:scale-110">ğŸ’¯ ì™„ë²½í•œ ì‹¤ì²œ</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" value="consistent" class="hidden badge-check">
                                <span class="badge-label inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 transition transform hover:scale-110">ğŸ“… ê¾¸ì¤€í•œ ì‹¤ì²œ</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" value="improved" class="hidden badge-check">
                                <span class="badge-label inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 transition transform hover:scale-110">ğŸ“ˆ ë°œì „í•˜ëŠ” ëª¨ìŠµ</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" value="creative" class="hidden badge-check">
                                <span class="badge-label inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 transition transform hover:scale-110">ğŸ¨ ì°½ì˜ì ì¸ ì†Œê°</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" value="positive" class="hidden badge-check">
                                <span class="badge-label inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 transition transform hover:scale-110">â˜€ï¸ ê¸ì •ì ì¸ íƒœë„</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block font-bold mb-2">ì¢…í•© í”¼ë“œë°±</label>
                    <textarea id="overallFeedback" rows="3" 
                              class="w-full p-3 border-2 rounded-xl hover:border-purple-400 focus:border-purple-500 transition"
                              placeholder="í•™ìƒì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ì¹­ì°¬ê³¼ ê²©ë ¤ì˜ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!"></textarea>
                </div>
                
                <button onclick="saveOverallEvaluation()" 
                        class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-bold text-lg hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition shadow-lg">
                    ğŸ’¾ í‰ê°€ ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ê°œë³„ ì†Œê° í‰ê°€ ëª¨ë‹¬ (ì• ë‹ˆë©”ì´ì…˜ ê°œì„ ) -->
<div id="reflectionEvalModal" class="fixed inset-0 bg-black bg-opacity-0 hidden transition-opacity duration-300 items-center justify-center z-50 p-4">
    <div id="evalModalContent" class="bg-white rounded-3xl p-6 max-w-md w-full transform scale-95 opacity-0 transition-all duration-300 shadow-2xl">
        <h3 class="fun-font text-2xl mb-4 flex items-center">
            <span class="text-3xl animate-spin mr-2">â­</span> ì†Œê° í‰ê°€í•˜ê¸°
        </h3>
        
        <div class="mb-4">
            <p class="font-semibold mb-2" id="evalModalInfo"></p>
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-3 mb-4">
                <p id="evalReflectionText" class="text-sm"></p>
            </div>
        </div>
        
        <div class="mb-4">
            <label class="block font-bold mb-2">ì ìˆ˜ ì„ íƒ</label>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="selectScore(3)" class="score-btn p-3 border-2 rounded-xl text-center hover:bg-green-100 transform hover:scale-105 transition">
                    <span class="text-2xl">ğŸ˜Š</span><br>
                    <span class="text-sm">ë§¤ìš° ì˜í•¨</span>
                </button>
                <button onclick="selectScore(2)" class="score-btn p-3 border-2 rounded-xl text-center hover:bg-blue-100 transform hover:scale-105 transition">
                    <span class="text-2xl">ğŸ˜„</span><br>
                    <span class="text-sm">ì˜í•¨</span>
                </button>
                <button onclick="selectScore(1)" class="score-btn p-3 border-2 rounded-xl text-center hover:bg-gray-100 transform hover:scale-105 transition">
                    <span class="text-2xl">ğŸ˜</span><br>
                    <span class="text-sm">ë³´í†µ</span>
                </button>
            </div>
        </div>
        
        <div class="mb-4">
            <label class="block font-bold mb-2">ì´ëª¨ì§€ í”¼ë“œë°±</label>
            <div class="flex gap-2 justify-center">
                <button onclick="selectEmoji('great')" class="emoji-btn text-3xl p-2 hover:scale-125 transform transition">ğŸŒŸ</button>
                <button onclick="selectEmoji('good')" class="emoji-btn text-3xl p-2 hover:scale-125 transform transition">ğŸ‘</button>
                <button onclick="selectEmoji('nice')" class="emoji-btn text-3xl p-2 hover:scale-125 transform transition">ğŸ’ª</button>
                <button onclick="selectEmoji('fighting')" class="emoji-btn text-3xl p-2 hover:scale-125 transform transition">ğŸ”¥</button>
                <button onclick="selectEmoji('smile')" class="emoji-btn text-3xl p-2 hover:scale-125 transform transition">ğŸ˜Š</button>
            </div>
        </div>
        
        <div class="mb-4">
            <label class="block font-bold mb-2">ì§§ì€ ì½”ë©˜íŠ¸ (ì„ íƒ)</label>
            <input type="text" id="evalComment" class="w-full p-2 border-2 rounded-xl hover:border-purple-400 focus:border-purple-500 transition" 
                   placeholder="ì˜í–ˆì–´ìš”! ê³„ì† ë…¸ë ¥í•´ìš”!">
        </div>
        
        <div class="flex justify-end gap-2">
            <button onclick="closeReflectionEvalModal()" 
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 transform hover:scale-105 transition">
                ì·¨ì†Œ
            </button>
            <button onclick="saveReflectionEvaluation()" 
                    class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold hover:from-green-600 hover:to-emerald-600 transform hover:scale-105 transition">
                í‰ê°€ ì €ì¥
            </button>
        </div>
    </div>
</div>

<!-- CSRF í† í° ì¶”ê°€ -->
{% csrf_token %}

<script>
// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCSRFToken() {
    return $('[name=csrfmiddlewaretoken]').val();
}

// ì „ì—­ ë³€ìˆ˜
const slideId = {{ slide_id }};
let currentTrackerId = null;
let currentReflectionId = null;
let selectedScore = 2;
let selectedEmoji = 'good';
let statisticsData = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ
$(document).ready(function() {
    loadStudents();
});

// í•™ìƒ ëª©ë¡ ë¡œë“œ
function loadStudents() {
    const classId = $('#classSelect').val();
    
    $.ajax({
        url: `/health_habit/api/teacher/students/${slideId}/`,
        type: 'GET',
        data: { class_id: classId },
        success: function(response) {
            displayStudents(response.students);
            calculateStatistics(response.students);
        }
    });
}

// í†µê³„ ê³„ì‚°
function calculateStatistics(students) {
    statisticsData = {
        total: students.length,
        submitted: students.filter(s => s.is_submitted).length,
        avgCompletionRate: students.reduce((sum, s) => sum + s.completion_rate, 0) / students.length || 0,
        totalStars: students.reduce((sum, s) => sum + s.total_stars, 0),
        gradeDistribution: {
            'A': students.filter(s => s.evaluation_grade === 'A').length,
            'B': students.filter(s => s.evaluation_grade === 'B').length,
            'C': students.filter(s => s.evaluation_grade === 'C').length,
            'D': students.filter(s => s.evaluation_grade === 'D').length,
            'none': students.filter(s => !s.evaluation_grade).length
        }
    };
    
    updateStatisticsDisplay();
}

// í†µê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateStatisticsDisplay() {
    $('#totalStudents').text(statisticsData.total);
    $('#submittedStudents').text(statisticsData.submitted);
    $('#avgCompletionRate').text(Math.round(statisticsData.avgCompletionRate) + '%');
    $('#totalStars').text(statisticsData.totalStars);
    
    // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    drawGradeChart();
    drawPromiseChart();
}

// ë“±ê¸‰ ë¶„í¬ ì°¨íŠ¸
function drawGradeChart() {
    const svg = document.getElementById('gradeChart');
    svg.innerHTML = '';
    
    const grades = ['A', 'B', 'C', 'D', 'ë¯¸í‰ê°€'];
    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#9ca3af'];
    const data = [
        statisticsData.gradeDistribution.A,
        statisticsData.gradeDistribution.B,
        statisticsData.gradeDistribution.C,
        statisticsData.gradeDistribution.D,
        statisticsData.gradeDistribution.none
    ];
    
    const maxValue = Math.max(...data, 1);
    const barWidth = 40;
    const barSpacing = 15;
    const chartHeight = 150;
    
    data.forEach((value, index) => {
        const barHeight = (value / maxValue) * chartHeight;
        const x = 30 + index * (barWidth + barSpacing);
        const y = 170 - barHeight;
        
        // ë§‰ëŒ€
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', y);
        rect.setAttribute('width', barWidth);
        rect.setAttribute('height', barHeight);
        rect.setAttribute('fill', colors[index]);
        rect.setAttribute('rx', '5');
        rect.setAttribute('class', 'transition-all duration-500');
        rect.style.opacity = '0';
        svg.appendChild(rect);
        
        // ì• ë‹ˆë©”ì´ì…˜
        setTimeout(() => {
            rect.style.opacity = '1';
            rect.style.transform = `scaleY(1)`;
        }, index * 100);
        
        // ê°’ í‘œì‹œ
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', x + barWidth / 2);
        text.setAttribute('y', y - 5);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', '#374151');
        text.setAttribute('font-size', '14');
        text.setAttribute('font-weight', 'bold');
        text.textContent = value;
        svg.appendChild(text);
        
        // ë ˆì´ë¸”
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', x + barWidth / 2);
        label.setAttribute('y', 190);
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('fill', '#374151');
        label.setAttribute('font-size', '12');
        label.textContent = grades[index];
        svg.appendChild(label);
    });
}

// ì•½ì†ë³„ ì°¨íŠ¸ (ì„ì‹œ ë°ì´í„°)
function drawPromiseChart() {
    const svg = document.getElementById('promiseChart');
    svg.innerHTML = '';
    
    // ì„ì‹œ ë°ì´í„° (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ë°›ì•„ì™€ì•¼ í•¨)
    const promises = ['ë°”ë¥¸ìì„¸', 'ìš´ë™', 'ì‹ìŠµê´€', 'ìœ„ìƒ', 'ì •ë¦¬', 'ë§ˆìŒ'];
    const data = [85, 72, 90, 88, 75, 82];
    const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
    
    const barHeight = 20;
    const barSpacing = 8;
    const maxWidth = 200;
    
    data.forEach((value, index) => {
        const barWidth = (value / 100) * maxWidth;
        const y = 20 + index * (barHeight + barSpacing);
        
        // ë°°ê²½ ë§‰ëŒ€
        const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        bgRect.setAttribute('x', 70);
        bgRect.setAttribute('y', y);
        bgRect.setAttribute('width', maxWidth);
        bgRect.setAttribute('height', barHeight);
        bgRect.setAttribute('fill', '#e5e7eb');
        bgRect.setAttribute('rx', '10');
        svg.appendChild(bgRect);
        
        // ì§„í–‰ ë§‰ëŒ€
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', 70);
        rect.setAttribute('y', y);
        rect.setAttribute('width', '0');
        rect.setAttribute('height', barHeight);
        rect.setAttribute('fill', colors[index]);
        rect.setAttribute('rx', '10');
        svg.appendChild(rect);
        
        // ì• ë‹ˆë©”ì´ì…˜
        setTimeout(() => {
            rect.setAttribute('width', barWidth);
            rect.style.transition = 'width 1s ease-out';
        }, index * 100);
        
        // ë ˆì´ë¸”
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', 65);
        label.setAttribute('y', y + barHeight / 2 + 5);
        label.setAttribute('text-anchor', 'end');
        label.setAttribute('fill', '#374151');
        label.setAttribute('font-size', '12');
        label.textContent = promises[index];
        svg.appendChild(label);
        
        // ê°’
        const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        valueText.setAttribute('x', 75 + barWidth + 5);
        valueText.setAttribute('y', y + barHeight / 2 + 5);
        valueText.setAttribute('fill', '#374151');
        valueText.setAttribute('font-size', '11');
        valueText.setAttribute('font-weight', 'bold');
        valueText.textContent = value + '%';
        svg.appendChild(valueText);
    });
}

// í†µê³„ íŒ¨ë„ í† ê¸€
function toggleStatistics() {
    const panel = $('#statisticsPanel');
    const btn = $('#statsToggleBtn');
    
    if (panel.hasClass('hidden')) {
        panel.removeClass('hidden');
        setTimeout(() => {
            panel.removeClass('opacity-0 -translate-y-4');
        }, 10);
        btn.text('ğŸ“Š ë‹«ê¸°');
    } else {
        panel.addClass('opacity-0 -translate-y-4');
        setTimeout(() => {
            panel.addClass('hidden');
        }, 500);
        btn.text('ğŸ“Š í†µê³„');
    }
}

// ì»´íŒ©íŠ¸í•œ í•™ìƒ ëª©ë¡ í‘œì‹œ
function displayStudents(students) {
    const $grid = $('#studentGrid');
    $grid.empty();
    
    if (students.length === 0) {
        $grid.append(`
            <div class="col-span-full text-center py-8">
                <p class="text-gray-500 text-lg">í•´ë‹¹ í•™ê¸‰ì˜ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `);
        return;
    }
    
    students.forEach(student => {
        const completionColor = student.completion_rate >= 80 ? 'from-green-50 to-green-100' : 
                               student.completion_rate >= 60 ? 'from-yellow-50 to-yellow-100' : 'from-red-50 to-red-100';
        
        const submissionIcon = student.is_submitted ? 'âœ…' : 'ğŸ“';
        const evaluationBadge = student.is_evaluated ? 
            `<span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full">í‰ê°€ì™„ë£Œ</span>` :
            `<span class="text-xs bg-orange-500 text-white px-2 py-0.5 rounded-full animate-pulse">í‰ê°€ëŒ€ê¸°</span>`;
        
        $grid.append(`
            <div class="bg-gradient-to-br ${completionColor} rounded-xl shadow hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:scale-105 hover:-translate-y-1"
                 onclick="viewStudent(${student.tracker_id})">
                <div class="p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-sm">${student.name}</h4>
                            <p class="text-xs text-gray-600">${student.student_grade}-${student.class_number} ${student.number}ë²ˆ</p>
                        </div>
                        <span class="text-lg">${submissionIcon}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-2xl font-bold text-gray-800">${student.completion_rate}%</p>
                            <div class="flex gap-2 text-xs text-gray-600 mt-1">
                                <span>ğŸ“ ${student.total_reflections}</span>
                                <span>â­ ${student.total_stars}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            ${evaluationBadge}
                            ${student.evaluation_grade ? `<p class="text-lg font-bold mt-1">${getGradeEmoji(student.evaluation_grade)}</p>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `);
    });
}

// ë“±ê¸‰ ì´ëª¨ì§€ í‘œì‹œ (ê°„ë‹¨í•˜ê²Œ)
function getGradeEmoji(grade) {
    const gradeEmojis = {
        'A': 'ğŸ†',
        'B': 'ğŸ¥‡',
        'C': 'ğŸ¥ˆ',
        'D': 'ğŸ¥‰'
    };
    return gradeEmojis[grade] || grade;
}

// í•™ìƒ ìƒì„¸ ë³´ê¸° (ì• ë‹ˆë©”ì´ì…˜ ê°œì„ )
function viewStudent(trackerId) {
    currentTrackerId = trackerId;
    
    $.ajax({
        url: `/health_habit/api/teacher/student-detail/${trackerId}/`,
        type: 'GET',
        success: function(response) {
            displayStudentDetail(response.data);
            
            // ëª¨ë‹¬ ì—´ê¸° ì• ë‹ˆë©”ì´ì…˜
            $('#evaluationModal').removeClass('hidden').addClass('flex');
            setTimeout(() => {
                $('#evaluationModal').removeClass('bg-opacity-0').addClass('bg-opacity-50');
                $('#modalContent').removeClass('scale-95 opacity-0').addClass('scale-100 opacity-100');
            }, 10);
        }
    });
}

// ëª¨ë‹¬ ë‹«ê¸° ì• ë‹ˆë©”ì´ì…˜
function closeEvaluationModal() {
    $('#modalContent').removeClass('scale-100 opacity-100').addClass('scale-95 opacity-0');
    $('#evaluationModal').removeClass('bg-opacity-50').addClass('bg-opacity-0');
    
    setTimeout(() => {
        $('#evaluationModal').addClass('hidden').removeClass('flex');
        currentTrackerId = null;
    }, 300);
}

// ì†Œê° í‰ê°€ ëª¨ë‹¬ ì—´ê¸°
function evaluateReflection(reflectionId, promiseTitle, dateInfo, reflectionText) {
    currentReflectionId = reflectionId;
    
    $('#evalModalInfo').text(`${promiseTitle} - ${dateInfo}`);
    $('#evalReflectionText').text(reflectionText);
    
    // ì´ˆê¸°í™”
    selectedScore = 2;
    selectedEmoji = 'good';
    $('#evalComment').val('');
    
    $('.score-btn').removeClass('border-green-500 border-blue-500 border-gray-500 bg-green-100 bg-blue-100 bg-gray-100');
    $('.emoji-btn').removeClass('ring-4 ring-purple-400 scale-125');
    
    // ëª¨ë‹¬ ì—´ê¸° ì• ë‹ˆë©”ì´ì…˜
    $('#reflectionEvalModal').removeClass('hidden').css('display', 'flex');
    setTimeout(() => {
        $('#reflectionEvalModal').removeClass('bg-opacity-0').addClass('bg-opacity-50');
        $('#evalModalContent').removeClass('scale-95 opacity-0').addClass('scale-100 opacity-100');
    }, 10);
}

// ì†Œê° í‰ê°€ ëª¨ë‹¬ ë‹«ê¸°
function closeReflectionEvalModal() {
    $('#evalModalContent').removeClass('scale-100 opacity-100').addClass('scale-95 opacity-0');
    $('#reflectionEvalModal').removeClass('bg-opacity-50').addClass('bg-opacity-0');
    
    setTimeout(() => {
        $('#reflectionEvalModal').hide();
        currentReflectionId = null;
    }, 300);
}

// ì ìˆ˜ ì„ íƒ (ì• ë‹ˆë©”ì´ì…˜ ê°œì„ )
function selectScore(score) {
    selectedScore = score;
    $('.score-btn').removeClass('border-green-500 border-blue-500 border-gray-500 bg-green-100 bg-blue-100 bg-gray-100 border-4 scale-105');
    
    if (score === 3) {
        $('.score-btn').eq(0).addClass('border-green-500 bg-green-100 border-4 scale-105');
    } else if (score === 2) {
        $('.score-btn').eq(1).addClass('border-blue-500 bg-blue-100 border-4 scale-105');
    } else {
        $('.score-btn').eq(2).addClass('border-gray-500 bg-gray-100 border-4 scale-105');
    }
}

// ì´ëª¨ì§€ ì„ íƒ (ì• ë‹ˆë©”ì´ì…˜ ê°œì„ )
function selectEmoji(emoji) {
    selectedEmoji = emoji;
    $('.emoji-btn').removeClass('ring-4 ring-purple-400 scale-125');
    $(`.emoji-btn`).each(function() {
        if ($(this).attr('onclick').includes(emoji)) {
            $(this).addClass('ring-4 ring-purple-400 scale-125');
        }
    });
}

// í•™ìƒ ìƒì„¸ ì •ë³´ í‘œì‹œ
function displayStudentDetail(data) {
    $('#studentName').text(data.student_name);
    
    const $detail = $('#studentDetail');
    $detail.empty();
    
    // ì•½ì†ë³„ í‘œì‹œ
    data.promises.forEach(promise => {
        const $promiseCard = $(`
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-4 transform hover:shadow-lg transition">
                <h5 class="font-bold text-lg mb-3">ì•½ì† ${promise.number}: ${promise.title}</h5>
                <div class="space-y-2">
                    ${promise.reflections.map(ref => {
                        const refText = ref.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        return `
                        <div class="bg-white rounded-xl p-3 ${ref.is_evaluated ? 'border-2 border-green-400' : ''} hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold">${ref.week}ì£¼ì°¨ ${ref.day_name}ìš”ì¼</span>
                                <span class="text-sm text-gray-500">${ref.date}</span>
                            </div>
                            <p class="mb-2 text-gray-700">${refText}</p>
                            <div class="flex items-center gap-2">
                                ${ref.is_evaluated ? `
                                    <span class="text-2xl animate-bounce">${ref.evaluation.emoji}</span>
                                    <span>${'â­'.repeat(ref.evaluation.score)}</span>
                                    ${ref.evaluation.comment ? `<span class="text-sm text-gray-600 italic">"${ref.evaluation.comment}"</span>` : ''}
                                ` : `
                                    <button onclick="evaluateReflection(${ref.id}, '${promise.title}', '${ref.week}ì£¼ì°¨ ${ref.day_name}ìš”ì¼', \`${refText}\`)" 
                                            class="bg-gradient-to-r from-yellow-400 to-orange-400 text-white px-3 py-1 rounded-full text-sm font-bold hover:from-yellow-500 hover:to-orange-500 transform hover:scale-105 transition">
                                        í‰ê°€í•˜ê¸°
                                    </button>
                                `}
                            </div>
                        </div>
                    `;}).join('')}
                </div>
            </div>
        `);
        
        $detail.append($promiseCard);
    });
    
    // ìµœì¢… ì†Œê°
    if (data.final_reflection) {
        $detail.append(`
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-4 transform hover:shadow-lg transition">
                <h5 class="font-bold text-lg mb-2 flex items-center">
                    <span class="text-2xl mr-2 animate-pulse">ğŸ“</span> ìµœì¢… ì†Œê°
                </h5>
                <p class="text-gray-700">${data.final_reflection}</p>
            </div>
        `);
    }
    
    // ê¸°ì¡´ í‰ê°€ ì •ë³´ í‘œì‹œ
    if (data.overall_evaluation) {
        $('#overallGrade').val(data.overall_evaluation.grade);
        $('#overallFeedback').val(data.overall_evaluation.feedback);
        
        // ë±ƒì§€ ì´ˆê¸°í™”
        $('.badge-check').prop('checked', false);
        $('.badge-label').removeClass('bg-purple-200 scale-110');
        
        // ë±ƒì§€ ì²´í¬
        data.overall_evaluation.badges.forEach(badge => {
            $(`.badge-check[value="${badge}"]`).prop('checked', true)
                .siblings('.badge-label').addClass('bg-purple-200 scale-110');
        });
    } else {
        // í‰ê°€ ì´ˆê¸°í™”
        $('#overallGrade').val('B');
        $('#overallFeedback').val('');
        $('.badge-check').prop('checked', false);
        $('.badge-label').removeClass('bg-purple-200 scale-110');
    }
}

// ì†Œê° í‰ê°€ ì €ì¥
function saveReflectionEvaluation() {
    $.ajax({
        url: '/health_habit/api/teacher/evaluate-reflection/',
        type: 'POST',
        data: JSON.stringify({
            reflection_id: currentReflectionId,
            score: selectedScore,
            emoji_feedback: selectedEmoji,
            comment: $('#evalComment').val()
        }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCSRFToken()
        },
        success: function(response) {
            closeReflectionEvalModal();
            viewStudent(currentTrackerId); // ìƒˆë¡œê³ ì¹¨
            
            // ì„±ê³µ ì•Œë¦¼ (í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼)
            showToast('í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! â­');
        }
    });
}

// ì¢…í•© í‰ê°€ ì €ì¥
function saveOverallEvaluation() {
    const selectedBadges = [];
    $('.badge-check:checked').each(function() {
        selectedBadges.push($(this).val());
    });
    
    const feedback = $('#overallFeedback').val().trim();
    if (!feedback) {
        showToast('ì¢…í•© í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”!', 'error');
        return;
    }
    
    const data = {
        tracker_id: currentTrackerId,
        grade: $('#overallGrade').val(),
        badges: selectedBadges,
        feedback: feedback
    };
    
    $.ajax({
        url: '/health_habit/api/teacher/overall-evaluation/',
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCSRFToken()
        },
        success: function(response) {
            showToast('ì¢…í•© í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
            closeEvaluationModal();
            loadStudents(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }
    });
}

// í† ìŠ¤íŠ¸ ì•Œë¦¼
function showToast(message, type = 'success') {
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    const toast = $(`
        <div class="fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
            ${message}
        </div>
    `);
    
    $('body').append(toast);
    
    setTimeout(() => {
        toast.removeClass('translate-x-full');
    }, 10);
    
    setTimeout(() => {
        toast.addClass('translate-x-full');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ë±ƒì§€ ì„ íƒ í† ê¸€ (ì• ë‹ˆë©”ì´ì…˜ ê°œì„ )
$(document).on('change', '.badge-check', function() {
    const $label = $(this).siblings('.badge-label');
    if ($(this).is(':checked')) {
        $label.addClass('bg-purple-200 scale-110');
    } else {
        $label.removeClass('bg-purple-200 scale-110');
    }
});
</script>

<style>
/* ì¶”ê°€ ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fadeIn {
    animation: fadeIn 0.5s ease-out;
}

/* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ ê°œì„  */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
button {
    position: relative;
    overflow: hidden;
}

button::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

button:active::after {
    width: 300px;
    height: 300px;
}

/* ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ */
.hover\:shadow-lg:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* SVG ì• ë‹ˆë©”ì´ì…˜ */
svg rect, svg text {
    transition: all 0.3s ease;
}

/* ëª¨ë‹¬ ë°±ë“œë¡­ ë¸”ëŸ¬ íš¨ê³¼ */
#evaluationModal.bg-opacity-50 {
    backdrop-filter: blur(5px);
}

#reflectionEvalModal.bg-opacity-50 {
    backdrop-filter: blur(5px);
}
</style>
{% endblock %}