<!-- teacher_evaluation.html -->
{% extends 'health_habit/base_health_habit.html' %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h2 class="fun-font text-4xl text-center mb-8 text-white">
        <span class="sticker">ğŸ“</span> í•™ìƒ ê±´ê°• ìŠµê´€ í‰ê°€í•˜ê¸°
    </h2>

    <!-- í•™ê¸‰ ì„ íƒ -->
    <div class="bg-white rounded-3xl p-6 mb-8 shadow-xl">
        <div class="flex flex-wrap items-center gap-4">
            <label class="font-bold text-lg">í•™ê¸‰ ì„ íƒ:</label>
            <select id="classSelect" class="px-4 py-2 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none">
                <option value="">ì „ì²´</option>
                {% for class in classes %}
                <option value="{{ class.id }}">{{ class.grade }}í•™ë…„ {{ class.class_number }}ë°˜</option>
                {% endfor %}
            </select>
            
            <div class="ml-auto flex gap-2">
                <button onclick="loadStudents()" class="bg-purple-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-purple-600 transition">
                    <span class="sticker">ğŸ”</span> ì¡°íšŒ
                </button>
                <button onclick="showStatistics()" class="bg-green-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-green-600 transition">
                    <span class="sticker">ğŸ“Š</span> í†µê³„
                </button>
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ëª©ë¡ -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="studentGrid">
        <!-- ë™ì  ë¡œë“œ -->
    </div>
</div>

<!-- í•™ìƒ ìƒì„¸ í‰ê°€ ëª¨ë‹¬ -->
<div id="evaluationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden overflow-y-auto z-50">
    <div class="min-h-screen px-4 py-8">
        <div class="bg-white rounded-3xl max-w-4xl mx-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="fun-font text-3xl">
                    <span class="sticker">ğŸŒŸ</span> <span id="studentName"></span>ì˜ ê±´ê°• ìŠµê´€ ê¸°ë¡
                </h3>
                <button onclick="closeEvaluationModal()" class="text-3xl hover:scale-110 transition">âŒ</button>
            </div>
            
            <div id="studentDetail" class="space-y-6">
                <!-- ë™ì  ë¡œë“œ -->
            </div>
            
            <!-- ì¢…í•© í‰ê°€ -->
            <div class="bg-yellow-50 rounded-2xl p-6 mt-6">
                <h4 class="fun-font text-2xl mb-4">ğŸ† ì¢…í•© í‰ê°€</h4>
                
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block font-bold mb-2">ë“±ê¸‰ ì„ íƒ</label>
                        <select id="overallGrade" class="w-full p-3 border-2 rounded-xl">
                            <option value="A">ğŸ† ìµœìš°ìˆ˜</option>
                            <option value="B">ğŸ¥‡ ìš°ìˆ˜</option>
                            <option value="C">ğŸ¥ˆ ë³´í†µ</option>
                            <option value="D">ğŸ¥‰ ë…¸ë ¥ í•„ìš”</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-bold mb-2">ì¹­ì°¬ ë±ƒì§€</label>
                        <div class="flex flex-wrap gap-2" id="badgeSelection">
                            <label class="cursor-pointer">
                                <input type="checkbox" value="perfect" class="hidden badge-check">
                                <span class="inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 badge-label">ğŸ’¯ ì™„ë²½í•œ ì‹¤ì²œ</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" value="consistent" class="hidden badge-check">
                                <span class="inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 badge-label">ğŸ“… ê¾¸ì¤€í•œ ì‹¤ì²œ</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" value="improved" class="hidden badge-check">
                                <span class="inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 badge-label">ğŸ“ˆ ë°œì „í•˜ëŠ” ëª¨ìŠµ</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" value="creative" class="hidden badge-check">
                                <span class="inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 badge-label">ğŸ¨ ì°½ì˜ì ì¸ ì†Œê°</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" value="positive" class="hidden badge-check">
                                <span class="inline-block px-3 py-1 bg-gray-200 rounded-full hover:bg-purple-200 badge-label">â˜€ï¸ ê¸ì •ì ì¸ íƒœë„</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block font-bold mb-2">ì¢…í•© í”¼ë“œë°±</label>
                    <textarea id="overallFeedback" rows="3" 
                              class="w-full p-3 border-2 rounded-xl"
                              placeholder="í•™ìƒì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ì¹­ì°¬ê³¼ ê²©ë ¤ì˜ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!"></textarea>
                </div>
                
                <button onclick="saveOverallEvaluation()" 
                        class="w-full bubble-button text-white py-3 rounded-xl font-bold text-lg">
                    ğŸ’¾ í‰ê°€ ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTrackerId = null;
let currentReflections = [];

// í•™ìƒ ëª©ë¡ ë¡œë“œ
function loadStudents() {
    const classId = $('#classSelect').val();
    
    $.ajax({
        url: `/health-habit/api/teacher/students/${slideId}/`,
        type: 'GET',
        data: { class_id: classId },
        success: function(response) {
            displayStudents(response.students);
        }
    });
}

// teacher_evaluation.htmlì˜ displayStudents í•¨ìˆ˜ ìˆ˜ì •
function displayStudents(students) {
    const $grid = $('#studentGrid');
    $grid.empty();
    
    students.forEach(student => {
        const completionColor = student.completion_rate >= 80 ? 'bg-green-100' : 
                               student.completion_rate >= 60 ? 'bg-yellow-100' : 'bg-red-100';
        
        const evaluationStatus = student.is_evaluated ? 
            `<span class="text-green-600 font-bold">âœ… í‰ê°€ ì™„ë£Œ</span>` :
            `<span class="text-orange-600 font-bold">â³ í‰ê°€ ëŒ€ê¸°</span>`;
        
        $grid.append(`
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform hover:scale-105 transition cursor-pointer"
                 onclick="viewStudent(${student.tracker_id})">
                <div class="${completionColor} p-4">
                    <h4 class="font-bold text-lg">${student.name}</h4>
                    <p class="text-sm">${student.student_grade}í•™ë…„ ${student.class_number}ë°˜ ${student.number}ë²ˆ</p>
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-3xl">${student.completion_rate}%</span>
                        ${evaluationStatus}
                    </div>
                    <div class="text-sm text-gray-600">
                        <p>ğŸ“ ì‘ì„± ì†Œê°: ${student.total_reflections}ê°œ</p>
                        <p>â­ ë°›ì€ ë³„: ${student.total_stars}ê°œ</p>
                    </div>
                    ${student.evaluation_grade ? `
                        <div class="mt-2 text-center text-2xl font-bold">
                            ${student.evaluation_grade}
                        </div>
                    ` : ''}
                </div>
            </div>
        `);
    });
}





// í•™ìƒ ìƒì„¸ ë³´ê¸°
function viewStudent(trackerId) {
    currentTrackerId = trackerId;
    
    $.ajax({
        url: `/health-habit/api/teacher/student-detail/${trackerId}/`,
        type: 'GET',
        success: function(response) {
            displayStudentDetail(response.data);
            $('#evaluationModal').show();
        }
    });
}

// í•™ìƒ ìƒì„¸ ì •ë³´ í‘œì‹œ
function displayStudentDetail(data) {
    $('#studentName').text(data.student_name);
    
    const $detail = $('#studentDetail');
    $detail.empty();
    
    // ì•½ì†ë³„ í‘œì‹œ
    data.promises.forEach(promise => {
        const $promiseCard = $(`
            <div class="bg-purple-50 rounded-2xl p-4">
                <h5 class="font-bold text-lg mb-3">ì•½ì† ${promise.number}: ${promise.title}</h5>
                <div class="space-y-2">
                    ${promise.reflections.map(ref => `
                        <div class="bg-white rounded-xl p-3 ${ref.is_evaluated ? 'border-2 border-green-400' : ''}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold">${ref.week}ì£¼ì°¨ ${ref.day_name}ìš”ì¼</span>
                                <span class="text-sm text-gray-500">${ref.date}</span>
                            </div>
                            <p class="mb-2">${ref.text}</p>
                            <div class="flex items-center gap-2">
                                ${ref.is_evaluated ? `
                                    <span class="text-2xl">${ref.evaluation.emoji}</span>
                                    <span>${'â­'.repeat(ref.evaluation.score)}</span>
                                    ${ref.evaluation.comment ? `<span class="text-sm text-gray-600">"${ref.evaluation.comment}"</span>` : ''}
                                ` : `
                                    <button onclick="evaluateReflection(${ref.id})" 
                                            class="bg-yellow-400 text-white px-3 py-1 rounded-full text-sm font-bold hover:bg-yellow-500 transition">
                                        í‰ê°€í•˜ê¸°
                                    </button>
                                `}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `);
        
        $detail.append($promiseCard);
    });
    
    // ìµœì¢… ì†Œê°
    if (data.final_reflection) {
        $detail.append(`
            <div class="bg-green-50 rounded-2xl p-4">
                <h5 class="font-bold text-lg mb-2">ğŸ“ ìµœì¢… ì†Œê°</h5>
                <p>${data.final_reflection}</p>
            </div>
        `);
    }
    
    // ê¸°ì¡´ í‰ê°€ ì •ë³´ í‘œì‹œ
    if (data.overall_evaluation) {
        $('#overallGrade').val(data.overall_evaluation.grade);
        $('#overallFeedback').val(data.overall_evaluation.feedback);
        
        // ë±ƒì§€ ì²´í¬
        data.overall_evaluation.badges.forEach(badge => {
            $(`.badge-check[value="${badge}"]`).prop('checked', true)
                .siblings('.badge-label').addClass('bg-purple-200');
        });
    }
}

// ê°œë³„ ì†Œê° í‰ê°€ ëª¨ë‹¬
function evaluateReflection(reflectionId) {
    // ê°„ë‹¨í•œ í‰ê°€ ëª¨ë‹¬ êµ¬í˜„
    const emoji = prompt('ì´ëª¨ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n1. ğŸŒŸ (great)\n2. ğŸ‘ (good)\n3. ğŸ’ª (nice)\n4. ğŸ”¥ (fighting)\n5. ğŸ˜Š (smile)');
    const score = prompt('ì ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n3. ë§¤ìš° ì˜í•¨\n2. ì˜í•¨\n1. ë³´í†µ');
    const comment = prompt('ì§§ì€ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­):');
    
    const emojiMap = {
        '1': 'great',
        '2': 'good',
        '3': 'nice',
        '4': 'fighting',
        '5': 'smile'
    };
    
    $.ajax({
        url: '/health-habit/api/teacher/evaluate-reflection/',
        type: 'POST',
        data: JSON.stringify({
            reflection_id: reflectionId,
            emoji_feedback: emojiMap[emoji] || 'good',
            score: parseInt(score) || 2,
            comment: comment || ''
        }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            alert('í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            viewStudent(currentTrackerId); // ìƒˆë¡œê³ ì¹¨
        }
    });
}

// ì¢…í•© í‰ê°€ ì €ì¥
function saveOverallEvaluation() {
    const selectedBadges = [];
    $('.badge-check:checked').each(function() {
        selectedBadges.push($(this).val());
    });
    
    const data = {
        tracker_id: currentTrackerId,
        grade: $('#overallGrade').val(),
        badges: selectedBadges,
        feedback: $('#overallFeedback').val()
    };
    
    $.ajax({
        url: '/health-habit/api/teacher/overall-evaluation/',
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            alert('ì¢…í•© í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
            closeEvaluationModal();
            loadStudents(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }
    });
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeEvaluationModal() {
    $('#evaluationModal').hide();
    currentTrackerId = null;
}

// ë±ƒì§€ ì„ íƒ í† ê¸€
$(document).on('change', '.badge-check', function() {
    if ($(this).is(':checked')) {
        $(this).siblings('.badge-label').addClass('bg-purple-200');
    } else {
        $(this).siblings('.badge-label').removeClass('bg-purple-200');
    }
});

// í†µê³„ ë³´ê¸°
function showStatistics() {
    // í†µê³„ ëª¨ë‹¬ êµ¬í˜„ (ìƒëµ)
    alert('í†µê³„ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤! ğŸ“Š');
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ
$(document).ready(function() {
    loadStudents();
});
</script>
{% endblock %}