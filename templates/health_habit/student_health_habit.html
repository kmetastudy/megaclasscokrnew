<!-- student_health_habit.html -->
{% extends 'health_habit/base_health_habit.html' %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- ìƒë‹¨ ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-3xl p-6 mb-6 shadow-xl">
        <h2 class="fun-font text-2xl text-center mb-2">
            ğŸŒŸ ê±´ê°•í•œ ìƒí™œ ìŠµê´€ 2ì£¼ ì‹¤ì²œ ê¸°ë¡ ğŸŒŸ
        </h2>
        <p class="text-center">
            ë§¤ì¼ ì‹¤ì²œí•œ ì•½ì†ì— ì²´í¬í•˜ê³ , ì†Œê°ì„ ì‘ì„±í•´ë³´ì„¸ìš”!<br>
            ê¾¸ì¤€íˆ ì‹¤ì²œí•˜ë©´ ê±´ê°•í•œ ìŠµê´€ì´ ë§Œë“¤ì–´ì ¸ìš”! ğŸ’ª
        </p>
    </div>

    <!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
    <div class="bg-white rounded-3xl p-6 mb-8 shadow-xl">
        <h2 class="fun-font text-3xl text-center mb-4">
            <span class="sticker">ğŸ“Š</span> ë‚˜ì˜ ì‹¤ì²œ í˜„í™©
        </h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-yellow-100 rounded-2xl">
                <p class="text-4xl mb-2">ğŸ¯</p>
                <p class="text-2xl font-bold" id="totalDays">0/84</p>
                <p class="text-sm">ì „ì²´ ì‹¤ì²œ</p>
            </div>
            <div class="text-center p-4 bg-green-100 rounded-2xl">
                <p class="text-4xl mb-2">ğŸ“</p>
                <p class="text-2xl font-bold" id="totalReflections">0</p>
                <p class="text-sm">ì‘ì„±í•œ ì†Œê°</p>
            </div>
            <div class="text-center p-4 bg-blue-100 rounded-2xl">
                <p class="text-4xl mb-2">â­</p>
                <p class="text-2xl font-bold" id="totalStars">0</p>
                <p class="text-sm">ë°›ì€ ë³„</p>
            </div>
            <div class="text-center p-4 bg-purple-100 rounded-2xl">
                <p class="text-4xl mb-2">ğŸ†</p>
                <p class="text-2xl font-bold" id="completionRate">0%</p>
                <p class="text-sm">ë‹¬ì„±ë¥ </p>
            </div>
        </div>
        
        <!-- í†µê³„ ë³´ê¸° ë²„íŠ¼ ì¶”ê°€ -->
        <div class="text-center mt-4">
            <button onclick="showStatisticsModal()" 
                    class="bg-blue-500 text-white px-6 py-2 rounded-full font-bold hover:bg-blue-600 transition">
                ğŸ“ˆ ìƒì„¸ í†µê³„ ë³´ê¸°
            </button>
        </div>
    </div>

    <!-- ì•½ì† ì¹´ë“œë“¤ -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for promise in promises_list %}
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden transform hover:scale-105 transition">
            <div class="promise-card p-4">
                <h3 class="fun-font text-2xl text-white text-center">
                    ì•½ì† {{ promise.number }}
                </h3>
            </div>
            <div class="p-6">
                <!-- ê³ ì •ëœ ì•½ì† ë‚´ìš© í‘œì‹œ -->
                <div class="bg-gray-100 rounded-xl p-4 mb-4 text-center">
                    <p class="text-lg font-bold text-gray-800">{{ promise.title }}</p>
                </div>
                
                <!-- 1ì£¼ì°¨ -->
                <div class="mb-4">
                    <h4 class="font-bold text-lg mb-2 text-purple-600">ğŸŒŸ 1ì£¼ì°¨</h4>
                    <div class="grid grid-cols-4 gap-2">
                        {% for day in week_days %}
                        <button class="day-bubble bg-gray-200 hover:bg-purple-200"
                                data-promise="{{ promise.number }}"
                                data-week="1"
                                data-day="{{ day.num }}"
                                onclick="openReflectionModal(this)">
                            {{ day.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- 2ì£¼ì°¨ -->
                <div class="mb-4">
                    <h4 class="font-bold text-lg mb-2 text-pink-600">ğŸŒˆ 2ì£¼ì°¨</h4>
                    <div class="grid grid-cols-4 gap-2">
                        {% for day in week_days %}
                        <button class="day-bubble bg-gray-200 hover:bg-pink-200"
                                data-promise="{{ promise.number }}"
                                data-week="2"
                                data-day="{{ day.num }}"
                                onclick="openReflectionModal(this)">
                            {{ day.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- ì†Œê° ëª©ë¡ ë²„íŠ¼ -->
                <button class="w-full bubble-button text-white py-3 rounded-xl font-bold"
                        onclick="toggleReflectionList({{ promise.number }})">
                    ğŸ“– ì†Œê° ë³´ê¸°
                </button>
                
                <!-- ì†Œê° ëª©ë¡ (ìˆ¨ê¹€) -->
                <div id="reflection-list-{{ promise.number }}" class="mt-4 hidden">
                    <div class="max-h-40 overflow-y-auto space-y-2">
                        <!-- ë™ì ìœ¼ë¡œ ë¡œë“œ -->
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì˜ì—­ -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg p-4 z-30">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <a href="{% url 'student:slide_view' slide_id %}" 
               class="bg-gray-500 text-white px-6 py-3 rounded-full font-bold hover:bg-gray-600 transition">
                â† ìŠ¬ë¼ì´ë“œë¡œ ëŒì•„ê°€ê¸°
            </a>
            <button onclick="showFinalReflectionModal()" 
                    class="bubble-button text-white px-8 py-4 rounded-full text-xl font-bold shadow-xl">
                ğŸ‰ ìµœì¢… ì†Œê° ì‘ì„±í•˜ê³  ì œì¶œí•˜ê¸°!
            </button>
        </div>
    </div>
    
    <!-- í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ (ê³ ì • ë²„íŠ¼ ì˜ì—­ë§Œí¼) -->
    <div class="h-24"></div>
</div>

<!-- ì¼ì¼ ì†Œê° ëª¨ë‹¬ -->
<div id="reflectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl p-6 max-w-md w-full">
        <h3 class="fun-font text-2xl mb-4">
            <span class="sticker">âœï¸</span> ì¼ì¼ ì‹¤ì²œ ì†Œê°
        </h3>
        
        <div class="mb-4">
            <p class="font-bold text-lg mb-2" id="modalInfo"></p>
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">ë‚ ì§œ ì„ íƒ</label>
                    <input type="date" id="reflectionDate" 
                           class="w-full p-2 border-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">ì‹œê°„ ì„ íƒ</label>
                    <input type="time" id="reflectionTime" 
                           class="w-full p-2 border-2 rounded-lg">
                </div>
            </div>
            
            <label class="block font-semibold mb-2">ì˜¤ëŠ˜ì˜ ì‹¤ì²œ ì†Œê°</label>
            <textarea id="reflectionText" rows="4" 
                      class="w-full p-3 border-2 rounded-lg"
                      placeholder="ì˜¤ëŠ˜ ì´ ì•½ì†ì„ ì‹¤ì²œí•˜ë©´ì„œ ëŠë‚€ ì ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
        </div>
        
        <div class="flex justify-end gap-2">
            <button class="px-6 py-2 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 transition" 
                    onclick="closeReflectionModal()">
                ì·¨ì†Œ
            </button>
            <button class="px-6 py-2 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600 transition" 
                    onclick="saveReflection()">
                ì €ì¥í•˜ê¸°
            </button>
        </div>
    </div>
</div>

<!-- ìµœì¢… ì†Œê° ëª¨ë‹¬ -->
<div id="finalReflectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <h3 class="fun-font text-2xl mb-4 text-center">
            <span class="sticker">ğŸŠ</span> 2ì£¼ ì‹¤ì²œì„ ë§ˆì¹˜ë©°
        </h3>
        
        <!-- ì „ì²´ ìš”ì•½ -->
        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-4 mb-6">
            <h4 class="font-bold text-lg mb-3">ğŸ“Š ë‚˜ì˜ ì‹¤ì²œ ìš”ì•½</h4>
            <div id="finalSummary" class="space-y-2">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>
        
        <!-- ìµœì¢… ì†Œê° ì‘ì„± -->
        <div class="mb-6">
            <label class="block font-bold text-lg mb-2">
                ğŸ’­ 2ì£¼ê°„ì˜ ê±´ê°• ìŠµê´€ ì‹¤ì²œì„ ë§ˆì¹˜ê³  ëŠë‚€ ì 
            </label>
            <textarea id="finalReflectionText" rows="6" 
                      class="w-full p-4 border-2 rounded-xl text-lg"
                      placeholder="2ì£¼ ë™ì•ˆ ê±´ê°•í•œ ìƒí™œ ìŠµê´€ì„ ì‹¤ì²œí•˜ë©´ì„œ ëŠë‚€ ì , ë³€í™”ëœ ì , ì•ìœ¼ë¡œì˜ ë‹¤ì§ ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
        </div>
        
        <div class="flex justify-end gap-3">
            <button class="px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400 transition" 
                    onclick="closeFinalReflectionModal()">
                ì·¨ì†Œ
            </button>
            <button class="px-8 py-3 bg-purple-600 text-white rounded-xl font-bold text-lg hover:bg-purple-700 transition shadow-lg" 
                    onclick="submitFinal()">
                ğŸ“¤ ìµœì¢… ì œì¶œí•˜ê¸°
            </button>
        </div>
    </div>
</div>

<!-- í†µê³„ ëª¨ë‹¬ -->
<div id="statisticsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <h3 class="fun-font text-2xl mb-4 text-center">
            <span class="sticker">ğŸ“Š</span> ë‚˜ì˜ ì‹¤ì²œ í†µê³„
        </h3>
        
        <div id="statisticsContent" class="space-y-4">
            <!-- ë™ì ìœ¼ë¡œ ë¡œë“œ -->
        </div>
        
        <div class="text-center mt-6">
            <button onclick="closeStatisticsModal()" 
                    class="bg-gray-300 text-gray-700 px-6 py-3 rounded-xl font-bold hover:bg-gray-400 transition">
                ë‹«ê¸°
            </button>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let currentButton = null;
let trackerId = null;
const slideId = {{ slide_id }};

// ê³ ì •ëœ ì•½ì† ì •ì˜
const fixedPromises = {
    1: 'ë°”ë¥¸ ìì„¸ë¡œ ìƒí™œí•˜ê¸°',
    2: 'ê·œì¹™ì ìœ¼ë¡œ ê°€ë²¼ìš´ ìš´ë™í•˜ê¸°',
    3: 'ë°”ë¥¸ ì‹ìŠµê´€ ê¸°ë¥´ê¸°',
    4: 'ëª¸ì„ ê¹¨ë—í•˜ê²Œ í•˜ê¸°',
    5: 'ìƒí™œ ì£¼ë³€ì„ ê¹¨ë—í•˜ê²Œ í•˜ê¸°',
    6: 'ë§ˆìŒ ê±´ê°•í•˜ê²Œ ê´€ë¦¬í•˜ê¸°'
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
$(document).ready(function() {
    loadTrackerData();
});

// íŠ¸ë˜ì»¤ ë°ì´í„° ë¡œë“œ
function loadTrackerData() {
    $.ajax({
        url: `/health_habit/api/tracker/${slideId}/`,
        type: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                trackerId = response.data.id;
                
                // íŠ¸ë˜ì»¤ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
                if (!trackerId) {
                    createTracker();
                } else {
                    // ì™„ë£Œëœ ë‚ ì§œ í‘œì‹œ
                    response.data.reflections.forEach(reflection => {
                        const $btn = $(`.day-bubble[data-promise="${reflection.promise_number}"][data-week="${reflection.week}"][data-day="${reflection.day}"]`);
                        $btn.addClass('completed');
                        
                        // í‰ê°€ ë°›ì€ ê²½ìš° ë³„ í‘œì‹œ
                        if (reflection.has_evaluation) {
                            $btn.html($btn.text() + '<br>â­');
                        }
                    });
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    updateStatistics(response.data.statistics);
                }
            } else {
                // íŠ¸ë˜ì»¤ê°€ ì—†ìœ¼ë©´ ìƒì„±
                createTracker();
            }
        }
    });
}

// íŠ¸ë˜ì»¤ ìë™ ìƒì„±
function createTracker() {
    $.ajax({
        url: '/health_habit/api/save-promises/',
        type: 'POST',
        data: JSON.stringify({
            slide_id: slideId,
            promises: fixedPromises
        }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            loadTrackerData(); // ë‹¤ì‹œ ë¡œë“œ
        }
    });
}

// í†µê³„ ì—…ë°ì´íŠ¸
function updateStatistics(stats) {
    $('#totalDays').text(`${stats.total_reflections}/84`);
    $('#totalReflections').text(stats.total_reflections);
    $('#totalStars').text(stats.total_stars || 0);
    $('#completionRate').text(stats.completion_rate + '%');
}

// ì†Œê° ëª¨ë‹¬ ì—´ê¸°
function openReflectionModal(button) {
    currentButton = button;
    const $btn = $(button);
    const promise = $btn.data('promise');
    const week = $btn.data('week');
    const day = $btn.data('day');
    const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
    
    // ëª¨ë‹¬ ì •ë³´ ì„¤ì •
    const promiseText = fixedPromises[promise];
    $('#modalInfo').text(`${promiseText} - ${week}ì£¼ì°¨ ${days[day-1]}ìš”ì¼`);
    
    // í˜„ì¬ ë‚ ì§œ/ì‹œê°„ ì„¤ì •
    const now = new Date();
    $('#reflectionDate').val(now.toISOString().split('T')[0]);
    $('#reflectionTime').val(now.toTimeString().slice(0, 5));
    
    // ê¸°ì¡´ ì†Œê° ë¡œë“œ
    if (trackerId) {
        loadReflection(promise, week, day);
    }
    
    $('#reflectionModal').css('display', 'flex');
}

// ê¸°ì¡´ ì†Œê° ë¡œë“œ
function loadReflection(promise, week, day) {
    $.ajax({
        url: `/health_habit/api/reflection/${trackerId}/${promise}/${week}/${day}/`,
        type: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                $('#reflectionText').val(response.data.reflection_text);
                $('#reflectionDate').val(response.data.reflection_date);
                $('#reflectionTime').val(response.data.reflection_time);
            } else {
                $('#reflectionText').val('');
            }
        }
    });
}

// ì†Œê° ì €ì¥
function saveReflection() {
    const $btn = $(currentButton);
    const promise = $btn.data('promise');
    const week = $btn.data('week');
    const day = $btn.data('day');
    
    const reflectionText = $('#reflectionText').val().trim();
    if (!reflectionText) {
        alert('ì†Œê°ì„ ì‘ì„±í•´ì£¼ì„¸ìš”!');
        return;
    }
    
    $.ajax({
        url: '/health_habit/api/save-reflection/',
        type: 'POST',
        data: JSON.stringify({
            tracker_id: trackerId,
            promise_number: promise,
            week: week,
            day: day,
            reflection_text: reflectionText,
            reflection_date: $('#reflectionDate').val(),
            reflection_time: $('#reflectionTime').val()
        }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                $btn.addClass('completed');
                closeReflectionModal();
                alert('ì†Œê°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’š');
                loadTrackerData(); // í†µê³„ ì—…ë°ì´íŠ¸
                
                // ì†Œê° ëª©ë¡ì´ ì—´ë ¤ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                if ($(`#reflection-list-${promise}`).is(':visible')) {
                    loadPromiseReflections(promise);
                }
            }
        }
    });
}

// ì†Œê° ëª¨ë‹¬ ë‹«ê¸°
function closeReflectionModal() {
    $('#reflectionModal').hide();
    $('#reflectionText').val('');
    currentButton = null;
}

// ì†Œê° ëª©ë¡ í† ê¸€
function toggleReflectionList(promiseNum) {
    const $list = $(`#reflection-list-${promiseNum}`);
    
    if ($list.is(':visible')) {
        $list.slideUp();
    } else {
        $list.slideDown();
        loadPromiseReflections(promiseNum);
    }
}

// ì•½ì†ë³„ ì†Œê° ëª©ë¡ ë¡œë“œ
function loadPromiseReflections(promiseNum) {
    if (!trackerId) return;
    
    $.ajax({
        url: `/health_habit/api/reflections/${trackerId}/${promiseNum}/`,
        type: 'GET',
        success: function(response) {
            if (response.success) {
                displayReflections(promiseNum, response.reflections);
            }
        }
    });
}

// ì†Œê° ëª©ë¡ í‘œì‹œ
function displayReflections(promiseNum, reflections) {
    const $container = $(`#reflection-list-${promiseNum}`);
    $container.empty();
    
    if (reflections.length === 0) {
        $container.html('<p class="text-center text-gray-500">ì•„ì§ ì‘ì„±ëœ ì†Œê°ì´ ì—†ìŠµë‹ˆë‹¤.</p>');
        return;
    }
    
    reflections.forEach(ref => {
        let evalHtml = '';
        if (ref.evaluation) {
            evalHtml = `
                <div class="mt-2 bg-yellow-50 rounded p-2">
                    <span class="text-lg">${ref.evaluation.emoji}</span>
                    ${'â­'.repeat(ref.evaluation.score)}
                    ${ref.evaluation.comment ? `<p class="text-sm text-gray-600">"${ref.evaluation.comment}"</p>` : ''}
                </div>
            `;
        }
        
        $container.append(`
            <div class="bg-gray-50 rounded-xl p-3 mb-2">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-sm">${ref.week}ì£¼ì°¨ ${ref.day_name}ìš”ì¼</span>
                    <span class="text-xs text-gray-500">${ref.reflection_date}</span>
                </div>
                <p class="text-sm">${ref.reflection_text}</p>
                ${evalHtml}
            </div>
        `);
    });
}

// í†µê³„ ëª¨ë‹¬ í‘œì‹œ
function showStatisticsModal() {
    if (!trackerId) return;
    
    $.ajax({
        url: `/health_habit/api/tracker/${slideId}/`,
        type: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                displayDetailedStatistics(response.data);
                $('#statisticsModal').css('display', 'flex');
            }
        }
    });
}

// ìƒì„¸ í†µê³„ í‘œì‹œ
function displayDetailedStatistics(data) {
    const $content = $('#statisticsContent');
    $content.empty();
    
    // ì „ì²´ í†µê³„
    $content.append(`
        <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl p-4">
            <h4 class="font-bold text-lg mb-2">ğŸ“Š ì „ì²´ ì‹¤ì²œ í˜„í™©</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-600">ì „ì²´ ì‹¤ì²œë¥ </p>
                    <p class="text-2xl font-bold">${data.statistics.completion_rate}%</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">ì´ ì‹¤ì²œ ì¼ìˆ˜</p>
                    <p class="text-2xl font-bold">${data.statistics.total_reflections}/84ì¼</p>
                </div>
            </div>
        </div>
    `);
    
    // ì•½ì†ë³„ í†µê³„
    for (let i = 1; i <= 6; i++) {
        const promiseStat = data.statistics.promises_stats[i];
        $content.append(`
            <div class="bg-gray-50 rounded-xl p-4">
                <h5 class="font-bold mb-2">ì•½ì† ${i}: ${fixedPromises[i]}</h5>
                <div class="flex items-center gap-4">
                    <div class="flex-1 bg-gray-200 rounded-full h-4">
                        <div class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: ${promiseStat.rate}%"></div>
                    </div>
                    <span class="text-sm font-bold">${promiseStat.completed_days}/14ì¼ (${promiseStat.rate}%)</span>
                </div>
            </div>
        `);
    }
}

// í†µê³„ ëª¨ë‹¬ ë‹«ê¸°
function closeStatisticsModal() {
    $('#statisticsModal').hide();
}

// ìµœì¢… ì†Œê° ëª¨ë‹¬ í‘œì‹œ
function showFinalReflectionModal() {
    if (!trackerId) return;
    
    // ìµœì¢… ìš”ì•½ í‘œì‹œ
    $.ajax({
        url: `/health_habit/api/tracker/${slideId}/`,
        type: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                displayFinalSummary(response.data.statistics);
                
                // ê¸°ì¡´ ìµœì¢… ì†Œê° ë¡œë“œ
                loadFinalReflection();
                
                $('#finalReflectionModal').css('display', 'flex');
            }
        }
    });
}

// ìµœì¢… ìš”ì•½ í‘œì‹œ
function displayFinalSummary(stats) {
    const $summary = $('#finalSummary');
    $summary.empty();
    
    for (let i = 1; i <= 6; i++) {
        const promiseStat = stats.promises_stats[i];
        $summary.append(`
            <div class="flex justify-between items-center">
                <span class="font-semibold">ì•½ì† ${i}: ${fixedPromises[i]}</span>
                <span class="text-green-600 font-bold">${promiseStat.completed_days}/14ì¼</span>
            </div>
        `);
    }
    
    $summary.append(`
        <div class="border-t pt-2 mt-2">
            <div class="flex justify-between items-center">
                <span class="font-bold">ì „ì²´ ë‹¬ì„±ë¥ </span>
                <span class="text-purple-600 font-bold text-lg">${stats.completion_rate}%</span>
            </div>
        </div>
    `);
}

// ê¸°ì¡´ ìµœì¢… ì†Œê° ë¡œë“œ
function loadFinalReflection() {
    $.ajax({
        url: `/health_habit/api/final-reflection/${trackerId}/`,
        type: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                $('#finalReflectionText').val(response.data);
            }
        }
    });
}

// ìµœì¢… ì†Œê° ëª¨ë‹¬ ë‹«ê¸°
function closeFinalReflectionModal() {
    $('#finalReflectionModal').hide();
}

// ìµœì¢… ì œì¶œ
function submitFinal() {
    const finalReflection = $('#finalReflectionText').val().trim();
    
    if (!finalReflection) {
        alert('ìµœì¢… ì†Œê°ì„ ì‘ì„±í•´ì£¼ì„¸ìš”! ğŸ“');
        return;
    }
    
    if (!confirm('ì •ë§ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì œì¶œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    $.ajax({
        url: '/health_habit/api/submit/',
        type: 'POST',
        data: JSON.stringify({
            tracker_id: trackerId,
            final_reflection: finalReflection
        }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! 2ì£¼ê°„ì˜ ê±´ê°• ìŠµê´€ ì‹¤ì²œ ê¸°ë¡ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
                window.location.href = "{% url 'student:slide_view' slide_id %}";
            }
        },
        error: function(xhr, status, error) {
            alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    });
}
</script>

<style>
/* ì¶”ê°€ ìŠ¤íƒ€ì¼ */
.reflection-items::-webkit-scrollbar {
    width: 4px;
}
.reflection-items::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}
.reflection-items::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 2px;
}
.reflection-items::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
{% endblock %}